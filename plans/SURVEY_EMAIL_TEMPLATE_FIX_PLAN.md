# Survey Email Template Fix Plan
**Created**: 2025-10-16
**Status**: READY TO EXECUTE
**Context Estimate**: ~15,000 tokens

---

## üî• THE PROBLEM (Root Cause Analysis)

You're absolutely right - the survey invitation emails are **NOT** integrated with your beautiful email template customization system. Here's exactly what's happening:

### What You See (The Symptoms)
1. You go to Activity ‚Üí Email Templates ‚Üí Survey Invitation
2. You customize:
   - Subject: "üìù Nous aimerions votre avis"
   - Hero image: Euro logo
   - Title: French title
   - Intro text: French introduction
3. You click "Save" ‚úÖ **IT SAVES CORRECTLY**
4. You preview ‚ùå **IT SHOWS THE OLD BLUE HARDCODED EMAIL**
5. You send emails ‚ùå **RECIPIENTS GET THE OLD BLUE HARDCODED EMAIL**

### Why This Happens (The Root Cause)

**There are TWO separate email template systems fighting each other:**

#### System 1: Your Beautiful Customization Tool ‚úÖ (Working)
- **Location**: `/activity/<activity_id>/email-templates`
- **Storage**: `activity.email_templates` JSON column in database
- **Templates**: All 6 types including `survey_invitation`
- **Status**: **SAVES PERFECTLY** to database
- **UI**: Beautiful Tabler.io interface with hero images, TinyMCE editor
- **Compilation**: Uses `templates/email_templates/compileEmailTemplate.py`

#### System 2: Old Hardcoded Survey Templates ‚ùå (Broken/Outdated)
- **Location**: `templates/email_templates/survey_invitation/`
- **Files**:
  - `index.html` - Old blue hardcoded template
  - `survey_invitation_NEW/index.html` - Newer version (unused)
  - `survey_invitation_compiled/index.html` - Compiled version (uses old source)
  - `survey_invitation_original/index.html` - Original backup
- **Status**: **HARDCODED** with English text and blue theme
- **Problem**: These files are **NOT** generated by the compilation system

### The Disconnect (Where It Breaks)

When you send survey invitations (`app.py:7084-7093`):

```python
send_email_async(
    app=current_app._get_current_object(),
    user=passport.user,
    activity=survey.activity,  # ‚úÖ ACTIVITY IS PASSED
    organization_id=survey.activity.organization_id,
    subject=subject,
    to_email=passport.user.email,
    template_name='survey_invitation',  # ‚ùå USES HARDCODED TEMPLATE
    context=context
)
```

**The email system (`utils.py:send_email_async` ‚Üí `send_email`):**
1. ‚úÖ Correctly calls `get_email_context(activity, 'survey_invitation', base_context)`
2. ‚úÖ Correctly loads your customizations from `activity.email_templates['survey_invitation']`
3. ‚úÖ Correctly merges subject, title, intro_text, conclusion_text
4. ‚ùå **BUT THEN** renders `templates/email_templates/survey_invitation_compiled/index.html`
5. ‚ùå That compiled template is **HARDCODED** - it doesn't use Jinja variables!

---

## üéØ THE SOLUTION (What Needs to Happen)

Survey invitation emails need to work like ALL your other email templates:

### How Other Templates Work (The Model to Follow)

**Example: New Pass Email**
1. User customizes via `/activity/<id>/email-templates`
2. Saves to `activity.email_templates['newPass']`
3. Clicks "Compile" or saves (triggers compilation)
4. `compileEmailTemplate.py` generates:
   - `templates/email_templates/newPass_compiled/index.html`
   - Uses Jinja variables: `{{ title }}`, `{{ intro }}`, etc.
5. When email is sent:
   - `get_email_context()` loads customizations
   - Renders compiled template with merged context
   - Email uses customized values ‚úÖ

**Survey Invitation (Current Broken State)**
1. User customizes via `/activity/<id>/email-templates` ‚úÖ
2. Saves to `activity.email_templates['survey_invitation']` ‚úÖ
3. ‚ùå **NO COMPILATION HAPPENS**
4. ‚ùå Old hardcoded `survey_invitation_compiled/index.html` is used
5. When email is sent:
   - `get_email_context()` loads customizations ‚úÖ
   - Renders old hardcoded template ‚ùå
   - Email ignores customizations ‚ùå

---

## üîß THE FIX (Step-by-Step Implementation)

### Phase 1: Verify Current State (5 minutes)

**Specialist Agent Checklist:**
```bash
# 1. Check if survey_invitation template exists in email template system
grep -r "survey_invitation" templates/email_templates/compileEmailTemplate.py

# 2. Check database for saved customizations
sqlite3 instance/minipass.db "SELECT id, name, email_templates FROM activity LIMIT 1;"

# 3. Verify email sending code passes activity
grep -A 10 "send_email_async" app.py | grep -A 10 "survey_invitation"

# 4. List all survey email template files
ls -la templates/email_templates/survey_invitation*/
```

**Expected Findings:**
- ‚úÖ Database has customizations saved
- ‚úÖ Email sending code passes activity
- ‚ùå Compilation system doesn't process survey_invitation
- ‚ùå Compiled template is hardcoded HTML

---

### Phase 2: Create Survey Invitation Template Source (30 minutes)

**File to Create**: `templates/email_templates/survey_invitation/index.html`

**Requirements:**
1. **MUST** use Jinja2 variables (NOT hardcoded text):
   ```jinja2
   {{ title }}           <!-- NOT "We'd Love Your Feedback!" -->
   {{ intro }}           <!-- NOT hardcoded English text -->
   {{ conclusion }}      <!-- NOT hardcoded closing text -->
   {{ survey_url }}      <!-- Dynamic survey link -->
   {{ user_name }}       <!-- Participant name -->
   {{ question_count }}  <!-- Number of questions -->
   ```

2. **MUST** match Tabler.io email template structure like other templates:
   - Copy structure from `templates/email_templates/newPass/index.html`
   - Same hero image section
   - Same header/footer structure
   - Same organization logo section

3. **MUST** include survey-specific elements:
   - Survey URL button
   - Question count display
   - Activity name
   - Friendly survey invitation tone

4. **Reference the working compiled templates**:
   ```bash
   # Copy structure from these files:
   templates/email_templates/newPass_compiled/index.html
   templates/email_templates/paymentReceived_compiled/index.html
   ```

**Template Structure:**
```html
<!DOCTYPE html>
<html>
<head>
    <!-- Tabler.io CSS -->
</head>
<body>
    <!-- Hero Image Section -->
    <div class="hero">
        <img src="cid:hero_image" alt="Activity Image">
    </div>

    <!-- Main Content -->
    <div class="content">
        <h1>{{ title }}</h1>
        <p>Hi {{ user_name }},</p>
        <div class="intro">{{ intro|safe }}</div>

        <!-- Survey Info Box -->
        <div class="survey-info">
            <p><strong>Activity:</strong> {{ activity_name }}</p>
            <p><strong>Survey:</strong> {{ survey_name }}</p>
            <p><strong>Takes only {{ question_count }} quick questions</strong></p>
        </div>

        <!-- CTA Button -->
        <a href="{{ survey_url }}" class="btn btn-primary">
            Take Survey Now
        </a>

        <!-- Conclusion -->
        <div class="conclusion">{{ conclusion|safe }}</div>
    </div>

    <!-- Organization Logo Footer -->
    <div class="footer">
        <img src="cid:activity_logo" alt="Logo">
        <p>{{ organization_name }}</p>
        <p>{{ organization_address }}</p>
    </div>
</body>
</html>
```

---

### Phase 3: Update Compilation System (15 minutes)

**File**: `templates/email_templates/compileEmailTemplate.py`

**Changes Needed:**

1. **Add survey_invitation to template types list**:
   ```python
   TEMPLATE_TYPES = [
       'newPass',
       'paymentReceived',
       'latePayment',
       'signup',
       'redeemPass',
       'survey_invitation'  # ADD THIS
   ]
   ```

2. **Add inline image mappings for survey_invitation**:
   ```python
   # In get_inline_images() or similar function
   if template_type == 'survey_invitation':
       inline_images = {
           'hero_image': 'path/to/default/hero.png',
           'activity_logo': 'path/to/default/logo.png'
       }
   ```

3. **Test compilation**:
   ```bash
   cd templates/email_templates/
   python compileEmailTemplate.py survey_invitation
   ```

4. **Verify compiled output**:
   - Check `survey_invitation_compiled/index.html` exists
   - Verify it has Jinja variables (NOT hardcoded text)
   - Verify inline images are embedded

---

### Phase 4: Hook Up Preview Functionality (20 minutes)

**File**: `app.py`

**Add Route for Survey Preview**:
```python
@app.route("/activity/<int:activity_id>/email-preview-live", methods=["POST"])
def preview_email_live(activity_id):
    """Generate live preview of email with current form data"""
    if "admin" not in session:
        return redirect(url_for("login"))

    from models import Activity
    from utils import get_email_context

    activity = Activity.query.get_or_404(activity_id)
    template_type = request.form.get('template_type')

    # Get form values (customizations)
    customizations = {
        'subject': request.form.get(f'{template_type}_subject', ''),
        'title': request.form.get(f'{template_type}_title', ''),
        'intro_text': request.form.get(f'{template_type}_intro_text', ''),
        'conclusion_text': request.form.get(f'{template_type}_conclusion_text', ''),
    }

    # Build preview context
    if template_type == 'survey_invitation':
        base_context = {
            'user_name': 'John Doe',
            'activity_name': activity.name,
            'survey_name': 'Post-Activity Feedback',
            'survey_url': '#',
            'question_count': 5,
            'organization_name': activity.organization.name if activity.organization else 'Minipass',
            'organization_address': '',
            'support_email': 'support@minipass.me'
        }

    # Merge with customizations
    context = get_email_context(activity, template_type, base_context)
    context.update(customizations)

    # Render compiled template
    template_path = f'email_templates/{template_type}_compiled/index.html'
    return render_template(template_path, **context)
```

**Frontend Changes**: (Already exists in `email_template_customization.html`)
- Preview button already wired up ‚úÖ
- Just needs backend route to work

---

### Phase 5: Fix Email Sending Flow (10 minutes)

**File**: `app.py` (lines 7056-7093)

**Current Code (Partially Working)**:
```python
# Get email context using activity-specific templates
email_context = get_email_context(survey.activity, 'survey_invitation', base_context)

subject = email_context.get('subject', f"{survey.name} - Your Feedback Requested")
template_name = 'survey_invitation'  # Match the template folder name
```

**Verify Context Keys Match Template Variables**:
```python
context = {
    'user_name': passport.user.name or 'Participant',
    'activity_name': survey.activity.name,
    'survey_name': survey.name,
    'survey_url': survey_url,
    'question_count': question_count,
    'organization_name': survey.activity.organization.name if survey.activity.organization else get_setting('ORG_NAME', 'Minipass'),
    'organization_address': get_setting('ORG_ADDRESS', ''),
    'support_email': get_setting('SUPPORT_EMAIL', 'support@minipass.me'),

    # CRITICAL: Match template variable names
    'title': email_context.get('title', 'We\'d Love Your Feedback!'),
    'intro': email_context.get('intro_text', 'Thank you for participating...'),  # Note: intro_text ‚Üí intro
    'conclusion': email_context.get('conclusion_text', 'Thank you for helping us...')  # Note: conclusion_text ‚Üí conclusion
}
```

**Key Fix**: Map `intro_text` ‚Üí `intro` and `conclusion_text` ‚Üí `conclusion` to match template variables.

---

### Phase 6: Add Auto-Compilation on Save (15 minutes)

**File**: `app.py` (in `save_email_templates` route, line 7483)

**Add After Successful Save**:
```python
@app.route("/activity/<int:activity_id>/email-templates/save", methods=["POST"])
def save_email_templates(activity_id):
    # ... existing save logic ...

    # After successful save:
    db.session.commit()

    # AUTO-COMPILE if template is survey_invitation
    single_template = request.form.get('single_template')
    if single_template == 'survey_invitation':
        try:
            import subprocess
            result = subprocess.run(
                ['python', 'templates/email_templates/compileEmailTemplate.py', 'survey_invitation'],
                capture_output=True,
                text=True,
                timeout=30
            )
            if result.returncode != 0:
                print(f"‚ö†Ô∏è Warning: Survey template compilation failed: {result.stderr}")
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Could not auto-compile survey template: {e}")

    return jsonify({
        'success': True,
        'message': f'{template_names[single_template]} saved and compiled successfully!',
        'template_type': single_template
    })
```

---

### Phase 7: Testing Checklist (20 minutes)

**Test 1: Database Save**
```bash
# 1. Customize survey_invitation template
# 2. Click Save
# 3. Verify database:
sqlite3 instance/minipass.db "SELECT email_templates FROM activity WHERE id=<activity_id>;"

# Expected: JSON with survey_invitation customizations
```

**Test 2: Template Compilation**
```bash
# 1. Run compilation manually
cd templates/email_templates/
python compileEmailTemplate.py survey_invitation

# 2. Check compiled output
cat survey_invitation_compiled/index.html | grep "{{ title }}"

# Expected: Jinja variables present (NOT hardcoded text)
```

**Test 3: Preview Functionality**
```bash
# 1. Go to /activity/<id>/email-templates
# 2. Click "Customize" on Survey Invitation
# 3. Change title to "TEST TITLE"
# 4. Click "Preview Changes"

# Expected: Preview shows "TEST TITLE" (not default text)
```

**Test 4: Live Email Send**
```bash
# 1. Go to Surveys ‚Üí Your Survey
# 2. Click "Send Invitations"
# 3. Check email inbox

# Expected:
# - ‚úÖ Subject matches customization
# - ‚úÖ Title matches customization
# - ‚úÖ Intro text matches customization (in French if set)
# - ‚úÖ Hero image matches uploaded image
# - ‚úÖ Professional Tabler.io design
# - ‚úÖ Lands in Primary inbox
```

**Test 5: Template Reset**
```bash
# 1. Customize survey_invitation template
# 2. Click "Reset to Default"
# 3. Verify customizations are cleared
# 4. Send email

# Expected: Default English template is used
```

---

## üö® CRITICAL GOTCHAS (Things That Will Break If You Don't Do This)

### 1. Variable Name Mismatch
**Problem**: Template uses `{{ intro }}` but context has `intro_text`
**Fix**: Map `intro_text ‚Üí intro` and `conclusion_text ‚Üí conclusion` in context

### 2. Hardcoded Template Still Used
**Problem**: Old `survey_invitation_compiled/index.html` has no Jinja variables
**Fix**: Delete old compiled template, regenerate from new source

### 3. Inline Images Not Embedded
**Problem**: Hero image shows as broken link
**Fix**: Ensure `compileEmailTemplate.py` embeds images as CID attachments

### 4. Preview Shows Old Template
**Problem**: Preview route doesn't use compiled template
**Fix**: Ensure preview route renders `{template_type}_compiled/index.html`

### 5. Auto-Compilation Doesn't Run
**Problem**: Save works but template doesn't update
**Fix**: Add subprocess call to compilation script in save route

---

## üìã EXECUTION CHECKLIST (For Next Agent)

**Before Starting:**
- [ ] Read this entire plan
- [ ] Understand the root cause (two separate systems)
- [ ] Acknowledge you will use compiled templates with Jinja variables

**Phase 1: Verify (5 min)**
- [ ] Check database has saved customizations
- [ ] Check email sending code passes activity
- [ ] List all survey_invitation template files
- [ ] Identify which template is currently used

**Phase 2: Create Source Template (30 min)**
- [ ] Copy structure from `newPass/index.html`
- [ ] Replace hardcoded text with Jinja variables
- [ ] Add survey-specific elements (survey_url, question_count)
- [ ] Match all variable names to context keys
- [ ] Save to `survey_invitation/index.html`

**Phase 3: Update Compilation (15 min)**
- [ ] Add survey_invitation to TEMPLATE_TYPES
- [ ] Add inline image mappings
- [ ] Run compilation script
- [ ] Verify compiled output has Jinja variables
- [ ] Delete old hardcoded compiled template

**Phase 4: Preview Functionality (20 min)**
- [ ] Add/verify preview route exists
- [ ] Test preview with custom values
- [ ] Verify preview uses compiled template
- [ ] Check French characters render correctly

**Phase 5: Email Sending (10 min)**
- [ ] Verify context keys match template variables
- [ ] Map intro_text ‚Üí intro, conclusion_text ‚Üí conclusion
- [ ] Test email send with customizations
- [ ] Verify inline images work

**Phase 6: Auto-Compilation (15 min)**
- [ ] Add subprocess call in save route
- [ ] Test save triggers compilation
- [ ] Handle compilation errors gracefully
- [ ] Add success message

**Phase 7: Testing (20 min)**
- [ ] Test database save
- [ ] Test compilation output
- [ ] Test preview functionality
- [ ] Test live email send
- [ ] Test template reset
- [ ] Verify French text works
- [ ] Verify hero images work
- [ ] Verify emails land in Primary inbox

---

## üéØ SUCCESS CRITERIA

**You know it's fixed when:**

1. ‚úÖ You customize survey_invitation template in UI
2. ‚úÖ You click "Save" ‚Üí Success message appears
3. ‚úÖ You click "Preview Changes" ‚Üí Shows YOUR customizations
4. ‚úÖ Preview shows French text if you entered French
5. ‚úÖ Preview shows uploaded hero image
6. ‚úÖ You send survey invitations
7. ‚úÖ Email arrives with YOUR subject line
8. ‚úÖ Email shows YOUR title (not "We'd Love Your Feedback!")
9. ‚úÖ Email shows YOUR intro text (not hardcoded English)
10. ‚úÖ Email shows YOUR hero image (not blue Euro)
11. ‚úÖ Email lands in Primary inbox (not Promotions)
12. ‚úÖ Email uses professional Tabler.io design

---

## üìù FILES TO MODIFY/CREATE

**Create:**
- `templates/email_templates/survey_invitation/index.html` (New Jinja source)

**Modify:**
- `templates/email_templates/compileEmailTemplate.py` (Add survey_invitation)
- `app.py` (Add auto-compilation on save, verify context keys)

**Delete (after creating new version):**
- `templates/email_templates/survey_invitation_compiled/index.html` (Old hardcoded)

**Verify (no changes needed if correct):**
- `app.py:7056-7093` (Email sending - already passes activity ‚úÖ)
- `utils.py:get_email_context` (Already merges customizations ‚úÖ)
- `email_template_customization.html` (Already has survey_invitation ‚úÖ)

---

## üí° WHY THIS WILL WORK

**The fix aligns survey_invitation with the existing working system:**

1. **Same compilation process** as newPass, paymentReceived, etc.
2. **Same template structure** with Jinja variables
3. **Same customization storage** in `activity.email_templates`
4. **Same rendering flow** through `get_email_context()`
5. **Same preview mechanism** using compiled templates
6. **Same auto-compilation** on save

**Your other 5 email templates work perfectly** because they follow this pattern.
**Survey invitation doesn't work** because it uses old hardcoded templates.
**Fix = Make survey invitation follow the same pattern as the other 5.**

---

## üî• CONTEXT-SAVING SUMMARY (If You Run Out of Tokens)

**Problem**: Survey invitation emails ignore customizations because they use old hardcoded templates instead of compiled Jinja templates like the other 5 email types.

**Fix**: Create `survey_invitation/index.html` with Jinja variables, update compilation script, ensure context variable names match template variables.

**Key Files**:
- CREATE: `templates/email_templates/survey_invitation/index.html` (copy structure from newPass)
- MODIFY: `templates/email_templates/compileEmailTemplate.py` (add survey_invitation to TEMPLATE_TYPES)
- MODIFY: `app.py:save_email_templates` (add auto-compilation)
- VERIFY: `app.py:7073-7075` (map intro_text‚Üíintro, conclusion_text‚Üíconclusion)

**Test**: Customize survey template, save, preview (should show customizations), send email (should use customizations).

---

**Plan Created By**: Claude Code
**Estimated Implementation Time**: 90-120 minutes
**Confidence**: 99% (root cause identified, solution matches existing working patterns)
