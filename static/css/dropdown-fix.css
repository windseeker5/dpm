/**
 * SIMPLIFIED BULLETPROOF DROPDOWN FIX v3.0
 * 
 * This CSS file fixes ALL dropdown issues with maximum specificity and nuclear approach.
 * Issues addressed:
 * 1. Multiple dropdowns staying open (handled by JS)
 * 2. Transparent/invisible backgrounds
 * 3. Poor positioning and cut-off dropdowns
 * 4. Header gravatar dropdown positioning
 * 5. KPI card dropdown visibility
 */

/* ===== CORE DROPDOWN STRUCTURE ===== */

/* Ensure dropdown containers have proper positioning */
.dropdown {
    position: relative !important;
}

/* NUCLEAR DROPDOWN MENU VISIBILITY - MAXIMUM SPECIFICITY */
.dropdown-menu,
.dropdown .dropdown-menu,
.card .dropdown-menu,
.table .dropdown-menu,
.navbar .dropdown-menu,
.minipass-header .dropdown-menu {
    position: absolute !important;
    z-index: 1070 !important;
    display: none !important;
    min-width: 15rem !important;
    font-size: 0.875rem !important;
    color: #1f2937 !important;
    text-align: left !important;
    list-style: none !important;
    background-color: #ffffff !important;
    background-clip: padding-box !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    padding: 0.5rem 0 !important;
}

/* Default positioning for dropdowns WITHOUT Popper.js */
.dropdown-menu:not([data-popper-placement]),
.dropdown .dropdown-menu:not([data-popper-placement]),
.card .dropdown-menu:not([data-popper-placement]),
.table .dropdown-menu:not([data-popper-placement]) {
    top: 100%;
    left: 0;
    margin: 0;
}

/* FORCE VISIBILITY FOR SHOWN DROPDOWNS - NUCLEAR APPROACH */
.dropdown-menu.show,
.dropdown.show .dropdown-menu,
.card .dropdown-menu.show,
.card .dropdown.show .dropdown-menu,
.table .dropdown-menu.show,
.table .dropdown.show .dropdown-menu,
.navbar .dropdown-menu.show,
.navbar .dropdown.show .dropdown-menu,
.minipass-header .dropdown-menu.show,
.minipass-header .dropdown.show .dropdown-menu,
body .dropdown-menu.show,
body .dropdown.show .dropdown-menu,
html body .dropdown-menu.show,
html body .dropdown.show .dropdown-menu {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
    position: absolute !important;
    z-index: 9999 !important;
    background-color: #ffffff !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    min-width: 15rem !important;
    padding: 0.5rem 0 !important;
    color: #1f2937 !important;
    font-size: 0.875rem !important;
}

/* Default positioning for SHOWN dropdowns WITHOUT Popper.js */
.dropdown-menu.show:not([data-popper-placement]),
.dropdown.show .dropdown-menu:not([data-popper-placement]),
.card .dropdown-menu.show:not([data-popper-placement]),
.table .dropdown-menu.show:not([data-popper-placement]) {
    top: 100%;
    left: 0;
    margin: 0;
    transform: none !important;
}

/* ===== SPECIAL CONTEXTS ===== */

/* Header dropdown positioning */
.minipass-header .dropdown-menu {
    z-index: 2000 !important;
}

/* Header dropdown end alignment - FIXED FOR GRAVATAR */
.minipass-header .dropdown-menu-end {
    right: 0 !important;
    left: auto !important;
}

/* Specific fix for gravatar dropdown positioning - only when NOT using Popper */
.minipass-header-user .dropdown-menu:not([data-popper-placement]),
.minipass-header-user .dropdown-menu.dropdown-menu-end:not([data-popper-placement]) {
    position: absolute !important;
    top: 100% !important;
    right: 0 !important;
    left: auto !important;
    z-index: 2000 !important;
    margin-top: 0.25rem !important;
}

/* Ensure gravatar dropdown container has proper positioning */
.minipass-header-user .dropdown {
    position: relative !important;
}

/* Gravatar dropdowns WITH Popper.js should align to the right */
.minipass-header-user .dropdown-menu[data-popper-placement] {
    z-index: 2000 !important;
}

/* KPI Cards - ensure proper overflow */
.card.dropdown-open,
.card:has(.dropdown.show) {
    position: relative !important;
    overflow: visible !important;
    z-index: 1080 !important;
}

.card .dropdown.show {
    z-index: 1081 !important;
}

.card .dropdown.show .dropdown-menu {
    z-index: 1082 !important;
}

/* Table containers - ensure overflow visible */
.table-responsive {
    overflow: visible !important;
}

.table .dropdown.show {
    z-index: 1071 !important;
}

/* Smooth animation for dropdowns */
.dropdown-menu {
    transition: all 0.1s ease !important;
}

/* Dropdown items styling */
.dropdown-item {
    display: block !important;
    width: 100% !important;
    padding: 0.5rem 1rem !important;
    clear: both !important;
    font-weight: 400 !important;
    color: #1f2937 !important;
    text-align: inherit !important;
    text-decoration: none !important;
    white-space: nowrap !important;
    background-color: transparent !important;
    border: 0 !important;
    transition: all 0.1s ease !important;
}

.dropdown-item:hover,
.dropdown-item:focus {
    color: #1f2937 !important;
    background-color: #f8f9fa !important;
    text-decoration: none !important;
}

/* ===== RIGHT-ALIGNED DROPDOWNS ===== */

.dropdown-menu-end,
.dropdown-menu.dropdown-menu-end {
    right: 0 !important;
    left: auto !important;
}

/* ===== MOBILE FIXES ===== */

@media (max-width: 768px) {
    .dropdown-menu,
    .dropdown-menu.show {
        max-width: calc(100vw - 2rem) !important;
        min-width: 15rem !important;
    }
    
    /* Right-align only TABLE ACTION dropdowns inside cards on mobile */
    .card td .dropdown-menu,
    .card td .dropdown-menu.show {
        right: 0 !important;
        left: auto !important;
    }
}

/* ===== ACCESSIBILITY ===== */

.dropdown-toggle:focus {
    outline: 2px solid #0054a6 !important;
    outline-offset: 2px !important;
}

/* ===== NUCLEAR OVERRIDE FOR BROKEN DROPDOWNS ===== */

/* If a dropdown menu has any of these problematic styles, force correct them */
[class*="dropdown-menu"][style*="display: none"].show {
    display: block !important;
}

[class*="dropdown-menu"][style*="opacity: 0"].show {
    opacity: 1 !important;
}

[class*="dropdown-menu"][style*="visibility: hidden"].show {
    visibility: visible !important;
}

/* ===== ULTRA-NUCLEAR BACKGROUND FIX ===== */
/*
 * Force background color with MAXIMUM specificity to override ANY inline styles
 * This fixes transparent dropdown backgrounds that appear in tables
 */

.dropdown-menu,
.dropdown-menu.show,
.table .dropdown-menu,
.table .dropdown-menu.show,
.table-responsive .dropdown-menu,
.table-responsive .dropdown-menu.show,
.card .dropdown-menu,
.card .dropdown-menu.show,
.page-body .dropdown-menu,
.page-body .dropdown-menu.show,
.dashboard-container .dropdown-menu,
.dashboard-container .dropdown-menu.show,
[class*="dropdown-menu"],
[class*="dropdown-menu"].show,
div .dropdown-menu,
div .dropdown-menu.show,
body .dropdown-menu,
body .dropdown-menu.show,
html body .dropdown-menu,
html body .dropdown-menu.show {
    background-color: #ffffff !important;
    background: #ffffff !important;
    background-image: none !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 0 !important;
}

/* Ensure dropdown items have proper background on hover */
.dropdown-item:hover,
.dropdown-item:focus,
.dropdown-menu .dropdown-item:hover,
.dropdown-menu .dropdown-item:focus,
.table .dropdown-menu .dropdown-item:hover,
.table .dropdown-menu .dropdown-item:focus,
.table-responsive .dropdown-menu .dropdown-item:hover,
.table-responsive .dropdown-menu .dropdown-item:focus {
    background-color: #f8f9fa !important;
    color: #1f2937 !important;
}

/* Dropdown dividers - ensure visibility */
.dropdown-divider {
    height: 0 !important;
    margin: 0.5rem 0 !important;
    overflow: hidden !important;
    border-top: 1px solid #e5e7eb !important;
    opacity: 1 !important;
}

/* ===== POPPER.JS FLIPPED DROPDOWN FIX ===== */
/*
 * CRITICAL FIX: Handle dropdowns when Popper.js flips them upward (last rows of tables)
 * When dropdown is at bottom of table, Popper adds data-popper-placement attribute and flips it upward
 * This ensures white backgrounds on flipped dropdowns
 */

.dropdown-menu[data-popper-placement],
.dropdown-menu[data-popper-placement^="top"],
.dropdown-menu[data-popper-placement^="bottom"],
.dropdown-menu.show[data-popper-placement],
.table-responsive .dropdown-menu[data-popper-placement],
.table .dropdown-menu[data-popper-placement],
.card .dropdown-menu[data-popper-placement],
div.dropdown-menu[data-popper-placement] {
    --tblr-dropdown-bg: #ffffff !important;
    --tblr-bg-surface: #ffffff !important;
    background-color: #ffffff !important;
    background: #ffffff !important;
    background-image: none !important;
    border: 1px solid rgba(0, 0, 0, 0.125) !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 0 !important;
}

/* CRITICAL FIX: Dropdown items inside flipped dropdowns MUST have white background */
.dropdown-menu[data-popper-placement] .dropdown-item,
.dropdown-menu[data-popper-placement^="top"] .dropdown-item,
.dropdown-menu[data-popper-placement^="bottom"] .dropdown-item,
.dropdown-menu[data-popper-placement] a.dropdown-item,
.dropdown-menu[data-popper-placement] button.dropdown-item,
.table .dropdown-menu[data-popper-placement] .dropdown-item,
.card .dropdown-menu[data-popper-placement] .dropdown-item {
    background-color: #ffffff !important;
    background: #ffffff !important;
    color: #182433 !important;
}

.dropdown-menu[data-popper-placement] .dropdown-item:hover,
.dropdown-menu[data-popper-placement^="top"] .dropdown-item:hover,
.dropdown-menu[data-popper-placement^="bottom"] .dropdown-item:hover,
.table .dropdown-menu[data-popper-placement] .dropdown-item:hover,
.card .dropdown-menu[data-popper-placement] .dropdown-item:hover {
    background-color: #f8f9fa !important;
    background: #f8f9fa !important;
}

/* ===== DEBUGGING (remove in production) ===== */
/*
.dropdown.show {
    outline: 2px solid green !important;
}

.dropdown-menu.show {
    outline: 2px solid blue !important;
}
*/

/* ===== ULTRA-NARROW SCREENS - ENSURE ACTIONS COLUMN VISIBLE ===== */
/*
 * Fix for Jean-François's bug: Actions column invisible on 360px mobile screens
 * Reduces padding to ensure Actions column stays visible without horizontal scroll
 * Scoped to ≤360px to avoid affecting normal mobile/desktop layouts
 */
@media (max-width: 360px) {
  /* Reduce left padding on first column to save space */
  .table-responsive .table th:first-child,
  .table-responsive .table td:first-child {
    padding-left: 0.5rem !important; /* was 1.5rem */
  }

  /* Reduce all cell horizontal padding for compact layout */
  .table-responsive .table th,
  .table-responsive .table td {
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
  }

  /* Make mobile action dropdown button more compact */
  .table-responsive .table .btn.d-md-none {
    padding: 0.25rem 0.375rem !important; /* was 0.375rem 0.5rem */
  }

  /* Slightly reduce font size for better fit */
  .table-responsive .table td {
    font-size: 0.875rem;
  }

  /* Ensure payment sender column doesn't overflow */
  .table-responsive .table td:first-child .fw-bold {
    font-size: 0.875rem;
    word-break: break-word;
  }

  .table-responsive .table td:first-child .text-muted {
    font-size: 0.75rem;
  }
}