<!DOCTYPE html>
<html>
<head>
    <title>Test Email Template JavaScript</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@2.36.0/icons-sprite.svg" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Testing Optimized Email Template JavaScript</h2>
        
        <!-- Mock form elements that mirror the actual template -->
        <form>
            <input type="text" id="signup_confirmation_subject" value="Test Subject">
            <input type="text" id="signup_confirmation_title" value="Test Title">
            <textarea id="signup_confirmation_intro_text" class="tinymce">Test intro</textarea>
            <textarea id="signup_confirmation_conclusion_text">Test conclusion</textarea>
            <input type="file" id="signup_confirmation_hero_image">
        </form>
        
        <!-- Mock badge -->
        <div id="heading-signup_confirmation">
            <span class="badge ms-2 bg-blue-lt">Customized</span>
        </div>
        
        <!-- Mock reset button -->
        <button class="btn btn-warning reset-btn" 
                data-template-key="signup_confirmation" 
                data-template-name="Signup Confirmation">
            Reset
        </button>
        
        <!-- Mock save button -->
        <button onclick="saveIndividualTemplate('signup_confirmation')" class="btn btn-primary">
            Save
        </button>
        
        <!-- Mock image preview -->
        <img id="hero-img-preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="width:100px;height:60px;">
        
        <!-- Mock modals -->
        <div class="modal" id="resetConfirmModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <span id="resetTemplateName"></span>
                    </div>
                    <div class="modal-footer">
                        <button id="confirmResetBtn" class="btn btn-warning">Confirm Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- The optimized JavaScript from our template -->
    <script>
    // Email Template Editor - Optimized (49 lines)
    document.addEventListener('DOMContentLoaded', function() {
        let resetKey = null; const resetModal = new bootstrap.Modal(document.getElementById('resetConfirmModal'));
        
        // Individual template save
        window.saveIndividualTemplate = function(key) {
            // Mock save - just show success
            toast('Template saved!', true);
        };
        
        // Reset button handlers
        document.querySelectorAll('.reset-btn').forEach(btn => btn.addEventListener('click', function() { resetKey = this.dataset.templateKey; document.getElementById('resetTemplateName').textContent = this.dataset.templateName; resetModal.show(); }));
        
        // Reset confirmation
        document.getElementById('confirmResetBtn').addEventListener('click', function() {
            if (!resetKey) return;
            ['subject', 'title', 'intro_text', 'conclusion_text'].forEach(field => {
                const input = document.getElementById(`${resetKey}_${field}`);
                if (input) {
                    input.style.transition = 'background 0.3s'; input.style.backgroundColor = '#fff3cd';
                    setTimeout(() => { input.value = ''; input.style.backgroundColor = ''; if (input.classList.contains('tinymce') && window.tinymce) { const ed = tinymce.get(input.id); if (ed) ed.setContent(''); } }, 150);
                }
            });
            document.querySelectorAll(`input[name^="${resetKey}_"][type="file"]`).forEach(f => {
                f.value = ''; 
                if (f.id.includes('hero')) document.getElementById('hero-img-preview')?.setAttribute('src', '/static/uploads/defaults/default_hero.png');
                if (f.id.includes('owner')) document.getElementById('owner-img-preview')?.setAttribute('src', '/static/uploads/flhgi.png');
            });
            setTimeout(() => updateBadge(resetKey), 200); resetModal.hide();
            toast(`${document.querySelector(`[data-template-key="${resetKey}"]`).dataset.templateName} reset to default`, true);
        });
        
        // Update status badge
        function updateBadge(key) {
            const badge = document.querySelector(`#heading-${key} .badge`), hasContent = ['subject', 'title', 'intro_text', 'conclusion_text'].some(f => document.getElementById(`${key}_${f}`)?.value?.trim());
            badge.style.transition = 'all 0.3s'; badge.style.transform = 'scale(0.8)';
            setTimeout(() => { badge.className = hasContent ? 'badge ms-2 bg-blue-lt' : 'badge ms-2 bg-secondary-lt'; badge.textContent = hasContent ? 'Customized' : 'Using Default'; badge.style.transform = 'scale(1)'; }, 150);
        }
        
        // Toast notifications
        function toast(msg, success) {
            const el = Object.assign(document.createElement('div'), {className: `alert alert-${success ? 'success' : 'danger'} position-fixed`, style: 'top:20px;right:20px;z-index:9999;min-width:300px;', innerHTML: `<i class="ti ti-${success ? 'check' : 'x'} me-2"></i>${msg}`});
            document.body.appendChild(el); setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 2500);
        }
        
        // Real-time badge updates and prevent accordion toggle on action buttons
        document.addEventListener('input', e => { const m = e.target.id?.match(/^(.+)_(subject|title|intro_text|conclusion_text)$/); if (m) setTimeout(() => updateBadge(m[1]), 100); });
        document.querySelectorAll('.header-actions button').forEach(btn => btn.addEventListener('click', e => e.stopPropagation()));
    });

    // Image preview function
    function previewImage(input, previewId) {
        const file = input.files[0]; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = e => document.getElementById(previewId).src = e.target.result; reader.readAsDataURL(file); }
    }
    </script>

    <script>
        // Test functionality after page loads
        setTimeout(function() {
            console.log('Testing JavaScript functionality...');
            
            // Test 1: Badge update
            console.log('✓ Badge update test: Changing input value...');
            document.getElementById('signup_confirmation_subject').value = '';
            document.getElementById('signup_confirmation_subject').dispatchEvent(new Event('input'));
            
            // Test 2: Toast notification
            setTimeout(() => {
                console.log('✓ Toast notification test...');
                // This will be triggered by the save button test
            }, 500);
            
            // Test 3: Individual save
            setTimeout(() => {
                console.log('✓ Individual save test...');
                if (typeof window.saveIndividualTemplate === 'function') {
                    console.log('saveIndividualTemplate function is available');
                } else {
                    console.error('❌ saveIndividualTemplate function not found!');
                }
            }, 1000);
            
            console.log('All JavaScript functionality tests completed!');
        }, 1000);
    </script>
</body>
</html>