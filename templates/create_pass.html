{% extends "base.html" %}

{% block title %}Create Pass{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
  <div class="col-lg-8">
    <form method="POST" class="card">
      <div class="card-header">
        <h3 class="card-title">Create a New Digital Pass</h3>
      </div>
      <div class="card-body">


        <!-- User Name with Auto-Suggest -->
        <div class="mb-3 position-relative">
          <label class="form-label">User Name</label>
          <input type="text" name="user_name" id="user_name" class="form-control" autocomplete="off" required />
          <div id="suggestions" class="list-group position-absolute w-100 shadow bg-white border rounded" style="top: 100%; z-index: 10; display: none;"></div>

        </div>

        <!-- Email -->
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" name="user_email" id="user_email" class="form-control" required />
        </div>

        <!-- Phone Number -->
        <div class="mb-3">
          <label class="form-label">Phone Number</label>
          <input type="tel" name="phone_number" id="mobile_phone" class="form-control" value="(581)222-3333" required />
        </div>

        <!-- Amount -->
        <div class="mb-3">
          <label class="form-label">Amount</label>
          <input type="number" name="sold_amt" step="0.01" class="form-control" value="{{ default_amt }}" required />
        </div>

        <!-- Sessions Quantity -->
        <div class="mb-3">
          <label class="form-label">Number of Games</label>
          <input type="number" name="sessionsQt" class="form-control" value="{{ default_qt }}" required />
        </div>

        <!-- Paid Checkbox -->
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" name="paid_ind" id="paidCheck">
          <label class="form-check-label" for="paidCheck">Mark as Paid</label>
        </div>

        <!-- Activity -->
        <div class="mb-3">
          <label class="form-label">Activity</label>
          <select name="activity" class="form-select">
            <option value="">-- Select Activity --</option>
            {% for activity in activity_list %}
              <option value="{{ activity }}">{{ activity }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Notes -->
        <div class="mb-3">
          <textarea name="notes" id="notes" rows="3" class="form-control" style="display:none;"></textarea>
          <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="noteToggle">
            <label class="form-check-label" for="noteToggle">Add a Note</label>
          </div>
        </div>
      </div>

      <div class="card-footer text-end">
        <button type="submit" class="btn btn-primary">
          <i class="ti ti-ticket me-2"></i>Create Pass
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Toggle Notes visibility
  function toggleNoteBox() {
    const box = document.getElementById("notes");
    const toggle = document.getElementById("noteToggle");
    box.style.display = toggle.checked ? "block" : "none";
  }
  document.getElementById("noteToggle").addEventListener("change", toggleNoteBox);

  // Auto-suggest and auto-fill
  document.addEventListener("DOMContentLoaded", function () {
    let userCache = [];

    const nameInput = document.getElementById("user_name");
    const emailInput = document.getElementById("user_email");
    const phoneInput = document.getElementById("mobile_phone");
    const suggestionBox = document.getElementById("suggestions");

    fetch("/users.json")
      .then(response => response.json())
      .then(data => userCache = data)
      .catch(err => console.error("❌ Failed to load user cache:", err));

    nameInput.addEventListener("input", () => {
      const input = nameInput.value.trim().toLowerCase();
      if (input.length < 2) return suggestionBox.style.display = "none";

      const matches = userCache.filter(user =>
        user.name && user.name.toLowerCase().startsWith(input)
      ).slice(0, 5);

      suggestionBox.innerHTML = "";
      if (matches.length > 0) {
        matches.forEach(user => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "list-group-item list-group-item-action text-start";
          btn.textContent = user.name;
          btn.dataset.email = user.email;
          btn.dataset.phone = user.phone;
          btn.addEventListener("click", () => {
            nameInput.value = user.name;
            emailInput.value = user.email;
            phoneInput.value = user.phone;
            suggestionBox.style.display = "none";
          });
          suggestionBox.appendChild(btn);
        });
        suggestionBox.style.display = "block";
      } else {
        suggestionBox.style.display = "none";
      }
    });

    document.addEventListener("click", (e) => {
      if (!suggestionBox.contains(e.target) && e.target !== nameInput) {
        suggestionBox.style.display = "none";
      }
    });
  });
</script>
{% endblock %}
