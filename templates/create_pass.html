{% extends "base.html" %}

{% block title %}Create Pass{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
  <div class="col-lg-8">
    <form method="POST" class="card">
      <div class="card-header">
        <h3 class="card-title">Create a New Digital Pass</h3>
      </div>
      <div class="card-body">

        <!-- ðŸ§‘ User Info -->
        <fieldset class="form-fieldset mb-4">
          <legend>User Information</legend>

          <!-- User Name with Auto-Suggest -->
          <div class="mb-3 position-relative input-icon">
            <span class="input-icon-addon"><i class="ti ti-user"></i></span>
            <input type="text" name="user_name" id="user_name" class="form-control" placeholder="Full Name" autocomplete="off" required />
            <div id="suggestions" class="list-group position-absolute w-100 shadow bg-white border rounded" style="top: 100%; z-index: 10;"></div>
          </div>

          <!-- Email -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-mail"></i></span>
            <input type="email" name="user_email" id="user_email" class="form-control" placeholder="Email" required />
          </div>

          <!-- Phone Number -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-phone"></i></span>
            <input type="tel" name="phone_number" id="mobile_phone" class="form-control" placeholder="Phone Number" value="" required />
          </div>
        </fieldset>

        <!-- ðŸŽŸ Pass Info -->
        <fieldset class="form-fieldset mb-4">
          <legend>Pass Details</legend>

          <!-- Activity -->
          <div class="mb-3">
            <label class="form-label">Activity <span class="text-danger">*</span></label>
            <select name="activity" class="form-select" required>
              <option value="">-- Select Activity --</option>
              {% for activity in activity_list %}
                <option value="{{ activity }}">{{ activity }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Amount -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-currency-dollar"></i></span>
            <input type="number" name="sold_amt" step="0.01" class="form-control" placeholder="Amount" value="{{ default_amt }}" required />
          </div>

          <!-- Sessions Quantity -->
          <div class="mb-3 input-icon">
            <span class="input-icon-addon"><i class="ti ti-list-numbers"></i></span>
            <input type="number" name="sessionsQt" class="form-control" placeholder="Number of Games" value="{{ default_qt }}" required />
          </div>



          <!-- Paid Checkbox -->
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" name="paid_ind" id="paidCheck">
            <label class="form-check-label" for="paidCheck">Mark as Paid</label>
          </div>

          <!-- Notes -->
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" id="notes" rows="3" class="form-control"></textarea>
          </div>
        </fieldset>
      </div>

      <div class="card-footer text-end">
        <button type="submit" class="btn btn-primary">
          <i class="ti ti-ticket me-2"></i>Create Pass
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let userCache = [];
    const nameInput = document.getElementById("user_name");
    const emailInput = document.getElementById("user_email");
    const phoneInput = document.getElementById("mobile_phone");
    const suggestionBox = document.getElementById("suggestions");

    fetch("/users.json")
      .then(response => response.json())
      .then(data => userCache = data)
      .catch(err => console.error("âŒ Failed to load user cache:", err));

    nameInput.addEventListener("input", () => {
      const input = nameInput.value.trim().toLowerCase();
      if (input.length < 2) return suggestionBox.classList.remove("show");

      const matches = userCache.filter(user =>
        user.name && user.name.toLowerCase().startsWith(input)
      ).slice(0, 5);

      suggestionBox.innerHTML = "";
      if (matches.length > 0) {
        matches.forEach(user => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "list-group-item list-group-item-action text-start";
          btn.textContent = user.name;
          btn.dataset.email = user.email;
          btn.dataset.phone = user.phone;
          btn.addEventListener("click", () => {
            nameInput.value = user.name;
            emailInput.value = user.email;
            phoneInput.value = user.phone;
            suggestionBox.classList.remove("show");
          });
          suggestionBox.appendChild(btn);
        });
        suggestionBox.classList.add("show");
      } else {
        suggestionBox.classList.remove("show");
      }
    });

    document.addEventListener("click", (e) => {
      if (!suggestionBox.contains(e.target) && e.target !== nameInput) {
        suggestionBox.classList.remove("show");
      }
    });
  });
</script>
{% endblock %}
