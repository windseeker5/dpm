{% extends "base.html" %}
{% block title %}Expense Ledger - {{ activity.name }}{% endblock %}

{% block content %}
<div class="container-xl mt-4">
  <div class="row justify-content-center">
    <!-- Expense Management -->
    <div class="col-lg-10">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="ti ti-currency-dollar me-2"></i>
            {{ "Edit Expense" if expense else "Add Expense" }}
          </h3>
        </div>
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-3">
              <label class="form-label">Category</label>
              <select name="category" class="form-select" required>
                {% for cat in categories %}
                  <option value="{{ cat }}" {% if expense and expense.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Amount ($)</label>
              <input type="number" name="amount" step="0.01" min="0" class="form-control"
                     value="{{ expense.amount if expense else '' }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" name="date" class="form-control"
                     value="{{ expense.date.strftime('%Y-%m-%d') if expense else now().strftime('%Y-%m-%d') }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea name="description" class="form-control" rows="2">{{ expense.description if expense else '' }}</textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success">
                <i class="ti ti-check me-1"></i> {{ "Update Expense" if expense else "Add Expense" }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">
          <h3 class="card-title"><i class="ti ti-list-details me-2"></i> Expense Ledger</h3>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter text-nowrap">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Receipt / Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for e in expenses %}
              <tr>
                <td>{{ e.date.strftime('%Y-%m-%d') }}</td>
                <td>{{ e.category }}</td>
                <td>${{ "%.2f"|format(e.amount) }}</td>
                <td>{{ e.description or "-" }}</td>
                <td>
                  {% if e.receipt_filename %}
                    <a href="{{ url_for('static', filename='uploads/receipts/' + e.receipt_filename) }}"
                       target="_blank" title="View Receipt">
                      <i class="ti ti-file-search me-1"></i>
                    </a>
                  {% else %}
                    <span class="text-muted me-1">-</span>
                  {% endif %}

                  <a href="{{ url_for('activity_expenses', activity_id=activity.id, expense_id=e.id) }}" class="text-primary" title="Edit">
                    <i class="ti ti-edit"></i>
                  </a>

                  <button type="button" class="text-danger btn btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#delete-expense-modal-{{ e.id }}">
                    <i class="ti ti-trash"></i>
                  </button>

                  <!-- Delete Modal -->
  
<!-- Delete Modal for Expense -->
<div class="modal modal-blur fade" id="delete-expense-modal-{{ e.id }}" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-status bg-danger"></div>

      <div class="modal-header">
        <h5 class="modal-title text-danger">
          <i class="ti ti-trash me-2"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body text-center">
        <p class="text-muted mb-3">Are you sure you want to delete this expense?</p>
      </div>

      <div class="modal-footer">
        <form method="POST" action="{{ url_for('delete_expense', expense_id=e.id) }}" class="w-100">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



                  
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-muted text-center">No expenses recorded yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
