{% extends "base.html" %}
{% block title %}E-Bank Reporting{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-xl my-4">
  <h2 class="mb-4 text-center">Basic Reporting</h2>


  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Sales Over Time by Activity</h3>
    </div>
    <div class="card-body">
      <canvas id="activityChart" height="120"></canvas>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const ctx = document.getElementById('activityChart').getContext('2d');
  
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: {{ activity_chart_data.labels | tojson }},
          datasets: {{ activity_chart_data.datasets | tojson }}
        },
        options: {
          responsive: true,
          tension: 0.4,
          interaction: {
            intersect: false,
            mode: 'index',
          },
          plugins: {
            legend: {
              labels: {
                usePointStyle: true,
              },
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Sold Amount ($)'
              },
              beginAtZero: true
            }
          }
        }
      });
    });
  </script>
  







  <!-- Matched E-Payments -->
  <h3 class="mt-5">Matched E-Payments</h3>
  <form method="get" action="{{ url_for('reporting') }}" class="mb-3">
    <input type="text" class="form-control" name="search_epay" placeholder="Search E-Payments..." value="{{ search_epay }}">
  </form>

  <div class="card table-responsive mb-4">
    <table class="table table-vcenter card-table">
      <thead><tr><th>Date</th><th>From</th><th>Bank</th><th>Amount</th><th>Name</th><th>Pass ID</th><th>Score</th><th>Result</th><th>Paid?</th></tr></thead>
      <tbody>
        {% for log in ebank_logs %}
        <tr>
          <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ log.from_email }}</td>
          <td>{{ log.bank_info_name }}</td>
          <td>${{ "%.2f"|format(log.bank_info_amt) }}</td>
          <td>{{ log.matched_name }}</td>
          <td>{{ log.matched_pass_id or '-' }}</td>
          <td>{{ "%.2f"|format(log.name_score) }}</td>
          <td>{{ log.result }}</td>
          <td><span class="text-success">✔️</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pagination_epay.pages > 1 %}
  <div class="text-center">
    <div class="pagination">
      {% for p in range(1, pagination_epay.pages + 1) %}
        <a href="{{ url_for('reporting', page_epay=p, search_epay=search_epay) }}"
           class="page-link {% if pagination_epay.page == p %}active{% endif %}">{{ p }}</a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Pass Log -->
  <h3 class="mt-5">Pass Log</h3>
  <form method="get" action="{{ url_for('reporting') }}" class="mb-3">
    <input type="text" class="form-control" name="search_pass" placeholder="Search Pass Log..." value="{{ search_pass }}">
  </form>

  <div class="card table-responsive mb-4">
    <table class="table table-vcenter card-table">
      <thead><tr><th>Date</th><th>User</th><th>Email</th><th>Amount</th><th>Games Left</th></tr></thead>
      <tbody>
        {% for p in passes %}
        <tr>
          <td>{{ p.pass_created_dt.strftime('%Y-%m-%d') }}</td>
          <td>{{ p.user_name }}</td>
          <td>{{ p.user_email }}</td>
          <td>${{ "%.2f"|format(p.sold_amt) }}</td>
          <td>{{ p.games_remaining }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pagination_pass.pages > 1 %}
  <div class="text-center">
    <div class="pagination">
      {% for p in range(1, pagination_pass.pages + 1) %}
        <a href="{{ url_for('reporting', page_pass=p, search_pass=search_pass) }}"
           class="page-link {% if pagination_pass.page == p %}active{% endif %}">{{ p }}</a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Email Log -->
  <h3 class="mt-5">Email Log</h3>
  <form method="get" action="{{ url_for('reporting') }}" class="mb-3">
    <input type="text" class="form-control" name="search_email" placeholder="Search Email Log..." value="{{ search_email }}">
  </form>

  <div class="card table-responsive mb-4">
    <table class="table table-vcenter card-table">
      <thead><tr><th>Date</th><th>To</th><th>Subject</th><th>Pass Code</th><th>Result</th></tr></thead>
      <tbody>
        {% for e in email_logs %}
        <tr>
          <td>{{ e.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ e.to_email }}</td>
          <td>{{ e.subject }}</td>
          <td>{{ e.pass_code or '-' }}</td>
          <td>{{ e.result }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pagination_email.pages > 1 %}
  <div class="text-center">
    <div class="pagination">
      {% for p in range(1, pagination_email.pages + 1) %}
        <a href="{{ url_for('reporting', page_email=p, search_email=search_email) }}"
           class="page-link {% if pagination_email.page == p %}active{% endif %}">{{ p }}</a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div>

{% endblock %}
