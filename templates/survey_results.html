{% extends "base.html" %}
{% block title %}Survey Results - {{ survey.name }}{% endblock %}

{% block head %}
<style>
/* Fix dropdown-menu-end alignment with Popper.js */
.page-header .dropdown {
  position: relative;
}

.page-header .dropdown-menu-end[data-popper-placement] {
  right: 0 !important;
  left: auto !important;
}

.results-card {
  background: #fff;
  border: 1px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}


.open-response {
  background: #f8f9fa;
  border-left: 4px solid #206bc4;
  padding: 1rem;
  margin-bottom: 0.75rem;
  border-radius: 0 0.375rem 0.375rem 0;
}

.question-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1rem;
}

/* Page structure - Light gray background to match all other pages */
.page-wrapper {
  min-height: 100vh;
  background-color: #f6f8fb !important;
}

.page-body {
  padding: 2rem 0;
}

.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

.page-title {
  font-weight: 700;
  color: #0f172a;
  font-size: 2.25rem;
}

/* White background for all cards */
.card {
  background-color: #fff !important;
}

.results-card {
  background-color: #fff !important;
}

.question-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .page-header {
    text-align: center;
  }

  .btn-list {
    flex-direction: column;
    gap: 0.5rem;
  }

  .container-xl {
    padding-left: 1rem;
    padding-right: 1rem;
  }

  .btn {
    min-height: 44px;
    padding: 0.75rem 1rem;
  }

  /* Stack summary cards on very small screens */
  .col-md-3 {
    margin-bottom: 0.75rem;
  }

  /* Mobile table improvements */
  .table-responsive {
    border: none;
  }

  .card-table th,
  .card-table td {
    padding: 0.75rem 0.5rem;
    font-size: 0.875rem;
  }

  /* Better mobile spacing for results */
  .results-card {
    margin-bottom: 1rem;
    padding: 1rem;
  }

  .question-header {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .badge {
    font-size: 0.75rem;
  }

  /* Open response mobile layout */
  .open-response {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  /* Modal mobile adjustments */
  .modal-lg {
    margin: 1rem;
  }

  .modal-header .btn-close {
    min-width: 44px;
    min-height: 44px;
  }

  /* Mobile form improvements */
  .form-control,
  .form-select {
    font-size: 16px;
    min-height: 48px;
  }

  /* Mobile KPI Carousel Styles */
  .mobile-kpi-container {
    position: relative;
  }

  .mobile-kpi-scroll {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    gap: 1rem;
    padding: 0 1rem;
  }

  .mobile-kpi-scroll::-webkit-scrollbar {
    display: none;
  }

  .mobile-kpi-card {
    flex: 0 0 85%;
    scroll-snap-align: start;
  }

  .mobile-kpi-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 1rem;
  }

  .mobile-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #dee2e6;
    transition: background 0.3s ease;
    cursor: pointer;
  }

  .mobile-dot.active {
    background: #206bc4;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h1 class="page-title mb-1"><i class="ti ti-chart-bar text-orange me-2"></i>Results</h1>
          <p class="text-muted mb-0" style="padding-left: 2.5rem; text-align: left;">{{ survey.name }}</p>
          {% if survey.activity %}<p class="text-muted small" style="padding-left: 2.5rem; text-align: left;">({{ survey.activity.name }})</p>{% endif %}
        </div>
        <div class="col-auto">
          <div class="dropdown">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              Actions
            </button>
            <div class="dropdown-menu dropdown-menu-end">
              <a class="dropdown-item" href="{{ url_for('list_surveys') }}">
                <i class="ti ti-arrow-left me-2"></i>Back to Surveys
              </a>
              {% if responses %}
              <a class="dropdown-item" href="{{ url_for('export_survey_results', survey_id=survey.id) }}">
                <i class="ti ti-download me-2"></i>Export Results
              </a>
              {% endif %}
              <a class="dropdown-item" href="{{ url_for('take_survey', survey_token=survey.survey_token) }}" target="_blank">
                <i class="ti ti-external-link me-2"></i>View Survey
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">

  <!-- Mobile View (Visible on Mobile Only) -->
  <div class="d-md-none">
    <!-- Mobile Summary Cards Carousel -->
    <div class="mobile-kpi-container mb-3">
      <div class="mobile-kpi-scroll">
        <!-- Total Responses Card -->
        <div class="mobile-kpi-card">
          <div class="card" style="border-radius: 12px; min-height: 130px;">
            <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
              <div class="text-muted small text-uppercase mb-2">TOTAL RESPONSES</div>
              <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ responses|length }}</div>
              <div class="text-muted small">
                Survey participants
              </div>
            </div>
          </div>
        </div>

        <!-- Completed Card -->
        <div class="mobile-kpi-card">
          <div class="card" style="border-radius: 12px; min-height: 130px;">
            <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
              <div class="text-muted small text-uppercase mb-2">COMPLETED</div>
              <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ responses|selectattr('completed', 'equalto', True)|list|length }}</div>
              <div class="text-muted small">
                Finished surveys
              </div>
            </div>
          </div>
        </div>

        <!-- Completion Rate Card -->
        <div class="mobile-kpi-card">
          <div class="card" style="border-radius: 12px; min-height: 130px;">
            <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
              {% set completion_rate = ((responses|selectattr('completed', 'equalto', True)|list|length / responses|length) * 100) if responses|length > 0 else 0 %}
              <div class="text-muted small text-uppercase mb-2">COMPLETION RATE</div>
              <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ "%.1f"|format(completion_rate) }}%</div>
              <div class="text-muted small">
                Success rate
              </div>
            </div>
          </div>
        </div>

        <!-- Survey Status Card -->
        <div class="mobile-kpi-card">
          <div class="card" style="border-radius: 12px; min-height: 130px;">
            <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
              <div class="text-muted small text-uppercase mb-2">SURVEY STATUS</div>
              <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ survey.status|title }}</div>
              <div class="text-muted small">
                {% if survey.status == 'active' %}
                <span class="badge bg-green-lt text-green mt-1">Live</span>
                {% elif survey.status == 'closed' %}
                <span class="badge bg-red-lt text-red mt-1">Ended</span>
                {% else %}
                <span class="badge bg-yellow-lt text-yellow mt-1">{{ survey.status|title }}</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dots Navigation -->
      <div class="mobile-kpi-dots">
        <div class="mobile-dot active" data-index="0"></div>
        <div class="mobile-dot" data-index="1"></div>
        <div class="mobile-dot" data-index="2"></div>
        <div class="mobile-dot" data-index="3"></div>
      </div>
    </div>
  </div>

  <!-- Desktop Content (Hidden on Mobile) -->
  <div class="d-none d-md-block">
    <!-- Summary Cards -->
    <div class="row mb-4">
      <!-- Total Responses -->
      <div class="col-md-3">
        <div class="card" style="border-radius: 12px; min-height: 130px;">
          <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
            <div class="text-muted small text-uppercase mb-2">TOTAL RESPONSES</div>
            <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ responses|length }}</div>
            <div class="text-muted small">
              Survey participants
            </div>
          </div>
        </div>
      </div>

      <!-- Completed -->
      <div class="col-md-3">
        <div class="card" style="border-radius: 12px; min-height: 130px;">
          <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
            <div class="text-muted small text-uppercase mb-2">COMPLETED</div>
            <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ responses|selectattr('completed', 'equalto', True)|list|length }}</div>
            <div class="text-muted small">
              Finished surveys
            </div>
          </div>
        </div>
      </div>

      <!-- Completion Rate -->
      <div class="col-md-3">
        <div class="card" style="border-radius: 12px; min-height: 130px;">
          <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
            {% set completion_rate = ((responses|selectattr('completed', 'equalto', True)|list|length / responses|length) * 100) if responses|length > 0 else 0 %}
            <div class="text-muted small text-uppercase mb-2">COMPLETION RATE</div>
            <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ "%.1f"|format(completion_rate) }}%</div>
            <div class="text-muted small">
              Success rate
            </div>
          </div>
        </div>
      </div>

      <!-- Survey Status -->
      <div class="col-md-3">
        <div class="card" style="border-radius: 12px; min-height: 130px;">
          <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
            <div class="text-muted small text-uppercase mb-2">SURVEY STATUS</div>
            <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ survey.status|title }}</div>
            <div class="text-muted small">
              {% if survey.status == 'active' %}
              <span class="badge bg-green-lt text-green mt-1">Live</span>
              {% elif survey.status == 'closed' %}
              <span class="badge bg-red-lt text-red mt-1">Ended</span>
              {% else %}
              <span class="badge bg-yellow-lt text-yellow mt-1">{{ survey.status|title }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if responses|length == 0 %}
  <!-- No Responses State -->
  <div class="card">
    <div class="card-body text-center py-5">
      <div class="empty">
        <div class="empty-img">
          <i class="ti ti-chart-bar" style="font-size: 4rem; color: #ccc;"></i>
        </div>
        <p class="empty-title">No responses yet</p>
        <p class="empty-subtitle text-muted">
          {% if survey.status == 'active' %}
            Survey is active but no responses have been received yet.
          {% else %}
            This survey has no responses.
          {% endif %}
        </p>
        <div class="empty-action">
          {% if survey.status == 'active' %}
          <form method="POST" action="{{ url_for('send_survey_invitations', survey_id=survey.id) }}" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-primary" onclick="return confirm('Send survey invitations to all participants?')">
              <i class="ti ti-mail"></i> Send Invitations
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <!-- Question Results -->
  {% for question_id, analysis_data in analysis.items() %}
  <div class="results-card">
    <div class="question-header">
      <div class="d-flex align-items-start">
        <span class="badge bg-primary text-white me-3" style="font-size: 1rem; padding: 0.5rem 0.75rem;">Q{{ loop.index }}</span>
        <div class="flex-grow-1">
          <h4 class="mb-1">{{ analysis_data.question.question }}</h4>
          <div class="text-muted small">
            Type: {{ analysis_data.question.type.replace('_', ' ').title() }}
            {% if analysis_data.question.required %} • Required{% else %} • Optional{% endif %}
            • {{ analysis_data.responses|length }} responses
          </div>
        </div>
      </div>
    </div>

    {% if analysis_data.question.type == 'multiple_choice' or analysis_data.question.type == 'rating' %}
    <!-- Multiple Choice and Rating Results -->
    <div class="mb-3">
      <h5 class="mb-3">Response Distribution</h5>
      {% set total_responses = analysis_data.responses|length %}

      {% if analysis_data.question.type == 'rating' %}
        {# For rating questions, count occurrences of each rating value #}
        {% set rating_counts = {} %}
        {% for response in analysis_data.responses %}
          {% set rating_str = response|string %}
          {% if rating_counts.update({rating_str: rating_counts.get(rating_str, 0) + 1}) %}{% endif %}
        {% endfor %}

        {# Display rating distribution sorted by rating value #}
        {% for rating in rating_counts.keys()|sort %}
          {% set count = rating_counts[rating] %}
          {% set percentage = (count / total_responses * 100) if total_responses > 0 else 0 %}
          <div class="mb-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small fw-medium">Rating: {{ rating }}</span>
              <span class="badge bg-green-lt text-green">{{ count }} ({{ "%.1f"|format(percentage) }}%)</span>
            </div>
            <div class="progress progress-sm">
              <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        {# Multiple choice distribution #}
        {% for option, count in analysis_data.summary.items() %}
        {% set percentage = (count / total_responses * 100) if total_responses > 0 else 0 %}
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="small fw-medium">{{ option }}</span>
            <span class="badge bg-green-lt text-green">{{ count }} ({{ "%.1f"|format(percentage) }}%)</span>
          </div>
          <div class="progress progress-sm">
            <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
          </div>
        </div>
        {% endfor %}
      {% endif %}
    </div>

    {% else %}
    <!-- Open-ended Results -->
    <div class="mb-3">
      <h5 class="mb-3">Responses ({{ analysis_data.summary.count }})</h5>
      {% if analysis_data.responses %}
      <div style="max-height: 400px; overflow-y: auto;">
        {% for response in analysis_data.responses %}
        <div class="open-response">
          <div class="text-break">{{ response }}</div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-muted text-center py-3">No responses for this question</div>
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endfor %}

  <!-- Response Details -->
  <div class="card main-table-card">
    <div class="card-header">
      <div class="d-flex justify-content-center align-items-center w-100">
        <!-- Filter Buttons -->
        <div class="github-filter-group" role="group" aria-label="Filter buttons" style="display: inline-flex; align-items: center; background: #f6f8fa; border: 1px solid #d1d5da; border-radius: 6px; padding: 0;">
          <a href="javascript:void(0)"
             class="github-filter-btn active"
             data-filter="completed">
            <i class="ti ti-check"></i>Completed <span class="filter-count">({{ responses|selectattr('completed', 'equalto', True)|list|length }})</span>
          </a>
          <a href="javascript:void(0)"
             class="github-filter-btn"
             data-filter="in_progress">
            In Progress <span class="filter-count">({{ responses|selectattr('completed', 'equalto', False)|list|length }})</span>
          </a>
          <a href="javascript:void(0)"
             class="github-filter-btn"
             data-filter="all">
            <i class="ti ti-list"></i>All <span class="filter-count">({{ responses|length }})</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Table Layout (Mobile & Desktop) -->
    <div class="table-responsive">
      <table class="table card-table table-vcenter table-hover">
        <thead>
          <tr>
            <th>User</th>
            <th class="d-none d-md-table-cell">Status</th>
            <th class="d-none d-md-table-cell">Started</th>
            <th class="d-none d-md-table-cell">Completed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for response in responses %}
          <tr class="response-row" data-status="{% if response.completed %}completed{% else %}in_progress{% endif %}">
            <td>
              <div class="d-flex align-items-center">
                {% if response.user %}
                <span class="avatar avatar-sm me-2" style="background-image: url('https://www.gravatar.com/avatar/{{ (response.user.email or 'default@example.com')|lower|trim|encode_md5 }}?d=identicon')"></span>
                <div>
                  <strong>{{ response.user.name or 'Anonymous' }}</strong>
                  <br>
                  <span class="text-muted small">{{ response.user.email or '-' }}</span>
                </div>
                {% else %}
                <span class="text-muted">Anonymous User</span>
                {% endif %}
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              {% if response.completed %}
              <span class="badge bg-green-lt text-green">Completed</span>
              {% else %}
              <span class="badge bg-yellow-lt text-yellow">In Progress</span>
              {% endif %}
            </td>
            <td class="d-none d-md-table-cell">
              <div class="small">
                {{ response.created_dt.strftime('%Y-%m-%d %H:%M') if response.created_dt else '-' }}
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              <div class="small">
                {{ response.completed_dt.strftime('%Y-%m-%d %H:%M') if response.completed_dt else '-' }}
              </div>
            </td>
            <td class="text-center" style="vertical-align: middle;">
              {% if response.responses %}
              <div class="dropdown d-inline-block">
                <a href="#" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  <span class="d-none d-md-inline">Actions</span>
                  <i class="ti ti-menu-2 d-md-none"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="javascript:void(0)" onclick='showIndividualResponse({{ response.id }}, "{{ (response.user.name if response.user else "Anonymous")|replace('"', '\\"') }}", {{ response.responses|safe }})'>
                    <i class="ti ti-eye me-2"></i>View Response
                  </a>
                </div>
              </div>
              {% else %}
              <span class="text-muted small">No data</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

    </div>
  </div>
</div>

<!-- Individual Response Modal -->
<div class="modal modal-blur fade" id="responseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-user me-2"></i>Response from <span id="responseUserName"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="responseContent">
          <!-- Individual response will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden question data for modal -->
<script id="questionData" type="application/json">
{{ analysis | tojson }}
</script>
{% endblock %}

{% block scripts %}
<script>
function showIndividualResponse(responseId, userName, responseData) {
  document.getElementById('responseUserName').textContent = userName;
  
  try {
    const questionData = JSON.parse(document.getElementById('questionData').textContent);
    
    let responseHtml = '';
    for (const [questionId, analysis] of Object.entries(questionData)) {
      const question = analysis.question;
      const userAnswer = responseData[questionId] || 'No answer';
      
      let questionNum = Object.keys(questionData).indexOf(questionId) + 1;
      responseHtml += `
        <div class="mb-4">
          <div class="d-flex align-items-start mb-2">
            <span class="badge bg-primary text-white me-2" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;">Q${questionNum}</span>
            <div class="flex-grow-1">
              <h6 class="mb-1">${question.question}</h6>
              <div class="text-muted small">${question.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
            </div>
          </div>
          <div class="ms-4">
            <div class="p-3 bg-light rounded">
              <strong>Answer:</strong> ${userAnswer}
            </div>
          </div>
        </div>
      `;
    }
    
    if (responseHtml === '') {
      responseHtml = '<div class="text-muted">No response data found.</div>';
    }
    
    document.getElementById('responseContent').innerHTML = responseHtml;
  } catch (e) {
    document.getElementById('responseContent').innerHTML = '<div class="text-danger">Error loading response data.</div>';
  }
  
  new bootstrap.Modal(document.getElementById('responseModal')).show();
}

// Mobile KPI dot navigation
document.addEventListener('DOMContentLoaded', function() {
  const scroll = document.querySelector('.mobile-kpi-scroll');
  const dots = document.querySelectorAll('.mobile-dot');
  if (scroll && dots.length > 0) {
    scroll.addEventListener('scroll', () => {
      const index = Math.round(scroll.scrollLeft / scroll.offsetWidth);
      dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
    });
  }

  // Initialize GitHub-style filter component for Response Details
  const filterButtons = document.querySelectorAll('.github-filter-btn');
  const responseRows = document.querySelectorAll('.response-row');

  filterButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();

      // Remove active class from all buttons
      filterButtons.forEach(btn => btn.classList.remove('active'));

      // Add active class to clicked button
      this.classList.add('active');

      // Get filter value
      const filter = this.getAttribute('data-filter');

      // Filter rows
      responseRows.forEach(row => {
        const status = row.getAttribute('data-status');

        if (filter === 'all') {
          row.style.display = '';
        } else {
          row.style.display = status === filter ? '' : 'none';
        }
      });
    });
  });
});
</script>
{% endblock %}