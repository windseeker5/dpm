{% extends "base.html" %}
{% block title %}Settings | Minipass{% endblock %}
{% block content %}

<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <h1 class="page-title mb-0"><i class="ti ti-settings fs-1 text-muted me-2"></i>Settings</h1>
        </div>
        <div class="d-flex align-items-center">
          <button type="submit" class="btn btn-success" form="settings-form">
            <i class="ti ti-device-floppy me-2"></i>
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">
  <form method="POST" enctype="multipart/form-data" id="settings-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card bg-white">
      <!-- Content Area (Full Width) -->
      <div class="card-body">
            <div class="tab-content">
              <!-- Admins Tab -->
              <div class="tab-pane fade show active" id="tab-admins">
                <h2 class="mb-4">Admin Accounts</h2>
                {% include 'partials/settings_admins.html' %}
              </div>

              <!-- Organization Tab -->
              <div class="tab-pane fade" id="tab-org">
                <h2 class="mb-4">Organization</h2>
                {% include 'partials/settings_org.html' %}
              </div>

              <!-- Email Settings Tab -->
              <div class="tab-pane fade" id="tab-email">
                <h2 class="mb-4">Email Settings</h2>
                {% include 'partials/settings_email.html' %}
              </div>


              <!-- Your Data Tab -->
              <div class="tab-pane fade" id="tab-data">
                <h2 class="mb-4">Your Data</h2>
                <div class="row">
                  <div class="col-lg-8">
                    <h3 class="mb-4">
                      <i class="ti ti-alert-triangle text-danger me-2"></i>
                      Danger Zone
                    </h3>
                    
                    <div class="card border-danger">
                      <div class="card-header bg-danger-lt">
                        <h4 class="card-title text-danger mb-0">
                          <i class="ti ti-trash me-2"></i>
                          Erase All Application Data
                        </h4>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-3">
                          This action will permanently delete all user passes, redemptions, reminders, 
                          e-bank logs, and email logs. This cannot be undone.
                        </p>
                        
                        <div class="alert alert-danger" role="alert">
                          <div class="d-flex">
                            <div>
                              <i class="ti ti-alert-circle me-2"></i>
                            </div>
                            <div>
                              <h4 class="alert-title">Warning!</h4>
                              <div class="text-muted">
                                Make sure you have created a backup before proceeding with this action.
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmEraseModal">
                          <i class="ti ti-trash me-2"></i>
                          Erase All App Data
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Backup & Restore Tab -->
              <div class="tab-pane fade" id="tab-backup">
                <h2 class="mb-4">Backup & Restore</h2>
                <div class="row">
                  <div class="col-lg-8">
                    <h3 class="mb-4">
                      <i class="ti ti-database me-2"></i>
                      Database Backup & Restore
                    </h3>
                    
                    <!-- Manual Backup Section -->
                    <div class="card mb-4">
                      <div class="card-header">
                        <h4 class="card-title mb-0">
                          <i class="ti ti-database-export me-2"></i>
                          Create Backup
                        </h4>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-3">
                          Generate a backup of your current database. Includes all active data but excludes 
                          settings and admin passwords for security.
                        </p>
                        
                        <button type="button" class="btn btn-primary" onclick="createBackup()">
                          <i class="ti ti-database-export me-2"></i>
                          Create Backup Now
                        </button>
                      </div>
                    </div>
                    
                    <!-- Upload & Restore Section -->
                    <div class="card">
                      <div class="card-header">
                        <h4 class="card-title mb-0">
                          <i class="ti ti-upload me-2"></i>
                          Upload & Restore Backup
                        </h4>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-3">
                          Upload a backup file from your computer and restore it. This will replace all current data.
                        </p>
                        <div class="mb-3">
                          <label for="backup_file_display" class="form-label">Select Backup File</label>
                          <input type="file" class="form-control" id="backup_file_display" 
                                 accept=".zip" required>
                          <div class="form-text">Only ZIP backup files are supported</div>
                        </div>
                        <button type="button" class="btn btn-warning" 
                                data-bs-toggle="modal" data-bs-target="#confirmUploadRestoreModal"
                                onclick="copyFileToModal()">
                          <i class="ti ti-restore me-2"></i>
                          Upload & Restore
                        </button>
                      </div>
                    </div>
                    
                    <!-- Available Backups Section -->
                    <div class="card">
                      <div class="card-header">
                        <h4 class="card-title mb-0">
                          <i class="ti ti-folder me-2"></i>
                          Available Backups
                        </h4>
                      </div>
                      <div class="card-body">
                        {% if backup_files %}
                          <div class="list-group list-group-flush">
                            {% for file in backup_files %}
                              <div class="list-group-item d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                  <i class="ti ti-file-zip text-muted me-3"></i>
                                  <div>
                                    <div class="fw-semibold">{{ file }}</div>
                                    <div class="text-muted small">Complete system backup (database + files)</div>
                                  </div>
                                </div>
                                <div class="d-flex gap-2">
                                  <a href="{{ url_for('static', filename='backups/' ~ file) }}" download class="btn btn-sm btn-outline-primary">
                                    <i class="ti ti-download me-1"></i>
                                    Download
                                  </a>
                                  <button type="button" class="btn btn-sm btn-outline-warning" 
                                          data-bs-toggle="modal" data-bs-target="#confirmRestoreModal"
                                          onclick="setRestoreFilename('{{ file }}')">
                                    <i class="ti ti-restore me-1"></i>
                                    Restore
                                  </button>
                                  <button type="button" class="btn btn-sm btn-outline-danger" 
                                          data-bs-toggle="modal" data-bs-target="#confirmDeleteBackupModal"
                                          onclick="setDeleteFilename('{{ file }}')">
                                    <i class="ti ti-trash me-1"></i>
                                    Delete
                                  </button>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        {% else %}
                          <div class="empty">
                            <div class="empty-icon">
                              <i class="ti ti-folder-x"></i>
                            </div>
                            <p class="empty-title">No backups found</p>
                            <p class="empty-subtitle text-muted">
                              Create your first backup to get started
                            </p>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
    </div>
    </form>
    </div>
  </div>
</div>

<!-- Backup Limit Modal -->
<div class="modal modal-blur fade" id="backupLimitModal" tabindex="-1" role="dialog" aria-labelledby="backupLimitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="backupLimitModalLabel">
          <i class="ti ti-alert-triangle text-warning me-2"></i>
          Backup Limit Reached
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <div class="me-3">
            <i class="ti ti-info-circle text-blue fs-2"></i>
          </div>
          <div>
            <p class="text-secondary mb-2">
              You already have <strong>5 backups</strong>, which is the maximum limit.
            </p>
            <p class="text-secondary mb-0">
              If you continue, we will automatically delete the <strong>oldest backup</strong> to create space for the new one.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn me-auto" data-bs-dismiss="modal">
          <i class="ti ti-x me-1"></i>
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="proceedWithBackup()">
          <i class="ti ti-database-export me-1"></i>
          Continue & Create Backup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Restore Backup Confirmation Modal -->
<div class="modal modal-blur fade" id="confirmRestoreModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-alert-triangle text-warning me-2"></i>
          Confirm Restore
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <div class="me-3">
            <i class="ti ti-restore text-warning fs-2"></i>
          </div>
          <div>
            <p class="text-secondary mb-2">
              <strong>Warning:</strong> This will replace ALL current data with the backup data.
            </p>
            <p class="text-secondary mb-0">
              This action cannot be undone. A restore point will be created automatically.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn me-auto" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="restoreForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <button type="submit" class="btn btn-warning">
            <i class="ti ti-restore me-1"></i>
            Restore Backup
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Backup Confirmation Modal -->
<div class="modal modal-blur fade" id="confirmDeleteBackupModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-trash text-danger me-2"></i>
          Delete Backup
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <div class="me-3">
            <i class="ti ti-trash text-danger fs-2"></i>
          </div>
          <div>
            <p class="text-secondary mb-0">
              Are you sure you want to delete this backup? This action cannot be undone.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn me-auto" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="deleteForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <button type="submit" class="btn btn-danger">
            <i class="ti ti-trash me-1"></i>
            Delete Backup
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Upload & Restore Confirmation Modal -->
<div class="modal modal-blur fade" id="confirmUploadRestoreModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-alert-triangle text-warning me-2"></i>
          Confirm Upload & Restore
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('upload_and_restore_backup') }}" enctype="multipart/form-data" id="uploadRestoreForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <div class="d-flex align-items-start">
            <div class="me-3">
              <i class="ti ti-upload text-warning fs-2"></i>
            </div>
            <div>
              <p class="text-secondary mb-2">
                <strong>Warning:</strong> This will replace ALL current data with the uploaded backup.
              </p>
              <p class="text-secondary mb-0">
                This action cannot be undone. A restore point will be created automatically.
              </p>
            </div>
          </div>
          <div class="mt-3">
            <input type="file" class="form-control" id="backup_file" name="backup_file" 
                   accept=".zip" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn me-auto" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="ti ti-restore me-1"></i>
            Upload & Restore
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Organization Email Modal -->
<div class="modal fade" id="orgModal" tabindex="-1" aria-labelledby="orgModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orgModalLabel">Add Organization</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="orgForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgName" class="form-label">Organization Name</label>
                <input type="text" class="form-control" id="orgName" name="org_name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgDomain" class="form-label">Email Domain</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="orgDomain" name="org_domain" required>
                  <span class="input-group-text">@minipass.me</span>
                </div>
                <small class="form-text text-muted">e.g., 'lhgi' for lhgi@minipass.me</small>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgMailServer" class="form-label">Mail Server</label>
                <input type="text" class="form-control" id="orgMailServer" name="org_mail_server" placeholder="mail.minipass.me" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgMailPort" class="form-label">Mail Port</label>
                <input type="number" class="form-control" id="orgMailPort" name="org_mail_port" value="587" required>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgMailUsername" class="form-label">Mail Username</label>
                <input type="email" class="form-control" id="orgMailUsername" name="org_mail_username" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgMailPassword" class="form-label">Mail Password</label>
                <input type="password" class="form-control" id="orgMailPassword" name="org_mail_password" required>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="orgSenderName" class="form-label">Sender Name</label>
                <input type="text" class="form-control" id="orgSenderName" name="org_mail_sender_name" placeholder="Organization Name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="orgUseTLS" name="org_mail_use_tls" checked>
                  <label class="form-check-label" for="orgUseTLS">Use TLS</label>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveOrganization()">Save Organization</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal modal-blur fade" id="confirmEraseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('erase_app_data') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Erase</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-danger fw-bold">
            This will permanently delete all user passes, redemptions, reminders, e-bank logs, and email logs.<br>
            Are you sure you want to continue?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, erase everything</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block head %}
<!-- Admin Settings Enhanced CSS -->
<link href="{{ url_for('static', filename='css/admin-settings.css') }}" rel="stylesheet">

<!-- Settings page uses dashboard-container for consistent alignment -->
<style>
/* Import dashboard container styles if not already available */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

/* Match dashboard card styling */
.card {
  background: rgba(255, 255, 255, 0.95) !important;
  border: none !important;
  border-radius: 16px !important;
  box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.04) !important;
}

/* Settings Header Button Alignment - Force Right Alignment */
.page-header .dashboard-container > .d-flex {
  width: 100% !important;
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
}

.page-header .d-flex:last-child {
  margin-left: auto !important;
  flex-shrink: 0 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .dashboard-container {
    padding: 0 1rem;
  }
  
  /* Ensure button stays aligned on mobile */
  .page-header .dashboard-container > .d-flex {
    flex-wrap: nowrap !important;
  }
  
  .page-header .btn-success {
    white-space: nowrap;
    flex-shrink: 0;
  }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Email Settings JavaScript -->
<script src="{{ url_for('static', filename='js/email-settings.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get the stored tab from localStorage
  const storedTab = localStorage.getItem('settings-active-tab') || 'admins';
  
  // Function to show a specific tab
  function showTab(tabName) {
    // Hide all tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
      pane.classList.remove('show', 'active');
      pane.classList.add('fade');
    });
    
    // Show the selected tab
    const targetTab = document.getElementById('tab-' + tabName);
    if (targetTab) {
      targetTab.classList.remove('fade');
      targetTab.classList.add('show', 'active');
    }
    
    // Update active state in sidebar submenu
    const submenuLinks = document.querySelectorAll('#settings-submenu .nav-link');
    submenuLinks.forEach(link => {
      const linkTab = link.getAttribute('data-tab');
      if (linkTab === tabName) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  }
  
  // Make the function globally available for sidebar navigation
  window.showSettingsTab = showTab;
  
  // Show the stored tab on page load
  showTab(storedTab);
  
  // Clear localStorage after using it (so it doesn't persist across sessions)
  localStorage.removeItem('settings-active-tab');
});

// Backup management functions
function createBackup() {
  const backupCount = {{ backup_files|length if backup_files else 0 }};
  console.log('Current backup count:', backupCount);
  
  if (backupCount >= 5) {
    // Show confirmation modal
    const modal = new bootstrap.Modal(document.getElementById('backupLimitModal'));
    modal.show();
  } else {
    // Proceed directly with backup creation
    window.location.href = '{{ url_for("generate_backup") }}';
  }
}

function proceedWithBackup() {
  // Close modal and proceed with backup
  const modal = bootstrap.Modal.getInstance(document.getElementById('backupLimitModal'));
  modal.hide();
  window.location.href = '{{ url_for("generate_backup") }}';
}

function setRestoreFilename(filename) {
  document.getElementById('restoreForm').action = `/restore-backup/${filename}`;
}

function setDeleteFilename(filename) {
  document.getElementById('deleteForm').action = `/delete-backup/${filename}`;
}

function copyFileToModal() {
  const displayInput = document.getElementById('backup_file_display');
  if (!displayInput.files.length) {
    alert('Please select a backup file first.');
    return false;
  }
  // Copy the file selection to the modal's file input
  const modalInput = document.getElementById('backup_file');
  modalInput.files = displayInput.files;
  return true;
}
</script>
{% endblock %}
