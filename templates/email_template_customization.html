{% extends "base.html" %}

{% block title %}Email Template Customization - {{ activity.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/email-template-customization.css') }}">
{% endblock %}

{% block content %}
<!-- Modern Activity Header -->
<div class="page-wrapper">
  <div class="page-body">
    <div class="dashboard-container">
      <!-- Activity Context Header -->
      <div class="activity-header-clean mb-4">
        <div class="header-split-layout">
          <!-- Left Content Section -->
          <div class="content-section">
            <!-- Activity Subtitle with Badge -->
            <div class="activity-subtitle-line">
              <span class="subtitle-text">EMAIL TEMPLATES</span>
              <span class="badge-active">
                Active
                <span class="pulse-dot"></span>
              </span>
            </div>

            <!-- Activity Title -->
            <h1 class="activity-title">{{ activity.name }}</h1>
            
            <!-- Description -->
            <p class="activity-description">
              Customize the content and appearance of automated emails sent to your users.
            </p>

            <!-- Action Buttons -->
            <div class="activity-actions-modern">
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-outline-primary">
                <i class="ti ti-arrow-left me-2"></i>
                Back to Activity
              </a>
            </div>
          </div>

          <!-- Right Image Section -->
          <div class="image-section">
            <!-- Activity Avatar -->
            <div class="activity-image-modern">
              {% if activity.image %}
                <img src="{{ url_for('uploaded_file', filename=activity.image) }}" alt="{{ activity.name }}">
              {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 bg-light rounded">
                  <span class="avatar avatar-xl" style="background-color: #206bc4; color: white; font-size: 2rem;">
                    {{ activity.name[0].upper() }}
                  </span>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Information Alert -->
      <div class="alert alert-info">
        <div class="d-flex">
          <i class="ti ti-info-circle alert-icon me-3"></i>
          <div>
            <h4 class="alert-title">How it works</h4>
            <div class="text-muted">
              Customize email templates for this activity. Any field left empty will use the system default. 
              Changes apply only to this activity.
            </div>
          </div>
        </div>
      </div>

      <!-- Email Template Form -->
      <form method="POST" action="{{ url_for('save_email_templates', activity_id=activity.id) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Template Accordion Sections -->
        <div class="accordion" id="templateAccordion">
          {% for template_key, template_name in template_types.items() %}
          {% set template_data = current_templates.get(template_key, {}) %}
          <div class="accordion-item">
            <!-- Accordion Header -->
            <h2 class="accordion-header" id="heading-{{ template_key }}">
              <button class="accordion-button{% if not loop.first %} collapsed{% endif %}" 
                      type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#collapse-{{ template_key }}" 
                      aria-expanded="{{ 'true' if loop.first else 'false' }}" 
                      aria-controls="collapse-{{ template_key }}">
                <i class="ti ti-mail me-2"></i>
                <strong>{{ template_name }}</strong>
                <small class="ms-2 text-muted">
                  {% if template_data.get('subject') %}
                    (Customized)
                  {% else %}
                    (Using default)
                  {% endif %}
                </small>
              </button>
            </h2>
            
            <!-- Accordion Content -->
            <div id="collapse-{{ template_key }}" 
                 class="accordion-collapse collapse{% if loop.first %} show{% endif %}" 
                 aria-labelledby="heading-{{ template_key }}" 
                 data-bs-parent="#templateAccordion">
              <div class="accordion-body">
                <div class="row">
                  <!-- Form Fields Column -->
                  <div class="col-lg-8">
                    <div class="mb-4">
                      <h5 class="text-muted mb-3">{{ template_name }} Settings</h5>
                                            
                      <!-- Email Subject -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_subject" class="form-label">Email Subject</label>
                        <input type="text" 
                               name="{{ template_key }}_subject" 
                               id="{{ template_key }}_subject"
                               class="form-control" 
                               value="{{ template_data.get('subject', '') }}"
                               placeholder="Leave empty to use system default">
                      </div>
                      
                      <!-- Email Title -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_title" class="form-label">Email Title</label>
                        <input type="text" 
                               name="{{ template_key }}_title" 
                               id="{{ template_key }}_title"
                               class="form-control" 
                               value="{{ template_data.get('title', '') }}"
                               placeholder="Main heading shown in the email">
                      </div>
                      
                      <!-- Introduction Text -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_intro_text" class="form-label">Introduction Text</label>
                        <textarea name="{{ template_key }}_intro_text" 
                                  id="{{ template_key }}_intro_text"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Opening message for the email">{{ template_data.get('intro_text', '') }}</textarea>
                      </div>
                                            
                      <!-- Activity Logo -->
                      <div class="mb-3">
                        <label class="form-label">Activity Logo</label>
                        <div class="row align-items-center">
                          <div class="col-md-8">
                            <div class="d-flex align-items-center gap-2">
                              <div class="current-logo-preview" id="logo-preview-{{ template_key }}">
                                <img src="{% if activity.logo_filename %}{{ url_for('static', filename='uploads/logos/' + activity.logo_filename) }}{% else %}{{ url_for('static', filename='uploads/logo.png') }}{% endif %}" 
                                     alt="Current logo" 
                                     style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;">
                              </div>
                              <div class="flex-fill">
                                <input type="file" 
                                       class="form-control logo-upload" 
                                       data-activity-id="{{ activity.id }}"
                                       data-template-key="{{ template_key }}"
                                       accept="image/*">
                                <small class="form-hint">Upload a logo specific to this activity (PNG, JPG, GIF)</small>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-4 text-end">
                            {% if activity.logo_filename %}
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger delete-logo-btn"
                                    data-activity-id="{{ activity.id }}"
                                    data-template-key="{{ template_key }}">
                              <i class="ti ti-trash me-1"></i>Reset to Default
                            </button>
                            {% else %}
                            <small class="text-muted">Using default logo</small>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <!-- Hero Image -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_hero_image" class="form-label">Hero Image</label>
                        <input type="file" 
                               name="{{ template_key }}_hero_image" 
                               id="{{ template_key }}_hero_image"
                               class="form-control" 
                               accept="image/*">
                        <small class="form-hint">Upload a banner image for this email type (optional)</small>
                        {% if template_data.get('hero_image') %}
                        <div class="mt-2 p-2 border rounded">
                          <img src="/static/uploads/email_heroes/{{ template_data.get('hero_image') }}" 
                               alt="Current hero image" 
                               style="max-width: 200px; height: auto; border-radius: 4px;">
                          <p class="text-muted small mt-1">Current hero image</p>
                          <div class="form-check">
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   name="{{ template_key }}_delete_hero" 
                                   id="{{ template_key }}_delete_hero">
                            <label class="form-check-label text-danger" for="{{ template_key }}_delete_hero">
                              <i class="ti ti-trash me-1"></i>Delete this image
                            </label>
                          </div>
                        </div>
                        {% endif %}
                      </div>
                                            
                      <!-- Call-to-Action Section -->
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="{{ template_key }}_cta_text" class="form-label">Call-to-Action Text</label>
                          <input type="text" 
                                 name="{{ template_key }}_cta_text" 
                                 id="{{ template_key }}_cta_text"
                                 class="form-control" 
                                 value="{{ template_data.get('cta_text', '') }}"
                                 placeholder="e.g., View Dashboard">
                        </div>
                        <div class="col-md-6">
                          <label for="{{ template_key }}_cta_url" class="form-label">Call-to-Action URL</label>
                          <input type="url" 
                                 name="{{ template_key }}_cta_url" 
                                 id="{{ template_key }}_cta_url"
                                 class="form-control" 
                                 value="{{ template_data.get('cta_url', '') }}"
                                 placeholder="https://your-website.com/dashboard">
                        </div>
                      </div>
                                            
                      <!-- Custom Message -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_custom_message" class="form-label">Custom Message</label>
                        <textarea name="{{ template_key }}_custom_message" 
                                  id="{{ template_key }}_custom_message"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Additional message or special instructions">{{ template_data.get('custom_message', '') }}</textarea>
                      </div>
                      
                      <!-- Conclusion Text -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_conclusion_text" class="form-label">Conclusion Text</label>
                        <textarea name="{{ template_key }}_conclusion_text" 
                                  id="{{ template_key }}_conclusion_text"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Closing message for the email">{{ template_data.get('conclusion_text', '') }}</textarea>
                      </div>
                    </div>
                  </div>
                                        
                  <!-- Preview Actions Column -->
                  <div class="col-lg-4">
                    <div class="card">
                      <div class="card-header">
                        <h4 class="card-title mb-0">
                          <i class="ti ti-eye me-2"></i>
                          Preview & Test
                        </h4>
                      </div>
                      <div class="card-body">
                        <div class="d-grid gap-2">
                          <!-- Preview Modal Button -->
                          <button type="button" 
                                  class="btn btn-outline-primary"
                                  data-bs-toggle="modal" 
                                  data-bs-target="#previewModal"
                                  data-template-type="{{ template_key }}"
                                  data-template-name="{{ template_name }}"
                                  data-activity-id="{{ activity.id }}">
                            <i class="ti ti-eye me-2"></i>
                            Preview Template
                          </button>
                          
                          <!-- Test Email Button -->
                          <button type="button" 
                                  onclick="document.getElementById('test-email-form-{{ template_key }}').submit();"
                                  class="btn btn-success">
                            <i class="ti ti-mail me-2"></i>
                            Send Test Email
                          </button>
                        </div>
                        
                        <!-- Template Status Info -->
                        <div class="mt-3">
                          <div class="small text-muted">
                            <div class="d-flex align-items-center mb-1">
                              <i class="ti ti-info-circle me-2"></i>
                              Template Status:
                            </div>
                            {% if template_data.get('subject') or template_data.get('title') or template_data.get('intro_text') %}
                              <span class="badge bg-blue-lt">Customized</span>
                            {% else %}
                              <span class="badge bg-secondary-lt">Using Default</span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
                        
        </div>
        
        <!-- Save Actions -->
        <div class="card mt-4">
          <div class="card-footer">
            <div class="d-flex">
              <button type="submit" class="btn btn-primary">
                <i class="ti ti-device-floppy me-2"></i>
                Save All Templates
              </button>
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" 
                 class="btn btn-outline-secondary ms-auto">
                <i class="ti ti-x me-2"></i>
                Cancel
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden forms for test email buttons (outside main form to prevent conflicts) -->
{% for template_key in template_types %}
<form id="test-email-form-{{ template_key }}" 
      method="POST" 
      action="{{ url_for('test_email_template', activity_id=activity.id) }}" 
      style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="template_type" value="{{ template_key }}">
</form>
{% endfor %}

<!-- Email Preview Modal -->
<div class="modal modal-lg fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="ti ti-eye me-2"></i>
          Email Template Preview
        </h5>
        <div class="ms-auto d-flex align-items-center me-3">
          <!-- Device Toggle Buttons -->
          <div class="btn-group" role="group" aria-label="Device preview toggle">
            <button type="button" class="btn btn-sm btn-outline-primary active" id="desktopView" data-device="desktop">
              <i class="ti ti-device-desktop me-1"></i>
              Desktop
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="mobileView" data-device="mobile">
              <i class="ti ti-device-mobile me-1"></i>
              Mobile
            </button>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-0">
        <!-- Preview Container -->
        <div class="preview-container d-flex justify-content-center align-items-start" style="min-height: 600px; background-color: #f8f9fa;">
          <div class="iframe-wrapper" id="previewWrapper">
            <iframe id="previewIframe" 
                    src="" 
                    frameborder="0" 
                    style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white;"
                    title="Email template preview">
            </iframe>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <!-- Template Type Navigation -->
        <div class="me-auto">
          <div class="btn-group" role="group" aria-label="Template type navigation">
            {% for temp_key, temp_name in template_types.items() %}
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary template-nav-btn{% if loop.first %} active{% endif %}" 
                    data-template-type="{{ temp_key }}"
                    data-template-name="{{ temp_name }}">
              {{ temp_name }}
            </button>
            {% endfor %}
          </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-success" id="openInNewTab">
            <i class="ti ti-external-link me-2"></i>
            Open in New Tab
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles for Activity Header -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">

<!-- Email Template Editor Script -->
<script src="{{ url_for('static', filename='js/email-template-editor.js') }}"></script>

<script>
// Enhanced accordion functionality
document.addEventListener('DOMContentLoaded', function() {
    const templateTypes = {{ template_types.keys() | list | tojson }};
    const activityId = {{ activity.id }};
    
    // Initialize accordion collapse/expand icons
    templateTypes.forEach(templateType => {
        const collapseElement = document.getElementById(`collapse-${templateType}`);
        const accordionButton = document.querySelector(`[data-bs-target="#collapse-${templateType}"] i.ti-mail`);
        
        if (collapseElement && accordionButton) {
            collapseElement.addEventListener('show.bs.collapse', function () {
                // Could add visual feedback here
            });
            
            collapseElement.addEventListener('hide.bs.collapse', function () {
                // Could add visual feedback here
            });
        }
    });
    
    // Preview Modal Functionality
    const previewModal = document.getElementById('previewModal');
    const previewIframe = document.getElementById('previewIframe');
    const previewWrapper = document.getElementById('previewWrapper');
    const desktopViewBtn = document.getElementById('desktopView');
    const mobileViewBtn = document.getElementById('mobileView');
    const openInNewTabBtn = document.getElementById('openInNewTab');
    const templateNavButtons = document.querySelectorAll('.template-nav-btn');
    const modalTitle = document.getElementById('previewModalLabel');
    
    let currentTemplateType = '';
    let currentTemplateName = '';
    
    // Function to update preview URL
    function updatePreview(templateType, templateName) {
        const previewUrl = `/activity/${activityId}/email-preview?type=${templateType}`;
        previewIframe.src = previewUrl;
        modalTitle.innerHTML = `<i class="ti ti-eye me-2"></i>Email Template Preview - ${templateName}`;
        currentTemplateType = templateType;
        currentTemplateName = templateName;
        
        // Update template navigation active state
        templateNavButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.templateType === templateType) {
                btn.classList.add('active');
            }
        });
    }
    
    // Handle modal open from preview buttons
    document.querySelectorAll('[data-bs-target="#previewModal"]').forEach(button => {
        button.addEventListener('click', function() {
            const templateType = this.dataset.templateType;
            const templateName = this.dataset.templateName;
            updatePreview(templateType, templateName);
        });
    });
    
    // Device view toggle functionality
    desktopViewBtn.addEventListener('click', function() {
        previewWrapper.className = 'iframe-wrapper desktop';
        desktopViewBtn.classList.add('active');
        mobileViewBtn.classList.remove('active');
    });
    
    mobileViewBtn.addEventListener('click', function() {
        previewWrapper.className = 'iframe-wrapper mobile';
        mobileViewBtn.classList.add('active');
        desktopViewBtn.classList.remove('active');
    });
    
    // Template type navigation
    templateNavButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateType = this.dataset.templateType;
            const templateName = this.dataset.templateName;
            updatePreview(templateType, templateName);
        });
    });
    
    // Open in new tab functionality
    openInNewTabBtn.addEventListener('click', function() {
        if (currentTemplateType) {
            const newTabUrl = `/activity/${activityId}/email-preview?type=${currentTemplateType}`;
            window.open(newTabUrl, '_blank');
        }
    });
    
    // Initialize desktop view as default
    previewWrapper.className = 'iframe-wrapper desktop';
    
    // Auto-save draft functionality (minimal localStorage implementation)
    let autoSaveTimeout;
    function autoSaveDraft() {
        const formData = new FormData(document.querySelector('form'));
        const draftData = {};
        for (let [key, value] of formData.entries()) {
            if (key.includes('_intro_text') || key.includes('_custom_message') || key.includes('_conclusion_text')) {
                draftData[key] = value;
            }
        }
        localStorage.setItem('email_template_draft_' + activityId, JSON.stringify(draftData));
    }
    
    // Load saved draft on page load
    const savedDraft = localStorage.getItem('email_template_draft_' + activityId);
    if (savedDraft) {
        try {
            const draftData = JSON.parse(savedDraft);
            Object.keys(draftData).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field && !field.value) {
                    field.value = draftData[key];
                }
            });
        } catch (e) {
            console.log('Draft load error:', e);
        }
    }
    
    // Auto-save on input changes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('tinymce')) {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveDraft, 2000);
        }
    });
    
    // Clear draft on form submit
    document.querySelector('form').addEventListener('submit', function() {
        localStorage.removeItem('email_template_draft_' + activityId);
    });
    
    // Logo Upload Functionality
    function handleLogoUpload() {
        document.querySelectorAll('.logo-upload').forEach(fileInput => {
            fileInput.addEventListener('change', function() {
                const activityId = this.dataset.activityId;
                const templateKey = this.dataset.templateKey;
                const file = this.files[0];
                
                if (!file) return;
                
                // Validate file type
                const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Please select a valid image file (PNG, JPG, JPEG, or GIF)');
                    this.value = '';
                    return;
                }
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File too large. Maximum size is 5MB.');
                    this.value = '';
                    return;
                }
                
                // Create FormData and upload
                const formData = new FormData();
                formData.append('logo_file', file);
                
                // Show loading state
                const preview = document.getElementById(`logo-preview-${templateKey}`);
                const originalImg = preview.querySelector('img');
                const loadingHtml = `<div class="d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border: 1px solid #dee2e6; border-radius: 6px; background: #f8f9fa;"><div class="spinner-border spinner-border-sm" role="status"></div></div>`;
                preview.innerHTML = loadingHtml;
                
                fetch(`/activity/${activityId}/upload-logo`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update logo preview for all template sections
                        document.querySelectorAll('[id^="logo-preview-"]').forEach(previewEl => {
                            previewEl.innerHTML = `<img src="${data.logo_url}?${Date.now()}" alt="Current logo" style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;">`;
                        });
                        
                        // Update delete buttons
                        document.querySelectorAll('.delete-logo-btn').forEach(btn => {
                            btn.style.display = 'inline-block';
                            const parent = btn.closest('.col-md-4');
                            const defaultText = parent.querySelector('.text-muted');
                            if (defaultText) defaultText.style.display = 'none';
                        });
                        
                        // Show success message
                        showNotification('Logo uploaded successfully!', 'success');
                    } else {
                        // Restore original image on error
                        preview.innerHTML = originalImg.outerHTML;
                        showNotification(data.error || 'Upload failed', 'error');
                    }
                })
                .catch(error => {
                    // Restore original image on error
                    preview.innerHTML = originalImg.outerHTML;
                    showNotification('Upload failed: ' + error.message, 'error');
                });
                
                // Clear file input
                this.value = '';
            });
        });
    }
    
    // Logo Delete Functionality
    function handleLogoDelete() {
        document.querySelectorAll('.delete-logo-btn').forEach(deleteBtn => {
            deleteBtn.addEventListener('click', function() {
                const activityId = this.dataset.activityId;
                const templateKey = this.dataset.templateKey;
                
                if (!confirm('Are you sure you want to reset to the default logo?')) {
                    return;
                }
                
                fetch(`/activity/${activityId}/delete-logo`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update logo preview for all template sections
                        document.querySelectorAll('[id^="logo-preview-"]').forEach(previewEl => {
                            previewEl.innerHTML = `<img src="${data.logo_url}?${Date.now()}" alt="Current logo" style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;">`;
                        });
                        
                        // Hide delete buttons and show default text
                        document.querySelectorAll('.delete-logo-btn').forEach(btn => {
                            btn.style.display = 'none';
                            const parent = btn.closest('.col-md-4');
                            const defaultText = parent.querySelector('.text-muted');
                            if (!defaultText) {
                                const newDefaultText = document.createElement('small');
                                newDefaultText.className = 'text-muted';
                                newDefaultText.textContent = 'Using default logo';
                                parent.appendChild(newDefaultText);
                            } else {
                                defaultText.style.display = 'inline';
                            }
                        });
                        
                        showNotification('Logo reset to default!', 'success');
                    } else {
                        showNotification(data.error || 'Delete failed', 'error');
                    }
                })
                .catch(error => {
                    showNotification('Delete failed: ' + error.message, 'error');
                });
            });
        });
    }
    
    // Notification helper
    function showNotification(message, type = 'info') {
        // Simple notification - in production you might want to use a toast library
        const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Initialize logo upload and delete handlers
    handleLogoUpload();
    handleLogoDelete();
});
</script>

<style>
/* Mobile-first responsive improvements */
@media (max-width: 767.98px) {
  .header-split-layout {
    flex-direction: column;
  }
  
  .image-section {
    margin-top: 1.5rem;
  }
  
  .activity-image-modern {
    height: 200px;
  }
  
  .accordion-body .row {
    flex-direction: column;
  }
  
  .accordion-body .col-lg-4 {
    margin-top: 1rem;
  }
}

/* Accordion customization */
.accordion-button:not(.collapsed) {
  background-color: #f8f9fa;
  box-shadow: none;
}

.accordion-button:focus {
  box-shadow: none;
  border-color: rgba(98, 105, 118, 0.16);
}

.accordion-item {
  margin-bottom: 0.75rem;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 0.5rem;
}

.accordion-item:last-child .accordion-button.collapsed {
  border-bottom-right-radius: 0.375rem;
  border-bottom-left-radius: 0.375rem;
}

/* Activity header adjustments */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

.activity-header-clean {
  background: #ffffff;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.activity-header-clean::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #206bc4 0%, #ed2988 100%);
}

/* Preview Modal Styles */
.preview-container {
  padding: 2rem;
  transition: all 0.3s ease;
}

.iframe-wrapper {
  transition: all 0.3s ease;
  max-width: 100%;
}

/* Desktop View (Default) */
.iframe-wrapper.desktop {
  width: 100%;
}

/* Mobile View */
.iframe-wrapper.mobile {
  width: 375px;
  max-width: 100%;
}

/* Device toggle button states */
.btn-group .btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Template navigation button states */
.template-nav-btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Mobile responsive modal */
@media (max-width: 767.98px) {
  .modal-xl {
    max-width: 95%;
  }
  
  .preview-container {
    padding: 1rem;
  }
  
  .iframe-wrapper {
    width: 100% !important;
  }
  
  .modal-header .btn-group {
    display: none;
  }
  
  .modal-footer .btn-group {
    flex-wrap: wrap;
  }
  
  .modal-footer .btn-group .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}
</style>
{% endblock %}