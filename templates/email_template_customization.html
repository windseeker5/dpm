{% extends "base.html" %}

{% block title %}Email Template Customization - {{ activity.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/email-template-customization.css') }}">
{% endblock %}

{% block content %}
<!-- Modern Activity Header -->
<div class="page-wrapper">
  <div class="page-body">
    <div class="dashboard-container">
      <!-- Clean Activity Header Card -->
      <div class="card activity-header-card">
        <div class="card-body">
          <!-- Header Top Section -->
          <div class="activity-header-top">
            <!-- Activity Picture -->
            <img src="{{ url_for('static', filename='uploads/activity_images/' ~ (activity.image_filename or 'placeholder.jpg')) }}" 
                 alt="{{ activity.name }}"
                 class="activity-image">
            
            <!-- Title and Description -->
            <div class="activity-info">
              <div class="activity-title-row">
                <h2 class="activity-title">{{ activity.name }}</h2>
                <span class="badge bg-success">
                  Active
                  <span class="badge-pulse"></span>
                </span>
              </div>
              <p class="activity-description text-muted">
                Email Templates - Customize the content and appearance of automated emails sent to your users.
              </p>
            </div>
            
            <!-- Right Section: Back Button -->
            <div class="activity-header-right">
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-outline-primary btn-sm">
                <i class="ti ti-arrow-left me-2"></i>
                Back to Activity
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Professional Title Section -->
      <div class="page-title-section mb-4">
        <h2 class="page-title">Email Communication Builder</h2>
        <p class="text-muted">Customize automated emails for {{ activity.name }}</p>
      </div>

      <!-- Simplified Email Templates Grid - OUTSIDE form to prevent unwanted submissions -->
      <div class="email-templates-grid" id="templateCardsGrid">
          {% for template_key, template_name in template_types.items() %}
          {% set template_data = current_templates.get(template_key, {}) %}
          {% set is_customized = template_data.get('subject') or template_data.get('title') or template_data.get('intro_text') or template_data.get('conclusion_text') or template_data.get('hero_image') or template_data.get('activity_logo') %}
          
          <div class="template-item" data-template="{{ template_key }}">
            <img src="{{ url_for('static', filename='uploads/email_thumbnails/' + activity.id|string + '_' + template_key + '.jpg') }}" 
                 alt="{{ template_name }}" 
                 class="template-preview"
                 onerror="this.src='{{ url_for('static', filename='uploads/email_template_previews/' + template_key + '.svg') }}';">
            
            <div class="template-overlay">
              <button type="button" class="action-btn customize-btn" 
                      data-action="customize" 
                      data-template="{{ template_key }}"
                      data-template-name="{{ template_name }}"
                      data-bs-toggle="modal" 
                      data-bs-target="#customizeModal"
                      title="Customize">
                <i class="ti ti-edit"></i>
              </button>
              
              <button type="button" class="action-btn preview-btn" 
                      data-action="preview" 
                      data-template="{{ template_key }}"
                      data-template-name="{{ template_name }}"
                      data-bs-toggle="modal" 
                      data-bs-target="#previewModal"
                      data-template-type="{{ template_key }}"
                      title="Preview">
                <i class="ti ti-eye"></i>
              </button>
              
              <button type="button" class="action-btn test-btn" 
                      data-action="test" 
                      data-template="{{ template_key }}"
                      onclick="document.getElementById('test-email-form-{{ template_key }}').submit();"
                      title="Send Test">
                <i class="ti ti-mail"></i>
              </button>
              
              <button type="button" class="action-btn reset-btn" 
                      data-action="reset" 
                      data-template="{{ template_key }}"
                      data-template-name="{{ template_name }}"
                      data-bs-toggle="modal" 
                      data-bs-target="#resetConfirmModal"
                      title="Reset to Default">
                <i class="ti ti-refresh"></i>
              </button>
            </div>
            
            <div class="template-name">{{ template_name }}</div>
            {% if is_customized %}
            <div class="template-status customized">Custom</div>
            {% else %}
            <div class="template-status default">Default</div>
            {% endif %}
          </div>
          {% endfor %}
      </div>
      
      <!-- Email Template Form - Only for saving -->
      <form method="POST" action="{{ url_for('save_email_templates', activity_id=activity.id) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Save Actions -->
        <div class="card mt-4">
          <div class="card-footer">
            <div class="d-flex">
              <button type="submit" class="btn btn-primary">
                <i class="ti ti-device-floppy me-2"></i>
                Save All Templates
              </button>
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" 
                 class="btn btn-outline-secondary ms-auto">
                <i class="ti ti-x me-2"></i>
                Cancel
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden forms for test email buttons (outside main form to prevent conflicts) -->
{% for template_key in template_types %}
<form id="test-email-form-{{ template_key }}" 
      method="POST" 
      action="{{ url_for('test_email_template', activity_id=activity.id) }}" 
      style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="template_type" value="{{ template_key }}">
</form>
{% endfor %}

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resetConfirmModalLabel">
          <i class="ti ti-refresh me-2"></i>
          Reset Template to Default
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start mb-4">
          <div class="avatar bg-warning-lt me-3 flex-shrink-0">
            <i class="ti ti-refresh"></i>
          </div>
          <div class="flex-grow-1">
            <h4 class="mb-2">Reset <span id="resetTemplateName" class="text-primary"></span> to Default?</h4>
            <p class="text-muted mb-0">This action will clear all custom values and revert this template to system defaults.</p>
          </div>
        </div>
        
        <div class="alert alert-warning border-warning">
          <div class="d-flex align-items-start">
            <i class="ti ti-info-circle me-2 mt-1 flex-shrink-0"></i>
            <div>
              <strong class="d-block mb-2">The following will be reset:</strong>
              <div class="row g-2">
                <div class="col-12 col-sm-6">
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Email subject line</small>
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Email title</small>
                </div>
                <div class="col-12 col-sm-6">
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Introduction text</small>
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Conclusion text</small>
                </div>
              </div>
              <div class="mt-2 pt-2 border-top border-warning">
                <small class="text-muted d-block"><i class="ti ti-clock me-1"></i>Changes take effect immediately and cannot be undone.</small>
                <small class="text-muted"><i class="ti ti-shield-check me-1"></i>Template will use professional system defaults.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="ti ti-x me-2"></i>
          Keep Current Settings
        </button>
        <button type="button" class="btn btn-warning" id="confirmResetBtn">
          <i class="ti ti-refresh me-2"></i>
          Reset to Default
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Email Preview Modal -->
<div class="modal modal-lg fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="ti ti-eye me-2"></i>
          Email Template Preview
        </h5>
        <div class="ms-auto d-flex align-items-center me-3">
          <!-- Device Toggle Buttons -->
          <div class="btn-group" role="group" aria-label="Device preview toggle">
            <button type="button" class="btn btn-sm btn-outline-primary active" id="desktopView" data-device="desktop">
              <i class="ti ti-device-desktop me-1"></i>
              Desktop
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="mobileView" data-device="mobile">
              <i class="ti ti-device-mobile me-1"></i>
              Mobile
            </button>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-0">
        <!-- Preview Container -->
        <div class="preview-container d-flex justify-content-center align-items-start" style="min-height: 600px; background-color: #f8f9fa;">
          <div class="iframe-wrapper" id="previewWrapper">
            <iframe id="previewIframe" 
                    src="" 
                    frameborder="0" 
                    style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white;"
                    title="Email template preview">
            </iframe>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <!-- Template Type Navigation -->
        <div class="me-auto">
          <div class="btn-group" role="group" aria-label="Template type navigation">
            {% for temp_key, temp_name in template_types.items() %}
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary template-nav-btn{% if loop.first %} active{% endif %}" 
                    data-template-type="{{ temp_key }}"
                    data-template-name="{{ temp_name }}">
              {{ temp_name }}
            </button>
            {% endfor %}
          </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-success" id="openInNewTab">
            <i class="ti ti-external-link me-2"></i>
            Open in New Tab
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW CENTERED EMAIL TEMPLATE MODAL -->
<div class="modal fade" id="customizeModal" tabindex="-1" aria-labelledby="customizeModalLabel" aria-hidden="true" style="backdrop-filter: blur(4px);">
  <div class="modal-dialog modal-xl" style="margin: 2rem auto !important; max-width: 90vw !important; display: flex !important; align-items: center !important; min-height: calc(100vh - 4rem) !important;">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="customizeModalLabel">
          <i class="ti ti-edit me-2"></i>
          Customize Email Template
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body" style="padding: 2rem 3rem;">
        <div id="customizeFormContent">
          <!-- Form content will be loaded here dynamically -->
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <div class="d-flex w-100 justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="ti ti-x me-2"></i>
            Cancel
          </button>
          <div>
            <button type="button" class="btn btn-outline-primary me-2" id="previewInModal">
              <i class="ti ti-eye me-2"></i>
              Preview Changes
            </button>
            <button type="button" class="btn btn-primary" id="saveTemplateChanges">
              <i class="ti ti-device-floppy me-2"></i>
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden Template Form Fields (for dynamic loading) -->
<div id="templateFormTemplates" style="display: none;">
  {% for template_key, template_name in template_types.items() %}
  {% set template_data = current_templates.get(template_key, {}) %}
  <div id="form-template-{{ template_key }}">
    <div class="template-form-section" data-template="{{ template_key }}">
      <div class="alert alert-info mb-4">
        <div class="d-flex align-items-start">
          <i class="ti ti-info-circle me-2 mt-1"></i>
          <div>
            <h6 class="mb-2">Customizing {{ template_name }}</h6>
            <p class="mb-0 small">Leave fields empty to use professional system defaults. All changes are saved automatically.</p>
          </div>
        </div>
      </div>
      
      <!-- Email Subject -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_subject" class="form-label">Email Subject</label>
        <input type="text" 
               name="{{ template_key }}_subject" 
               id="modal_{{ template_key }}_subject"
               class="form-control" 
               value="{{ template_data.get('subject', '') }}"
               placeholder="Leave empty to use system default">
      </div>
      
      <!-- Email Title -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_title" class="form-label">Email Title</label>
        <input type="text" 
               name="{{ template_key }}_title" 
               id="modal_{{ template_key }}_title"
               class="form-control" 
               value="{{ template_data.get('title', '') }}"
               placeholder="Main heading shown in the email">
      </div>
      
      <!-- Introduction Text -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_intro_text" class="form-label">Introduction Text</label>
        <textarea name="{{ template_key }}_intro_text" 
                  id="modal_{{ template_key }}_intro_text"
                  class="form-control template-textarea" 
                  rows="5"
                  placeholder="Opening message for the email">{{ template_data.get('intro_text', '') }}</textarea>
      </div>
      
      <!-- Conclusion Text -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_conclusion_text" class="form-label">Conclusion Text</label>
        <textarea name="{{ template_key }}_conclusion_text" 
                  id="modal_{{ template_key }}_conclusion_text"
                  class="form-control template-textarea" 
                  rows="5"
                  placeholder="Closing message for the email">{{ template_data.get('conclusion_text', '') }}</textarea>
      </div>
      
      <!-- Global Settings (only show for first template) -->
      {% if loop.first %}
      <hr class="my-4">
      <h6 class="mb-3">Global Email Settings</h6>
      <p class="text-muted small mb-3">These settings apply to all email templates for this activity.</p>
      
      <!-- Hero Image -->
      <div class="mb-3">
        <label class="form-label">Hero Image</label>
        <div class="d-flex align-items-center gap-2">
          <div class="current-image-preview" id="modal-hero-preview-{{ template_key }}">
            {% set hero_filename = activity.id|string + '_hero.png' %}
            <img id="modal-hero-img-preview" 
                 src="{{ url_for('static', filename='uploads/' + hero_filename) }}" 
                 alt="Current hero image" 
                 style="width: 100px; height: 60px; object-fit: cover; border: 1px solid #dee2e6; border-radius: 6px; background: white;"
                 onerror="this.src='{{ url_for('static', filename='uploads/defaults/default_hero.png') }}'; this.style.backgroundColor='#f8f9fa';">
          </div>
          <div class="flex-fill">
            <input type="file" 
                   name="modal_{{ template_key }}_hero_image" 
                   id="modal_{{ template_key }}_hero_image"
                   class="form-control" 
                   accept="image/*"
                   onchange="previewImage(this, 'modal-hero-img-preview')">
            <small class="form-hint d-block">Banner image shown at top of email (replaces ticket icon)</small>
          </div>
        </div>
      </div>
      
      <!-- Owner Card Logo -->
      <div class="mb-3">
        <label class="form-label">Owner Card Logo</label>
        <div class="d-flex align-items-center gap-2">
          <div class="current-logo-preview" id="modal-owner-logo-preview-{{ template_key }}">
            {% set owner_logo_filename = activity.id|string + '_owner_logo.png' %}
            <img id="modal-owner-img-preview" 
                 src="{{ url_for('static', filename='uploads/' + owner_logo_filename) }}" 
                 alt="Current owner logo" 
                 style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;"
                 onerror="this.src='{{ url_for('static', filename='uploads/flhgi.png') }}';">
          </div>
          <div class="flex-fill">
            <input type="file" 
                   name="modal_{{ template_key }}_owner_logo" 
                   id="modal_{{ template_key }}_owner_logo"
                   class="form-control" 
                   accept="image/*"
                   onchange="previewImage(this, 'modal-owner-img-preview')">
            <small class="form-hint d-block">Logo shown in organization card at bottom of email</small>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Custom Styles for Activity Header -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">

<!-- Email Template Editor Script -->
<script src="{{ url_for('static', filename='js/email-template-editor.js') }}"></script>

<script>
// Fixed Email Template Interface
document.addEventListener('DOMContentLoaded', function() {
    console.log('Fixed email template interface loaded');
    
    // Handle customize button clicks
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;
        
        const template = btn.dataset.template;
        const templateName = btn.dataset.templateName;
        
        if (btn.classList.contains('customize-btn')) {
            console.log('Customize:', template, templateName);
            // Load customize form content dynamically
            const formContent = document.getElementById(`form-template-${template}`);
            if (formContent) {
                document.getElementById('customizeFormContent').innerHTML = formContent.innerHTML;
                
                // Add tinymce class to textareas that should be rich text editors
                document.querySelectorAll('#customizeModal .template-textarea').forEach(textarea => {
                    textarea.classList.add('tinymce');
                });
                
                // Initialize TinyMCE for textareas ONLY in the modal
                setTimeout(() => {
                    if (typeof tinymce !== 'undefined') {
                        tinymce.remove('textarea.tinymce');
                        tinymce.init({
                            selector: '#customizeModal textarea.tinymce',
                            height: 200,
                            menubar: false,
                            plugins: 'lists link',
                            toolbar: 'bold italic | bullist numlist | link'
                        });
                    }
                }, 100);
            }
        } else if (btn.classList.contains('preview-btn')) {
            console.log('Preview:', template, templateName);
            // Update preview iframe URL
            const iframe = document.getElementById('previewIframe');
            if (iframe) {
                iframe.src = `/activity/{{ activity.id }}/email-preview?type=${template}`;
            }
        } else if (btn.classList.contains('reset-btn')) {
            console.log('Reset:', template, templateName);
            // Update reset modal content
            document.getElementById('resetTemplateName').textContent = templateName;
            document.getElementById('confirmResetBtn').dataset.template = template;
        }
    });
    
    // Handle reset confirmation
    document.addEventListener('click', function(e) {
        if (e.target.id === 'confirmResetBtn') {
            const template = e.target.dataset.template;
            // Send reset request
            fetch(`/activity/{{ activity.id }}/email-templates/reset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({template_type: template})
            }).then(() => {
                location.reload();
            });
        }
    });
    
    // Basic image preview for modals
    window.previewImage = (input, previewId) => {
        const file = input.files?.[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById(previewId);
                if (img) img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    };
});
</script>

<style>
/* Accordion header action buttons */
.header-actions {
  flex-shrink: 0;
}

.header-actions .btn-icon {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.header-actions .btn-group {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border-radius: 6px;
}

/* Prevent accordion toggle on action button clicks */
.header-actions button {
  pointer-events: auto;
}

.accordion-button {
  padding-right: 0;
}

/* Mobile-first responsive improvements */
@media (max-width: 767.98px) {
  .header-split-layout {
    flex-direction: column;
  }
  
  .image-section {
    margin-top: 1.5rem;
  }
  
  .activity-image-modern {
    height: 200px;
  }
  
  .accordion-body .row {
    flex-direction: column;
  }
  
  .accordion-body .col-lg-4 {
    margin-top: 1rem;
  }
  
  /* Hide action button text on mobile, keep icons */
  .header-actions .btn-group {
    gap: 2px;
  }
  
  .header-actions .btn-icon {
    width: 28px;
    height: 28px;
    font-size: 14px;
  }
}

/* Accordion customization */
.accordion-button:not(.collapsed) {
  background-color: #f8f9fa;
  box-shadow: none;
}

.accordion-button:focus {
  box-shadow: none;
  border-color: rgba(98, 105, 118, 0.16);
}

.accordion-item {
  margin-bottom: 0.75rem;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 0.5rem;
}

.accordion-item:last-child .accordion-button.collapsed {
  border-bottom-right-radius: 0.375rem;
  border-bottom-left-radius: 0.375rem;
}

/* Activity header adjustments */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

.activity-header-clean {
  background: #ffffff;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.activity-header-clean::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #206bc4 0%, #ed2988 100%);
}

/* Preview Modal Styles */
.preview-container {
  padding: 2rem;
  transition: all 0.3s ease;
}

.iframe-wrapper {
  transition: all 0.3s ease;
  max-width: 100%;
}

/* Desktop View (Default) */
.iframe-wrapper.desktop {
  width: 100%;
}

/* Mobile View */
.iframe-wrapper.mobile {
  width: 375px;
  max-width: 100%;
}

/* Device toggle button states */
.btn-group .btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Template navigation button states */
.template-nav-btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Mobile responsive modal */
@media (max-width: 767.98px) {
  .modal-xl {
    max-width: 95%;
  }
  
  .preview-container {
    padding: 1rem;
  }
  
  .iframe-wrapper {
    width: 100% !important;
  }
  
  .modal-header .btn-group {
    display: none;
  }
  
  .modal-footer .btn-group {
    flex-wrap: wrap;
  }
  
  .modal-footer .btn-group .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}
</style>

{% endblock %}