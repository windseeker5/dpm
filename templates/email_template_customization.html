{% extends "base.html" %}

{% block title %}Email Template Customization - {{ activity.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/email-template-customization.css') }}">
{% endblock %}

{% block content %}

<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <div class="row align-items-center">
        <div class="col">
          <h2 class="page-title mb-1" style="font-size: 1.75rem; font-weight: 600;">
            <i class="ti ti-mail text-blue me-2"></i>Email Templates
          </h2>
          <p class="text-muted mb-0" style="font-size: 0.95rem;">{{ activity.name }}</p>
        </div>
        <div class="col-auto">
          <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-outline-primary">
            <i class="ti ti-arrow-left me-2 d-none d-md-inline"></i>
            <span class="d-none d-md-inline">Back to Activity</span>
            <span class="d-md-none">Back</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">

      <!-- Simplified Email Templates Grid - OUTSIDE form to prevent unwanted submissions -->
      <div class="email-templates-grid" id="templateCardsGrid">
          {% for template_key, template_name in template_types.items() %}
          {% set template_data = current_templates.get(template_key, {}) %}
          {% set raw_template_data = activity.email_templates.get(template_key, {}) if activity.email_templates else {} %}
          {% set is_customized = (raw_template_data.get('subject') and raw_template_data.get('subject') != '') or (raw_template_data.get('title') and raw_template_data.get('title') != '') or (raw_template_data.get('intro_text') and raw_template_data.get('intro_text') != '') or (raw_template_data.get('conclusion_text') and raw_template_data.get('conclusion_text') != '') or (raw_template_data.get('hero_image') and raw_template_data.get('hero_image') != '') or (raw_template_data.get('activity_logo') and raw_template_data.get('activity_logo') != '') %}
          
          <div class="template-item" data-template="{{ template_key }}">
            <!-- Email Template Hybrid Preview -->
            <div class="email-preview-placeholder">
              <!-- Mini Hero Image -->
              <div class="mini-hero mb-1">
                <img src="{{ url_for('get_hero_image', activity_id=activity.id, template_type=template_key) }}"
                     alt="Hero"
                     class="mini-hero-img"
                     onerror="this.src='{{ url_for('static', filename='uploads/defaults/default_hero.png') }}';">
              </div>

              <!-- Mini Subject line placeholder -->
              <div class="placeholder col-8 mb-1"></div>

              <!-- Mini text content placeholders -->
              <div class="placeholder col-10 mb-1"></div>
              <div class="placeholder col-7 mb-1"></div>
              <div class="placeholder col-9 mb-1"></div>

              {% if template_key in ['newPass', 'paymentReceived', 'redeemPass', 'latePayment'] %}
                <!-- Mini Owner Card -->
                <div class="mini-owner-card mb-1">
                  <div class="d-flex align-items-center gap-1">
                    <img src="{{ url_for('static', filename='uploads/' + activity.id|string + '_owner_logo.png') }}"
                         alt="Logo"
                         class="mini-logo"
                         onerror="this.src='{{ url_for('static', filename='uploads/' + org_logo_filename) }}';">
                    <div class="flex-grow-1">
                      <div class="placeholder col-12 mb-0"></div>
                      <div class="placeholder col-8 mb-0"></div>
                    </div>
                  </div>
                </div>

                <!-- Mini History Table -->
                <div class="mini-history-table mb-1">
                  <div class="mini-table-row d-flex gap-1 mb-0">
                    <div class="placeholder col-3"></div>
                    <div class="placeholder col-6"></div>
                  </div>
                  <div class="mini-table-row d-flex gap-1 mb-0">
                    <div class="placeholder col-3"></div>
                    <div class="placeholder col-5"></div>
                  </div>
                </div>
              {% endif %}

              <!-- Mini Button placeholder based on template type -->
              {% if template_key == 'newPass' %}
                <div class="placeholder placeholder-button placeholder-button-green col-4 mb-1"></div>
              {% elif template_key == 'paymentReceived' %}
                <div class="placeholder placeholder-button placeholder-button-blue col-4 mb-1"></div>
              {% elif template_key == 'latePayment' %}
                <div class="placeholder placeholder-button placeholder-button-orange col-4 mb-1"></div>
              {% elif template_key == 'signup' %}
                <div class="d-flex gap-1 mb-1">
                  <div class="placeholder placeholder-button placeholder-button-green col-3"></div>
                  <div class="placeholder placeholder-button placeholder-button-blue col-3"></div>
                </div>
              {% elif template_key == 'redeemPass' %}
                <!-- Mini QR Code -->
                <div class="mini-qr mb-1">
                  <div class="placeholder placeholder-qr col-3"></div>
                </div>
              {% elif template_key == 'survey_invitation' %}
                <div class="placeholder placeholder-button placeholder-button-purple col-4 mb-1"></div>
              {% endif %}

              <!-- Mini footer text -->
              <div class="placeholder col-6"></div>
            </div>

            <div class="template-overlay">
              <button type="button" class="action-btn customize-btn" 
                      data-action="customize" 
                      data-template="{{ template_key }}"
                      data-template-name="{{ template_name }}"
                      data-bs-toggle="modal" 
                      data-bs-target="#customizeModal"
                      title="Customize">
                <i class="ti ti-edit"></i>
              </button>
              
              <button type="button" class="action-btn reset-btn" 
                      data-action="reset" 
                      data-template="{{ template_key }}"
                      data-template-name="{{ template_name }}"
                      data-bs-toggle="modal" 
                      data-bs-target="#resetConfirmModal"
                      title="Reset to Default">
                <i class="ti ti-refresh"></i>
              </button>
            </div>
            
            <div class="template-name">{{ template_name }}</div>
            {% if is_customized %}
            <div class="template-status customized">Custom</div>
            {% else %}
            <div class="template-status default">Default</div>
            {% endif %}
          </div>
          {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Hidden forms for test email buttons (outside main form to prevent conflicts) -->
{% for template_key in template_types %}
<form id="test-email-form-{{ template_key }}" 
      method="POST" 
      action="{{ url_for('test_email_template', activity_id=activity.id) }}" 
      style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="template_type" value="{{ template_key }}">
</form>
{% endfor %}

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
    <div class="modal-content" style="margin: 0 2rem;">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="resetConfirmModalLabel">
          <i class="ti ti-refresh me-2"></i>
          Reset to Default
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <p class="mb-3">Reset <strong><span id="resetTemplateName" class="text-primary"></span></strong> to default values?</p>
      </div>
      <div class="modal-footer border-0 pt-0 justify-content-center gap-2">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn">
          <i class="ti ti-refresh me-2"></i>
          Reset
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Email Preview Modal -->
<div class="modal modal-lg fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="ti ti-eye me-2"></i>
          Email Template Preview
        </h5>
        <div class="ms-auto d-flex align-items-center me-3">
          <!-- Device Toggle Buttons -->
          <div class="btn-group" role="group" aria-label="Device preview toggle">
            <button type="button" class="btn btn-sm btn-outline-primary active" id="desktopView" data-device="desktop">
              <i class="ti ti-device-desktop me-1"></i>
              Desktop
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="mobileView" data-device="mobile">
              <i class="ti ti-device-mobile me-1"></i>
              Mobile
            </button>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-0">
        <!-- Preview Container -->
        <div class="preview-container d-flex justify-content-center align-items-start" style="min-height: 600px; background-color: #f8f9fa;">
          <div class="iframe-wrapper" id="previewWrapper">
            <iframe id="previewIframe" 
                    src="" 
                    frameborder="0" 
                    style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white;"
                    title="Email template preview">
            </iframe>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <!-- Template Type Navigation -->
        <div class="me-auto">
          <div class="btn-group" role="group" aria-label="Template type navigation">
            {% for temp_key, temp_name in template_types.items() %}
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary template-nav-btn{% if loop.first %} active{% endif %}" 
                    data-template-type="{{ temp_key }}"
                    data-template-name="{{ temp_name }}">
              {{ temp_name }}
            </button>
            {% endfor %}
          </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-success" id="openInNewTab">
            <i class="ti ti-external-link me-2"></i>
            Open in New Tab
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW CENTERED EMAIL TEMPLATE MODAL -->
<div class="modal fade" id="customizeModal" tabindex="-1" aria-labelledby="customizeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="customizeModalLabel">
          <i class="ti ti-edit me-2"></i>
          <span id="modalTemplateName">Customize Email Template</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body" style="padding: 1.5rem;">
        <div id="customizeFormContent" class="template-form-single-column">
          <!-- Form content will be loaded here dynamically -->
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="justify-content: center; padding: 1rem 1.5rem;">
        <div class="d-flex gap-2 flex-wrap w-100" style="max-width: 500px;">
          <button type="button" class="btn btn-primary flex-fill" id="previewInModal">
            <i class="ti ti-eye me-2"></i>
            Preview
          </button>
          <button type="button" class="btn btn-success flex-fill" id="saveTemplateChanges">
            <i class="ti ti-device-floppy me-2"></i>
            Save
          </button>
          <button type="button" class="btn btn-info flex-fill" id="sendTestEmail">
            <i class="ti ti-mail-forward me-2"></i>
            Send Test ({{ session['admin'] }})
          </button>
          <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">
            <i class="ti ti-x me-2"></i>Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden Template Form Fields (for dynamic loading) -->
<div id="templateFormTemplates" style="display: none;">
  {% for template_key, template_name in template_types.items() %}
  {% set template_data = current_templates.get(template_key, {}) %}
  {% set raw_template_data = activity.email_templates.get(template_key, {}) if activity.email_templates else {} %}
  <div id="form-template-{{ template_key }}">
    <div class="template-form-section" data-template="{{ template_key }}">
      <!-- Email Subject -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_subject" class="form-label">Email Subject</label>
        <input type="text" 
               name="{{ template_key }}_subject" 
               id="modal_{{ template_key }}_subject"
               class="form-control" 
               value="{{ template_data.get('subject', '') }}"
               placeholder="Leave empty to use system default">
      </div>
      
      <!-- Hero Image -->
      <div class="mb-3">
        <label class="form-label">Hero Image</label>
        <div class="hero-image-section">
          <div class="d-flex align-items-start gap-3">
            <div class="hero-image-preview">
              <img id="modal-hero-img-preview-{{ template_key }}" 
                   src="{{ url_for('get_hero_image', activity_id=activity.id, template_type=template_key) }}" 
                   alt="Current hero image" 
                   class="hero-preview-img"
                   onerror="this.src='{{ url_for('static', filename='uploads/defaults/default_hero.png') }}';">
            </div>
            <div class="hero-upload-controls">
              <input type="file" 
                     name="{{ template_key }}_hero_image" 
                     id="modal_{{ template_key }}_hero_image"
                     class="hero-file-input" 
                     accept="image/*"
                     onchange="previewImage(this, 'modal-hero-img-preview-{{ template_key }}')">
              <label for="modal_{{ template_key }}_hero_image" class="btn btn-outline-primary btn-sm hero-upload-btn">
                <i class="ti ti-upload me-1"></i>
                Choose Image
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Email Title -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_title" class="form-label">Email Title</label>
        <input type="text" 
               name="{{ template_key }}_title" 
               id="modal_{{ template_key }}_title"
               class="form-control" 
               value="{{ template_data.get('title', '') }}"
               placeholder="Main heading shown in the email">
      </div>
      
      <!-- Introduction Text -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_intro_text" class="form-label">Introduction Text</label>
        <textarea name="{{ template_key }}_intro_text" 
                  id="modal_{{ template_key }}_intro_text"
                  class="form-control template-textarea" 
                  rows="5"
                  placeholder="Opening message for the email">{{ template_data.get('intro_text', '') }}</textarea>
      </div>
      
      <!-- Conclusion Text -->
      <div class="mb-3">
        <label for="modal_{{ template_key }}_conclusion_text" class="form-label">Conclusion Text</label>
        <textarea name="{{ template_key }}_conclusion_text" 
                  id="modal_{{ template_key }}_conclusion_text"
                  class="form-control template-textarea" 
                  rows="5"
                  placeholder="Closing message for the email">{{ template_data.get('conclusion_text', '') }}</textarea>
      </div>
      
      <!-- Global Settings (only show for first template) -->
      {% if loop.first %}
      <hr class="my-4">
      <h6 class="mb-3">Organization Logo</h6>
      <p class="text-muted small mb-3">Logo shown at the bottom of all email templates.</p>
      
      <!-- Owner Card Logo -->
      <div class="mb-3">
        <label class="form-label">Owner Card Logo</label>
        <div class="d-flex align-items-center gap-2">
          <div class="current-logo-preview" id="modal-owner-logo-preview-{{ template_key }}">
            {% set owner_logo_filename = activity.id|string + '_owner_logo.png' %}
            <img id="modal-owner-img-preview-{{ template_key }}"
                 src="{{ url_for('static', filename='uploads/' + owner_logo_filename) }}"
                 alt="Current owner logo"
                 style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;"
                 onerror="this.src='{{ url_for('static', filename='uploads/' + org_logo_filename) }}';">
          </div>
          <div class="flex-fill">
            <input type="file" 
                   name="{{ template_key }}_owner_logo" 
                   id="modal_{{ template_key }}_owner_logo"
                   class="form-control" 
                   accept="image/*"
                   onchange="previewImage(this, 'modal-owner-img-preview-{{ template_key }}')">
            <small class="form-hint d-block">Logo shown in organization card at bottom of email</small>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Custom Styles for Activity Header -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">

<!-- Email Template Editor Scripts -->
<script src="{{ url_for('static', filename='js/email-template-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/email-template-enhanced.js') }}"></script>

<script>
// Fixed Email Template Interface
document.addEventListener('DOMContentLoaded', function() {
    console.log('Fixed email template interface loaded');

    // Add cache-busting to all template card hero images on page load
    document.querySelectorAll('.mini-hero-img').forEach(img => {
        if (!img.src.includes('?t=')) {
            img.src = img.src + `?t=${Date.now()}`;
        }
    });

    // Handle customize button clicks
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;

        const template = btn.dataset.template;
        const templateName = btn.dataset.templateName;

        if (btn.classList.contains('customize-btn')) {
            console.log('Customize:', template, templateName);
            // Load customize form content dynamically
            const formContent = document.getElementById(`form-template-${template}`);
            if (formContent) {
                document.getElementById('customizeFormContent').innerHTML = formContent.innerHTML;
                
                // Update modal title with template name
                const modalTitleElement = document.getElementById('modalTemplateName');
                if (modalTitleElement) {
                    modalTitleElement.textContent = templateName;
                }
                
                // Ensure hero images are loaded with cache-busting to show current state
                const heroImg = document.getElementById(`modal-hero-img-preview-${template}`);
                if (heroImg) {
                    const currentSrc = heroImg.src;
                    // Add cache-busting parameter to ensure fresh load
                    if (!currentSrc.includes('?t=')) {
                        heroImg.src = currentSrc + `?t=${Date.now()}`;
                    }
                }
                
                // Add tinymce class to textareas that should be rich text editors
                document.querySelectorAll('#customizeModal .template-textarea').forEach(textarea => {
                    textarea.classList.add('tinymce');
                });
                
                // Initialize TinyMCE for textareas ONLY in the modal
                setTimeout(() => {
                    if (typeof tinymce !== 'undefined') {
                        tinymce.remove('textarea.tinymce');
                        tinymce.init({
                            selector: '#customizeModal textarea.tinymce',
                            height: 200,
                            menubar: false,
                            plugins: 'lists link',
                            toolbar: 'bold italic | bullist numlist | link',
                            license_key: 'gpl'
                        });
                    }
                }, 100);
            }
        } else if (btn.classList.contains('reset-btn')) {
            console.log('Reset:', template, templateName);
            // Update reset modal content
            document.getElementById('resetTemplateName').textContent = templateName;
            document.getElementById('confirmResetBtn').dataset.template = template;
        }
    });
    
    // Handle reset confirmation
    document.addEventListener('click', function(e) {
        if (e.target.id === 'confirmResetBtn') {
            const template = e.target.dataset.template;
            const button = e.target;

            // Set loading state
            button.disabled = true;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="ti ti-loader ti-spin me-2"></i>Resetting...';

            // Send reset request
            fetch(`/activity/{{ activity.id }}/email-templates/reset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({template_type: template})
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetConfirmModal'));
                    if (resetModal) resetModal.hide();

                    // Reload page - Flask flash message will appear
                    location.reload();
                } else {
                    alert('Error resetting template: ' + (data.message || 'Unknown error'));
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
            }).catch(error => {
                console.error('Reset error:', error);
                alert('Error resetting template: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalHTML;
            });
        }
    });
    
    // Enhanced image preview for modals with hero image support
    window.previewImage = (input, previewId) => {
        const file = input.files?.[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById(previewId);
                if (img) {
                    img.src = e.target.result;
                    // Add visual feedback for new image selection
                    img.style.border = '2px solid #206bc4';
                    img.style.borderRadius = '6px';
                    
                    // Add a small "NEW" badge if this is a hero image
                    if (previewId.includes('hero-img-preview')) {
                        // Remove any existing badge
                        const existingBadge = img.parentElement.querySelector('.new-image-badge');
                        if (existingBadge) existingBadge.remove();
                        
                        // Add new badge
                        const badge = document.createElement('div');
                        badge.className = 'new-image-badge';
                        badge.innerHTML = '<i class="ti ti-upload"></i> NEW';
                        badge.style.cssText = 'position: absolute; top: -8px; right: -8px; background: #206bc4; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; z-index: 10;';
                        
                        img.parentElement.style.position = 'relative';
                        img.parentElement.appendChild(badge);
                    }
                }
            };
            reader.readAsDataURL(file);
        } else if (input.files?.length === 0) {
            // Handle file clear - revert to original image
            const img = document.getElementById(previewId);
            if (img && previewId.includes('hero-img-preview')) {
                // Extract template type from preview ID
                const templateType = previewId.replace('modal-hero-img-preview-', '');
                // Reload original hero image
                img.src = `/activity/{{ activity.id }}/hero-image/${templateType}?t=${Date.now()}`;
                img.style.border = '1px solid #dee2e6';
                
                // Remove new badge
                const badge = img.parentElement.querySelector('.new-image-badge');
                if (badge) badge.remove();
            }
        }
    };
    
    // Handle Preview Changes button with debouncing
    let previewInProgress = false;

    document.addEventListener('click', function(e) {
        if (e.target.id === 'previewInModal' || e.target.closest('#previewInModal')) {
            const button = e.target.id === 'previewInModal' ? e.target : e.target.closest('#previewInModal');

            // Prevent multiple clicks while preview is being generated
            if (previewInProgress) {
                console.log('Preview already in progress, ignoring click');
                return;
            }

            console.log('Preview button clicked - sending live preview with current data');

            // Get current template type from modal
            const activeSection = document.querySelector('.template-form-section[data-template]');
            if (!activeSection) {
                alert('No template selected');
                return;
            }

            const templateType = activeSection.dataset.template;

            // Set loading state
            previewInProgress = true;
            button.disabled = true;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="ti ti-loader ti-spin me-2"></i><span class="d-none d-sm-inline">Loading...</span>';

            // Create FormData with current form values (including uploaded files)
            const formData = new FormData();
            formData.append('template_type', templateType);
            formData.append('csrf_token', '{{ csrf_token() }}');

            // Get form values from modal
            const subjectInput = document.querySelector(`#modal_${templateType}_subject`);
            const titleInput = document.querySelector(`#modal_${templateType}_title`);
            const heroImageInput = document.querySelector(`#modal_${templateType}_hero_image`);

            if (subjectInput) formData.append(`${templateType}_subject`, subjectInput.value);
            if (titleInput) formData.append(`${templateType}_title`, titleInput.value);
            if (heroImageInput && heroImageInput.files.length > 0) {
                formData.append(`${templateType}_hero_image`, heroImageInput.files[0]);
            }

            // Get TinyMCE content for intro and conclusion text
            const introEditor = tinymce.get(`modal_${templateType}_intro_text`);
            const conclusionEditor = tinymce.get(`modal_${templateType}_conclusion_text`);

            if (introEditor) formData.append(`${templateType}_intro_text`, introEditor.getContent());
            if (conclusionEditor) formData.append(`${templateType}_conclusion_text`, conclusionEditor.getContent());

            // Send POST request to live preview endpoint and open result in new tab
            fetch('/activity/{{ activity.id }}/email-preview-live', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                // Create blob URL with proper UTF-8 charset to handle French characters
                const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const newTab = window.open(url, '_blank');

                // Reset button state
                button.disabled = false;
                button.innerHTML = originalHTML;
                previewInProgress = false;

                // Clean up blob URL after a delay (browser needs time to load it)
                if (newTab) {
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                } else {
                    alert('Please allow popups to view the preview');
                }
            })
            .catch(error => {
                console.error('Preview error:', error);
                alert('Error generating preview: ' + error.message);

                // Reset button state on error
                button.disabled = false;
                button.innerHTML = originalHTML;
                previewInProgress = false;
            });
        }
    });
    
    // Handle Save Changes button  
    document.addEventListener('click', function(e) {
        if (e.target.id === 'saveTemplateChanges') {
            console.log('Save button clicked - implementing real save');
            
            // Get current template type from modal
            const activeSection = document.querySelector('.template-form-section[data-template]');
            if (!activeSection) return;
            
            const templateType = activeSection.dataset.template;
            
            // Collect form data from modal
            const formData = new FormData();
            formData.append('csrf_token', '{{ csrf_token() }}');
            formData.append('single_template', templateType);
            
            // Get field values
            const subjectInput = document.querySelector(`#modal_${templateType}_subject`);
            const titleInput = document.querySelector(`#modal_${templateType}_title`);
            
            if (subjectInput) formData.append(`${templateType}_subject`, subjectInput.value);
            if (titleInput) formData.append(`${templateType}_title`, titleInput.value);
            
            // Get TinyMCE content
            if (typeof tinymce !== 'undefined') {
                const introEditor = tinymce.get(`modal_${templateType}_intro_text`);
                const conclusionEditor = tinymce.get(`modal_${templateType}_conclusion_text`);
                
                if (introEditor) formData.append(`${templateType}_intro_text`, introEditor.getContent());
                if (conclusionEditor) formData.append(`${templateType}_conclusion_text`, conclusionEditor.getContent());
            }
            
            // Get file inputs for images
            const heroImageInput = document.querySelector(`#modal_${templateType}_hero_image`);
            const ownerLogoInput = document.querySelector(`#modal_${templateType}_owner_logo`);
            
            if (heroImageInput && heroImageInput.files[0]) {
                formData.append(`${templateType}_hero_image`, heroImageInput.files[0]);
            }
            if (ownerLogoInput && ownerLogoInput.files[0]) {
                formData.append(`${templateType}_owner_logo`, ownerLogoInput.files[0]);
            }
            
            // Save to backend
            fetch(`/activity/{{ activity.id }}/email-templates/save`, {
                method: 'POST',
                body: formData
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('customizeModal'));
                    if (modal) modal.hide();
                    // Reload page - Flask flash message will appear
                    location.reload();
                } else {
                    alert('Error saving template: ' + (data.message || 'Unknown error'));
                }
            }).catch(error => {
                console.error('Save error:', error);
                alert('Error saving template: ' + error.message);
            });
        }
    });

    // Handle Send Test Email button
    document.addEventListener('click', function(e) {
        if (e.target.id === 'sendTestEmail' || e.target.closest('#sendTestEmail')) {
            console.log('Send Test Email button clicked');

            // Get current template type from modal
            const activeSection = document.querySelector('.template-form-section[data-template]');
            if (!activeSection) {
                alert('Please select a template first');
                return;
            }

            const templateType = activeSection.dataset.template;
            console.log('Template type:', templateType);

            // Disable button and show loading state
            const btn = e.target.id === 'sendTestEmail' ? e.target : e.target.closest('#sendTestEmail');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ti ti-loader ti-spin me-2"></i>Sending...';

            // Submit the hidden test form for this template type
            const formData = new FormData();
            formData.append('csrf_token', '{{ csrf_token() }}');
            formData.append('template_type', templateType);

            fetch(`/activity/{{ activity.id }}/email-test`, {
                method: 'POST',
                body: formData
            }).then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;

                if (data.success) {
                    alert(data.message + '\n\nCheck your inbox to verify the template renders correctly.');
                } else {
                    alert('Error sending test email:\n\n' + (data.error || data.message || 'Unknown error'));
                }
            }).catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                console.error('Test email error:', error);
                alert('Error sending test email: ' + error.message);
            });
        }
    });
});
</script>

<style>
/* Accordion header action buttons */
.header-actions {
  flex-shrink: 0;
}

.header-actions .btn-icon {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.header-actions .btn-group {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border-radius: 6px;
}

/* Prevent accordion toggle on action button clicks */
.header-actions button {
  pointer-events: auto;
}

.accordion-button {
  padding-right: 0;
}

/* Mobile-first responsive improvements */
@media (max-width: 767.98px) {
  .header-split-layout {
    flex-direction: column;
  }
  
  .image-section {
    margin-top: 1.5rem;
  }
  
  .activity-image-modern {
    height: 200px;
  }
  
  .accordion-body .row {
    flex-direction: column;
  }
  
  .accordion-body .col-lg-4 {
    margin-top: 1rem;
  }
  
  /* Hide action button text on mobile, keep icons */
  .header-actions .btn-group {
    gap: 2px;
  }
  
  .header-actions .btn-icon {
    width: 28px;
    height: 28px;
    font-size: 14px;
  }
}

/* Accordion customization */
.accordion-button:not(.collapsed) {
  background-color: #f8f9fa;
  box-shadow: none;
}

.accordion-button:focus {
  box-shadow: none;
  border-color: rgba(98, 105, 118, 0.16);
}

.accordion-item {
  margin-bottom: 0.75rem;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 0.5rem;
}

.accordion-item:last-child .accordion-button.collapsed {
  border-bottom-right-radius: 0.375rem;
  border-bottom-left-radius: 0.375rem;
}

/* Activity header adjustments */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

.activity-header-clean {
  background: #ffffff;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.activity-header-clean::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #206bc4 0%, #ed2988 100%);
}

/* Preview Modal Styles */
.preview-container {
  padding: 2rem;
  transition: all 0.3s ease;
}

.iframe-wrapper {
  transition: all 0.3s ease;
  max-width: 100%;
}

/* Desktop View (Default) */
.iframe-wrapper.desktop {
  width: 100%;
}

/* Mobile View */
.iframe-wrapper.mobile {
  width: 375px;
  max-width: 100%;
}

/* Device toggle button states */
.btn-group .btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Template navigation button states */
.template-nav-btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Mobile responsive modal */
@media (max-width: 767.98px) {
  .modal-xl {
    max-width: 95%;
  }

  .preview-container {
    padding: 1rem;
  }

  .iframe-wrapper {
    width: 100% !important;
  }

  .modal-header .btn-group {
    display: none;
  }

  .modal-footer .btn-group {
    flex-wrap: wrap;
  }

  .modal-footer .btn-group .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  /* Improve modal header spacing on mobile */
  .modal-header {
    padding: 0.5rem 1rem;
  }

  /* Hide modal title on mobile - users already know which template from previous screen */
  .modal-header .modal-title {
    display: none;
  }

  .modal-header .btn-close {
    padding: 0.5rem;
    margin: 0;
  }
}

/* Activity thumbnail inline with title */
.activity-thumbnail-inline {
  height: 42px;
  width: 42px;
  object-fit: cover;
  border-radius: 6px;
  margin: 0 8px;
  vertical-align: middle;
  border: 1px solid rgba(98, 105, 118, 0.16);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

/* Activity name highlight effect */
.activity-name-highlight {
  background-color: #fff3cd;
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #ffeaa7;
  display: inline-block;
  margin-left: 4px;
  font-weight: 600;
}

/* Email Template Hybrid Preview Styling */
.email-preview-placeholder {
  background: #ffffff;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 18px; /* Increased from 8px to 18px (10px more padding) */
  height: 280px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,0.06);
  transition: all 0.2s ease;
}

.email-preview-placeholder:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
  border-color: #206bc4;
}

.email-preview-placeholder .placeholder {
  background: #dee2e6 !important; /* Static light gray - no animation */
  border-radius: 1px;
  height: 4px !important; /* Double the height */
  min-height: 4px !important; /* Override Tabler's min-height: 1em */
}

@keyframes placeholder-glow {
  0% { opacity: 1; }
  100% { opacity: 0.6; }
}

/* Mini Hero Image */
.mini-hero {
  height: 40px;
  overflow: hidden;
  border-radius: 4px;
  background: #f8f9fa;
}

.mini-hero-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 4px;
}

/* Mini Logo */
.mini-logo {
  width: 16px;
  height: 16px;
  object-fit: contain;
  border-radius: 2px;
  background: white;
  border: 1px solid #e9ecef;
}

/* Mini Owner Card */
.mini-owner-card {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 4px;
  padding: 4px;
}

/* Mini History Table */
.mini-history-table {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 4px;
  padding: 3px;
}

.mini-table-row {
  margin-bottom: 1px;
}

/* Mini QR Code */
.mini-qr {
  display: flex;
  justify-content: center;
}

/* Button placeholder colors */
.placeholder-button {
  height: 10px !important;
}

.placeholder-button-green {
  background: #4CAF50 !important;
}

.placeholder-button-blue {
  background: #2196F3 !important;
}

.placeholder-button-orange {
  background: #FF9800 !important;
}

.placeholder-button-purple {
  background: #9C27B0 !important;
}

.placeholder-qr {
  height: 18px !important;
  background: #f1f3f4 !important;
  border: 1px dashed #d1d5db !important;
}

/* All templates now use the main Tabler gray color for placeholders */





</style>

{% endblock %}