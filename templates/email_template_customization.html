{% extends "base.html" %}

{% block title %}Email Template Customization - {{ activity.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/email-template-customization.css') }}">
{% endblock %}

{% block content %}
<!-- Modern Activity Header -->
<div class="page-wrapper">
  <div class="page-body">
    <div class="dashboard-container">
      <!-- Clean Activity Header Card -->
      <div class="card activity-header-card">
        <div class="card-body">
          <!-- Header Top Section -->
          <div class="activity-header-top">
            <!-- Activity Picture -->
            <img src="{{ url_for('static', filename='uploads/activity_images/' ~ (activity.image_filename or 'placeholder.jpg')) }}" 
                 alt="{{ activity.name }}"
                 class="activity-image">
            
            <!-- Title and Description -->
            <div class="activity-info">
              <div class="activity-title-row">
                <h2 class="activity-title">{{ activity.name }}</h2>
                <span class="badge bg-success">
                  Active
                  <span class="badge-pulse"></span>
                </span>
              </div>
              <p class="activity-description text-muted">
                Email Templates - Customize the content and appearance of automated emails sent to your users.
              </p>
            </div>
            
            <!-- Right Section: Back Button -->
            <div class="activity-header-right">
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-outline-primary btn-sm">
                <i class="ti ti-arrow-left me-2"></i>
                Back to Activity
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Professional Title Section -->
      <div class="page-title-section mb-4">
        <h2 class="page-title">Email Communication Builder</h2>
        <p class="text-muted">Customize automated emails for {{ activity.name }}</p>
      </div>

      <!-- Email Template Form -->
      <form method="POST" action="{{ url_for('save_email_templates', activity_id=activity.id) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Template Accordion Sections -->
        <div class="accordion" id="templateAccordion">
          {% for template_key, template_name in template_types.items() %}
          {% set template_data = current_templates.get(template_key, {}) %}
          <div class="accordion-item">
            <!-- Accordion Header with Action Buttons -->
            <h2 class="accordion-header" id="heading-{{ template_key }}">
              <div class="d-flex align-items-center w-100">
                <!-- Left: Expand Button -->
                <button class="accordion-button{% if not loop.first %} collapsed{% endif %}" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse-{{ template_key }}" 
                        aria-expanded="{{ 'true' if loop.first else 'false' }}" 
                        aria-controls="collapse-{{ template_key }}">
                  <i class="ti ti-mail me-2"></i>
                  <strong>{{ template_name }}</strong>
                  <span class="badge ms-2 {% if template_data.get('subject') or template_data.get('title') or template_data.get('intro_text') or template_data.get('conclusion_text') %}bg-blue-lt{% else %}bg-secondary-lt{% endif %}">
                    {% if template_data.get('subject') or template_data.get('title') or template_data.get('intro_text') or template_data.get('conclusion_text') %}Customized{% else %}Using Default{% endif %}
                  </span>
                </button>
                
                <!-- Right: Action Buttons -->
                <div class="header-actions ms-auto me-3">
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-icon"
                            data-bs-toggle="modal" data-bs-target="#previewModal"
                            data-template-type="{{ template_key }}" data-template-name="{{ template_name }}"
                            title="Preview Template">
                      <i class="ti ti-eye"></i>
                    </button>
                    <button type="button" class="btn btn-outline-success btn-icon"
                            onclick="document.getElementById('test-email-form-{{ template_key }}').submit();"
                            title="Send Test Email">
                      <i class="ti ti-mail"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-icon"
                            onclick="saveIndividualTemplate('{{ template_key }}')"
                            title="Save Template">
                      <i class="ti ti-device-floppy"></i>
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-icon reset-btn"
                            data-template-key="{{ template_key }}" data-template-name="{{ template_name }}"
                            title="Reset to Default">
                      <i class="ti ti-refresh"></i>
                    </button>
                  </div>
                </div>
              </div>
            </h2>
            
            <!-- Accordion Content -->
            <div id="collapse-{{ template_key }}" 
                 class="accordion-collapse collapse{% if loop.first %} show{% endif %}" 
                 aria-labelledby="heading-{{ template_key }}" 
                 data-bs-parent="#templateAccordion">
              <div class="accordion-body">
                <!-- Form Fields Only (Preview Cards Removed) -->
                <div class="row">
                  <div class="col-12">
                    <div class="mb-4">
                      <h5 class="text-muted mb-3">{{ template_name }} Settings</h5>
                                            
                      <!-- Email Subject -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_subject" class="form-label">Email Subject</label>
                        <input type="text" 
                               name="{{ template_key }}_subject" 
                               id="{{ template_key }}_subject"
                               class="form-control" 
                               value="{{ template_data.get('subject', '') }}"
                               placeholder="Leave empty to use system default">
                      </div>
                      
                      <!-- Email Title -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_title" class="form-label">Email Title</label>
                        <input type="text" 
                               name="{{ template_key }}_title" 
                               id="{{ template_key }}_title"
                               class="form-control" 
                               value="{{ template_data.get('title', '') }}"
                               placeholder="Main heading shown in the email">
                      </div>
                      
                      <!-- Introduction Text -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_intro_text" class="form-label">Introduction Text</label>
                        <textarea name="{{ template_key }}_intro_text" 
                                  id="{{ template_key }}_intro_text"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Opening message for the email">{{ template_data.get('intro_text', '') }}</textarea>
                      </div>
                                            
                      <!-- Hero Image (Activity-wide, only show on first template) -->
                      {% if loop.first %}
                      <div class="mb-3">
                        <label class="form-label">Hero Image</label>
                        <div class="d-flex align-items-center gap-2">
                          <div class="current-image-preview" id="hero-preview-{{ template_key }}">
                            {% set hero_filename = activity.id|string + '_hero.png' %}
                            <img id="hero-img-preview" 
                                 src="{{ url_for('static', filename='uploads/' + hero_filename) }}" 
                                 alt="Current hero image" 
                                 style="width: 100px; height: 60px; object-fit: cover; border: 1px solid #dee2e6; border-radius: 6px; background: white;"
                                 onerror="this.src='{{ url_for('static', filename='uploads/defaults/default_hero.png') }}'; this.style.backgroundColor='#f8f9fa';">
                          </div>
                          <div class="flex-fill">
                            <input type="file" 
                                   name="{{ template_key }}_hero_image" 
                                   id="{{ template_key }}_hero_image"
                                   class="form-control" 
                                   accept="image/*"
                                   onchange="previewImage(this, 'hero-img-preview')">
                            <small class="form-hint d-block">Banner image shown at top of email (replaces ticket icon)</small>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                      
                      <!-- Owner Card Logo (Activity-wide, only show on first template) -->
                      {% if loop.first %}
                      <div class="mb-3">
                        <label class="form-label">Owner Card Logo</label>
                        <div class="d-flex align-items-center gap-2">
                          <div class="current-logo-preview" id="owner-logo-preview-{{ template_key }}">
                            {% set owner_logo_filename = activity.id|string + '_owner_logo.png' %}
                            <img id="owner-img-preview" 
                                 src="{{ url_for('static', filename='uploads/' + owner_logo_filename) }}" 
                                 alt="Current owner logo" 
                                 style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;"
                                 onerror="this.src='{{ url_for('static', filename='uploads/flhgi.png') }}';">
                          </div>
                          <div class="flex-fill">
                            <input type="file" 
                                   name="{{ template_key }}_owner_logo" 
                                   id="{{ template_key }}_owner_logo"
                                   class="form-control" 
                                   accept="image/*"
                                   onchange="previewImage(this, 'owner-img-preview')">
                            <small class="form-hint d-block">Logo shown in organization card at bottom of email</small>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                                            
                      
                      <!-- Conclusion Text -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_conclusion_text" class="form-label">Conclusion Text</label>
                        <textarea name="{{ template_key }}_conclusion_text" 
                                  id="{{ template_key }}_conclusion_text"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Closing message for the email">{{ template_data.get('conclusion_text', '') }}</textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
                        
        </div>
        
        <!-- Save Actions -->
        <div class="card mt-4">
          <div class="card-footer">
            <div class="d-flex">
              <button type="submit" class="btn btn-primary">
                <i class="ti ti-device-floppy me-2"></i>
                Save All Templates
              </button>
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" 
                 class="btn btn-outline-secondary ms-auto">
                <i class="ti ti-x me-2"></i>
                Cancel
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden forms for test email buttons (outside main form to prevent conflicts) -->
{% for template_key in template_types %}
<form id="test-email-form-{{ template_key }}" 
      method="POST" 
      action="{{ url_for('test_email_template', activity_id=activity.id) }}" 
      style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="template_type" value="{{ template_key }}">
</form>
{% endfor %}

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resetConfirmModalLabel">
          <i class="ti ti-refresh me-2"></i>
          Reset Template to Default
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start mb-4">
          <div class="avatar bg-warning-lt me-3 flex-shrink-0">
            <i class="ti ti-refresh"></i>
          </div>
          <div class="flex-grow-1">
            <h4 class="mb-2">Reset <span id="resetTemplateName" class="text-primary"></span> to Default?</h4>
            <p class="text-muted mb-0">This action will clear all custom values and revert this template to system defaults.</p>
          </div>
        </div>
        
        <div class="alert alert-warning border-warning">
          <div class="d-flex align-items-start">
            <i class="ti ti-info-circle me-2 mt-1 flex-shrink-0"></i>
            <div>
              <strong class="d-block mb-2">The following will be reset:</strong>
              <div class="row g-2">
                <div class="col-12 col-sm-6">
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Email subject line</small>
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Email title</small>
                </div>
                <div class="col-12 col-sm-6">
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Introduction text</small>
                  <small class="d-block"><i class="ti ti-point-filled me-1"></i>Conclusion text</small>
                </div>
              </div>
              <div class="mt-2 pt-2 border-top border-warning">
                <small class="text-muted d-block"><i class="ti ti-clock me-1"></i>Changes take effect immediately and cannot be undone.</small>
                <small class="text-muted"><i class="ti ti-shield-check me-1"></i>Template will use professional system defaults.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="ti ti-x me-2"></i>
          Keep Current Settings
        </button>
        <button type="button" class="btn btn-warning" id="confirmResetBtn">
          <i class="ti ti-refresh me-2"></i>
          Reset to Default
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Email Preview Modal -->
<div class="modal modal-lg fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="ti ti-eye me-2"></i>
          Email Template Preview
        </h5>
        <div class="ms-auto d-flex align-items-center me-3">
          <!-- Device Toggle Buttons -->
          <div class="btn-group" role="group" aria-label="Device preview toggle">
            <button type="button" class="btn btn-sm btn-outline-primary active" id="desktopView" data-device="desktop">
              <i class="ti ti-device-desktop me-1"></i>
              Desktop
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="mobileView" data-device="mobile">
              <i class="ti ti-device-mobile me-1"></i>
              Mobile
            </button>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-0">
        <!-- Preview Container -->
        <div class="preview-container d-flex justify-content-center align-items-start" style="min-height: 600px; background-color: #f8f9fa;">
          <div class="iframe-wrapper" id="previewWrapper">
            <iframe id="previewIframe" 
                    src="" 
                    frameborder="0" 
                    style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white;"
                    title="Email template preview">
            </iframe>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <!-- Template Type Navigation -->
        <div class="me-auto">
          <div class="btn-group" role="group" aria-label="Template type navigation">
            {% for temp_key, temp_name in template_types.items() %}
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary template-nav-btn{% if loop.first %} active{% endif %}" 
                    data-template-type="{{ temp_key }}"
                    data-template-name="{{ temp_name }}">
              {{ temp_name }}
            </button>
            {% endfor %}
          </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-success" id="openInNewTab">
            <i class="ti ti-external-link me-2"></i>
            Open in New Tab
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Styles for Activity Header -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity-header-clean.css') }}">

<!-- Email Template Editor Script -->
<script src="{{ url_for('static', filename='js/email-template-editor.js') }}"></script>

<script>
// Email Template Editor - Optimized (47 lines)
document.addEventListener('DOMContentLoaded', function() {
    let resetKey = null;
    const resetModal = new bootstrap.Modal(document.getElementById('resetConfirmModal'));
    const toast = (msg, success) => {
        const el = Object.assign(document.createElement('div'), {
            className: `alert alert-${success ? 'success' : 'danger'} position-fixed`,
            style: 'top:20px;right:20px;z-index:9999;min-width:300px;',
            innerHTML: `<i class="ti ti-${success ? 'check' : 'x'} me-2"></i>${msg}`
        });
        document.body.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 2500);
    };
    
    const updateBadge = (key) => {
        const badge = document.querySelector(`#heading-${key} .badge`);
        const hasContent = ['subject', 'title', 'intro_text', 'conclusion_text'].some(f => document.getElementById(`${key}_${f}`)?.value?.trim());
        badge.style.transition = 'all 0.3s'; badge.style.transform = 'scale(0.8)';
        setTimeout(() => {
            badge.className = hasContent ? 'badge ms-2 bg-blue-lt' : 'badge ms-2 bg-secondary-lt';
            badge.textContent = hasContent ? 'Customized' : 'Using Default';
            badge.style.transform = 'scale(1)';
        }, 150);
    };
    
    // Individual template save
    window.saveIndividualTemplate = (key) => {
        const form = document.querySelector('form'), data = new FormData(form);
        data.append('single_template', key);
        fetch(form.action, { method: 'POST', body: data })
            .then(r => r.json())
            .then(d => toast(d.success ? 'Template saved!' : 'Save failed', d.success))
            .catch(() => toast('Save failed', false));
    };
    
    // Reset handlers
    document.querySelectorAll('.reset-btn').forEach(btn => btn.addEventListener('click', function() {
        resetKey = this.dataset.templateKey;
        document.getElementById('resetTemplateName').textContent = this.dataset.templateName;
        resetModal.show();
    }));
    
    document.getElementById('confirmResetBtn').addEventListener('click', () => {
        if (!resetKey) return;
        ['subject', 'title', 'intro_text', 'conclusion_text'].forEach(field => {
            const input = document.getElementById(`${resetKey}_${field}`);
            if (input) {
                input.style.transition = 'background 0.3s'; input.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    input.value = ''; input.style.backgroundColor = '';
                    if (input.classList.contains('tinymce') && window.tinymce) {
                        const ed = tinymce.get(input.id); if (ed) ed.setContent('');
                    }
                }, 150);
            }
        });
        document.querySelectorAll(`input[name^="${resetKey}_"][type="file"]`).forEach(f => {
            f.value = '';
            if (f.id.includes('hero')) document.getElementById('hero-img-preview')?.setAttribute('src', '/static/uploads/defaults/default_hero.png');
            if (f.id.includes('owner')) document.getElementById('owner-img-preview')?.setAttribute('src', '/static/uploads/flhgi.png');
        });
        setTimeout(() => updateBadge(resetKey), 200);
        resetModal.hide();
        toast(`${document.querySelector(`[data-template-key="${resetKey}"]`).dataset.templateName} reset to default`, true);
    });
    
    // Event listeners
    document.addEventListener('input', e => {
        const m = e.target.id?.match(/^(.+)_(subject|title|intro_text|conclusion_text)$/);
        if (m) setTimeout(() => updateBadge(m[1]), 100);
    });
    document.querySelectorAll('.header-actions button').forEach(btn => btn.addEventListener('click', e => e.stopPropagation()));
});

// Image preview and external script loading
function previewImage(input, previewId) {
    const file = input.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => document.getElementById(previewId).src = e.target.result;
        reader.readAsDataURL(file);
    }
}
fetch('/static/js/email-template-preview.js').then(r=>r.text()).then(js=>eval(js));
</script>

<style>
/* Accordion header action buttons */
.header-actions {
  flex-shrink: 0;
}

.header-actions .btn-icon {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.header-actions .btn-group {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border-radius: 6px;
}

/* Prevent accordion toggle on action button clicks */
.header-actions button {
  pointer-events: auto;
}

.accordion-button {
  padding-right: 0;
}

/* Mobile-first responsive improvements */
@media (max-width: 767.98px) {
  .header-split-layout {
    flex-direction: column;
  }
  
  .image-section {
    margin-top: 1.5rem;
  }
  
  .activity-image-modern {
    height: 200px;
  }
  
  .accordion-body .row {
    flex-direction: column;
  }
  
  .accordion-body .col-lg-4 {
    margin-top: 1rem;
  }
  
  /* Hide action button text on mobile, keep icons */
  .header-actions .btn-group {
    gap: 2px;
  }
  
  .header-actions .btn-icon {
    width: 28px;
    height: 28px;
    font-size: 14px;
  }
}

/* Accordion customization */
.accordion-button:not(.collapsed) {
  background-color: #f8f9fa;
  box-shadow: none;
}

.accordion-button:focus {
  box-shadow: none;
  border-color: rgba(98, 105, 118, 0.16);
}

.accordion-item {
  margin-bottom: 0.75rem;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 0.5rem;
}

.accordion-item:last-child .accordion-button.collapsed {
  border-bottom-right-radius: 0.375rem;
  border-bottom-left-radius: 0.375rem;
}

/* Activity header adjustments */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

.activity-header-clean {
  background: #ffffff;
  border: 1px solid rgba(98, 105, 118, 0.16);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.activity-header-clean::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #206bc4 0%, #ed2988 100%);
}

/* Preview Modal Styles */
.preview-container {
  padding: 2rem;
  transition: all 0.3s ease;
}

.iframe-wrapper {
  transition: all 0.3s ease;
  max-width: 100%;
}

/* Desktop View (Default) */
.iframe-wrapper.desktop {
  width: 100%;
}

/* Mobile View */
.iframe-wrapper.mobile {
  width: 375px;
  max-width: 100%;
}

/* Device toggle button states */
.btn-group .btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Template navigation button states */
.template-nav-btn.active {
  background-color: #206bc4;
  border-color: #206bc4;
  color: white;
}

/* Mobile responsive modal */
@media (max-width: 767.98px) {
  .modal-xl {
    max-width: 95%;
  }
  
  .preview-container {
    padding: 1rem;
  }
  
  .iframe-wrapper {
    width: 100% !important;
  }
  
  .modal-header .btn-group {
    display: none;
  }
  
  .modal-footer .btn-group {
    flex-wrap: wrap;
  }
  
  .modal-footer .btn-group .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}
</style>

{% endblock %}