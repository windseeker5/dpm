{% extends "base.html" %}
{% block title %}Activity Log{% endblock %}

{% block content %}

<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <h2 class="mb-0">
        <i class="ti ti-history me-2" style="color: #206bc4;"></i>Activity Log
      </h2>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">

    <!-- ðŸ”¹ Search + Filter Controls -->
    <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">


        <!-- Dropdown Filter -->
        <div class="col-md-3">
          <select id="filterType" class="form-select">
            <option value="">All Types</option>
            <option value="Passport Created">Passport Created</option>
            <option value="Passport Redeemed">Passport Redeemed</option>
            <option value="Email Sent">Email Sent</option>
            <option value="Payment Matched">Payment Matched</option>
            <option value="Marked Paid">Marked Paid</option>
            <option value="Reminder Sent">Reminder Sent</option>
            <option value="Signup Submitted">Signup Submitted</option>
            <option value="Signup Approved">Signup Approved</option>
            <option value="Signup Rejected">Signup Rejected</option>
            <option value="Activity Created">Activity Created</option>
            <option value="Admin Action">Admin Action</option>
          </select>
        </div>





        <!-- Search Input -->
        <div class="col-md">
          <div class="input-icon">
            <span class="input-icon-addon">
              <i class="ti ti-search"></i>
            </span>
            <input type="text" id="searchBox" class="form-control" placeholder="Search logs...">
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- ðŸ”¹ Table / Cards Container -->
    <div class="card">
    <div class="card-header">
      <h3 class="card-title">Last Transactions</h3>
    </div>

    <!-- Desktop Table View (hidden on mobile) -->
    <div class="d-none d-md-block">
      <div class="table-responsive">
        <table class="table card-table table-vcenter" id="logTable">
          <thead>
            <tr>
              <th scope="col" class="text-muted">Date/Time</th>
              <th scope="col" class="text-muted">Type</th>
              <th scope="col" class="text-muted">Description</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr data-type="{{ log.type }}">
              <td>{{ log.timestamp | utc_to_local | datetimeformat('%Y-%m-%d %H:%M') }}</td>
              <td>
                {% if log.type == 'Passport Redeemed' %}
                  <i class="ti ti-ticket text-danger"></i>
                {% elif log.type == 'Email Sent' %}
                  <i class="ti ti-mail text-info"></i>
                {% elif log.type == 'Passport Created' %}
                  <i class="ti ti-id text-lime"></i>
                {% elif log.type == 'Interact Payment' %}
                  <i class="ti ti-currency-dollar text-success"></i>
                {% elif log.type == 'Marked Paid' %}
                  <i class="ti ti-check text-green"></i>
                {% elif log.type == 'Reminder Sent' %}
                  <i class="ti ti-bell text-purple"></i>
                {% elif log.type == 'Signup Submitted' %}
                  <i class="ti ti-user-plus text-success"></i>
                {% elif log.type == 'Signup Approved' %}
                  <i class="ti ti-user-check text-green"></i>
                {% elif log.type == 'Signup Rejected' %}
                  <i class="ti ti-user-x text-danger"></i>
                {% elif log.type == 'Signup Cancelled' %}
                  <i class="ti ti-user-x text-danger"></i>
                {% elif log.type == 'Activity Created' %}
                  <i class="ti ti-target text-orange"></i>
                {% elif log.type == 'Admin Action' %}
                  <i class="ti ti-settings text-muted"></i>
                {% else %}
                  <i class="ti ti-activity text-muted"></i>
                {% endif %}
                {{ log.type }}
              </td>
              <td class="log-description">{{ log.details }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Card View (hidden on desktop) -->
    <div class="d-md-none" id="mobileLogCards">
      {% for log in logs %}
      <div class="log-card-mobile" data-type="{{ log.type }}">
        <div class="log-card-badges mb-2">
          <span class="badge badge-sm bg-gray-lt me-2">{{ log.timestamp | utc_to_local | datetimeformat('%Y-%m-%d') }}</span>
          <span class="badge badge-sm bg-{{ log.type | log_type_color }}-lt">{{ log.type }}</span>
        </div>
        <div class="log-card-description">{{ log.details }}</div>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="card-footer d-flex align-items-center">
      <p class="m-0 text-muted">Showing <span id="showingCount">0</span> of {{ logs|length }}</p>
      <ul class="pagination m-0 ms-auto" id="paginationControls"></ul>
    </div>
    </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchBox");
  const typeFilter = document.getElementById("filterType");
  const showingCount = document.getElementById("showingCount");

  // Desktop table elements
  const tableRows = Array.from(document.querySelectorAll("#logTable tbody tr"));
  const tableBody = document.querySelector("#logTable tbody");

  // Mobile card elements
  const mobileCards = Array.from(document.querySelectorAll("#mobileLogCards .log-card-mobile"));
  const mobileContainer = document.getElementById("mobileLogCards");

  const rowsPerPage = 50;
  let currentPage = 1;

  function filterItems(items) {
    const search = searchInput.value.toLowerCase();
    const type = typeFilter.value.toLowerCase();

    return items.filter(item => {
      const itemType = (item.getAttribute("data-type") || "").toLowerCase();
      const text = item.textContent.toLowerCase();
      return (!type || itemType.includes(type)) && text.includes(search);
    });
  }

  function renderView() {
    const filteredTableRows = filterItems(tableRows);
    const filteredMobileCards = filterItems(mobileCards);

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    // Render desktop table
    const pageTableRows = filteredTableRows.slice(start, end);
    tableBody.innerHTML = "";
    pageTableRows.forEach(row => tableBody.appendChild(row));

    // Render mobile cards
    const pageMobileCards = filteredMobileCards.slice(start, end);
    mobileContainer.innerHTML = "";
    pageMobileCards.forEach(card => mobileContainer.appendChild(card));

    // Update count (use table rows count as reference)
    showingCount.textContent = filteredTableRows.length;

    renderPagination(filteredTableRows.length);
  }

  function renderPagination(total) {
    const pageCount = Math.ceil(total / rowsPerPage);
    const pagination = document.getElementById("paginationControls");
    pagination.innerHTML = "";

    for (let i = 1; i <= pageCount; i++) {
      const li = document.createElement("li");
      li.className = `page-item ${i === currentPage ? "active" : ""}`;
      li.innerHTML = `<a href="#" class="page-link">${i}</a>`;
      li.addEventListener("click", function (e) {
        e.preventDefault();
        currentPage = i;
        renderView();
      });
      pagination.appendChild(li);
    }
  }

  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderView();
  });

  typeFilter.addEventListener("change", () => {
    currentPage = 1;
    renderView();
  });

  renderView();
});
</script>
{% endblock %}
