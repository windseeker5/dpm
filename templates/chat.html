{% extends "base.html" %}
{% block title %}ChatBot Analytics | Minipass{% endblock %}
{% block content %}

<div class="container-xl">
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          ðŸ¤– ChatBot Analytics
        </h2>
      </div>
    </div>
  </div>

  <form method="POST" class="card mb-4" onsubmit="showLoading()">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Select LLM Model</label>
        <select class="form-select" name="model">
          {% for model in models %}
            <option value="{{ model }}" {% if selected_model == model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Ask a question (English or French)</label>
        <input type="text" name="question" class="form-control" placeholder="e.g., Montre-moi les 10 derniÃ¨res passes crÃ©Ã©es aujourd'hui." value="{{ question or '' }}" required>
      </div>
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
  </form>

  <!-- ðŸ‘‡ LLM Loading Feedback -->
  <div id="loader" class="alert alert-info d-none" role="alert">
    ðŸ§  Thinking... Generating SQL with {{ selected_model or 'LLM' }}. Please wait.
  </div>

  {% if sql %}
  <div class="card mb-4">
    <div class="card-header">
      <strong>ðŸ§  SQL Generated</strong>
    </div>
    <div class="card-body">
      <code>{{ sql }}</code>
    </div>
  </div>
  {% endif %}

  {% if result %}
    {% if result.error %}
      <div class="alert alert-danger">
        <strong>Error:</strong> {{ result.error }}
      </div>
    {% elif result.rows %}
      <div class="card">
        <div class="card-header">
          <strong>ðŸ“Š Result</strong>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-striped">
            <thead>
              <tr>
                {% for col in result.columns %}
                  <th>{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in result.rows %}
                <tr>
                  {% for cell in row %}
                    <td>{{ cell }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning">
        No results returned.
      </div>
    {% endif %}
  {% endif %}

  {% if chart_data and chart_type %}
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>ðŸ“ˆ Chart Preview ({{ chart_type | capitalize }})</strong>
      <div>
        <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadChartImage()">ðŸ“¸ PNG</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="downloadCSV()">ðŸ“„ CSV</button>
      </div>
    </div>
    <div class="card-body">
      <canvas id="resultChart" height="120"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById("resultChart").getContext("2d");
    const labels = {{ chart_data["labels"]|tojson }};
    const values = {{ chart_data["values"]|tojson }};

    const chart = new Chart(ctx, {
      type: "{{ chart_type }}",
      data: {
        labels: labels,
        datasets: [{
          label: "Total",
          data: values,
          borderWidth: 1,
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59, 130, 246, 0.3)"
        }]
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const val = context.parsed.y;
                return `ðŸ’° ${val.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 60,
              minRotation: 45,
              autoSkip: true
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return `$${value}`;
              }
            }
          }
        }
      }
    });

    function downloadChartImage() {
      const link = document.createElement("a");
      link.download = "chart.png";
      link.href = document.getElementById("resultChart").toDataURL("image/png");
      link.click();
    }

    function downloadCSV() {
      let csv = "Label,Value\n";
      for (let i = 0; i < labels.length; i++) {
        csv += `${labels[i]},${values[i]}\n`;
      }
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "chart_data.csv";
      link.click();
    }

    function showLoading() {
      const loader = document.getElementById("loader");
      if (loader) {
        loader.classList.remove("d-none");
      }
    }
  </script>
  {% endif %}

</div>

{% endblock %}
