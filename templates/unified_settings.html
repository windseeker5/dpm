{% extends "base.html" %}
{% block title %}Settings | Minipass{% endblock %}
{% block content %}

<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <h1 class="page-title mb-0"><i class="ti ti-settings fs-1 text-muted me-2"></i>Settings</h1>
        </div>
        <div class="d-flex align-items-center">
          <button type="submit" class="btn btn-success" form="unified-settings-form">
            <i class="ti ti-device-floppy me-2"></i>
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">
      <form method="POST" enctype="multipart/form-data" id="unified-settings-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Organization Settings Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Organization Settings</h2>
            <div class="mb-3">
              <label class="form-label">Organization Name</label>
              <input type="text" name="ORG_NAME" class="form-control" value="{{ settings.get('ORG_NAME', '') }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Call-Back Delay (days) if unpaid</label>
              <input type="number" name="CALL_BACK_DAYS" class="form-control" min="0" value="{{ settings.get('CALL_BACK_DAYS', '15') }}">
              <div class="form-text">
                Test late payment reminders for unpaid passports beyond this delay
                <a href="/admin/unified-settings?test_late_payment=1" class="btn btn-sm btn-warning" style="margin-left: 10px;">Test Late Payment Reminders</a>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Upload Logo</label>
              <div class="mb-2">
                <img id="logo-preview" 
                     src="{{ url_for('static', filename='uploads/' ~ settings.LOGO_FILENAME) if settings.LOGO_FILENAME else '' }}" 
                     alt="Logo Preview"
                     style="max-height: 80px; display: {{ 'block' if settings.LOGO_FILENAME else 'none' }};">
              </div>
              <input type="file" name="ORG_LOGO_FILE" class="form-control" accept="image/*" id="logo-file-input">
            </div>
          </div>
        </div>

        <!-- Email Configuration Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Email Configuration</h2>
            
            <div class="mb-3">
              <label class="form-label">Default Sender Email</label>
              <input type="email" class="form-control" name="mail_default_sender" value="{{ settings.MAIL_DEFAULT_SENDER or '' }}" required>
              <div class="form-text">The email address used as sender for all outgoing emails</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Sender Name</label>
              <input type="text" class="form-control" name="mail_sender_name" value="{{ settings.MAIL_SENDER_NAME or '' }}" placeholder="e.g., LHGI, Your Organization">
              <div class="form-text">The display name shown in email clients (e.g., "LHGI &lt;lhgi@minipass.me&gt;")</div>
            </div>

            <!-- Advanced Server Settings (Improved) -->
            <div class="mt-4">
              <div class="border rounded">
                <button class="btn btn-link w-100 text-start p-3 text-decoration-none text-dark d-flex justify-content-between align-items-center" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapseAdvanced" 
                        aria-expanded="false" 
                        aria-controls="collapseAdvanced">
                  <span class="fw-medium">
                    <i class="ti ti-server me-2"></i>
                    Advanced Server Settings
                  </span>
                  <i class="ti ti-chevron-down" id="chevron-icon"></i>
                </button>
                <div id="collapseAdvanced" class="collapse">
                  <div class="border-top p-3">
                    <div class="mb-3">
                      <label class="form-label">Mail Server</label>
                      <input type="text" class="form-control" name="mail_server" value="{{ settings.MAIL_SERVER or '' }}" required>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Mail Port</label>
                      <input type="number" class="form-control" name="mail_port" value="{{ settings.MAIL_PORT or '587' }}" required>
                    </div>

                    <div class="form-check mb-3">
                      <input type="checkbox" class="form-check-input" name="mail_use_tls" id="mail_use_tls" {% if settings.MAIL_USE_TLS == 'True' %}checked{% endif %}>
                      <label class="form-check-label" for="mail_use_tls">Use TLS</label>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Email Username</label>
                      <input type="email" class="form-control" name="mail_username" value="{{ settings.MAIL_USERNAME or '' }}" required>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Email Password</label>
                      <input type="password" class="form-control" name="mail_password_raw" value="{{ settings.get('MAIL_PASSWORD', '') }}" autocomplete="off">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Bot Configuration Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Payment Bot Configuration</h2>
            
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" name="enable_email_payment_bot" id="enable_email_payment_bot" {% if settings.ENABLE_EMAIL_PAYMENT_BOT == 'True' %}checked{% endif %}>
              <label class="form-check-label" for="enable_email_payment_bot">Enable Email Payment Bot</label>
            </div>

            <div id="email-bot-config" style="display: {% if settings.ENABLE_EMAIL_PAYMENT_BOT == 'True' %}block{% else %}none{% endif %};">
              <!-- Information Alert with Very Light Background -->
              <div class="alert alert-info mb-3" style="background-color: #f0f9ff; border-color: #e0f2fe;">
                <div class="d-flex">
                  <div>
                    <i class="ti ti-info-circle alert-icon text-info"></i>
                  </div>
                  <div>
                    <h4 class="alert-title">How Payment Bot Works</h4>
                    <div class="text-muted">
                      The payment bot automatically processes incoming e-transfer notifications by:
                      <ul class="mb-0 mt-2">
                        <li>Monitoring incoming payment emails</li>
                        <li>Matching sender name with valid passport holders using fuzzy matching</li>
                        <li>Verifying payment amount matches passport price</li>
                        <li>Automatically processing matched payments</li>
                        <li>Moving processed emails to designated folder</li>
                        <li>Bot validates payment emails every 30 minutes 
                            <a href="/admin/unified-settings?test_payment_bot=1" class="btn btn-sm btn-primary" style="margin-left: 10px;">Test Now</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Payment Email Display -->
              <div class="alert alert-success mb-3">
                <div class="d-flex">
                  <div>
                    <i class="ti ti-mail me-2"></i>
                  </div>
                  <div>
                    <h4 class="alert-title">Payment Email Address</h4>
                    <div class="text-muted">{{ settings.MAIL_USERNAME or 'Not configured - please set Email Username in Advanced Settings' }}</div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Email Sender (e.g., notify@yourbank)</label>
                <input type="text" class="form-control" name="bank_email_from" value="{{ settings.BANK_EMAIL_FROM or 'notify@payments.interac.ca' }}">
                <div class="form-text">The email address that sends payment notifications</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Email Subject to Match</label>
                <input type="text" class="form-control" name="bank_email_subject" value="{{ settings.BANK_EMAIL_SUBJECT or 'Virement Interac :' }}">
                <div class="form-text">Subject line to identify payment emails</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Fuzzy Match Threshold: <span id="threshold-value">{{ settings.BANK_EMAIL_NAME_CONFIDANCE or '85' }}</span>%</label>
                <input type="range" class="form-range" name="bank_email_name_confidance" 
                       value="{{ settings.BANK_EMAIL_NAME_CONFIDANCE or '85' }}" 
                       min="0" max="100" id="threshold-slider">
                <div class="form-text">Minimum confidence percentage for name matching</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Database Maintenance Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Database Maintenance</h2>

            <div class="mb-3">
              <label class="form-label fw-bold">Clean Duplicate Payment Logs</label>
              <div class="form-text mb-2">Remove duplicate "Payment No Match" log entries caused by email processing glitches. This keeps only the latest entry for each unique payment.</div>
              <button type="button" class="btn btn-warning" onclick="cleanDuplicateLogs()">
                <i class="ti ti-trash me-1"></i>Clean Duplicate Payment Logs
              </button>
            </div>
          </div>
        </div>

        <!-- Bottom Save Button -->
        <div class="d-flex justify-content-end mb-3">
          <button type="submit" class="btn btn-success">
            <i class="ti ti-device-floppy me-2"></i>
            Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Unified Settings JavaScript -->
<script src="{{ url_for('static', filename='js/unified-settings.js') }}?v=2.2"></script>
<script>
// Add chevron rotation for Advanced Server Settings
document.addEventListener('DOMContentLoaded', function() {
    const collapseElement = document.getElementById('collapseAdvanced');
    const chevronIcon = document.getElementById('chevron-icon');
    
    if (collapseElement && chevronIcon) {
        collapseElement.addEventListener('show.bs.collapse', function () {
            chevronIcon.style.transform = 'rotate(180deg)';
            chevronIcon.style.transition = 'transform 0.3s ease';
        });
        
        collapseElement.addEventListener('hide.bs.collapse', function () {
            chevronIcon.style.transform = 'rotate(0deg)';
            chevronIcon.style.transition = 'transform 0.3s ease';
        });
    }
    
    // Initialize payment bot test functionality
    console.log('Initializing payment bot test...');
    initializePaymentBotTest();
});
</script>
{% endblock %}

{% block head %}
<!-- Settings page uses dashboard-container for consistent alignment -->
<style>
/* Import dashboard container styles if not already available */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

/* Match dashboard card styling */
.card {
  background: rgba(255, 255, 255, 0.95) !important;
  border: none !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
  border-radius: 0.5rem !important;
}

/* Clean alert styling */
.alert-icon {
  font-size: 1.25rem;
}

/* Advanced Server Settings improved styling */
#collapseAdvanced .border-top {
  background-color: #f8f9fa;
}
</style>
{% endblock %}