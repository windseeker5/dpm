{% extends "base.html" %}
{% block title %}Settings | Minipass{% endblock %}
{% block content %}

<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <h1 class="page-title mb-0"><i class="ti ti-settings fs-1 text-muted me-2"></i>Settings</h1>
        </div>
        <div class="d-flex align-items-center">
          <button type="submit" class="btn btn-success" form="unified-settings-form">
            <i class="ti ti-device-floppy me-2"></i>
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">
      <form method="POST" enctype="multipart/form-data" id="unified-settings-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Organization Settings Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Organization Settings</h2>
            <div class="mb-3">
              <label class="form-label">Organization Name</label>
              <input type="text" name="ORG_NAME" class="form-control" value="{{ settings.get('ORG_NAME', '') }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Call-Back Delay (days) if unpaid</label>
              <input type="number" name="CALL_BACK_DAYS" class="form-control" min="0" value="{{ settings.get('CALL_BACK_DAYS', '15') }}">
              <div class="form-text">
                Test late payment reminders for unpaid passports beyond this delay
                <a href="/admin/unified-settings?test_late_payment=1" class="btn btn-sm btn-warning" style="margin-left: 10px;">Test Late Payment Reminders</a>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Organization Logo</label>
              <div class="position-relative d-inline-block mb-2" id="logoWrapper">
                {% if settings.get('LOGO_FILENAME') %}
                  <img id="logo-preview"
                       src="{{ url_for('static', filename='uploads/' ~ settings.LOGO_FILENAME) }}"
                       class="rounded" style="width: 80px; height: 80px; object-fit: contain; background: #f8f9fa;">
                  <span class="position-absolute top-0 end-0 badge bg-danger rounded-circle p-2"
                        style="cursor: pointer;" id="deleteLogoBtn">
                    <i class="ti ti-x text-white" style="font-size: 14px;"></i>
                  </span>
                {% else %}
                  <div id="logo-preview" class="rounded bg-secondary-lt d-flex flex-column align-items-center justify-content-center"
                       style="width: 80px; height: 80px;">
                    <i class="ti ti-photo text-muted fs-2"></i>
                    <small class="text-muted">No logo</small>
                  </div>
                {% endif %}
              </div>
              <input type="hidden" name="delete_logo" id="deleteLogoFlag" value="">
              <input type="file" name="ORG_LOGO_FILE" class="form-control" accept="image/*" id="logo-file-input">
            </div>
          </div>
        </div>

        <!-- Email Configuration Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Email Configuration</h2>
            
            <div class="mb-3">
              <label class="form-label">Default Sender Email</label>
              <input type="email" class="form-control" name="mail_default_sender" value="{{ settings.get('MAIL_DEFAULT_SENDER', '') }}" required>
              <div class="form-text">The email address used as sender for all outgoing emails</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Sender Name</label>
              <input type="text" class="form-control" name="mail_sender_name" value="{{ settings.get('MAIL_SENDER_NAME', '') }}" placeholder="e.g., LHGI, Your Organization">
              <div class="form-text">The display name shown in email clients (e.g., "LHGI &lt;lhgi@minipass.me&gt;")</div>
            </div>

            <!-- Advanced Server Settings (Improved) -->
            <div class="mt-4">
              <div class="border rounded">
                <button class="btn btn-link w-100 text-start p-3 text-decoration-none text-dark d-flex justify-content-between align-items-center" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapseAdvanced" 
                        aria-expanded="false" 
                        aria-controls="collapseAdvanced">
                  <span class="fw-medium">
                    <i class="ti ti-server me-2"></i>
                    Advanced Server Settings
                  </span>
                  <i class="ti ti-chevron-down" id="chevron-icon"></i>
                </button>
                <div id="collapseAdvanced" class="collapse">
                  <div class="border-top p-3">
                    <div class="mb-3">
                      <label class="form-label">Mail Server</label>
                      <input type="text" class="form-control" name="mail_server" value="{{ settings.get('MAIL_SERVER', '') }}" required>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Mail Port</label>
                      <input type="number" class="form-control" name="mail_port" value="{{ settings.get('MAIL_PORT', '587') }}" required>
                    </div>

                    <div class="form-check mb-3">
                      <input type="checkbox" class="form-check-input" name="mail_use_tls" id="mail_use_tls" {% if settings.get('MAIL_USE_TLS') == 'True' %}checked{% endif %}>
                      <label class="form-check-label" for="mail_use_tls">Use TLS</label>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Email Username</label>
                      <input type="email" class="form-control" name="mail_username" value="{{ settings.get('MAIL_USERNAME', '') }}" required>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Email Password</label>
                      <input type="password" class="form-control" name="mail_password_raw" value="{{ settings.get('MAIL_PASSWORD', '') }}" autocomplete="off">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Bot Configuration Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4">Payment Bot Configuration</h2>
            
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" name="enable_email_payment_bot" id="enable_email_payment_bot" {% if settings.ENABLE_EMAIL_PAYMENT_BOT == 'True' %}checked{% endif %}>
              <label class="form-check-label" for="enable_email_payment_bot">Enable Email Payment Bot</label>
            </div>

            <div id="email-bot-config" style="display: {% if settings.ENABLE_EMAIL_PAYMENT_BOT == 'True' %}block{% else %}none{% endif %};">
              <!-- Information Alert with Very Light Background -->
              <div class="alert alert-info mb-3" style="background-color: #f0f9ff; border-color: #e0f2fe;">
                <div class="d-flex">
                  <div>
                    <i class="ti ti-info-circle alert-icon text-info"></i>
                  </div>
                  <div>
                    <h4 class="alert-title">How Payment Bot Works</h4>
                    <div class="text-muted">
                      The payment bot automatically processes incoming e-transfer notifications by:
                      <ul class="mb-0 mt-2">
                        <li>Monitoring incoming payment emails</li>
                        <li>Matching sender name with valid passport holders using fuzzy matching</li>
                        <li>Verifying payment amount matches passport price</li>
                        <li>Automatically processing matched payments</li>
                        <li>Moving processed emails to designated folder</li>
                        <li>Bot validates payment emails every 30 minutes 
                            <a href="/admin/unified-settings?test_payment_bot=1" class="btn btn-sm btn-primary" style="margin-left: 10px;">Test Now</a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Payment Email Display -->
              <div class="alert alert-success mb-3">
                <div class="d-flex">
                  <div>
                    <i class="ti ti-mail me-2"></i>
                  </div>
                  <div>
                    <h4 class="alert-title">Payment Email Address (Inbox)</h4>
                    <div class="text-muted">{{ settings.MAIL_USERNAME or 'Not configured - please set Email Username in Advanced Settings' }}</div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Display Payment Email (Optional)</label>
                <input type="email" class="form-control" name="display_payment_email"
                       value="{{ settings.DISPLAY_PAYMENT_EMAIL or '' }}"
                       placeholder="Leave empty to use the inbox email above">
                <small class="form-hint">
                  If set, this email will appear in payment instructions sent to users.
                  Useful when you have a legacy email that forwards to your inbox.
                </small>
              </div>

              <div class="mb-3">
                <label class="form-label">Email Sender (e.g., notify@yourbank)</label>
                <input type="text" class="form-control" name="bank_email_from" value="{{ settings.BANK_EMAIL_FROM or 'notify@payments.interac.ca' }}">
                <div class="form-text">The email address that sends payment notifications</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Email Subject to Match</label>
                <input type="text" class="form-control" name="bank_email_subject" value="{{ settings.BANK_EMAIL_SUBJECT or 'Virement Interac :' }}">
                <div class="form-text">Subject line to identify payment emails</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Fuzzy Match Threshold: <span id="threshold-value">{{ settings.BANK_EMAIL_NAME_CONFIDANCE or '85' }}</span>%</label>
                <input type="range" class="form-range" name="bank_email_name_confidance" 
                       value="{{ settings.BANK_EMAIL_NAME_CONFIDANCE or '85' }}" 
                       min="0" max="100" id="threshold-slider">
                <div class="form-text">Minimum confidence percentage for name matching</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Credit Card Payments (Stripe) Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <div class="border rounded">
              <button class="btn btn-link w-100 text-start p-3 text-decoration-none text-dark d-flex justify-content-between align-items-center"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseStripe"
                      aria-expanded="false"
                      aria-controls="collapseStripe">
                <h2 class="mb-0">
                  <i class="ti ti-credit-card me-2"></i>
                  Credit Card Settings (Stripe)
                </h2>
                <i class="ti ti-chevron-down" id="stripe-chevron-icon"></i>
              </button>
              <div id="collapseStripe" class="collapse">
                <div class="border-top p-3">

                  <!-- Enable toggle (always visible when section is expanded) -->
                  <div class="mb-3">
                    <label class="form-check form-switch">
                      <input class="form-check-input" type="checkbox"
                             name="stripe_payments_enabled"
                             id="stripe_payments_enabled"
                             {% if stripe_payments_enabled %}checked{% endif %}>
                      <span class="form-check-label">Enable Credit Card Payments</span>
                    </label>
                    <div class="form-text">When enabled, activities can accept payment by credit card via Stripe Checkout.</div>
                  </div>

                  <!-- Key fields: only shown when toggle is ON -->
                  <div id="stripe-key-fields"
                       style="display: {% if stripe_payments_enabled %}block{% else %}none{% endif %};">

                    {% if stripe_payments_enabled and not settings.STRIPE_PAYMENTS_SECRET_KEY %}
                    <div class="alert alert-warning mb-3">
                      <div class="d-flex">
                        <div><i class="ti ti-alert-triangle alert-icon me-2"></i></div>
                        <div>
                          <h4 class="alert-title">Secret Key Required</h4>
                          <div class="text-secondary">Credit card payments are enabled but no Stripe Secret Key is saved yet. Enter your key below to activate payments in activities.</div>
                        </div>
                      </div>
                    </div>
                    {% endif %}

                    <div class="alert alert-info mb-3">
                      <div class="d-flex">
                        <div><i class="ti ti-brand-stripe alert-icon me-2"></i></div>
                        <div>
                          <h4 class="alert-title">Accept Credit Cards via Stripe</h4>
                          <div class="text-secondary">Let customers pay by credit card for your activities. Requires a <a href="https://dashboard.stripe.com/apikeys" target="_blank" rel="noopener">Stripe account</a>. Once configured, you can enable credit card payments per activity.</div>
                        </div>
                      </div>
                    </div>

                    <!-- Webhook URL (Read-only with copy button) -->
                    <div class="mb-3">
                      <label class="form-label">Webhook URL</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="stripeWebhookUrl" value="{{ webhook_url }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText(document.getElementById('stripeWebhookUrl').value); this.innerHTML='<i class=\'ti ti-check\'></i>'; setTimeout(() => this.innerHTML='<i class=\'ti ti-copy\'></i>', 2000)">
                          <i class="ti ti-copy"></i>
                        </button>
                      </div>
                      <div class="form-text">Copy this URL into your Stripe webhook endpoint settings. Configure it to send <code>checkout.session.completed</code> and <code>payout.paid</code> events. See the <a href="https://minipass.me/docs/how-to-setup-stripe" target="_blank" rel="noopener">setup guide</a> for step-by-step instructions.</div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Secret Key</label>
                      <input type="text" class="form-control" name="stripe_payments_secret_key"
                             value="{{ settings.STRIPE_PAYMENTS_SECRET_KEY or '' }}"
                             placeholder="sk_test_... or sk_live_...">
                      <div class="form-text">Your Stripe Secret Key from the API keys page. Leave blank to keep existing value.</div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Webhook Secret</label>
                      <input type="text" class="form-control" name="stripe_webhook_secret"
                             value="{{ settings.STRIPE_WEBHOOK_SECRET or '' }}"
                             placeholder="whsec_...">
                      <div class="form-text">Your Stripe Webhook Signing Secret. Leave blank to keep existing value.</div>
                    </div>

                  </div><!-- /#stripe-key-fields -->

                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Push Notifications Card -->
        <div class="card bg-white mb-3">
          <div class="card-body">
            <h2 class="mb-4"><i class="ti ti-bell-ringing me-2"></i>Push Notifications</h2>

            <div class="alert alert-info mb-3" style="background-color: #f0f9ff; border-color: #e0f2fe;">
              <div class="d-flex">
                <div>
                  <i class="ti ti-device-mobile alert-icon text-info me-2"></i>
                </div>
                <div>
                  <h4 class="alert-title">Real-time Alerts</h4>
                  <div class="text-muted">
                    Get instant notifications on your device when:
                    <ul class="mb-0 mt-1">
                      <li>Someone signs up for an activity</li>
                      <li>A payment is automatically matched</li>
                      <li>A payment needs manual review (no match)</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="push-notifications-toggle" style="width: 3em; height: 1.5em;">
              <label class="form-check-label ms-2" for="push-notifications-toggle" style="font-size: 1.1rem;">
                Enable Push Notifications
              </label>
            </div>

            <div id="push-status" class="text-muted small"></div>

            <!-- iOS Warning (hidden by default, shown via JS if on iOS) -->
            <div id="ios-push-warning" class="alert alert-warning mt-3" style="display: none;">
              <i class="ti ti-brand-apple me-2"></i>
              <strong>iOS Note:</strong> Push notifications require iOS 16.4+ and the app must be
              added to your home screen ("Add to Home Screen" in Safari).
            </div>
          </div>
        </div>

        <!-- Bottom Save Button -->
        <div class="d-flex justify-content-end mb-3">
          <button type="submit" class="btn btn-success">
            <i class="ti ti-device-floppy me-2"></i>
            Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Unified Settings JavaScript -->
<script src="{{ url_for('static', filename='js/unified-settings.js') }}?v=3.0"></script>
<!-- Push Notifications Module -->
<script src="{{ url_for('static', filename='js/push-notifications.js') }}?v=1.0"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chevron rotation for Advanced Server Settings
    const collapseElement = document.getElementById('collapseAdvanced');
    const chevronIcon = document.getElementById('chevron-icon');
    if (collapseElement && chevronIcon) {
        collapseElement.addEventListener('show.bs.collapse', () => chevronIcon.style.transform = 'rotate(180deg)');
        collapseElement.addEventListener('hide.bs.collapse', () => chevronIcon.style.transform = 'rotate(0deg)');
    }

    // Chevron rotation for Stripe Settings
    const collapseStripe = document.getElementById('collapseStripe');
    const stripeChevron = document.getElementById('stripe-chevron-icon');
    if (collapseStripe && stripeChevron) {
        collapseStripe.addEventListener('show.bs.collapse', () => stripeChevron.style.transform = 'rotate(180deg)');
        collapseStripe.addEventListener('hide.bs.collapse', () => stripeChevron.style.transform = 'rotate(0deg)');
    }

    // Push Notifications Toggle
    const pushToggle = document.getElementById('push-notifications-toggle');
    const pushStatus = document.getElementById('push-status');
    const iosWarning = document.getElementById('ios-push-warning');

    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        iosWarning.style.display = 'block';
    }

    if (typeof MinipassPush !== 'undefined') {
        MinipassPush.initToggle(pushToggle, pushStatus);
    }
});
</script>
{% endblock %}

{% block head %}
<!-- Settings page uses dashboard-container for consistent alignment -->
<style>
/* Import dashboard container styles if not already available */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

/* Match dashboard card styling */
.card {
  background: rgba(255, 255, 255, 0.95) !important;
  border: none !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
  border-radius: 0.5rem !important;
}

/* Clean alert styling */
.alert-icon {
  font-size: 1.25rem;
}

/* Advanced Server Settings improved styling */
#collapseAdvanced .border-top,
#collapseStripe .border-top {
  background-color: #f8f9fa;
}
</style>
{% endblock %}