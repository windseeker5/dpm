{% extends "base.html" %}
{% block title %}Survey Management{% endblock %}

{% block head %}
<!-- Note: Search component styles loaded via base.html -->
<style>
/* NO HOVER EFFECTS - per CLAUDE.md constraints */
.survey-card {
  background-color: #fff !important;
}
.survey-actions {
  opacity: 1 !important;
}

/* Force dropdown menu right edge to align with button right edge */
.page-header .dropdown {
  position: relative;
}

.page-header .dropdown-menu-end[data-popper-placement] {
  right: 0 !important;
  left: auto !important;
}


/* White background for all cards and tables */
.card {
  background-color: #fff !important;
}

.table {
  background-color: #fff !important;
}

.survey-card {
  background-color: #fff !important;
}

.survey-table {
  background-color: #fff !important;
}

/* Modal touch targets for mobile */
.modal .btn {
  min-height: 44px;
}

.modal .form-control {
  min-height: 44px;
}

.modal .form-select {
  min-height: 44px;
}

/* Form buttons in dropdowns should look like dropdown items */
.dropdown-menu form {
  margin: 0;
}

.dropdown-menu button.dropdown-item {
  border: none;
  background: none;
  text-align: left;
  width: 100%;
  padding: 0.375rem 1rem;
}

.dropdown-menu button.dropdown-item:hover {
  background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none" style="padding-top: 2rem;">
    <div class="dashboard-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="page-title mb-0"><i class="ti ti-clipboard-check text-blue me-2"></i>Surveys</h1>
        <div class="dropdown">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Actions
          </button>
          <div class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#quickSurveyModal">
              <i class="ti ti-plus me-2"></i>Create Survey
            </a>
            <a class="dropdown-item" href="{{ url_for('list_survey_templates') }}">
              <i class="ti ti-edit me-2"></i>Edit Templates
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">

    <!-- Enhanced Dynamic Search -->
    <form method="GET" action="{{ url_for('list_surveys') }}" class="mb-4" id="dynamicSearchForm">
      <div class="input-icon position-relative">
        <span class="input-icon-addon">
          <i class="ti ti-search fs-3"></i>
        </span>
        <input type="text" 
               name="q"
               id="enhancedSearchInput"
               class="form-control form-control-lg shadow-sm" 
               placeholder="Start typing to search surveys instantly..." 
               value="{{ current_filters.q or '' }}"
               style="padding-right: 100px; border-radius: 0.5rem;"
               autocomplete="off"
               data-bs-toggle="false">
        <div class="position-absolute end-0 top-50 translate-middle-y me-3 d-flex align-items-center gap-2">
          <small id="searchCharCounter" class="text-muted" style="font-size: 0.75rem; display: none;"></small>
          <kbd id="searchKbdHint" class="text-muted">ctrl + k</kbd>
          <button id="searchClearBtn" type="button" class="btn btn-link p-0 border-0" style="display: none; width: 24px; height: 24px;" aria-label="Clear search">
            <i class="ti ti-x" style="font-size: 18px; color: #6c757d;"></i>
          </button>
        </div>
      </div>
    </form>

    <!-- Main Table -->
    <div class="card main-table-card" style="margin-top: 1.5rem !important;">
      <div class="card-header">
        <div class="d-flex justify-content-center align-items-center w-100">
          <!-- Filter Buttons -->
          <div class="github-filter-group" role="group" aria-label="Filter buttons" style="display: inline-flex; align-items: center; background: #f6f8fa; border: 1px solid #d1d5da; border-radius: 6px; padding: 0;">
            <a href="{{ url_for('list_surveys', status='active') }}"
               class="github-filter-btn {% if current_filters.status == 'active' and not current_filters.show_all %}active{% endif %}">
              <i class="ti ti-activity"></i>Active <span class="filter-count">({{ statistics.active_surveys }})</span>
            </a>
            <a href="{{ url_for('list_surveys', status='closed') }}"
               class="github-filter-btn {% if current_filters.status == 'closed' %}active{% endif %}">
              <i class="ti ti-pause"></i>Closed <span class="filter-count">({{ statistics.closed_surveys|default(0) }})</span>
            </a>
            <a href="{{ url_for('list_surveys', show_all='true') }}"
               class="github-filter-btn {% if current_filters.show_all %}active{% endif %}">
              <i class="ti ti-list"></i>All <span class="filter-count">({{ statistics.total_surveys }})</span>
            </a>
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover">
        <thead>
          <tr>
            <th>Survey</th>
            <th class="d-none d-md-table-cell">Created</th>
            <th class="d-none d-md-table-cell">Activity</th>
            <th class="d-none d-md-table-cell">Status</th>
            <th class="d-none d-md-table-cell">Sent/Completed</th>
            <th class="d-none d-md-table-cell">Completion Rate</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for survey in surveys %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                {% if survey.activity and survey.activity.image_filename %}
                <div class="avatar avatar-md me-3" style="background-image: url({{ url_for('static', filename='uploads/activity_images/' + survey.activity.image_filename) }}); background-size: cover; background-position: center; border-radius: 8px;"></div>
                {% else %}
                <div class="avatar avatar-md me-3" style="background-color: #e0e0e0; border-radius: 8px;">
                  <i class="ti ti-clipboard-check text-muted"></i>
                </div>
                {% endif %}
                <div>
                  <strong>{{ survey.name }}</strong>
                  <div class="text-muted small">{{ survey.template.name if survey.template else 'No template' }}</div>
                </div>
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              <div class="small">
                {{ survey.created_dt.strftime('%Y-%m-%d') }}
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              <strong>{{ survey.activity.name if survey.activity else '-' }}</strong>
              {% if survey.passport_type %}
              <br><span class="text-muted small">{{ survey.passport_type.name }} participants</span>
              {% endif %}
            </td>
            <td class="d-none d-md-table-cell">
              {% if survey.status == 'active' %}
              <span class="badge bg-green-lt text-green">Active</span>
              {% elif survey.status == 'closed' %}
              <span class="badge bg-red-lt text-red">Closed</span>
              {% else %}
              <span class="badge bg-gray-lt text-gray">{{ survey.status|title }}</span>
              {% endif %}
            </td>
            <td class="d-none d-md-table-cell">
              <strong>{{ survey.invitation_count }} invited</strong>
              {% if survey.completed_count > 0 %}
              <br><span class="text-success small">{{ survey.completed_count }} completed</span>
              {% endif %}
            </td>
            <td class="d-none d-md-table-cell">
              {% if survey.invitation_count > 0 %}
              <strong>{{ "%.1f"|format(survey.completion_rate) }}%</strong>
              {% else %}
              <span class="text-muted">No invitations</span>
              {% endif %}
            </td>
            <td class="text-center" style="vertical-align: middle;">
              <div class="dropdown d-inline-block">
                <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  <span class="d-none d-md-inline">Actions</span>
                  <i class="ti ti-menu-2 d-md-none"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="{{ url_for('take_survey', survey_token=survey.survey_token) }}" target="_blank">
                    <i class="ti ti-external-link me-2"></i>View Survey
                  </a>
                  <a class="dropdown-item" href="{{ url_for('survey_results', survey_id=survey.id) }}">
                    <i class="ti ti-chart-bar me-2"></i>View Results
                  </a>
                  {% if survey.status == 'active' %}
                  <form method="POST" action="{{ url_for('send_survey_invitations', survey_id=survey.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="dropdown-item" onclick="return confirmSendInvitations({{ survey.id }}, '{{ survey.name }}', '{{ survey.activity.name if survey.activity else 'Unknown' }}')">
                      <i class="ti ti-mail me-2"></i>Send Invitations
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('send_survey_invitations', survey_id=survey.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="resend_all" value="true">
                    <button type="submit" class="dropdown-item" onclick="return confirmResendAll({{ survey.id }}, '{{ survey.name }}')">
                      <i class="ti ti-refresh me-2"></i>Resend All Invitations
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('close_survey', survey_id=survey.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="dropdown-item" onclick="return confirmCloseSurvey({{ survey.id }}, '{{ survey.name }}')">
                      <i class="ti ti-pause me-2"></i>Close Survey
                    </button>
                  </form>
                  {% elif survey.status == 'closed' %}
                  <form method="POST" action="{{ url_for('reopen_survey', survey_id=survey.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="dropdown-item" onclick="return confirmReopenSurvey('{{ survey.name }}')">
                      <i class="ti ti-play me-2"></i>Reopen Survey
                    </button>
                  </form>
                  {% endif %}
                  {% if survey.responses %}
                  <a class="dropdown-item" href="{{ url_for('export_survey_results', survey_id=survey.id) }}">
                    <i class="ti ti-download me-2"></i>Export Results
                  </a>
                  {% endif %}
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item text-danger" href="#" onclick="confirmDelete({{ survey.id }}, '{{ survey.name }}'); return false;">
                    <i class="ti ti-trash me-2"></i>Delete Survey
                  </a>
                </div>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-center py-5">
              <div class="empty">
                <div class="empty-img">
                  <i class="ti ti-clipboard-check" style="font-size: 4rem; color: #ccc;"></i>
                </div>
                <p class="empty-title">No surveys found</p>
                <p class="empty-subtitle text-muted">
                  {% if current_filters.q or current_filters.status or current_filters.activity or current_filters.template %}
                    Try adjusting your search filters or <a href="{{ url_for('list_surveys') }}">clear all filters</a>
                  {% else %}
                    Get started by creating a survey using one of your templates, or create a new template
                  {% endif %}
                </p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      
      <!-- Pagination -->
      <div class="card-footer d-flex justify-content-between align-items-center">
        {% if pagination and pagination.total > 0 %}
          <span class="text-muted">Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to {{ ((pagination.page - 1) * pagination.per_page) + surveys|length }} of {{ pagination.total }} entries</span>
          {% if pagination.pages > 1 %}
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <!-- Previous page -->
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                  {% if pagination.has_prev %}
                    <a class="page-link" href="{{ url_for(request.endpoint, page=pagination.prev_num, **current_filters) }}" aria-label="Previous">
                      <i class="ti ti-chevron-left"></i>
                    </a>
                  {% else %}
                    <span class="page-link" aria-label="Previous">
                      <i class="ti ti-chevron-left"></i>
                    </span>
                  {% endif %}
                </li>
                
                <!-- Page numbers -->
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                  {% if page_num %}
                    {% if page_num != pagination.page %}
                      <li class="page-item">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=page_num, **current_filters) }}">{{ page_num }}</a>
                      </li>
                    {% else %}
                      <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                      </li>
                    {% endif %}
                  {% else %}
                    <li class="page-item disabled">
                      <span class="page-link">…</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                <!-- Next page -->
                <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                  {% if pagination.has_next %}
                    <a class="page-link" href="{{ url_for(request.endpoint, page=pagination.next_num, **current_filters) }}" aria-label="Next">
                      <i class="ti ti-chevron-right"></i>
                    </a>
                  {% else %}
                    <span class="page-link" aria-label="Next">
                      <i class="ti ti-chevron-right"></i>
                    </span>
                  {% endif %}
                </li>
              </ul>
            </nav>
          {% endif %}
        {% elif surveys|length > 0 %}
          <span class="text-muted">Showing {{ surveys|length }} of {{ surveys|length }} entries</span>
        {% else %}
          <span class="text-muted">No entries found</span>
        {% endif %}
      </div>
      </div>
    </div>

    </div>
  </div>
</div>

<!-- Quick Survey Creation Modal -->
<div class="modal modal-blur fade" id="quickSurveyModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-zap me-2 text-success"></i>Create Quick Survey
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('create_quick_survey') }}" id="quickSurveyForm">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Template Selection -->
          <div class="mb-4">
            <label class="form-label required">Select Survey Template</label>
            <select name="template_id" class="form-select form-select-lg" required id="templateSelect">
              <option value="">Choose a template...</option>
              {% for template in survey_templates %}
              <option value="{{ template.id }}"
                      data-questions="{{ template.question_count }}"
                      data-name="{{ template.name }}"
                      data-description="{{ template.description }}"
                      {% if template.name == 'Post-Activity Feedback' %}selected{% endif %}>
                {{ template.name }} ({{ template.question_count }} questions)
              </option>
              {% endfor %}
            </select>
            <div class="form-hint" id="templateHint">Choose a template for your survey questions</div>
          </div>

          <!-- Template Preview Alert -->
          <div class="alert alert-info d-none" id="templatePreviewAlert">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <strong id="selectedTemplateName">Post-Activity Feedback</strong>
                <div class="text-muted small mt-1" id="selectedTemplateDescription">Standard post-activity feedback survey</div>
              </div>
              <button type="button" class="btn btn-outline-info btn-sm" onclick="previewSelectedTemplate()">
                <i class="ti ti-eye me-1"></i>Preview
              </button>
            </div>
          </div>

          <!-- Survey Name -->
          <div class="mb-4">
            <label class="form-label required">Survey Name</label>
            <input type="text" name="survey_name" class="form-control form-control-lg"
                   placeholder="e.g., Yoga Session Feedback"
                   required maxlength="100" id="surveyNameInput">
            <div class="form-hint">Give your survey a clear, descriptive name</div>
          </div>

          <!-- Activity Selection -->
          <div class="mb-4">
            <label class="form-label required">Select Activity</label>
            <select name="activity_id" class="form-select form-select-lg" required id="activitySelect">
              <option value="">Choose an activity...</option>
              {% for activity in activities %}
              <option value="{{ activity.id }}">{{ activity.name }}</option>
              {% endfor %}
            </select>
            <div class="form-hint">The survey will be sent to participants of this activity</div>
          </div>
          
          <!-- Preview Section -->
          <div class="card d-none" id="surveyPreview">
            <div class="card-header">
              <h4 class="card-title">Survey Preview</h4>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <strong>Survey:</strong> <span id="previewSurveyName">-</span>
              </div>
              <div class="mb-3">
                <strong>Activity:</strong> <span id="previewActivityName">-</span>
              </div>
              <div class="mb-3">
                <strong>Template:</strong> Post-Activity Feedback (4 questions)
              </div>
              <div class="alert alert-info">
                <i class="ti ti-info-circle me-2"></i>
                <strong>Next steps after creation:</strong>
                <ul class="mb-0 mt-2">
                  <li>Review survey questions</li>
                  <li>Send invitations to participants</li>
                  <li>Monitor responses in real-time</li>
                  <li>Export results when complete</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success" id="createBtn" disabled>
            <i class="ti ti-check me-1"></i>Create Survey
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Template Preview Modal -->
<div class="modal modal-blur fade" id="templatePreviewModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-template me-2"></i>Post-Activity Feedback Template
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          <i class="ti ti-star me-2"></i>
          This is our recommended template for gathering feedback after activities.
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-start mb-2">
              <span class="badge bg-success me-2">1</span>
              <div class="flex-grow-1">
                <h6 class="card-title mb-1">How would you rate your overall experience with this activity?</h6>
                <div class="text-muted small mb-2">Type: Multiple Choice • Required</div>
                <div class="ms-3">
                  <div class="text-muted small">• Excellent</div>
                  <div class="text-muted small">• Very Good</div>
                  <div class="text-muted small">• Good</div>
                  <div class="text-muted small">• Fair</div>
                  <div class="text-muted small">• Poor</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-start mb-2">
              <span class="badge bg-success me-2">2</span>
              <div class="flex-grow-1">
                <h6 class="card-title mb-1">What did you enjoy most about this activity?</h6>
                <div class="text-muted small mb-2">Type: Open-ended • Optional</div>
                <div class="text-muted small">Maximum 500 characters</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-start mb-2">
              <span class="badge bg-success me-2">3</span>
              <div class="flex-grow-1">
                <h6 class="card-title mb-1">Is there anything you would like us to improve?</h6>
                <div class="text-muted small mb-2">Type: Open-ended • Optional</div>
                <div class="text-muted small">Maximum 500 characters</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-start mb-2">
              <span class="badge bg-success me-2">4</span>
              <div class="flex-grow-1">
                <h6 class="card-title mb-1">Would you recommend this activity to others?</h6>
                <div class="text-muted small mb-2">Type: Multiple Choice • Required</div>
                <div class="ms-3">
                  <div class="text-muted small">• Definitely Yes</div>
                  <div class="text-muted small">• Probably Yes</div>
                  <div class="text-muted small">• Not Sure</div>
                  <div class="text-muted small">• Probably No</div>
                  <div class="text-muted small">• Definitely No</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal modal-blur fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the survey <strong id="deleteSurveyName"></strong>?</p>
        <p class="text-muted">This action cannot be undone and will delete all responses.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="deleteForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">Delete Survey</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Send Invitations Confirmation Modal -->
<div class="modal modal-blur fade" id="sendInvitationsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-mail me-2"></i>Send Survey Invitations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Send survey invitations for <strong id="sendInvitationsSurveyName"></strong>?</p>
        <div class="alert alert-info mb-2">
          <i class="ti ti-info-circle me-2"></i>
          <strong>This will send email invitations to all participants of "<span id="sendInvitationsActivityName"></span>" who haven't been invited yet.</strong>
        </div>
        <p class="text-muted small mb-0">Note: Only new participants will receive invitations.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="sendInvitationsForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-primary"><i class="ti ti-mail me-2"></i>Send Invitations</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Resend All Invitations Confirmation Modal -->
<div class="modal modal-blur fade" id="resendAllModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-refresh me-2"></i>Resend All Invitations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Resend ALL invitations for <strong id="resendAllSurveyName"></strong>?</p>
        <div class="alert alert-warning mb-2">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>This will send invitations to ALL participants, including those who have already been invited.</strong>
        </div>
        <p class="text-muted small mb-0"><i class="ti ti-alert-circle me-1"></i>Caution: Participants may receive duplicate emails.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="resendAllForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="resend_all" value="true">
          <button type="submit" class="btn btn-warning"><i class="ti ti-refresh me-2"></i>Resend All</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Close Survey Confirmation Modal -->
<div class="modal modal-blur fade" id="closeSurveyModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-pause me-2"></i>Close Survey</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Close survey <strong id="closeSurveyName"></strong>?</p>
        <div class="alert alert-info mb-2">
          <i class="ti ti-info-circle me-2"></i>
          <strong>This will:</strong>
          <ul class="mb-0 mt-2">
            <li>Stop accepting new responses</li>
            <li>Make the survey inactive</li>
            <li>Prevent sending more invitations</li>
          </ul>
        </div>
        <p class="text-muted small mb-0">You can reopen it later if needed.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" id="closeSurveyForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-warning"><i class="ti ti-pause me-2"></i>Close Survey</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search component
    if (window.SearchComponent) {
        window.SearchComponent.init({
            formId: 'dynamicSearchForm',
            inputId: 'enhancedSearchInput',
            preserveParams: ['status', 'activity']
        });
    }

    // Initialize filter component
    if (window.FilterComponent) {
        window.FilterComponent.init({
            filterClass: 'github-filter-btn',
            mode: 'server',
            preserveScrollPosition: true,
            enableSearchPreservation: true
        });
    }
});


// Delete confirmation
function confirmDelete(surveyId, surveyName) {
  document.getElementById('deleteSurveyName').textContent = surveyName;
  document.getElementById('deleteForm').action = `/delete-survey/${surveyId}`;
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Initialize tooltips and other Bootstrap components
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Add better visual feedback for buttons
  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-1px)';
    });
    btn.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
  
  // Quick survey form validation
  const surveyNameInput = document.getElementById('surveyNameInput');
  const activitySelect = document.getElementById('activitySelect');
  const templateSelect = document.getElementById('templateSelect');
  const createBtn = document.getElementById('createBtn');
  const templatePreviewAlert = document.getElementById('templatePreviewAlert');
  const selectedTemplateName = document.getElementById('selectedTemplateName');
  const selectedTemplateDescription = document.getElementById('selectedTemplateDescription');

  function validateQuickSurveyForm() {
    const hasName = surveyNameInput && surveyNameInput.value.trim().length > 0;
    const hasActivity = activitySelect && activitySelect.value;
    const hasTemplate = templateSelect && templateSelect.value;
    const isValid = hasName && hasActivity && hasTemplate;

    if (createBtn) createBtn.disabled = !isValid;

    return isValid;
  }

  // Template selection handler
  if (templateSelect) {
    templateSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (this.value) {
        // Show template preview alert
        templatePreviewAlert.classList.remove('d-none');
        selectedTemplateName.textContent = selectedOption.dataset.name;
        selectedTemplateDescription.textContent = selectedOption.dataset.description || 'Survey template';
      } else {
        // Hide template preview alert
        templatePreviewAlert.classList.add('d-none');
      }
      validateQuickSurveyForm();
    });

    // Trigger change event on load if there's a selected template
    if (templateSelect.value) {
      templateSelect.dispatchEvent(new Event('change'));
    }
  }

  if (surveyNameInput) {
    surveyNameInput.addEventListener('input', validateQuickSurveyForm);
  }
  if (activitySelect) {
    activitySelect.addEventListener('change', validateQuickSurveyForm);
  }
});

// Quick survey modal functions
function showPreview() {
  const surveyName = document.getElementById('surveyNameInput').value.trim();
  const activitySelect = document.getElementById('activitySelect');
  const templateSelect = document.getElementById('templateSelect');
  const activityName = activitySelect.options[activitySelect.selectedIndex].text;
  const templateName = templateSelect.options[templateSelect.selectedIndex].text;

  document.getElementById('previewSurveyName').textContent = surveyName;
  document.getElementById('previewActivityName').textContent = activityName;

  const previewCard = document.getElementById('surveyPreview');
  previewCard.classList.remove('d-none');

  // Smooth scroll to preview
  previewCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function previewSelectedTemplate() {
  const templateSelect = document.getElementById('templateSelect');
  if (!templateSelect || !templateSelect.value) {
    return;
  }

  const templateId = templateSelect.value;
  const templateName = templateSelect.options[templateSelect.selectedIndex].dataset.name;

  try {
    // Fetch template data from API
    const response = await fetch(`/api/survey-template/${templateId}`);
    if (!response.ok) {
      throw new Error('Failed to fetch template');
    }

    const templateData = await response.json();

    // Build preview HTML
    let previewHTML = `
      <div class="modal modal-blur fade show" style="display: block; background: rgba(0,0,0,0.5);" id="dynamicTemplatePreview">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="ti ti-template me-2"></i>${templateData.name}
              </h5>
              <button type="button" class="btn-close" onclick="document.getElementById('dynamicTemplatePreview').remove()"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                <i class="ti ti-info-circle me-2"></i>${templateData.description}
              </div>
    `;

    templateData.questions.forEach((q, index) => {
      const questionNum = index + 1;
      const requiredBadge = q.required ? '<span class="badge bg-red-lt ms-2">Required</span>' : '<span class="badge bg-gray-lt ms-2">Optional</span>';

      previewHTML += `
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-start">
              <span class="badge bg-primary text-white me-3" style="font-size: 1.1rem; padding: 0.5rem 0.75rem; font-weight: 600;">${questionNum}</span>
              <div class="flex-grow-1">
                <h6 class="mb-1">${q.question || q.text || 'Question'}</h6>
                <div class="text-muted small mb-2">
                  Type: ${q.type.replace('_', ' ')} ${requiredBadge}
                </div>
      `;

      if (q.type === 'multiple_choice' && q.options) {
        previewHTML += '<div class="ms-3">';
        q.options.forEach(opt => {
          const optionText = typeof opt === 'string' ? opt : (opt.text || opt.value || opt);
          previewHTML += `<div class="text-muted small">• ${optionText}</div>`;
        });
        previewHTML += '</div>';
      } else if (q.type === 'rating') {
        previewHTML += `<div class="text-muted small mb-2">Rating scale: ${q.min_rating || 1} to ${q.max_rating || 5}</div>`;
        if (q.labels) {
          previewHTML += '<div class="ms-3">';
          for (let i = q.min_rating || 1; i <= (q.max_rating || 5); i++) {
            const label = q.labels[i] || q.labels[i.toString()] || '';
            previewHTML += `<div class="text-muted small">⭐ ${i}${label ? ' - ' + label : ''}</div>`;
          }
          previewHTML += '</div>';
        }
      } else if (q.type === 'open_ended' || q.type === 'text') {
        previewHTML += `<div class="text-muted small">Open text response (max ${q.max_length || 500} characters)</div>`;
      }

      previewHTML += `
              </div>
            </div>
          </div>
        </div>
      `;
    });

    previewHTML += `
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="document.getElementById('dynamicTemplatePreview').remove()">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Insert modal into page
    document.body.insertAdjacentHTML('beforeend', previewHTML);

  } catch (error) {
    alert('Error loading template preview: ' + error.message);
  }
}

function showQuickPreview() {
  new bootstrap.Modal(document.getElementById('templatePreviewModal')).show();
}

// Reset modal when closed
document.getElementById('quickSurveyModal').addEventListener('hidden.bs.modal', function() {
  // Reset form
  document.getElementById('quickSurveyForm').reset();
  document.getElementById('surveyPreview').classList.add('d-none');
  document.getElementById('templatePreviewAlert').classList.add('d-none');

  // Reset button states
  const createBtn = document.getElementById('createBtn');
  createBtn.disabled = true;
  createBtn.innerHTML = '<i class="ti ti-check me-1"></i>Create Survey';
});

// NO JAVASCRIPT NEEDED - Bootstrap handles it all!

// Direct form submission with loading state (no confirmation modal)
document.getElementById('quickSurveyForm').addEventListener('submit', function(e) {
  // Show loading state immediately
  const createBtn = document.getElementById('createBtn');

  if (createBtn.disabled) {
    // Already submitting
    e.preventDefault();
    return false;
  }

  createBtn.disabled = true;
  createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating Survey...';

  // Allow form to submit normally
  return true;
});

// Enhanced confirmation functions using Bootstrap modals
function confirmSendInvitations(surveyId, surveyName, activityName) {
  document.getElementById('sendInvitationsSurveyName').textContent = surveyName;
  document.getElementById('sendInvitationsActivityName').textContent = activityName;
  document.getElementById('sendInvitationsForm').action = `/send-survey-invitations/${surveyId}`;
  new bootstrap.Modal(document.getElementById('sendInvitationsModal')).show();
  return false; // Prevent form submission
}

function confirmResendAll(surveyId, surveyName) {
  document.getElementById('resendAllSurveyName').textContent = surveyName;
  document.getElementById('resendAllForm').action = `/send-survey-invitations/${surveyId}`;
  new bootstrap.Modal(document.getElementById('resendAllModal')).show();
  return false; // Prevent form submission
}

function confirmCloseSurvey(surveyId, surveyName) {
  document.getElementById('closeSurveyName').textContent = surveyName;
  document.getElementById('closeSurveyForm').action = `/close-survey/${surveyId}`;
  new bootstrap.Modal(document.getElementById('closeSurveyModal')).show();
  return false; // Prevent form submission
}

function confirmReopenSurvey(surveyName) {
  return confirm(`Reopen survey "${surveyName}"?\n\nThis will:\n• Allow new responses again\n• Make the survey active\n• Enable sending invitations`);
}

</script>
{% endblock %}
{% block styles %}
<style>
/* Enhanced Card Design - NO HOVER EFFECTS per CLAUDE.md */
.card {
  background-color: #fff !important;
  border: none !important;
  border-radius: 16px !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* Statistics Cards Enhancement */
.card .card-body {
  padding: 1.75rem 1.5rem;
  position: relative;
}

.card .text-blue {
  color: #3b82f6 !important;
  font-weight: 700;
}

.card .text-green {
  color: #10b981 !important;
  font-weight: 700;
}

.card .text-yellow {
  color: #f59e0b !important;
  font-weight: 700;
}

.card .text-primary {
  color: #6366f1 !important;
  font-weight: 700;
}

.card .h2 {
  font-weight: 700;
  font-size: 1.75rem;
  line-height: 1.2;
  margin-bottom: 0.5rem;
}

.card .text-muted.small {
  font-weight: 500;
  letter-spacing: 0.5px;
  font-size: 0.875rem;
  color: #64748b;
}

/* Page Header Styling */
.page-header {
  background: transparent;
  border: none;
  margin-bottom: 2rem;
}

.page-title {
  font-weight: 700;
  color: #0f172a;
  font-size: 2.25rem;
  line-height: 1.2;
  margin-bottom: 0.5rem;
}

/* Enhanced Table Styling */
.table {
  background-color: transparent !important;
}

.table th {
  border-bottom: 2px solid #e2e8f0;
  font-weight: 600;
  color: #475569;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1rem;
}

.table td {
  border-bottom: 1px solid #f1f5f9;
  padding: 1rem;
  color: #334155;
  vertical-align: middle;
}

.table tbody tr:hover {
  background-color: rgba(13, 110, 253, 0.04);
}

/* Enhanced search styling */
#enhancedSearchInput {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#enhancedSearchInput:focus {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15), 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Component styles loaded via base.html */

/* Mobile dropdown fix - make menu wider to show full text */
@media (max-width: 767.98px) {
  .page-header .dropdown-menu {
    min-width: 220px !important; /* Increased to fit "Manage Templates" */
    white-space: nowrap !important;
  }

  .page-header .dropdown-menu .dropdown-item {
    white-space: nowrap !important;
    overflow: visible !important;
    text-overflow: clip !important;
    min-width: 100% !important;
  }
}

/* Enhanced Dropdown Improvements */
.dropdown-menu {
  z-index: 1060 !important;
  min-width: 200px;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  border: 1px solid rgba(0, 0, 0, 0.125);
  border-radius: 8px;
  transform-origin: top right;
  transition: opacity 0.15s ease, transform 0.15s ease;
  position: absolute !important;
}

.dropdown-menu .dropdown-item {
  white-space: nowrap !important;
  padding: 0.5rem 1rem;
  overflow: visible !important;
  text-overflow: clip !important;
}

/* CRITICAL: Force proper dropdown positioning in tables */
.table .dropdown-menu {
  position: absolute !important;
  top: 100% !important;
  right: 0 !important;
  left: auto !important;
  transform: none !important;
  margin: 0 !important;
  z-index: 1060 !important;
}

/* CRITICAL: Force all parent containers to allow overflow when dropdown is open */
.dropdown.show {
  position: relative;
  z-index: 1000;
}

/* Ensure table cells don't clip dropdown content */
.table td:has(.dropdown.show),
.table th:has(.dropdown.show) {
  overflow: visible !important;
  position: relative;
  z-index: 1061;
}

/* Legacy support for browsers without :has() */
.table td.dropdown-open,
.table th.dropdown-open {
  overflow: visible !important;
  position: relative;
  z-index: 1061;
}

/* Ensure dropdown positioning within table cells */
.table .dropdown {
  position: relative;
}

/* Mobile dropdown fix - ensure full text is visible */
@media (max-width: 767px) {
  /* CRITICAL: Allow overflow for page header to show dropdown */
  .page-header,
  .page-header > div,
  .page-header .row,
  .page-header .col-auto {
    overflow: visible !important;
    position: relative !important;
  }

  /* Fix for ALL dropdowns on mobile, especially page header */
  .dropdown {
    position: relative !important;
    overflow: visible !important;
  }

  /* Critical: Force ALL dropdown menus to be properly positioned on mobile */
  .dropdown-menu,
  .dropdown-menu.dropdown-menu-end,
  .page-header .dropdown-menu,
  .page-header .dropdown-menu.dropdown-menu-end {
    position: absolute !important;
    top: 100% !important;
    right: 0 !important;
    bottom: auto !important;
    left: auto !important;
    margin-top: 0.125rem !important;
    margin-right: 0 !important;
    margin-bottom: 0 !important;
    margin-left: 0 !important;
    min-width: 250px !important; /* Increased to ensure full text fits */
    max-width: none !important;
    transform: none !important;
    inset: unset !important;
    width: 250px !important; /* Fixed width */
    white-space: nowrap !important;
    z-index: 9999 !important; /* Very high z-index to ensure it appears above everything */
    overflow: visible !important;
  }

  /* Ensure dropdown items don't wrap or truncate */
  .dropdown-menu .dropdown-item,
  .page-header .dropdown-menu .dropdown-item {
    white-space: nowrap !important;
    font-size: 14px !important;
    padding: 0.5rem 1rem !important;
    display: block !important;
    width: 100% !important;
    min-width: 100% !important;
    overflow: visible !important;
    text-overflow: clip !important;
    max-width: none !important;
  }

  /* Force table dropdowns to work properly on mobile */
  .table .dropdown-menu {
    position: absolute !important;
    top: 100% !important;
    right: 0 !important;
    left: auto !important;
    transform: none !important;
    margin: 0 !important;
    min-width: 200px !important;
    z-index: 1060 !important;
  }
}

.dropdown.show .dropdown-menu {
  display: block !important;
  opacity: 1;
  transform: scale(1);
  z-index: 1060 !important;
}

.dropdown .dropdown-menu {
  opacity: 0;
  transform: scale(0.95);
}

/* Empty State */
.empty {
  padding: 2rem 1rem;
  text-align: center;
}

.empty-icon {
  font-size: 3rem;
  color: #64748b;
  margin-bottom: 1rem;
}

.empty-title {
  font-size: 1.25rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.empty-subtitle {
  color: #64748b;
}

/* Dashboard Container */
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

/* Page structure matching signups.html */
.page-wrapper {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.page-body {
  padding: 2rem 0;
}

/* Responsive Design */
@media (max-width: 767px) {
  .dashboard-container {
    padding: 0 1rem;
  }
  
  .page-title {
    font-size: 1.75rem;
  }
  
  .bulk-actions-card .card-body {
    padding: 0.875rem 1rem !important;
  }
}
</style>
{% endblock %}