{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<style>
  .table-responsive {
    overflow: visible !important;
    position: relative;
  }
  .table-responsive .dropdown {
    position: relative;
  }
  .table-responsive .dropdown-menu {
    z-index: 1060;
  }
</style>

<!-- ðŸ”µ Activity Title Card -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h1 class="card-title mb-2">{{ activity.name }}</h1>
        <p class="text-muted">{{ activity.description }}</p>
      </div>
      <div>
        <a href="{{ url_for('edit_activity', activity_id=activity.id) }}"
           class="btn btn-outline-primary">
          <i class="ti ti-pencil"></i> Edit Activity
        </a>
      </div>
    </div>
  </div>
</div>





<!-- ðŸŸ¢ Signups Table (pending only) -->
{% set pending_signups = signups | selectattr('status', 'equalto', 'pending') | list %}
{% if pending_signups %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title">Activity Signups (Pending)</h3>
    <span class="badge bg-yellow-lt">{{ pending_signups|length }} pending</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table card-table table-vcenter" id="signupTable">


        <thead>
          <tr>
            <th>Name</th>
            <th class="d-none d-md-table-cell">Activity</th>
            <th class="d-none d-md-table-cell">Email</th>
            <th class="d-none d-md-table-cell">Signup Date</th>
            <th class="d-none d-md-table-cell">Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        

        <tbody>
          {% for s in pending_signups %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <span class="avatar me-2 rounded"
                      style="background-image:url('https://www.gravatar.com/avatar/{{ s.user.email|lower|trim|encode_md5 }}?d=identicon')">
                </span>
                {{ s.user.name }}
              </div>
            </td>
            <td class="d-none d-md-table-cell">{{ s.activity.name if s.activity else '-' }}</td>

            <td class="d-none d-md-table-cell">{{ s.user.email }}</td>
            <td class="d-none d-md-table-cell">{{ s.signed_up_at.strftime('%Y-%m-%d') }}</td>

          
            <td class="d-none d-md-table-cell">
              {% if s.paid %}
                <span class="badge bg-green-lt">Paid</span>
              {% else %}
                <span class="badge bg-red-lt">Unpaid</span>
              {% endif %}
            </td>



            <td>
              <div class="dropdown">
                <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  Actions
                </a>
                <div class="dropdown-menu">
                  <a class="dropdown-item text-success"
                     href="{{ url_for('approve_and_create_pass', signup_id=s.id) }}">
                    <i class="ti ti-check me-2"></i>Approve & Create Passport
                  </a>
                  <form method="POST"
                        action="{{ url_for('update_signup_status', signup_id=s.id) }}">
                    <input type="hidden" name="status" value="rejected">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="dropdown-item text-danger" type="submit">
                      <i class="ti ti-x me-2"></i>Reject
                    </button>
                  </form>
                  <form method="POST"
                        action="{{ url_for('update_signup_status', signup_id=s.id) }}">
                    <input type="hidden" name="status" value="cancelled">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="dropdown-item text-warning" type="submit">
                      <i class="ti ti-ban me-2"></i>Cancel
                    </button>
                  </form>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}




<!-- ðŸ”Ž Search + Add New -->
<div class="card mb-3">
  <div class="card-body">
    <h3 class="card-title mb-3"><i class="ti ti-filter me-2"></i>Manage Passes</h3>
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-auto">
        <a href="{{ url_for('create_passport') }}" class="btn btn-primary w-100 w-md-auto">
          <i class="ti ti-plus"></i> Add New
        </a>
      </div>
      <div class="col-12 col-md-auto">
        <a href="{{ url_for('scan_qr') }}" class="btn btn-secondary w-100 w-md-auto">
          <i class="ti ti-scan"></i> Scan Pass
        </a>
      </div>
      <div class="col-12 col-md">
        <div class="input-icon">
          <span class="input-icon-addon"><i class="ti ti-search"></i></span>
          <input type="text" id="searchBox" class="form-control" placeholder="Search by User Name..." />
        </div>
      </div>
    </div>
  </div>
</div>




{# ------------------------------ #}
{# ðŸ›‚ Passport Table (refactored) #}
{# ------------------------------ #}

{% if passes %}
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="card-title">Active or Unpaid Passports</h3>
      <span class="badge bg-green-lt">{{ passes|length }} total</span>
    </div>
    <div class="table-responsive">
      {# Macro for POST actions with CSRF + confirm #}
      {% macro action_button(url, icon, label, btn_class, confirm_msg) %}
      <form method="POST"
            action="{{ url }}"
            onsubmit="return confirm('{{ confirm_msg }}');"
            class="m-0 p-0">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="dropdown-item {{ btn_class }}" type="submit">
          <i class="{{ icon }} me-2"></i>{{ label }}
        </button>
      </form>
      {% endmacro %}

      <table class="table card-table table-vcenter" id="passportTable">

        
        <thead>
          <tr>
            <th>User</th>
            <th class="d-none d-md-table-cell">Activity</th>
            <th class="d-none d-md-table-cell">Created</th>
            <th class="d-none d-md-table-cell">Remaining</th>
            <th class="d-none d-md-table-cell">Status</th>
            <th>Actions</th>
          </tr>
        </thead>
               
        
        <tbody>
          {% for p in passes %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <span class="avatar me-2 rounded"
                      style="background-image: url('https://www.gravatar.com/avatar/{{ p.user.email|lower|trim|encode_md5 }}?d=identicon')">
                </span>
                {{ p.user.name }}
              </div>
            </td>
            <td class="d-none d-md-table-cell">{{ p.activity.name if p.activity else '-' }}</td>

            <td class="d-none d-md-table-cell">{{ p.created_dt.strftime('%Y-%m-%d') }}</td>
            <td class="d-none d-md-table-cell">{{ p.uses_remaining }}</td>

            
            <td class="d-none d-md-table-cell">
              {% if p.paid %}
                <span class="badge bg-green-lt">Paid</span>
              {% else %}
                <span class="badge bg-red-lt">Unpaid</span>
              {% endif %}
            </td>




            <td>
              <div class="dropdown">
                {# Toggle #}
                <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  Actions
                </a>
                <div class="dropdown-menu" style="z-index:1050;">
                  {# Redeem #}
                  {{ action_button(
                       url_for('redeem_passport', pass_code=p.pass_code),
                       'ti ti-check',
                       'Redeem',
                       'text-primary',
                       'Redeem 1 session for ' ~ p.user.name ~ '?' ) }}
                  {# Edit #}
                  <a class="dropdown-item" href="{{ url_for('edit_passport', passport_id=p.id) }}">
                    <i class="ti ti-pencil me-2"></i>Edit
                  </a>
                  {# Mark Paid if needed #}
                  {% if not p.paid %}
                    {{ action_button(
                         url_for('mark_passport_paid', passport_id=p.id),
                         'ti ti-currency-dollar',
                         'Mark as Paid',
                         'text-success',
                         'Mark this passport as paid?' ) }}
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="alert alert-warning text-center mt-4">
    No active or unpaid passports found for this activity.
  </div>
{% endif %}

{% endblock %}

{% block scripts %}

 
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('searchBox');
    const passportTable = document.getElementById('passportTable').getElementsByTagName('tbody')[0];

    searchBox.addEventListener('input', function() {
        const filter = searchBox.value.toLowerCase();
        const rows = passportTable.getElementsByTagName('tr');

        Array.from(rows).forEach(function(row) {
            const username = row.querySelector('td').innerText.toLowerCase();
            if (username.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    const rowsPerPage = 10;
    let currentPage = 1;

    function paginateTable(tableBody) {
        const rows = tableBody.getElementsByTagName('tr');
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        function renderPage(page) {
            Array.from(rows).forEach((row, index) => {
                if (index >= (page - 1) * rowsPerPage && index < page * rowsPerPage) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function createPaginationControls() {
            const card = tableBody.closest('.card');
            const cardFooter = document.createElement('div');
            cardFooter.className = 'card-footer d-flex align-items-center';

            const paginationContainer = document.createElement('ul');
            paginationContainer.className = 'pagination m-0 ms-auto';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');

                const button = document.createElement('a');
                button.className = 'page-link';
                button.href = '#';
                button.textContent = i;
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = i;
                    updatePagination();
                });

                li.appendChild(button);
                paginationContainer.appendChild(li);
            }

            cardFooter.appendChild(paginationContainer);
            card.appendChild(cardFooter);
        }

        function updatePagination() {
            renderPage(currentPage);
            const paginationButtons = document.querySelectorAll('.pagination .page-item');
            paginationButtons.forEach((item, index) => {
                item.classList.toggle('active', index === currentPage - 1);
            });
        }

        renderPage(currentPage);
        createPaginationControls();
    }

    paginateTable(passportTable);
});
</script>
 





{% endblock %}
