{% extends "base.html" %}

{% block title %}Activity Dashboard - {{ activity.name }}{% endblock %}

{% block content %}
<style>
/* Fix dropdown z-index issues in tables */
.table-responsive {
  overflow: visible !important;
  position: static !important;
}
.table-responsive .dropdown {
  position: relative;
}
.table-responsive .dropdown-menu {
  z-index: 9999 !important;
  position: absolute !important;
  transform: none !important;
  top: 100% !important;
  min-width: 160px;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
.table-responsive .dropdown-menu.dropdown-menu-end {
  right: 0 !important;
  left: auto !important;
}

/* Ensure cards with dropdowns don't clip dropdowns */
.table-responsive .card,
.card:has(.dropdown-menu) {
  overflow: visible !important;
}

/* Fix card footer background to white per style guide */
.card-footer {
  background-color: #fff !important;
  border-top: 1px solid rgba(98, 105, 118, 0.16);
}

/* Add proper table padding for alignment with card margins */
.table-responsive .table td:first-child {
  padding-left: 1.5rem !important;
}
.table-responsive .table td:last-child {
  padding-right: 1.5rem !important;
}
.table-responsive .table th:first-child {
  padding-left: 1.5rem !important;
}
.table-responsive .table th:last-child {
  padding-right: 1.5rem !important;
}

/* Mobile scroll snap styles for KPI cards */
.d-flex.overflow-auto {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.d-flex.overflow-auto::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}


/* Mobile scroll indicators */
@media (max-width: 767.98px) {
  .flex-shrink-0 {
    scroll-snap-align: start;
  }
}
</style>

<div class="page-wrapper">

  <div class="page-body">
    <div class="dashboard-container">
      <!-- Split Layout Header with Activity Image -->
      <div class="activity-header-split">
        <div class="row g-4 align-items-center">
          <div class="col-lg-7">
            <div class="activity-info">
              <h1 class="activity-title">{{ activity.name }}</h1>
              <p class="activity-description">{{ activity.description or "No description provided." }}{% if activity.start_date %} â€¢ {{ activity.start_date.strftime('%b %d') }}{% if activity.end_date %} - {{ activity.end_date.strftime('%b %d, %Y') }}{% endif %}{% endif %}</p>
              <div class="activity-actions">
                <a href="{{ url_for('edit_activity', activity_id=activity.id) }}" class="btn btn-primary">
                  <i class="ti ti-edit me-2"></i>Edit Activity
                </a>
                <a href="{{ url_for('scan_qr') }}" class="btn btn-success ms-2">
                  <i class="ti ti-scan me-2"></i>Scan Activity
                </a>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="activity-image-card">
              <img src="{{ url_for('static', filename='uploads/activity_images/' ~ (activity.image_filename or 'placeholder.jpg')) }}" 
                   class="activity-featured-image" 
                   alt="{{ activity.name }}">
              <div class="image-overlay">
                <button class="btn btn-sm btn-ghost-light">
                  <i class="ti ti-camera me-1"></i>Change Image
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Section - Desktop Layout -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- Revenue Card -->
        <div class="col-md-3 mb-3">
          <div class="card kpi-card-rounded">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">REVENUE</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="revenue-value">${{ "{:.0f}".format(kpi_data.revenue.total|float) }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'success' if kpi_data.revenue.trend == 'up' else 'muted' }} me-2" id="revenue-trend">{{ "{:.0f}".format(kpi_data.revenue.percentage|float) }}% <i class="ti ti-trending-{{ kpi_data.revenue.trend }}"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="revenue-chart">
                  <!-- Chart will be populated by JavaScript -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Users Card -->
        <div class="col-md-3 mb-3">
          <div class="card kpi-card-rounded">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVE USERS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="active-users-value">{{ kpi_data.active_users.total }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'success' if kpi_data.active_users.trend == 'up' else 'muted' }} me-2" id="active-users-trend">{{ kpi_data.active_users.percentage }}% <i class="ti ti-trending-{{ kpi_data.active_users.trend }}"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="active-users-chart">
                  <!-- Bar chart for active users -->
                  <rect x="10" y="28" width="8" height="12" fill="#206bc4" opacity="0.8" />
                  <rect x="25" y="25" width="8" height="15" fill="#206bc4" opacity="0.8" />
                  <rect x="40" y="30" width="8" height="10" fill="#206bc4" opacity="0.8" />
                  <rect x="55" y="22" width="8" height="18" fill="#206bc4" opacity="0.8" />
                  <rect x="70" y="26" width="8" height="14" fill="#206bc4" opacity="0.8" />
                  <rect x="85" y="20" width="8" height="20" fill="#206bc4" opacity="0.8" />
                  <rect x="100" y="15" width="8" height="25" fill="#206bc4" opacity="0.8" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Unpaid Passports Card -->
        <div class="col-md-3 mb-3">
          <div class="card kpi-card-rounded">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">UNPAID PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="unpaid-passports-value">{{ kpi_data.unpaid_passports.total }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'danger' if kpi_data.unpaid_passports.overdue > 0 else 'muted' }} me-2" id="unpaid-passports-trend">{{ kpi_data.unpaid_passports.overdue }} overdue <i class="ti ti-alert-circle"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="unpaid-passports-chart">
                  <!-- Bar chart for unpaid passports -->
                  <rect x="10" y="30" width="8" height="10" fill="#f76707" opacity="0.8" />
                  <rect x="25" y="28" width="8" height="12" fill="#f76707" opacity="0.8" />
                  <rect x="40" y="32" width="8" height="8" fill="#f76707" opacity="0.8" />
                  <rect x="55" y="26" width="8" height="14" fill="#f76707" opacity="0.8" />
                  <rect x="70" y="24" width="8" height="16" fill="#f76707" opacity="0.8" />
                  <rect x="85" y="29" width="8" height="11" fill="#f76707" opacity="0.8" />
                  <rect x="100" y="27" width="8" height="13" fill="#f76707" opacity="0.8" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity Profit Card -->
        <div class="col-md-3 mb-3">
          <div class="card kpi-card-rounded">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVITY PROFIT</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="profit-value">${{ "{:.0f}".format(kpi_data.profit.total|float) }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'success' if kpi_data.profit.trend == 'up' else 'muted' }} me-2" id="profit-trend">{{ "{:.0f}".format(kpi_data.profit.margin|float) }}% margin <i class="ti ti-trending-{{ kpi_data.profit.trend }}"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="profit-chart">
                  <!-- Chart will be populated by JavaScript -->
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Section - Mobile Carousel -->
      <div class="d-md-none mb-4">
        <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
          <!-- Revenue Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card kpi-card-rounded">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">REVENUE</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1" id="mobile-revenue-value">${{ "{:.0f}".format(kpi_data.revenue.total|float) }}</div>
                <div class="d-flex align-items-center mb-3">
                  <div class="text-{{ 'success' if kpi_data.revenue.trend == 'up' else 'muted' }} me-2" id="mobile-revenue-trend">{{ "{:.0f}".format(kpi_data.revenue.percentage|float) }}% <i class="ti ti-trending-{{ kpi_data.revenue.trend }}"></i></div>
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-revenue-chart">
                    <!-- Chart will be populated by JavaScript -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Active Users Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card kpi-card-rounded">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">ACTIVE USERS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1" id="mobile-active-users-value">{{ kpi_data.active_users.total }}</div>
                <div class="d-flex align-items-center mb-3">
                  <div class="text-{{ 'success' if kpi_data.active_users.trend == 'up' else 'muted' }} me-2" id="mobile-active-users-trend">{{ kpi_data.active_users.percentage }}% <i class="ti ti-trending-{{ kpi_data.active_users.trend }}"></i></div>
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-active-users-chart">
                    <!-- Bar chart for active users -->
                    <rect x="10" y="28" width="8" height="12" fill="#206bc4" opacity="0.8" />
                    <rect x="25" y="25" width="8" height="15" fill="#206bc4" opacity="0.8" />
                    <rect x="40" y="30" width="8" height="10" fill="#206bc4" opacity="0.8" />
                    <rect x="55" y="22" width="8" height="18" fill="#206bc4" opacity="0.8" />
                    <rect x="70" y="26" width="8" height="14" fill="#206bc4" opacity="0.8" />
                    <rect x="85" y="20" width="8" height="20" fill="#206bc4" opacity="0.8" />
                    <rect x="100" y="15" width="8" height="25" fill="#206bc4" opacity="0.8" />
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Unpaid Passports Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card kpi-card-rounded">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">UNPAID PASSPORTS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1" id="mobile-unpaid-passports-value">{{ kpi_data.unpaid_passports.total }}</div>
                <div class="d-flex align-items-center mb-3">
                  <div class="text-{{ 'danger' if kpi_data.unpaid_passports.overdue > 0 else 'muted' }} me-2" id="mobile-unpaid-passports-trend">{{ kpi_data.unpaid_passports.overdue }} overdue <i class="ti ti-alert-circle"></i></div>
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-unpaid-passports-chart">
                    <!-- Bar chart for unpaid passports -->
                    <rect x="10" y="30" width="8" height="10" fill="#f76707" opacity="0.8" />
                    <rect x="25" y="28" width="8" height="12" fill="#f76707" opacity="0.8" />
                    <rect x="40" y="32" width="8" height="8" fill="#f76707" opacity="0.8" />
                    <rect x="55" y="26" width="8" height="14" fill="#f76707" opacity="0.8" />
                    <rect x="70" y="24" width="8" height="16" fill="#f76707" opacity="0.8" />
                    <rect x="85" y="29" width="8" height="11" fill="#f76707" opacity="0.8" />
                    <rect x="100" y="27" width="8" height="13" fill="#f76707" opacity="0.8" />
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Activity Profit Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card kpi-card-rounded">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">ACTIVITY PROFIT</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1" id="mobile-profit-value">${{ "{:.0f}".format(kpi_data.profit.total|float) }}</div>
                <div class="d-flex align-items-center mb-3">
                  <div class="text-{{ 'success' if kpi_data.profit.trend == 'up' else 'muted' }} me-2" id="mobile-profit-trend">{{ "{:.0f}".format(kpi_data.profit.margin|float) }}% margin <i class="ti ti-trending-{{ kpi_data.profit.trend }}"></i></div>
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-profit-chart">
                    <!-- Chart will be populated by JavaScript -->
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Scroll indicators -->
        <div class="text-center mt-2">
          <span class="badge bg-primary me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light" style="width: 8px; height: 8px; border-radius: 50%;"></span>
        </div>
      </div>

      <!-- Passport List Title -->
      {% if passes %}
      <h2 class="mt-4 mb-3">
        <i class="ti ti-activity-heartbeat me-2" style="color: #e03131;"></i>Your Activity Passport
      </h2>

      <!-- Search Bar -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div class="position-relative flex-fill me-3">
            <div class="input-icon">
              <span class="input-icon-addon">
                <i class="ti ti-search fs-3"></i>
              </span>
              <input type="text" id="userSearch" class="form-control shadow-sm" 
                     placeholder="Search passports and users..." 
                     style="padding-right: 80px; border-radius: 0.5rem; transition: all 0.3s ease;"
                     onfocus="this.style.boxShadow='0 0 0 0.25rem rgba(32, 107, 196, 0.15)'" 
                     onblur="this.style.boxShadow='0 0.125rem 0.25rem rgba(0,0,0,0.075)'">
              <span class="position-absolute end-0 top-50 translate-middle-y me-3 d-none d-md-block">
                <kbd class="text-muted">ctrl + k</kbd>
              </span>
            </div>
          </div>
          <div class="flex-shrink-0">
            <a href="{{ url_for('create_passport') }}" class="btn btn-primary">
              <i class="ti ti-plus me-1 me-md-1"></i><span class="d-none d-md-inline">Passport</span>
            </a>
          </div>
        </div>
      </div>



      <!-- Main Data Table (Responsive) -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="ti ti-passport me-2"></i>Digital Passes
          </h3>
        </div>
        <div class="table-responsive">
          <table class="table table-hover user-table">
            <thead>
              <tr>
                <th style="width: 300px;">User</th>
                <th class="d-md-none text-center">Remain</th>
                <th class="d-none d-md-table-cell">Activity</th>
                <th class="d-none d-md-table-cell text-center">Pass Type</th>
                <th class="d-none d-md-table-cell text-center">Created</th>
                <th class="d-none d-md-table-cell text-center">Remaining</th>
                <th class="d-none d-md-table-cell text-center">Status</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in passes %}
              <tr>
                <td style="vertical-align: middle;">
                  <div class="d-flex align-items-center">
                    <img src="https://www.gravatar.com/avatar/{{ p.user.email|lower|trim|encode_md5 }}?d=identicon&s=40" 
                         class="rounded-circle me-3 user-avatar d-none d-md-block" alt="Avatar">
                    <div>
                      <div class="fw-bold">{{ p.user.name }}</div>
                      <div class="text-muted small">{{ p.user.email }}</div>
                    </div>
                  </div>
                </td>
                <td class="d-md-none text-center" style="vertical-align: middle;">
                  <span class="badge bg-{{ 'green-lt' if p.paid else 'red-lt' }}">{{ p.uses_remaining }}</span>
                </td>
                <td class="d-none d-md-table-cell" style="vertical-align: middle;">
                  {{ activity.name }}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  {% if p.passport_type %}
                    {{ p.passport_type.name }}
                  {% elif p.passport_type_name %}
                    {{ p.passport_type_name }}
                  {% else %}
                    Standard
                  {% endif %}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  {% if p.created_dt %}
                    {{ p.created_dt.strftime('%Y-%m-%d') }}
                  {% else %}
                    <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  {{ p.uses_remaining }}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  <span class="badge bg-{{ 'green-lt text-green-lt-fg' if p.paid else 'red-lt text-red-lt-fg' }}">{{ 'Paid' if p.paid else 'Unpaid' }}</span>
                </td>
                <td style="vertical-align: middle;">
                  <div class="dropdown">
                    <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                      <span class="d-none d-md-inline">Actions</span>
                      <i class="ti ti-menu-2 d-md-none"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                      {% if p.uses_remaining > 0 %}
                      <button type="button" class="dropdown-item text-primary" data-bs-toggle="modal" data-bs-target="#redeem-modal-{{ p.id }}">
                        <i class="ti ti-check me-2"></i>Redeem
                      </button>
                      {% endif %}
                      <a class="dropdown-item text-info" href="{{ url_for('show_pass', pass_code=p.pass_code) }}">
                        <i class="ti ti-eye me-2"></i>View & Redeem
                      </a>
                      <a class="dropdown-item" href="{{ url_for('edit_passport', passport_id=p.id) }}">
                        <i class="ti ti-pencil me-2"></i>Edit
                      </a>
                      <a class="dropdown-item" href="#">
                        <i class="ti ti-mail me-2"></i>Send Reminder
                      </a>
                      {% if not p.paid %}
                      <div class="dropdown-divider"></div>
                      <button type="button" class="dropdown-item text-success" data-bs-toggle="modal" data-bs-target="#mark-paid-modal-{{ p.id }}">
                        <i class="ti ti-currency-dollar me-2"></i>Mark as Paid
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Modal dialogs for passport actions -->
        {% for p in passes %}
        <!-- Redeem Modal -->
        <div class="modal modal-blur fade" id="redeem-modal-{{ p.id }}" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-status bg-primary"></div>
              <div class="modal-body text-center py-4">
                <i class="ti ti-check icon mb-2 text-primary" style="font-size: 2rem;"></i>
                <h3>Redeem Session</h3>
                <div class="text-muted">Redeem 1 session from {{ p.user.name }}'s passport?</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('redeem_passport', pass_code=p.pass_code) }}" class="w-100">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-primary w-100">Yes, Redeem</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        {% if not p.paid %}
        <!-- Mark as Paid Modal -->
        <div class="modal modal-blur fade" id="mark-paid-modal-{{ p.id }}" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-status bg-success"></div>
              <div class="modal-body text-center py-4">
                <i class="ti ti-currency-dollar icon mb-2 text-success" style="font-size: 2rem;"></i>
                <h3>Confirm Payment</h3>
                <div class="text-muted">Mark {{ p.user.name }}'s passport as paid?</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('mark_passport_paid', passport_id=p.id) }}" class="w-100">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-success w-100">Yes, mark as paid</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- Pagination -->
        <div class="card-footer d-flex justify-content-between align-items-center">
          <span class="text-muted">Showing 1 to {{ passes|length }} of {{ dashboard_stats.total_passports if dashboard_stats else passes|length }} entries</span>
          {% set total_items = dashboard_stats.total_passports if dashboard_stats else passes|length %}
          {% set items_per_page = 10 %}
          {% set total_pages = ((total_items - 1) // items_per_page) + 1 if total_items > 0 else 1 %}
          {% if total_pages > 1 %}
          <nav aria-label="User table pagination">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">
                  <i class="ti ti-chevron-left"></i>
                </a>
              </li>
              {% for page_num in range(1, total_pages + 1) %}
                {% if page_num <= 5 %}
                <li class="page-item {% if page_num == 1 %}active{% endif %}">
                  <a class="page-link" href="#">{{ page_num }}</a>
                </li>
                {% endif %}
              {% endfor %}
              <li class="page-item">
                <a class="page-link" href="#">
                  <i class="ti ti-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Pending Signups Section -->




<br><br>



      <!-- Pending Signups Table -->
      {% set pending_signups = signups | selectattr('status', 'equalto', 'pending') | list %}
      {% if pending_signups %}
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title">
            <i class="ti ti-hand-stop me-2"></i>Pending Signups
          </h3>
          <span class="badge bg-warning">{{ pending_signups|length }} pending</span>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter" id="signupTable">
            <thead>
              <tr>
                <th style="width: 300px;">User</th>
                <th>Signup Date</th>
                <th>Activity</th>
                <th>Status</th>
                <th>Payment Due</th>
                <th>Days Pending</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for signup in pending_signups %}
                <tr>
                  <td style="vertical-align: middle;">
                    <div class="d-flex align-items-center">
                      <img src="https://www.gravatar.com/avatar/{{ signup.user.email|lower|trim|encode_md5 }}?d=identicon&s=48" class="rounded-circle me-3" width="48" height="48" alt="Avatar">
                      <div>
                        <div class="fw-bold">{{ signup.user.name }}</div>
                        <div class="text-muted small">{{ signup.user.email }}</div>
                      </div>
                    </div>
                  </td>
                  <td style="vertical-align: middle;">{{ signup.signed_up_at.strftime('%Y-%m-%d') if signup.signed_up_at else 'Unknown' }}</td>
                  <td style="vertical-align: middle;">{{ activity.name }}</td>
                  <td style="vertical-align: middle;">
                    <span class="badge bg-{{ 'yellow' if signup.status == 'pending' else 'orange' if not signup.paid else 'red' }}-lt text-{{ 'yellow' if signup.status == 'pending' else 'orange' if not signup.paid else 'red' }}-lt-fg">
                      {% if signup.status == 'pending' %}Pending Approval{% elif not signup.paid %}Payment Required{% else %}Overdue Payment{% endif %}
                    </span>
                  </td>
                  <td style="vertical-align: middle;">
                    {% if signup.passport_type %}
                      ${{ signup.passport_type.price_per_user }}
                    {% else %}
                      {% set default_price = activity.passport_types[0].price_per_user if activity.passport_types else 50 %}
                      ${{ default_price }}
                    {% endif %}
                  </td>
                  <td style="vertical-align: middle;">{{ signup.signed_up_at|days_ago if signup.signed_up_at else 0 }} days</td>
                  <td style="vertical-align: middle;">
                    <div class="dropdown">
                      <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</a>
                      <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item text-success" href="{{ url_for('approve_and_create_pass', signup_id=signup.id) }}">
                          <i class="ti ti-check me-2"></i>Approve & Create Pass
                        </a>
                        <a class="dropdown-item" href="#">
                          <i class="ti ti-mail me-2"></i>Contact User
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="{{ url_for('update_signup_status', signup_id=signup.id) }}" onclick="event.preventDefault(); if(confirm('Reject this signup?')) { var form = document.createElement('form'); form.method = 'POST'; form.action = this.href; var statusInput = document.createElement('input'); statusInput.type = 'hidden'; statusInput.name = 'status'; statusInput.value = 'rejected'; form.appendChild(statusInput); var csrfInput = document.createElement('input'); csrfInput.type = 'hidden'; csrfInput.name = 'csrf_token'; csrfInput.value = '{{ csrf_token() }}'; form.appendChild(csrfInput); document.body.appendChild(form); form.submit(); }">
                          <i class="ti ti-x me-2"></i>Reject
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-footer d-flex align-items-center">
          <p class="m-0 text-muted">Showing 1 to {{ pending_signups|length }} of {{ dashboard_stats.pending_signups if dashboard_stats else pending_signups|length }} pending signups</p>
          {% set signup_total_items = dashboard_stats.pending_signups if dashboard_stats else pending_signups|length %}
          {% set signup_items_per_page = 10 %}
          {% set signup_total_pages = ((signup_total_items - 1) // signup_items_per_page) + 1 if signup_total_items > 0 else 1 %}
          {% if signup_total_pages > 1 %}
          <ul class="pagination m-0 ms-auto">
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
            {% for page_num in range(1, signup_total_pages + 1) %}
              {% if page_num <= 5 %}
              <li class="page-item {% if page_num == 1 %}active{% endif %}">
                <a class="page-link" href="#">{{ page_num }}</a>
              </li>
              {% endif %}
            {% endfor %}
            <li class="page-item">
              <a class="page-link" href="#">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
          </ul>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- What's Happening Section -->
      {% if activity_logs %}
      <h3 class="mt-5 mb-3">
        <i class="ti ti-cardboards me-2" style="color: #2fb344;"></i>What's Happening in Your Activity
      </h3>

      <!-- Activity Log Table -->
      <div class="card" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header">
          <h4 class="card-title">Recent Activity</h4>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter" id="activityLogTable">
            <thead>
              <tr>
                <th scope="col" class="text-muted">Date/Time</th>
                <th scope="col" class="text-muted">Type</th>
                <th scope="col" class="text-muted">Description</th>
              </tr>
            </thead>
            <tbody>
              {% for log in activity_logs %}
                <tr>
                  <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M') if log.timestamp else 'Unknown' }}</td>
                  <td>
                    {% set action_lower = log.action.lower() %}
                    {% if 'redeem' in action_lower %}
                      <i class="ti ti-ticket text-danger"></i>
                      Passport Redeemed
                    {% elif 'signup' in action_lower %}
                      <i class="ti ti-user-plus text-success"></i>
                      Signup Activity
                    {% elif 'created' in action_lower %}
                      <i class="ti ti-id text-lime"></i>
                      Passport Created
                    {% elif 'email' in action_lower %}
                      <i class="ti ti-mail text-info"></i>
                      Email Activity
                    {% elif 'payment' in action_lower %}
                      <i class="ti ti-currency-dollar text-success"></i>
                      Payment Activity
                    {% else %}
                      <i class="ti ti-settings text-muted"></i>
                      Admin Action
                    {% endif %}
                  </td>
                  <td>{{ log.action }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="card-footer d-flex align-items-center">
          <p class="m-0 text-muted">Showing <span id="activityShowingCount">{{ activity_logs|length if activity_logs else 0 }}</span> of {{ activity_logs|length if activity_logs else 0 }} activity logs</p>
          {% set log_total_items = activity_logs|length if activity_logs else 0 %}
          {% set log_items_per_page = 10 %}
          {% set log_total_pages = ((log_total_items - 1) // log_items_per_page) + 1 if log_total_items > 0 else 1 %}
          {% if log_total_pages > 1 %}
          <ul class="pagination m-0 ms-auto" id="activityPaginationControls">
            {% for page_num in range(1, log_total_pages + 1) %}
              {% if page_num <= 5 %}
              <li class="page-item {% if page_num == 1 %}active{% endif %}">
                <a href="#" class="page-link">{{ page_num }}</a>
              </li>
              {% endif %}
            {% endfor %}
          </ul>
          {% endif %}
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>


<script>
// Store KPI data from backend for JavaScript access
const kpiData = {{ kpi_data | tojson | safe }};

document.addEventListener('DOMContentLoaded', function() {
  // Initialize dashboard
  initializeActivityDashboard();
  // Initialize charts with current data
  initializeChartsWithData();
});

// Initialize charts with current page data
function initializeChartsWithData() {
  // Check if kpiData is available and log for debugging
  console.log('Initializing charts with KPI data:', kpiData);
  
  // Initialize revenue charts with default 7-day data
  if (kpiData && kpiData.revenue && kpiData.revenue.trend_data) {
    console.log('Using revenue trend data:', kpiData.revenue.trend_data);
    const revenueData = kpiData.revenue.trend_data;
    initializeRevenueChart(revenueData);
  } else {
    console.log('Using fallback revenue data');
    // Fallback: create default chart with sample data for 7 days
    const defaultData = [150, 200, 180, 220, 190, 250, 280];
    initializeRevenueChart(defaultData);
  }
  
  // Initialize profit charts if data is available
  if (kpiData && kpiData.profit && kpiData.profit.trend_data) {
    console.log('Using profit trend data:', kpiData.profit.trend_data);
    const profitData = kpiData.profit.trend_data;
    initializeProfitChart(profitData);
  } else {
    console.log('Using fallback profit data');
    // Fallback: create default profit chart
    const defaultProfitData = [80, 120, 95, 140, 110, 160, 180];
    initializeProfitChart(defaultProfitData);
  }
}

// Initialize revenue chart for both desktop and mobile
function initializeRevenueChart(data) {
  const chartPath = generateCleanLineChart(data, 300, 40);
  
  // Update desktop chart
  const desktopChart = document.getElementById('revenue-chart');
  if (desktopChart && chartPath) {
    desktopChart.innerHTML = `<path d="${chartPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
  }
  
  // Update mobile chart
  const mobileChart = document.getElementById('mobile-revenue-chart');
  if (mobileChart && chartPath) {
    mobileChart.innerHTML = `<path d="${chartPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
  }
}

// Initialize profit chart for both desktop and mobile
function initializeProfitChart(data) {
  const chartPath = generateCleanLineChart(data, 300, 40);
  
  // Update desktop chart
  const desktopChart = document.getElementById('profit-chart');
  if (desktopChart && chartPath) {
    desktopChart.innerHTML = `<path d="${chartPath}" fill="none" stroke="#2fb344" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
  }
  
  // Update mobile chart
  const mobileChart = document.getElementById('mobile-profit-chart');
  if (mobileChart && chartPath) {
    mobileChart.innerHTML = `<path d="${chartPath}" fill="none" stroke="#2fb344" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
  }
}

function initializeActivityDashboard() {
  // Search functionality
  const searchInput = document.getElementById('userSearch');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(handleSearch, 300));
  }
  
  // Filter tabs
  document.querySelectorAll('.filter-pills .nav-link').forEach(tab => {
    tab.addEventListener('click', handleFilterChange);
  });
  
  // KPI dropdowns
  initializeKPIDropdowns();
  
  // Keyboard shortcuts
  document.addEventListener('keydown', handleKeyboardShortcuts);
  
  // Most dropdown actions now use direct navigation via href attributes
  // Only add click handlers for specific client-side actions
  document.querySelectorAll('.dropdown-item[href="#"]').forEach(item => {
    item.addEventListener('click', handleUserAction);
  });
  
  // Handle window resize to update search behavior (simplified since we use unified approach)
  window.addEventListener('resize', debounce(() => {
    // Re-trigger search to update result count
    const searchInput = document.getElementById('userSearch');
    if (searchInput && searchInput.value) {
      handleSearch({ target: searchInput });
    }
  }, 300));
}

// Search functionality - unified approach for both mobile and desktop
function handleSearch(e) {
  const query = e.target.value.toLowerCase();
  
  // Use unified search logic that targets table rows (works for both mobile and desktop)
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const userName = row.querySelector('.fw-bold')?.textContent.toLowerCase() || '';
    const userEmail = row.querySelector('.text-muted.small')?.textContent.toLowerCase() || '';
    
    if (userName.includes(query) || userEmail.includes(query)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
  
  updateResultCount();
}

// Filter handling
function handleFilterChange(e) {
  e.preventDefault();
  
  // Update active state
  document.querySelectorAll('.filter-pills .nav-link').forEach(link => {
    link.classList.remove('active');
  });
  e.target.classList.add('active');
  
  const filter = e.target.dataset.filter;
  applyFilter(filter);
}

function applyFilter(filter) {
  const rows = document.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const passportStatus = row.querySelector('td:nth-child(3) .badge')?.textContent.trim();
    const paymentStatus = row.querySelector('td:nth-child(5) .badge')?.textContent.trim();
    
    let shouldShow = false;
    
    switch(filter) {
      case 'all':
        shouldShow = true;
        break;
      case 'active':
        shouldShow = passportStatus === 'Active';
        break;
      case 'unpaid':
        shouldShow = paymentStatus === 'Overdue' || passportStatus === 'Pending';
        break;
      case 'completed':
        shouldShow = row.querySelector('.sessions-progress-bar')?.style.width === '0%';
        break;
      default:
        shouldShow = true;
    }
    
    row.style.display = shouldShow ? '' : 'none';
  });
  
  updateResultCount();
}


// Update result count - unified approach for both mobile and desktop
function updateResultCount() {
  const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])');
  const totalRows = document.querySelectorAll('tbody tr');
  const visibleCount = visibleRows.length;
  const totalCount = totalRows.length;
  
  const footerText = document.querySelector('.card-footer .text-muted');
  if (footerText) {
    footerText.textContent = `Showing ${visibleCount} of ${totalCount} entries`;
  }
}

// Keyboard shortcuts
function handleKeyboardShortcuts(e) {
  // Focus search with Ctrl+K or /
  if ((e.ctrlKey && e.key === 'k') || (e.key === '/' && e.target.tagName !== 'INPUT')) {
    e.preventDefault();
    document.getElementById('userSearch')?.focus();
  }
  
  // Clear search with Escape
  if (e.key === 'Escape') {
    const searchInput = document.getElementById('userSearch');
    if (searchInput === document.activeElement) {
      searchInput.value = '';
      searchInput.blur();
      handleSearch({ target: searchInput });
    }
  }
  
}

// User actions - now handled by individual links with proper URLs
function handleUserAction(e) {
  const action = e.target.textContent.trim();
  const userName = e.target.closest('tr')?.querySelector('.fw-bold')?.textContent || 'User';
  
  // Most actions now use direct links to Flask routes
  // Only handle client-side actions here
  switch(action) {
    case 'Send Reminder':
      showNotification('info', `Reminder request sent for ${userName}`);
      break;
    case 'Remove User':
      // This would be handled by a DELETE request to the backend
      showNotification('info', `Remove action triggered for ${userName}`);
      break;
  }
}


// Utility functions
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showNotification(type, message) {
  // Create notification element
  const notification = document.createElement('div');
  const typeClass = type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger';
  const icon = type === 'success' ? 'check' : type === 'warning' ? 'alert-triangle' : type === 'info' ? 'info-circle' : 'alert-circle';
  const title = type === 'success' ? 'Success!' : type === 'warning' ? 'Warning!' : type === 'info' ? 'Info' : 'Error!';
  
  notification.className = `alert alert-${typeClass} alert-dismissible position-fixed top-0 end-0 m-3`;
  notification.style.zIndex = '9999';
  notification.style.minWidth = '300px';
  notification.innerHTML = `
    <div class="d-flex">
      <div>
        <i class="ti ti-${icon} alert-icon"></i>
      </div>
      <div>
        <h4 class="alert-title">${title}</h4>
        <div class="text-muted">${message}</div>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Enhanced search with URL updates and better filtering
function enhancedSearch(query) {
  const rows = document.querySelectorAll('tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const userName = row.querySelector('.fw-bold')?.textContent.toLowerCase() || '';
    const userEmail = row.querySelector('.text-muted.small')?.textContent.toLowerCase() || '';
    const activityName = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
    
    const searchText = query.toLowerCase();
    const isVisible = userName.includes(searchText) || 
                     userEmail.includes(searchText) || 
                     activityName.includes(searchText);
    
    row.style.display = isVisible ? '' : 'none';
    if (isVisible) visibleCount++;
  });
  
  // Update result count display
  const resultInfo = document.querySelector('.card-footer .text-muted');
  if (resultInfo) {
    const totalRows = rows.length;
    resultInfo.textContent = `Showing ${visibleCount} of ${totalRows} entries`;
  }
  
  // Update URL without page reload for better UX
  if (history.pushState) {
    const url = new URL(window.location);
    if (query) {
      url.searchParams.set('search', query);
    } else {
      url.searchParams.delete('search');
    }
    history.pushState(null, '', url);
  }
  
  return visibleCount;
}

// Function to generate interactive line chart with hover points
function generateInteractiveLineChart(data, width = 300, height = 40, chartId = '') {
  if (!data || data.length === 0) {
    return { path: '', points: [] };
  }
  
  // Ensure data is properly formatted and clean
  const cleanData = data.map(val => {
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num;
  });
  
  if (cleanData.length === 0) {
    return { path: '', points: [] };
  }
  
  // Find min and max for scaling
  const max = Math.max(...cleanData);
  const min = Math.min(...cleanData);
  const range = max - min || 1;
  
  // Generate path coordinates and hover points
  const coordinates = [];
  const hoverPoints = [];
  
  cleanData.forEach((value, index) => {
    const x = cleanData.length === 1 ? width / 2 : (index / (cleanData.length - 1)) * width;
    const y = height - ((value - min) / range) * (height - 10) - 5;
    
    // Ensure coordinates are valid numbers
    const cleanX = isNaN(x) ? 0 : Math.round(x * 100) / 100;
    const cleanY = isNaN(y) ? height / 2 : Math.round(y * 100) / 100;
    
    coordinates.push(`${index === 0 ? 'M' : 'L'} ${cleanX},${cleanY}`);
    hoverPoints.push({ 
      x: cleanX, 
      y: cleanY, 
      value: value, 
      index: index 
    });
  });
  
  return {
    path: coordinates.join(' '),
    points: hoverPoints
  };
}

// Clean line chart generator that ensures proper SVG path format
function generateCleanLineChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) {
    return `M 0,${height/2} L ${width},${height/2}`;
  }
  
  // Ensure data is properly formatted and clean
  const cleanData = data.map(val => {
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num;
  });
  
  if (cleanData.length === 0) {
    return `M 0,${height/2} L ${width},${height/2}`;
  }
  
  // Calculate scaling
  const max = Math.max(...cleanData);
  const min = Math.min(...cleanData);
  const range = max - min || 1;
  
  // Generate clean coordinates
  const points = [];
  for (let i = 0; i < cleanData.length; i++) {
    const x = cleanData.length === 1 ? width / 2 : (i / (cleanData.length - 1)) * width;
    const y = height - ((cleanData[i] - min) / range) * (height - 10) - 5;
    
    // Ensure coordinates are valid numbers
    const cleanX = isNaN(x) ? 0 : Math.round(x * 100) / 100;
    const cleanY = isNaN(y) ? height / 2 : Math.round(y * 100) / 100;
    
    points.push({
      x: cleanX,
      y: cleanY,
      command: i === 0 ? 'M' : 'L'
    });
  }
  
  // Build SVG path string
  return points.map(point => `${point.command} ${point.x},${point.y}`).join(' ');
}

// Legacy function for backward compatibility - generates simple line charts
function generateLineChart(data, width = 300, height = 40) {
  return generateCleanLineChart(data, width, height);
}

function generateBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  // Ensure data is properly formatted
  const cleanData = data.map(val => parseFloat(val) || 0);
  const max = Math.max(...cleanData) || 1;
  const barWidth = Math.max(8, (width - (cleanData.length - 1) * 2) / cleanData.length);
  
  let svg = '';
  cleanData.forEach((value, index) => {
    const barHeight = Math.max(1, (value / max) * (height - 5));
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#206bc4" opacity="0.8" />`;
  });
  
  return svg;
}

function generateUnpaidBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  // Ensure data is properly formatted
  const cleanData = data.map(val => parseFloat(val) || 0);
  const max = Math.max(...cleanData) || 1;
  const barWidth = Math.max(8, (width - (cleanData.length - 1) * 2) / cleanData.length);
  
  let svg = '';
  cleanData.forEach((value, index) => {
    const barHeight = Math.max(1, (value / max) * (height - 5));
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#f76707" opacity="0.8" />`;
  });
  
  return svg;
}

// Tooltip management functions
function createTooltip() {
  let tooltip = document.getElementById('chart-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'chart-tooltip';
    tooltip.className = 'chart-tooltip';
    tooltip.style.cssText = `
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      white-space: nowrap;
    `;
    document.body.appendChild(tooltip);
  }
  return tooltip;
}

function showTooltip(x, y, value, period, index, chartType = 'revenue') {
  const tooltip = createTooltip();
  
  // Format value based on chart type
  let formattedValue;
  if (chartType === 'revenue' || chartType === 'profit') {
    formattedValue = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value);
  } else {
    formattedValue = Math.round(value).toString();
  }
  
  // Calculate the date based on period and index
  const daysAgo = parseInt(period) - index - 1;
  const date = new Date();
  date.setDate(date.getDate() - daysAgo);
  const formattedDate = date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric'
  });
  
  tooltip.innerHTML = `${formattedValue}<br><small>${formattedDate}</small>`;
  tooltip.style.left = `${x}px`;
  tooltip.style.top = `${y - 10}px`;
  tooltip.style.opacity = '1';
}

function hideTooltip() {
  const tooltip = document.getElementById('chart-tooltip');
  if (tooltip) {
    tooltip.style.opacity = '0';
  }
}

// KPI Dropdown Functionality
function initializeKPIDropdowns() {
  // Add event listeners to all KPI dropdown items with the kpi-period-btn class
  document.querySelectorAll('.kpi-period-btn').forEach(item => {
    item.addEventListener('click', handleKPITimeChange);
  });
}

function handleKPITimeChange(event) {
  event.preventDefault();
  
  const clickedItem = event.target;
  const period = parseInt(clickedItem.dataset.period);
  const dropdown = clickedItem.closest('.dropdown');
  const dropdownButton = dropdown.querySelector('.dropdown-toggle');
  
  // Prevent multiple rapid clicks
  if (clickedItem.classList.contains('loading')) return;
  clickedItem.classList.add('loading');
  
  // Update only the clicked dropdown button text with loading state
  const originalText = dropdownButton.textContent;
  dropdownButton.style.opacity = '0.7';
  dropdownButton.textContent = clickedItem.textContent.trim() + ' ...';
  
  // Determine which KPI card to update based on the clicked dropdown
  const kpiCard = dropdown.closest('.card');
  const kpiType = determineKPIType(kpiCard);
  
  // Show loading state for this card only
  showKPILoading(kpiCard);
  
  // Make AJAX request to update only this specific KPI data
  updateSingleKPIData(period, kpiType, kpiCard);
  
  // Reset loading state for this dropdown only after completion
  setTimeout(() => {
    clickedItem.classList.remove('loading');
    if (dropdownButton.textContent.includes('...')) {
      dropdownButton.textContent = clickedItem.textContent.trim();
      dropdownButton.style.opacity = '1';
    }
  }, 800);
}

function showKPILoading(cardElement = null) {
  // Show loading for specific card or all KPI cards
  const targetCards = cardElement ? [cardElement] : document.querySelectorAll('.kpi-card-rounded');
  
  targetCards.forEach(card => {
    const valueEl = card.querySelector('.h2');
    const trendEl = card.querySelector('.text-success, .text-danger, .text-muted');
    const chartEl = card.querySelector('svg');
    
    if (valueEl) valueEl.style.opacity = '0.6';
    if (trendEl) trendEl.style.opacity = '0.6';
    if (chartEl) chartEl.style.opacity = '0.3';
  });
}

function hideKPILoading(cardElement = null) {
  // Hide loading for specific card or all KPI cards
  const targetCards = cardElement ? [cardElement] : document.querySelectorAll('.kpi-card-rounded');
  
  targetCards.forEach(card => {
    const valueEl = card.querySelector('.h2');
    const trendEl = card.querySelector('.text-success, .text-danger, .text-muted');
    const chartEl = card.querySelector('svg');
    
    if (valueEl) valueEl.style.opacity = '1';
    if (trendEl) trendEl.style.opacity = '1';
    if (chartEl) chartEl.style.opacity = '1';
  });
}

function determineKPIType(cardElement) {
  // Determine KPI type based on card content
  const cardText = cardElement.textContent.toLowerCase();
  if (cardText.includes('revenue')) return 'revenue';
  if (cardText.includes('active users')) return 'active_users';
  if (cardText.includes('unpaid')) return 'unpaid_passports';
  if (cardText.includes('profit')) return 'profit';
  return 'revenue'; // fallback
}

function updateSingleKPIData(period, kpiType, cardElement) {
  // Get activity ID from current URL
  const pathParts = window.location.pathname.split('/');
  const activityId = pathParts[pathParts.length - 1];
  
  // Show loading state for this card only
  showKPILoading(cardElement);
  
  // Make API call to get updated KPI data
  fetch(`/api/activity-kpis/${activityId}?period=${period}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateSingleKPIDisplay(data.kpi_data, period, kpiType, cardElement);
      } else {
        console.error('Failed to fetch KPI data:', data.error);
        showNotification('error', 'Failed to update KPI data');
      }
      // Hide loading state
      setTimeout(() => {
        hideKPILoading(cardElement);
      }, 200);
    })
    .catch(error => {
      console.error('Error fetching KPI data:', error);
      showNotification('error', 'Failed to update KPI data');
      hideKPILoading(cardElement);
    });
}

function updateSingleKPIDisplay(kpiData, period, kpiType, cardElement) {
  // Update only the specific KPI card
  const kpiTypeData = kpiData[kpiType];
  if (!kpiTypeData) return;
  
  // Determine chart type and prefix based on KPI type
  let chartType = 'line';
  let prefix = kpiType;
  
  if (kpiType === 'active_users') {
    chartType = 'bar';
    prefix = 'active-users';
  } else if (kpiType === 'unpaid_passports') {
    chartType = 'unpaid-bar';
    prefix = 'unpaid-passports';
  }
  
  // Update the specific card
  updateKPICard(prefix, kpiTypeData, chartType, period);
}

function updateAllKPIData(period) {
  // Get activity ID from current URL
  const pathParts = window.location.pathname.split('/');
  const activityId = pathParts[pathParts.length - 1];
  
  // Make API call to get updated KPI data
  fetch(`/api/activity-kpis/${activityId}?period=${period}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateAllKPIDisplays(data.kpi_data, period);
      } else {
        console.error('Failed to fetch KPI data:', data.error);
        showNotification('error', 'Failed to update KPI data');
      }
      hideKPILoading();
    })
    .catch(error => {
      console.error('Error fetching KPI data:', error);
      showNotification('error', 'Failed to update KPI data');
      hideKPILoading();
    });
}

function updateAllKPIDisplays(kpiData, period) {
  // Add fade-out animation to existing charts
  const allCharts = document.querySelectorAll('.card svg');
  allCharts.forEach(chart => {
    chart.style.transition = 'opacity 0.3s ease';
    chart.style.opacity = '0.3';
  });
  
  // Delay the chart update for smooth transition
  setTimeout(() => {
    // Update Revenue with interactive tooltips
    updateKPICard('revenue', kpiData.revenue, 'line', period);
    updateKPICard('mobile-revenue', kpiData.revenue, 'line', period);
    
    // Update Active Users
    updateKPICard('active-users', kpiData.active_users, 'bar', period);
    updateKPICard('mobile-active-users', kpiData.active_users, 'bar', period);
    
    // Update Unpaid Passports
    updateKPICard('unpaid-passports', kpiData.unpaid_passports, 'unpaid-bar', period);
    updateKPICard('mobile-unpaid-passports', kpiData.unpaid_passports, 'unpaid-bar', period);
    
    // Update Profit with interactive tooltips
    updateKPICard('profit', kpiData.profit, 'line', period);
    updateKPICard('mobile-profit', kpiData.profit, 'line', period);
    
    // Add fade-in animation to updated charts
    setTimeout(() => {
      const allCharts = document.querySelectorAll('.card svg');
      allCharts.forEach(chart => {
        chart.style.opacity = '1';
      });
    }, 100);
  }, 300);
}

function updateKPICard(prefix, data, chartType, period) {
  // Update value
  const valueEl = document.getElementById(`${prefix}-value`);
  if (valueEl) {
    if (prefix.includes('revenue') || prefix.includes('profit')) {
      valueEl.textContent = `$${Math.round(parseFloat(data.total) || 0)}`;
    } else {
      valueEl.textContent = Math.round(parseFloat(data.total) || 0);
    }
  }
  
  // Update trend
  const trendEl = document.getElementById(`${prefix}-trend`);
  if (trendEl) {
    let trendClass = '';
    let icon = '';
    
    if (data.trend === 'up') {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (data.trend === 'down') {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    } else {
      trendClass = 'text-muted';
      icon = 'ti-minus';
    }
    
    if (prefix.includes('unpaid-passports')) {
      trendEl.innerHTML = `${data.overdue} overdue <i class="ti ti-alert-circle"></i>`;
      trendEl.className = `${data.overdue > 0 ? 'text-danger' : 'text-muted'} me-2`;
    } else if (prefix.includes('profit')) {
      const safeMargin = Math.round(parseFloat(data.margin) || 0);
      trendEl.innerHTML = `${safeMargin}% margin <i class="${icon}"></i>`;
      trendEl.className = `${trendClass} me-2`;
    } else {
      const safePercentage = Math.round(parseFloat(data.percentage) || 0);
      trendEl.innerHTML = `${safePercentage}% <i class="${icon}"></i>`;
      trendEl.className = `${trendClass} me-2`;
    }
  }
  
  // Update chart with appropriate complexity based on period
  const chartEl = document.getElementById(`${prefix}-chart`);
  if (chartEl && data.trend_data) {
    let chartContent = '';
    
    if (chartType === 'line') {
      const color = prefix.includes('revenue') ? '#206bc4' : '#2fb344';
      
      // Get current period from dropdown to determine chart complexity
      const dropdown = chartEl.closest('.card').querySelector('.dropdown-toggle');
      const periodText = dropdown ? dropdown.textContent : 'Last 7 days';
      const periodDays = parseInt(periodText.match(/\d+/)?.[0] || '7');
      
      // Always use clean chart generation to avoid encoding issues
      const cleanPath = generateCleanLineChart(data.trend_data, 300, 40);
      
      if (cleanPath && cleanPath.trim() !== '') {
        if (periodDays <= 7) {
          // Simple line chart for 7 days or less
          chartContent = `<path d="${cleanPath}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
        } else {
          // Interactive chart for longer periods
          const chartData = generateInteractiveLineChart(data.trend_data, 300, 40, prefix);
          
          if (chartData && chartData.path && chartData.path.trim() !== '') {
            chartContent = `
              <path d="${chartData.path}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              ${chartData.points.map((point, index) => 
                `<circle cx="${point.x}" cy="${point.y}" r="4" fill="transparent" 
                         data-value="${point.value}" data-index="${index}" 
                         class="chart-hover-point" style="cursor: pointer;" />`
              ).join('')}
            `;
          } else {
            // Fallback to simple path if interactive generation fails
            chartContent = `<path d="${cleanPath}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
          }
        }
      } else {
        // Final fallback - create a simple horizontal line
        chartContent = `<path d="M 0,20 L 300,20" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
      }
    } else if (chartType === 'bar') {
      chartContent = generateBarChart(data.trend_data);
    } else if (chartType === 'unpaid-bar') {
      chartContent = generateUnpaidBarChart(data.trend_data);
    }
    
    chartEl.innerHTML = chartContent;
    
    // Add hover event listeners only for interactive charts (30+ days)
    const dropdown = chartEl.closest('.card').querySelector('.dropdown-toggle');
    const periodText = dropdown ? dropdown.textContent : 'Last 7 days';
    const periodDays = parseInt(periodText.match(/\d+/)?.[0] || '7');
    
    if ((prefix.includes('revenue') || prefix.includes('profit')) && chartType === 'line' && periodDays > 7) {
      chartEl.querySelectorAll('.chart-hover-point').forEach(point => {
        point.addEventListener('mouseenter', function(e) {
          const rect = chartEl.getBoundingClientRect();
          const value = parseFloat(this.getAttribute('data-value'));
          const index = parseInt(this.getAttribute('data-index'));
          const chartType = prefix.includes('revenue') ? 'revenue' : 'profit';
          showTooltip(
            rect.left + parseFloat(this.getAttribute('cx')) + window.scrollX,
            rect.top + parseFloat(this.getAttribute('cy')) + window.scrollY - 50,
            value, 
            periodDays, 
            index,
            chartType
          );
        });
        
        point.addEventListener('mouseleave', hideTooltip);
      });
    }
  }
}
</script>
{% endblock %}