{% extends "base.html" %}

{% block title %}Activity Dashboard - {{ activity.name }}{% endblock %}

{% block content %}
<style>
/* Fix dropdown z-index issues in tables */
.table-responsive {
  overflow: visible !important;
  position: static !important;
}
.table-responsive .dropdown {
  position: relative;
}
.table-responsive .dropdown-menu {
  z-index: 9999 !important;
  position: absolute !important;
  transform: none !important;
  top: 100% !important;
  min-width: 160px;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
.table-responsive .dropdown-menu.dropdown-menu-end {
  right: 0 !important;
  left: auto !important;
}

/* Ensure card doesn't clip dropdowns */
.card {
  overflow: visible !important;
}

/* Fix card footer background to white per style guide */
.card-footer {
  background-color: #fff !important;
  border-top: 1px solid rgba(98, 105, 118, 0.16);
}

/* Add proper table padding for alignment with card margins */
.table-responsive .table td:first-child {
  padding-left: 1.5rem !important;
}
.table-responsive .table td:last-child {
  padding-right: 1.5rem !important;
}
.table-responsive .table th:first-child {
  padding-left: 1.5rem !important;
}
.table-responsive .table th:last-child {
  padding-right: 1.5rem !important;
}
</style>

<div class="page-wrapper">

  <div class="page-body">
    <div class="dashboard-container">
      <!-- Split Layout Header with Activity Image -->
      <div class="activity-header-split">
        <div class="row g-4 align-items-center">
          <div class="col-lg-7">
            <div class="activity-info">
              <h1 class="activity-title">{{ activity.name }}</h1>
              <p class="activity-description">{{ activity.description or "No description provided." }}{% if activity.start_date %} â€¢ {{ activity.start_date.strftime('%b %d') }}{% if activity.end_date %} - {{ activity.end_date.strftime('%b %d, %Y') }}{% endif %}{% endif %}</p>
              <div class="activity-actions">
                <a href="{{ url_for('edit_activity', activity_id=activity.id) }}" class="btn btn-primary">
                  <i class="ti ti-edit me-2"></i>Edit Activity
                </a>
                <a href="{{ url_for('scan_qr') }}" class="btn btn-success ms-2">
                  <i class="ti ti-scan me-2"></i>Scan Activity
                </a>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="activity-image-card">
              <img src="{{ url_for('static', filename='uploads/activity_images/' ~ (activity.image_filename or 'placeholder.jpg')) }}" 
                   class="activity-featured-image" 
                   alt="{{ activity.name }}">
              <div class="image-overlay">
                <button class="btn btn-sm btn-ghost-light">
                  <i class="ti ti-camera me-1"></i>Change Image
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Metrics Row -->
      <div class="row row-cards mb-4">
        <!-- Revenue Card -->
        <div class="col-sm-6 col-lg-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">REVENUE</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">${{ "%.0f"|format(kpi_data.revenue.total) }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'success' if kpi_data.revenue.trend == 'up' else 'muted' }} me-2">{{ kpi_data.revenue.percentage }}% <i class="ti ti-trending-{{ kpi_data.revenue.trend }}"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                  <path d="M 0,32 L 15,30 L 30,31 L 45,28 L 60,29 L 75,26 L 90,27 L 105,24 L 120,25 L 135,22 L 150,24 L 165,21 L 180,22 L 195,19 L 210,20 L 225,18 L 240,19 L 255,17 L 270,18 L 285,16 L 300,17" 
                        fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Users Card -->
        <div class="col-sm-6 col-lg-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVE USERS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ kpi_data.active_users.total }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'success' if kpi_data.active_users.trend == 'up' else 'muted' }} me-2">{{ kpi_data.active_users.percentage }}% <i class="ti ti-trending-{{ kpi_data.active_users.trend }}"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                  <!-- Bar chart for active users -->
                  <rect x="10" y="28" width="8" height="12" fill="#206bc4" opacity="0.8" />
                  <rect x="25" y="25" width="8" height="15" fill="#206bc4" opacity="0.8" />
                  <rect x="40" y="30" width="8" height="10" fill="#206bc4" opacity="0.8" />
                  <rect x="55" y="22" width="8" height="18" fill="#206bc4" opacity="0.8" />
                  <rect x="70" y="26" width="8" height="14" fill="#206bc4" opacity="0.8" />
                  <rect x="85" y="20" width="8" height="20" fill="#206bc4" opacity="0.8" />
                  <rect x="100" y="15" width="8" height="25" fill="#206bc4" opacity="0.8" />
                  <rect x="115" y="18" width="8" height="22" fill="#206bc4" opacity="0.8" />
                  <rect x="130" y="12" width="8" height="28" fill="#206bc4" opacity="0.8" />
                  <rect x="145" y="16" width="8" height="24" fill="#206bc4" opacity="0.8" />
                  <rect x="160" y="10" width="8" height="30" fill="#206bc4" opacity="0.8" />
                  <rect x="175" y="14" width="8" height="26" fill="#206bc4" opacity="0.8" />
                  <rect x="190" y="18" width="8" height="22" fill="#206bc4" opacity="0.8" />
                  <rect x="205" y="22" width="8" height="18" fill="#206bc4" opacity="0.8" />
                  <rect x="220" y="20" width="8" height="20" fill="#206bc4" opacity="0.8" />
                  <rect x="235" y="24" width="8" height="16" fill="#206bc4" opacity="0.8" />
                  <rect x="250" y="26" width="8" height="14" fill="#206bc4" opacity="0.8" />
                  <rect x="265" y="28" width="8" height="12" fill="#206bc4" opacity="0.8" />
                  <rect x="280" y="30" width="8" height="10" fill="#206bc4" opacity="0.8" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Unpaid Passports Card -->
        <div class="col-sm-6 col-lg-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">UNPAID PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ kpi_data.unpaid_passports.total }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'danger' if kpi_data.unpaid_passports.overdue > 0 else 'muted' }} me-2">{{ kpi_data.unpaid_passports.overdue }} overdue <i class="ti ti-alert-circle"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                  <path d="M 0,25 L 30,28 L 60,26 L 90,30 L 120,32 L 150,29 L 180,31 L 210,28 L 240,30 L 270,27 L 300,29" 
                        fill="none" stroke="#f76707" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity Profit Card -->
        <div class="col-sm-6 col-lg-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVITY PROFIT</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">${{ "%.0f"|format(kpi_data.profit.total) }}</div>
              <div class="d-flex align-items-center mb-3">
                <div class="text-{{ 'success' if kpi_data.profit.trend == 'up' else 'muted' }} me-2">{{ "%.0f"|format(kpi_data.profit.margin) }}% margin <i class="ti ti-trending-{{ kpi_data.profit.trend }}"></i></div>
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                  <path d="M 0,30 L 30,28 L 60,25 L 90,22 L 120,20 L 150,18 L 180,15 L 210,12 L 240,10 L 270,8 L 300,5" 
                        fill="none" stroke="#2fb344" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Passport List Title -->
      {% if passes %}
      <h2 class="mt-4 mb-3">
        <i class="ti ti-activity-heartbeat me-2" style="color: #e03131;"></i>Your Activity Passport
      </h2>

      <!-- Search Bar -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div class="position-relative flex-fill me-3">
            <div class="input-icon">
              <span class="input-icon-addon">
                <i class="ti ti-search fs-3"></i>
              </span>
              <input type="text" id="userSearch" class="form-control shadow-sm" 
                     placeholder="Search passports and users..." 
                     style="padding-right: 80px; border-radius: 0.5rem; transition: all 0.3s ease;"
                     onfocus="this.style.boxShadow='0 0 0 0.25rem rgba(32, 107, 196, 0.15)'" 
                     onblur="this.style.boxShadow='0 0.125rem 0.25rem rgba(0,0,0,0.075)'">
              <span class="position-absolute end-0 top-50 translate-middle-y me-3">
                <kbd class="text-muted">ctrl + k</kbd>
              </span>
            </div>
          </div>
          <div class="flex-shrink-0">
            <a href="{{ url_for('create_passport') }}" class="btn btn-primary">
              <i class="ti ti-plus me-1"></i>Passport
            </a>
          </div>
        </div>
      </div>



      <!-- Main Data Table (Responsive) -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="ti ti-passport me-2"></i>Digital Passes
          </h3>
        </div>
        <div class="table-responsive">
          <table class="table table-hover user-table">
            <thead>
              <tr>
                <th style="width: 300px;">User</th>
                <th class="d-md-none text-center">Remain</th>
                <th class="d-none d-md-table-cell">Activity</th>
                <th class="d-none d-md-table-cell text-center">Pass Type</th>
                <th class="d-none d-md-table-cell text-center">Created</th>
                <th class="d-none d-md-table-cell text-center">Remaining</th>
                <th class="d-none d-md-table-cell text-center">Status</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in passes %}
              <tr>
                <td style="vertical-align: middle;">
                  <div class="d-flex align-items-center">
                    <img src="https://www.gravatar.com/avatar/{{ p.user.email|lower|trim|encode_md5 }}?d=identicon&s=40" 
                         class="rounded-circle me-3 user-avatar d-none d-md-block" alt="Avatar">
                    <div>
                      <div class="fw-bold">{{ p.user.name }}</div>
                      <div class="text-muted small">{{ p.user.email }}</div>
                    </div>
                  </div>
                </td>
                <td class="d-md-none text-center" style="vertical-align: middle;">
                  <span class="badge bg-{{ 'green-lt' if p.paid else 'red-lt' }}">{{ p.uses_remaining }}</span>
                </td>
                <td class="d-none d-md-table-cell" style="vertical-align: middle;">
                  {{ activity.name }}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  {% if p.passport_type %}
                    {{ p.passport_type.name }}
                  {% elif p.passport_type_name %}
                    {{ p.passport_type_name }}
                  {% else %}
                    Standard
                  {% endif %}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  {% if p.created_dt %}
                    {{ p.created_dt.strftime('%Y-%m-%d') }}
                  {% else %}
                    <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  {{ p.uses_remaining }}
                </td>
                <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                  <span class="badge bg-{{ 'green-lt text-green-lt-fg' if p.paid else 'red-lt text-red-lt-fg' }}">{{ 'Paid' if p.paid else 'Unpaid' }}</span>
                </td>
                <td style="vertical-align: middle;">
                  <div class="dropdown">
                    <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                      <span class="d-none d-md-inline">Actions</span>
                      <i class="ti ti-menu-2 d-md-none"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                      {% if p.uses_remaining > 0 %}
                      <button type="button" class="dropdown-item text-primary" data-bs-toggle="modal" data-bs-target="#redeem-modal-{{ p.id }}">
                        <i class="ti ti-check me-2"></i>Redeem
                      </button>
                      {% endif %}
                      <a class="dropdown-item text-info" href="{{ url_for('show_pass', pass_code=p.pass_code) }}">
                        <i class="ti ti-eye me-2"></i>View & Redeem
                      </a>
                      <a class="dropdown-item" href="{{ url_for('edit_passport', passport_id=p.id) }}">
                        <i class="ti ti-pencil me-2"></i>Edit
                      </a>
                      <a class="dropdown-item" href="#">
                        <i class="ti ti-mail me-2"></i>Send Reminder
                      </a>
                      {% if not p.paid %}
                      <div class="dropdown-divider"></div>
                      <button type="button" class="dropdown-item text-success" data-bs-toggle="modal" data-bs-target="#mark-paid-modal-{{ p.id }}">
                        <i class="ti ti-currency-dollar me-2"></i>Mark as Paid
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Modal dialogs for passport actions -->
        {% for p in passes %}
        <!-- Redeem Modal -->
        <div class="modal modal-blur fade" id="redeem-modal-{{ p.id }}" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-status bg-primary"></div>
              <div class="modal-body text-center py-4">
                <i class="ti ti-check icon mb-2 text-primary" style="font-size: 2rem;"></i>
                <h3>Redeem Session</h3>
                <div class="text-muted">Redeem 1 session from {{ p.user.name }}'s passport?</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('redeem_passport', pass_code=p.pass_code) }}" class="w-100">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-primary w-100">Yes, Redeem</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        {% if not p.paid %}
        <!-- Mark as Paid Modal -->
        <div class="modal modal-blur fade" id="mark-paid-modal-{{ p.id }}" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-status bg-success"></div>
              <div class="modal-body text-center py-4">
                <i class="ti ti-currency-dollar icon mb-2 text-success" style="font-size: 2rem;"></i>
                <h3>Confirm Payment</h3>
                <div class="text-muted">Mark {{ p.user.name }}'s passport as paid?</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-link w-100" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('mark_passport_paid', passport_id=p.id) }}" class="w-100">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-success w-100">Yes, mark as paid</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- Pagination -->
        <div class="card-footer d-flex justify-content-between align-items-center">
          <span class="text-muted">Showing 1 to {{ passes|length }} of {{ dashboard_stats.total_passports if dashboard_stats else passes|length }} entries</span>
          {% set total_items = dashboard_stats.total_passports if dashboard_stats else passes|length %}
          {% set items_per_page = 10 %}
          {% set total_pages = ((total_items - 1) // items_per_page) + 1 if total_items > 0 else 1 %}
          {% if total_pages > 1 %}
          <nav aria-label="User table pagination">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">
                  <i class="ti ti-chevron-left"></i>
                </a>
              </li>
              {% for page_num in range(1, total_pages + 1) %}
                {% if page_num <= 5 %}
                <li class="page-item {% if page_num == 1 %}active{% endif %}">
                  <a class="page-link" href="#">{{ page_num }}</a>
                </li>
                {% endif %}
              {% endfor %}
              <li class="page-item">
                <a class="page-link" href="#">
                  <i class="ti ti-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Pending Signups Section -->




<br><br>



      <!-- Pending Signups Table -->
      {% set pending_signups = signups | selectattr('status', 'equalto', 'pending') | list %}
      {% if pending_signups %}
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title">
            <i class="ti ti-hand-stop me-2"></i>Pending Signups
          </h3>
          <span class="badge bg-warning">{{ pending_signups|length }} pending</span>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter" id="signupTable">
            <thead>
              <tr>
                <th style="width: 300px;">User</th>
                <th>Signup Date</th>
                <th>Activity</th>
                <th>Status</th>
                <th>Payment Due</th>
                <th>Days Pending</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for signup in pending_signups %}
                <tr>
                  <td style="vertical-align: middle;">
                    <div class="d-flex align-items-center">
                      <img src="https://www.gravatar.com/avatar/{{ signup.user.email|lower|trim|encode_md5 }}?d=identicon&s=48" class="rounded-circle me-3" width="48" height="48" alt="Avatar">
                      <div>
                        <div class="fw-bold">{{ signup.user.name }}</div>
                        <div class="text-muted small">{{ signup.user.email }}</div>
                      </div>
                    </div>
                  </td>
                  <td style="vertical-align: middle;">{{ signup.signed_up_at.strftime('%Y-%m-%d') if signup.signed_up_at else 'Unknown' }}</td>
                  <td style="vertical-align: middle;">{{ activity.name }}</td>
                  <td style="vertical-align: middle;">
                    <span class="badge bg-{{ 'yellow' if signup.status == 'pending' else 'orange' if not signup.paid else 'red' }}-lt text-{{ 'yellow' if signup.status == 'pending' else 'orange' if not signup.paid else 'red' }}-lt-fg">
                      {% if signup.status == 'pending' %}Pending Approval{% elif not signup.paid %}Payment Required{% else %}Overdue Payment{% endif %}
                    </span>
                  </td>
                  <td style="vertical-align: middle;">
                    {% if signup.passport_type %}
                      ${{ signup.passport_type.price_per_user }}
                    {% else %}
                      {% set default_price = activity.passport_types[0].price_per_user if activity.passport_types else 50 %}
                      ${{ default_price }}
                    {% endif %}
                  </td>
                  <td style="vertical-align: middle;">{{ signup.signed_up_at|days_ago if signup.signed_up_at else 0 }} days</td>
                  <td style="vertical-align: middle;">
                    <div class="dropdown">
                      <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</a>
                      <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item text-success" href="{{ url_for('approve_and_create_pass', signup_id=signup.id) }}">
                          <i class="ti ti-check me-2"></i>Approve & Create Pass
                        </a>
                        <a class="dropdown-item" href="#">
                          <i class="ti ti-mail me-2"></i>Contact User
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="{{ url_for('update_signup_status', signup_id=signup.id) }}" onclick="event.preventDefault(); if(confirm('Reject this signup?')) { var form = document.createElement('form'); form.method = 'POST'; form.action = this.href; var statusInput = document.createElement('input'); statusInput.type = 'hidden'; statusInput.name = 'status'; statusInput.value = 'rejected'; form.appendChild(statusInput); var csrfInput = document.createElement('input'); csrfInput.type = 'hidden'; csrfInput.name = 'csrf_token'; csrfInput.value = '{{ csrf_token() }}'; form.appendChild(csrfInput); document.body.appendChild(form); form.submit(); }">
                          <i class="ti ti-x me-2"></i>Reject
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-footer d-flex align-items-center">
          <p class="m-0 text-muted">Showing 1 to {{ pending_signups|length }} of {{ dashboard_stats.pending_signups if dashboard_stats else pending_signups|length }} pending signups</p>
          {% set signup_total_items = dashboard_stats.pending_signups if dashboard_stats else pending_signups|length %}
          {% set signup_items_per_page = 10 %}
          {% set signup_total_pages = ((signup_total_items - 1) // signup_items_per_page) + 1 if signup_total_items > 0 else 1 %}
          {% if signup_total_pages > 1 %}
          <ul class="pagination m-0 ms-auto">
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
            {% for page_num in range(1, signup_total_pages + 1) %}
              {% if page_num <= 5 %}
              <li class="page-item {% if page_num == 1 %}active{% endif %}">
                <a class="page-link" href="#">{{ page_num }}</a>
              </li>
              {% endif %}
            {% endfor %}
            <li class="page-item">
              <a class="page-link" href="#">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
          </ul>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- What's Happening Section -->
      {% if activity_logs %}
      <h3 class="mt-5 mb-3">
        <i class="ti ti-cardboards me-2" style="color: #2fb344;"></i>What's Happening in Your Activity
      </h3>

      <!-- Activity Log Table -->
      <div class="card" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header">
          <h4 class="card-title">Recent Activity</h4>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter" id="activityLogTable">
            <thead>
              <tr>
                <th scope="col" class="text-muted">Date/Time</th>
                <th scope="col" class="text-muted">Type</th>
                <th scope="col" class="text-muted">Description</th>
              </tr>
            </thead>
            <tbody>
              {% for log in activity_logs %}
                <tr>
                  <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M') if log.timestamp else 'Unknown' }}</td>
                  <td>
                    {% set action_lower = log.action.lower() %}
                    {% if 'redeem' in action_lower %}
                      <i class="ti ti-ticket text-danger"></i>
                      Passport Redeemed
                    {% elif 'signup' in action_lower %}
                      <i class="ti ti-user-plus text-success"></i>
                      Signup Activity
                    {% elif 'created' in action_lower %}
                      <i class="ti ti-id text-lime"></i>
                      Passport Created
                    {% elif 'email' in action_lower %}
                      <i class="ti ti-mail text-info"></i>
                      Email Activity
                    {% elif 'payment' in action_lower %}
                      <i class="ti ti-currency-dollar text-success"></i>
                      Payment Activity
                    {% else %}
                      <i class="ti ti-settings text-muted"></i>
                      Admin Action
                    {% endif %}
                  </td>
                  <td>{{ log.action }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="card-footer d-flex align-items-center">
          <p class="m-0 text-muted">Showing <span id="activityShowingCount">{{ activity_logs|length if activity_logs else 0 }}</span> of {{ activity_logs|length if activity_logs else 0 }} activity logs</p>
          {% set log_total_items = activity_logs|length if activity_logs else 0 %}
          {% set log_items_per_page = 10 %}
          {% set log_total_pages = ((log_total_items - 1) // log_items_per_page) + 1 if log_total_items > 0 else 1 %}
          {% if log_total_pages > 1 %}
          <ul class="pagination m-0 ms-auto" id="activityPaginationControls">
            {% for page_num in range(1, log_total_pages + 1) %}
              {% if page_num <= 5 %}
              <li class="page-item {% if page_num == 1 %}active{% endif %}">
                <a href="#" class="page-link">{{ page_num }}</a>
              </li>
              {% endif %}
            {% endfor %}
          </ul>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Mobile Card Layout -->
      <div class="mobile-only" style="display: none;">
        {% for p in passes[:3] %}
        <div class="user-card">
          <div class="user-card-header">
            <div>
              <h5 class="mb-1">{{ p.user.name }}</h5>
              <small class="text-muted">{{ p.user.email }}</small>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm btn-ghost-secondary" data-bs-toggle="dropdown">
                <i class="ti ti-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ url_for('show_pass', pass_code=p.pass_code) }}">View Profile</a></li>
                <li><a class="dropdown-item" href="{{ url_for('edit_passport', passport_id=p.id) }}">Edit Passport</a></li>
                <li><a class="dropdown-item" href="#">Send Reminder</a></li>
              </ul>
            </div>
          </div>
          <div class="user-card-stats">
            <div>
              <small class="text-muted d-block">Sessions</small>
              {% set total_sessions = (p.passport_type.sessions_included if p.passport_type else 5) %}
              <strong>{{ p.uses_remaining }}/{{ total_sessions }} remaining</strong>
              <div class="sessions-progress mt-1">
                <div class="sessions-progress-bar bg-primary" style="width: {{ (p.uses_remaining / total_sessions * 100) if total_sessions > 0 else 0 }}%"></div>
              </div>
            </div>
            <div>
              <small class="text-muted d-block">Payment</small>
              <span class="badge bg-{{ 'success' if p.paid else 'warning' }}">{{ 'Paid' if p.paid else 'Unpaid' }}</span>
            </div>
          </div>
        </div>
        {% endfor %}

      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize dashboard
  initializeActivityDashboard();
});

function initializeActivityDashboard() {
  // Search functionality
  const searchInput = document.getElementById('userSearch');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(handleSearch, 300));
  }
  
  // Filter tabs
  document.querySelectorAll('.filter-pills .nav-link').forEach(tab => {
    tab.addEventListener('click', handleFilterChange);
  });
  
  // KPI dropdowns
  initializeKPIDropdowns();
  
  // Keyboard shortcuts
  document.addEventListener('keydown', handleKeyboardShortcuts);
  
  // Most dropdown actions now use direct navigation via href attributes
  // Only add click handlers for specific client-side actions
  document.querySelectorAll('.dropdown-item[href="#"]').forEach(item => {
    item.addEventListener('click', handleUserAction);
  });
  
  // Handle window resize to update search behavior
  window.addEventListener('resize', debounce(() => {
    // Re-trigger search to update for new layout
    const searchInput = document.getElementById('userSearch');
    if (searchInput && searchInput.value) {
      handleSearch({ target: searchInput });
    }
  }, 300));
}

// Search functionality - works for both desktop table and mobile cards
function handleSearch(e) {
  const query = e.target.value.toLowerCase();
  
  // Check if we're in mobile view
  const isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    // Search mobile cards
    const mobileCards = document.querySelectorAll('.mobile-only .user-card');
    mobileCards.forEach(card => {
      const userName = card.querySelector('h5')?.textContent.toLowerCase() || '';
      const userEmail = card.querySelector('small.text-muted')?.textContent.toLowerCase() || '';
      
      if (userName.includes(query) || userEmail.includes(query)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  } else {
    // Search desktop table rows
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const userName = row.querySelector('.fw-bold')?.textContent.toLowerCase() || '';
      const userEmail = row.querySelector('.text-muted.small')?.textContent.toLowerCase() || '';
      
      if (userName.includes(query) || userEmail.includes(query)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
  
  updateResultCount();
}

// Filter handling
function handleFilterChange(e) {
  e.preventDefault();
  
  // Update active state
  document.querySelectorAll('.filter-pills .nav-link').forEach(link => {
    link.classList.remove('active');
  });
  e.target.classList.add('active');
  
  const filter = e.target.dataset.filter;
  applyFilter(filter);
}

function applyFilter(filter) {
  const rows = document.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const passportStatus = row.querySelector('td:nth-child(3) .badge')?.textContent.trim();
    const paymentStatus = row.querySelector('td:nth-child(5) .badge')?.textContent.trim();
    
    let shouldShow = false;
    
    switch(filter) {
      case 'all':
        shouldShow = true;
        break;
      case 'active':
        shouldShow = passportStatus === 'Active';
        break;
      case 'unpaid':
        shouldShow = paymentStatus === 'Overdue' || passportStatus === 'Pending';
        break;
      case 'completed':
        shouldShow = row.querySelector('.sessions-progress-bar')?.style.width === '0%';
        break;
      default:
        shouldShow = true;
    }
    
    row.style.display = shouldShow ? '' : 'none';
  });
  
  updateResultCount();
}


// Update result count - works for both desktop and mobile
function updateResultCount() {
  const isMobile = window.innerWidth <= 768;
  let visibleCount, totalCount;
  
  if (isMobile) {
    const visibleCards = document.querySelectorAll('.mobile-only .user-card:not([style*="display: none"])');
    const totalCards = document.querySelectorAll('.mobile-only .user-card');
    visibleCount = visibleCards.length;
    totalCount = totalCards.length;
  } else {
    const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])');
    const totalRows = document.querySelectorAll('tbody tr');
    visibleCount = visibleRows.length;
    totalCount = totalRows.length;
  }
  
  const footerText = document.querySelector('.card-footer .text-muted');
  if (footerText) {
    footerText.textContent = `Showing ${visibleCount} of ${totalCount} entries`;
  }
}

// Keyboard shortcuts
function handleKeyboardShortcuts(e) {
  // Focus search with Ctrl+K or /
  if ((e.ctrlKey && e.key === 'k') || (e.key === '/' && e.target.tagName !== 'INPUT')) {
    e.preventDefault();
    document.getElementById('userSearch')?.focus();
  }
  
  // Clear search with Escape
  if (e.key === 'Escape') {
    const searchInput = document.getElementById('userSearch');
    if (searchInput === document.activeElement) {
      searchInput.value = '';
      searchInput.blur();
      handleSearch({ target: searchInput });
    }
  }
  
}

// User actions - now handled by individual links with proper URLs
function handleUserAction(e) {
  const action = e.target.textContent.trim();
  const userName = e.target.closest('tr')?.querySelector('.fw-bold')?.textContent || 'User';
  
  // Most actions now use direct links to Flask routes
  // Only handle client-side actions here
  switch(action) {
    case 'Send Reminder':
      showNotification('info', `Reminder request sent for ${userName}`);
      break;
    case 'Remove User':
      // This would be handled by a DELETE request to the backend
      showNotification('info', `Remove action triggered for ${userName}`);
      break;
  }
}


// Utility functions
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showNotification(type, message) {
  // Create notification element
  const notification = document.createElement('div');
  const typeClass = type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger';
  const icon = type === 'success' ? 'check' : type === 'warning' ? 'alert-triangle' : type === 'info' ? 'info-circle' : 'alert-circle';
  const title = type === 'success' ? 'Success!' : type === 'warning' ? 'Warning!' : type === 'info' ? 'Info' : 'Error!';
  
  notification.className = `alert alert-${typeClass} alert-dismissible position-fixed top-0 end-0 m-3`;
  notification.style.zIndex = '9999';
  notification.style.minWidth = '300px';
  notification.innerHTML = `
    <div class="d-flex">
      <div>
        <i class="ti ti-${icon} alert-icon"></i>
      </div>
      <div>
        <h4 class="alert-title">${title}</h4>
        <div class="text-muted">${message}</div>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Enhanced search with URL updates and better filtering
function enhancedSearch(query) {
  const rows = document.querySelectorAll('tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const userName = row.querySelector('.fw-bold')?.textContent.toLowerCase() || '';
    const userEmail = row.querySelector('.text-muted.small')?.textContent.toLowerCase() || '';
    const activityName = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
    
    const searchText = query.toLowerCase();
    const isVisible = userName.includes(searchText) || 
                     userEmail.includes(searchText) || 
                     activityName.includes(searchText);
    
    row.style.display = isVisible ? '' : 'none';
    if (isVisible) visibleCount++;
  });
  
  // Update result count display
  const resultInfo = document.querySelector('.card-footer .text-muted');
  if (resultInfo) {
    const totalRows = rows.length;
    resultInfo.textContent = `Showing ${visibleCount} of ${totalRows} entries`;
  }
  
  // Update URL without page reload for better UX
  if (history.pushState) {
    const url = new URL(window.location);
    if (query) {
      url.searchParams.set('search', query);
    } else {
      url.searchParams.delete('search');
    }
    history.pushState(null, '', url);
  }
  
  return visibleCount;
}

// KPI Dropdown Functionality
function initializeKPIDropdowns() {
  // Add event listeners to all KPI dropdown items
  document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(item => {
    // Only handle KPI dropdowns (those with period data)
    if (item.textContent.includes('days')) {
      item.addEventListener('click', handleKPITimeChange);
    }
  });
}

function handleKPITimeChange(event) {
  event.preventDefault();
  
  const clickedItem = event.target;
  const dropdown = clickedItem.closest('.dropdown');
  const dropdownButton = dropdown.querySelector('.dropdown-toggle');
  const kpiCard = clickedItem.closest('.card');
  
  // Extract period from text (e.g., "Last 7 days" -> 7)
  const periodText = clickedItem.textContent.trim();
  const periodMatch = periodText.match(/(\d+)\s+days/);
  if (!periodMatch) return;
  
  const period = parseInt(periodMatch[1]);
  
  // Update dropdown button text
  dropdownButton.textContent = periodText;
  
  // Show loading state
  showKPILoading(kpiCard);
  
  // Make AJAX request to update KPI data
  updateKPIData(period, kpiCard);
}

function showKPILoading(kpiCard) {
  const valueElement = kpiCard.querySelector('.h2');
  const trendElement = kpiCard.querySelector('.text-success, .text-muted');
  
  if (valueElement) {
    valueElement.style.opacity = '0.5';
  }
  if (trendElement) {
    trendElement.style.opacity = '0.5';
  }
}

function hideKPILoading(kpiCard) {
  const valueElement = kpiCard.querySelector('.h2');
  const trendElement = kpiCard.querySelector('.text-success, .text-muted');
  
  if (valueElement) {
    valueElement.style.opacity = '1';
  }
  if (trendElement) {
    trendElement.style.opacity = '1';
  }
}

function updateKPIData(period, kpiCard) {
  // Get activity ID from current URL
  const pathParts = window.location.pathname.split('/');
  const activityId = pathParts[pathParts.length - 1];
  
  // For now, simulate API call with mock data
  // TODO: Replace with actual API endpoint when available
  setTimeout(() => {
    updateKPIDisplay(kpiCard, period);
    hideKPILoading(kpiCard);
  }, 500);
  
  // Uncomment this when the API endpoint is available:
  /*
  fetch(`/api/activity-kpis/${activityId}?period=${period}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateKPIDisplayFromAPI(kpiCard, data.kpi_data);
      } else {
        console.error('Failed to fetch KPI data:', data.error);
        showNotification('error', 'Failed to update KPI data');
      }
      hideKPILoading(kpiCard);
    })
    .catch(error => {
      console.error('Error fetching KPI data:', error);
      showNotification('error', 'Failed to update KPI data');
      hideKPILoading(kpiCard);
    });
  */
}

function updateKPIDisplay(kpiCard, period) {
  const titleElement = kpiCard.querySelector('.text-uppercase');
  const valueElement = kpiCard.querySelector('.h2');
  const trendElement = kpiCard.querySelector('.text-success, .text-muted');
  
  if (!titleElement || !valueElement) return;
  
  const kpiType = titleElement.textContent.toLowerCase();
  
  // Mock data based on period and KPI type
  let mockData = getMockKPIData(kpiType, period);
  
  // Update display
  if (kpiType.includes('revenue')) {
    valueElement.textContent = `$${mockData.value}`;
  } else {
    valueElement.textContent = mockData.value;
  }
  
  if (trendElement) {
    const trendIcon = trendElement.querySelector('i');
    trendElement.className = `text-${mockData.trend === 'up' ? 'success' : 'muted'} me-2`;
    trendElement.innerHTML = `${mockData.percentage}% <i class="ti ti-trending-${mockData.trend}"></i>`;
  }
}

function getMockKPIData(kpiType, period) {
  // Generate realistic mock data based on period
  const baseMultiplier = period === 7 ? 1 : period === 30 ? 3.8 : 11.5;
  
  switch (kpiType) {
    case 'revenue':
      return {
        value: Math.round(1200 * baseMultiplier),
        percentage: Math.round(5 + (period / 10)),
        trend: 'up'
      };
    case 'active users':
      return {
        value: Math.round(25 * baseMultiplier),
        percentage: Math.round(8 + (period / 15)),
        trend: 'up'
      };
    case 'unpaid passports':
      return {
        value: Math.round(3 * Math.max(1, baseMultiplier * 0.3)),
        percentage: Math.round(2 + (period / 20)),
        trend: period > 30 ? 'up' : 'down'
      };
    case 'activity profit':
      return {
        value: Math.round(800 * baseMultiplier),
        percentage: Math.round(85 + (period / 30)),
        trend: 'up'
      };
    default:
      return { value: 0, percentage: 0, trend: 'stable' };
  }
}

function updateKPIDisplayFromAPI(kpiCard, kpiData) {
  // This function will be used when the actual API is integrated
  const titleElement = kpiCard.querySelector('.text-uppercase');
  const valueElement = kpiCard.querySelector('.h2');
  const trendElement = kpiCard.querySelector('.text-success, .text-muted');
  
  if (!titleElement || !valueElement) return;
  
  const kpiType = titleElement.textContent.toLowerCase();
  let data;
  
  // Map KPI types to API response data
  if (kpiType.includes('revenue')) {
    data = kpiData.revenue;
    valueElement.textContent = `$${Math.round(data.total)}`;
  } else if (kpiType.includes('active users')) {
    data = kpiData.active_users;
    valueElement.textContent = data.total;
  } else if (kpiType.includes('unpaid')) {
    data = kpiData.unpaid_passports;
    valueElement.textContent = data.total;
  } else if (kpiType.includes('profit')) {
    data = kpiData.profit;
    valueElement.textContent = `$${Math.round(data.total)}`;
  }
  
  if (data && trendElement) {
    trendElement.className = `text-${data.trend === 'up' ? 'success' : 'muted'} me-2`;
    trendElement.innerHTML = `${Math.round(data.percentage)}% <i class="ti ti-trending-${data.trend}"></i>`;
  }
}
</script>
{% endblock %}