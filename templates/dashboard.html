{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-3 d-none d-md-flex">
  <div class="col-auto">
    <a href="{{ url_for('create_pass') }}" class="btn btn-primary">
      <i class="ti ti-plus"></i> Add New
    </a>
  </div>
  <div class="col-auto">
    <a href="{{ url_for('scan_qr') }}" class="btn btn-secondary">
      <i class="ti ti-scan"></i> Scan Pass
    </a>
  </div>
  <div class="col-auto ms-auto">
    <div class="input-group">
      <input type="text" id="searchBox" class="form-control" placeholder="Search by User Name..." />
    </div>
  </div>
</div>

<!-- Floating action button for mobile -->
<div class="d-md-none">
  <div class="position-fixed bottom-0 end-0 m-4">
    <a href="{{ url_for('create_pass') }}" class="btn btn-primary btn-lg rounded-circle shadow" title="Add New Pass">
      <i class="ti ti-plus"></i>
    </a>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Active | Unpaid Passes</h3>
  </div>
  <div class="table-responsive">
    <table class="table card-table table-vcenter">
      <thead>
        <tr>
          <th>Name</th>
          <th>Created</th>
          <th class="d-none d-md-table-cell">Activity</th>
          <th>Amount</th>
          <th>Remain</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for pass in passes %}
        <tr>
          <td>
            <a href="{{ url_for('show_pass', pass_code=pass.pass_code) }}"
               class="d-flex align-items-center text-reset text-decoration-none"
               title="{{ pass.user_email }} (Pass ID: {{ pass.id }})">
              <span class="avatar me-2 rounded"
                    style="background-image: url('https://www.gravatar.com/avatar/{{ pass.user_email|lower|trim|encode_md5 }}?d=identicon')">
              </span>
              {{ pass.user_name }}
            </a>
          </td>
          <td>{{ pass.pass_created_dt.strftime('%Y-%m-%d') }}</td>
          <td class="d-none d-md-table-cell">{{ pass.activity }}</td>
          <td class="{% if not pass.paid_ind %}text-danger fw-bold{% endif %}">${{ '%.2f' % pass.sold_amt }}</td>
          <td>{{ pass.games_remaining }}</td>
          <td>
            <div class="dropdown">
              <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</a>
              <div class="dropdown-menu">
                <a class="dropdown-item text-primary redeem-btn" href="#" data-pass="{{ pass.pass_code }}">
                  <i class="ti ti-check me-2"></i>Redeem a Game
                </a>
                {% if not pass.paid_ind %}
                <form action="{{ url_for('mark_paid', pass_id=pass.id) }}" method="POST" onsubmit="return confirm('Mark this pass as paid?');">
                  <button class="dropdown-item text-success" type="submit">
                    <i class="ti ti-currency-dollar me-2"></i>Mark as Paid
                  </button>
                </form>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("searchBox");
    const rows = document.querySelectorAll("table tbody tr");

    input.addEventListener("input", function () {
      const filter = input.value.toLowerCase();
      rows.forEach(row => {
        const name = row.children[0].textContent.toLowerCase();
        row.style.display = name.includes(filter) ? "" : "none";
      });
    });

    document.querySelectorAll(".redeem-btn").forEach(button => {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        const passCode = this.dataset.pass;
        if (confirm(`Redeem 1 game from pass #${passCode}?`)) {
          window.location.href = `/redeem/${passCode}`;
        }
      });
    });

    // Auto-dismiss flash alerts after 5 seconds
    const alerts = document.querySelectorAll(".alert");
    if (alerts.length) {
      setTimeout(() => {
        alerts.forEach(alert => alert.remove());
      }, 5000);
    }
  });
</script>
{% endblock %}
