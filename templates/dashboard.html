{% extends "base.html" %}
{% block title %}Dashboard - Minipass{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none">
    <div class="dashboard-container">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h2 class="page-title mb-2">
            Welcome back{% if session.get("admin") %}, {{ session['admin'].split('@')[0].title() }}{% endif %}!
          </h2>
          <div class="text-muted">
            Here's what's happening with your activities today.
          </div>
        </div>
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <a href="{{ url_for('create_activity') }}" class="btn btn-primary d-none d-md-inline-block">
              <i class="ti ti-plus"></i>
              New Activity
            </a>
            <a href="{{ url_for('create_activity') }}" class="btn btn-primary d-md-none btn-icon" aria-label="New Activity">
              <i class="ti ti-plus"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">
      
      <!-- KPI Cards Section - Desktop Layout -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- Revenue Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">REVENUE</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="revenue-value">${{ "{:,.0f}".format(kpi_data['7d']['revenue']) if kpi_data and kpi_data.get('7d') else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('revenue_change') %}
                  {% if kpi_data['7d']['revenue_change'] > 0 %}
                    <div class="text-success me-2" id="revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['revenue_change'] < 0 %}
                    <div class="text-danger me-2" id="revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="revenue-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="revenue-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="revenue-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Passports Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ passport_stats['active_passports'] if passport_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('passport_change') %}
                  {% if kpi_data['7d']['passport_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['passport_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="active-passports-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Passports Created Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ passport_stats['total_passports'] if passport_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('new_passports_change') %}
                  {% if kpi_data['7d']['new_passports_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['new_passports_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="passports-created-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Sign Ups Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PENDING SIGN UPS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ signup_stats['pending_signups'] if signup_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('signup_change') %}
                  {% if kpi_data['7d']['signup_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['signup_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="pending-signups-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Section - Mobile Carousel -->
      <div class="d-md-none mb-4">
        <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
          <!-- Revenue Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">REVENUE</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1" id="mobile-revenue-value">${{ "{:,.0f}".format(kpi_data['7d']['revenue']) if kpi_data and kpi_data.get('7d') else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('revenue_change') %}
                    {% if kpi_data['7d']['revenue_change'] > 0 %}
                      <div class="text-success me-2" id="mobile-revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['revenue_change'] < 0 %}
                      <div class="text-danger me-2" id="mobile-revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2" id="mobile-revenue-trend">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2" id="mobile-revenue-trend">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-revenue-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Active Passports Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ passport_stats['active_passports'] if passport_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('passport_change') %}
                    {% if kpi_data['7d']['passport_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['passport_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-active-passports-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Passports Created Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ passport_stats['total_passports'] if passport_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('new_passports_change') %}
                    {% if kpi_data['7d']['new_passports_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['new_passports_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-passports-created-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Sign Ups Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">PENDING SIGN UPS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ signup_stats['pending_signups'] if signup_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('signup_change') %}
                    {% if kpi_data['7d']['signup_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['signup_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-pending-signups-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Scroll indicators -->
        <div class="text-center mt-2">
          <span class="badge bg-primary me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light" style="width: 8px; height: 8px; border-radius: 50%;"></span>
        </div>
      </div>

      <!-- Activities Section -->
      <div class="mb-4">
        <h3 class="mb-3">Your Activities</h3>
        
        <!-- Desktop Layout -->
        <div class="d-none d-md-block">
          <div class="row">
            {% for activity in activities %}
            <div class="col-md-3 mb-3">
              <div class="card" style="border-radius: 12px; overflow: hidden;">
                <!-- Activity Image -->
                {% if activity.image_filename %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                </div>
                {% else %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); display: flex; align-items: center; justify-content: center;">
                  <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="card-title mb-0">{{ activity.name[:20] }}{% if activity.name|length > 20 %}...{% endif %}</h3>
                    {% if activity.days_left != "N/A" %}
                    <small class="text-muted">{{ activity.days_left }}d left</small>
                    {% endif %}
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                    <span class="badge bg-blue-lt">{{ activity.passports }} created</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- Mobile Layout -->
        <div class="d-md-none">
          <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
            {% for activity in activities %}
            <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
              <div class="card" style="border-radius: 12px; overflow: hidden;">
                <!-- Activity Image -->
                {% if activity.image_filename %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                </div>
                {% else %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); display: flex; align-items: center; justify-content: center;">
                  <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="card-title mb-0">{{ activity.name }}</h3>
                    {% if activity.days_left != "N/A" %}
                    <small class="text-muted">{{ activity.days_left }}d left</small>
                    {% endif %}
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                    <span class="badge bg-blue-lt">{{ activity.passports }} created</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          <!-- Scroll indicators for activities -->
          <div class="text-center mt-2">
            {% set activity_count = activities|length %}
            {% set max_indicators = 4 if activity_count > 4 else activity_count %}
            {% for i in range(max_indicators) %}
              <span class="badge {% if i == 0 %}bg-primary{% else %}bg-light{% endif %} me-1" 
                    style="width: 8px; height: 8px; border-radius: 50%;"></span>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Activity Log Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-header">
              <h3 class="card-title">What's Happening?</h3>
            </div>
            <div class="table-responsive">
              <table class="table card-table table-vcenter" id="logTable">
                <thead>
                  <tr>
                    <th scope="col" class="text-muted">Date/Time</th>
                    <th scope="col" class="text-muted">Type</th>
                    <th scope="col" class="text-muted">Description</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in logs[:25] %}
                  <tr>
                    <td>{{ log.timestamp | utc_to_local | datetimeformat('%Y-%m-%d %H:%M') }}</td>
                    <td data-type="{{ log.type }}">
                      {% if log.type == 'Passport Redeemed' %}
                        <i class="ti ti-ticket text-danger"></i>
                      {% elif log.type == 'Email Sent' %}
                        <i class="ti ti-mail text-info"></i>
                      {% elif log.type == 'Passport Created' %}
                        <i class="ti ti-id text-lime"></i>
                      {% elif log.type == 'Interact Payment' %}
                        <i class="ti ti-currency-dollar text-success"></i>  
                      {% elif log.type == 'Marked Paid' %}
                        <i class="ti ti-check text-green"></i>  
                      {% elif log.type == 'Reminder Sent' %}
                        <i class="ti ti-bell text-purple"></i>
                      {% elif log.type == 'Signup Submitted' %}
                        <i class="ti ti-user-plus text-success"></i>  
                      {% elif log.type == 'Signup Approved' %}
                        <i class="ti ti-user-check text-green"></i>
                      {% elif log.type == 'Signup Rejected' %}
                        <i class="ti ti-user-x text-danger"></i>
                      {% elif log.type == 'Signup Cancelled' %}
                        <i class="ti ti-user-x text-danger"></i>
                      {% elif log.type == 'Activity Created' %}
                        <i class="ti ti-target text-orange"></i>
                      {% elif log.type == 'Admin Action' %}
                        <i class="ti ti-settings text-muted"></i>
                      {% else %}
                        <i class="ti ti-activity text-muted"></i>  
                      {% endif %}
                      {{ log.type }}
                    </td>
                    <td>{{ log.details }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer d-flex align-items-center">
              <p class="m-0 text-muted">Showing <span id="showingCount">{{ logs[:25]|length }}</span> of {{ logs|length }}</p>
              <ul class="pagination m-0 ms-auto" id="paginationControls">
                <li class="page-item active"><a href="#" class="page-link">1</a></li>
                <li class="page-item"><a href="#" class="page-link">2</a></li>
                <li class="page-item"><a href="#" class="page-link">3</a></li>
                <li class="page-item disabled"><a href="#" class="page-link">...</a></li>
                <li class="page-item"><a href="#" class="page-link">{{ (logs|length / 25)|round(0, 'ceil')|int }}</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

{% endblock %}

{% block styles %}
<style>
.card {
  background-color: #fff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.table {
  background-color: #fff !important;
}

/* Mobile scroll snap styles */
.d-flex.overflow-auto {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.d-flex.overflow-auto::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

/* Hover effects */
.card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transform: translateY(-1px);
  transition: all 0.2s ease-in-out;
}

/* Mobile scroll indicators */
@media (max-width: 767.98px) {
  .flex-shrink-0 {
    scroll-snap-align: start;
  }
}
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Store KPI data from backend
const kpiData = {{ kpi_data | tojson | safe }};
let currentPeriod = '7d';

// Function to generate interactive line chart with hover points
function generateInteractiveLineChart(data, width = 300, height = 40, chartId = '') {
  if (!data || data.length === 0) return { path: '', points: [] };
  
  // Find min and max for scaling
  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;
  
  // Generate path coordinates and hover points
  const coordinates = [];
  const hoverPoints = [];
  
  data.forEach((value, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - ((value - min) / range) * (height - 10) - 5;
    
    coordinates.push(`${index === 0 ? 'M' : 'L'} ${x},${y}`);
    hoverPoints.push({ x, y, value, index });
  });
  
  return {
    path: coordinates.join(' '),
    points: hoverPoints
  };
}

// Legacy function for backward compatibility
function generateLineChart(data, width = 300, height = 40) {
  const result = generateInteractiveLineChart(data, width, height);
  return result.path;
}

// Tooltip management functions
function createTooltip() {
  let tooltip = document.getElementById('chart-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'chart-tooltip';
    tooltip.className = 'chart-tooltip';
    tooltip.style.cssText = `
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      white-space: nowrap;
    `;
    document.body.appendChild(tooltip);
  }
  return tooltip;
}

function showTooltip(x, y, value, period, index) {
  const tooltip = createTooltip();
  const formattedValue = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value);
  
  // Calculate the date based on period and index
  const daysAgo = parseInt(period) - index - 1;
  const date = new Date();
  date.setDate(date.getDate() - daysAgo);
  const formattedDate = date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric'
  });
  
  tooltip.innerHTML = `${formattedValue}<br><small>${formattedDate}</small>`;
  tooltip.style.left = `${x}px`;
  tooltip.style.top = `${y - 10}px`;
  tooltip.style.opacity = '1';
}

function hideTooltip() {
  const tooltip = document.getElementById('chart-tooltip');
  if (tooltip) {
    tooltip.style.opacity = '0';
  }
}

// Function to generate bar chart SVG rectangles
function generateBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  const max = Math.max(...data) || 1;
  const barWidth = (width - (data.length - 1) * 2) / data.length;
  
  let svg = '';
  data.forEach((value, index) => {
    const barHeight = (value / max) * (height - 5);
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#206bc4" opacity="0.8" />`;
  });
  
  return svg;
}

// Update all charts with real data with smooth animations
function updateCharts(period = '7d') {
  const periodData = kpiData[period];
  if (!periodData) return;
  
  // Add fade-out animation to existing charts
  const allCharts = document.querySelectorAll('.card svg');
  allCharts.forEach(chart => {
    chart.style.transition = 'opacity 0.3s ease';
    chart.style.opacity = '0.3';
  });
  
  // Delay the chart update for smooth transition
  setTimeout(() => {
  
  // Update Revenue Line Chart (both desktop and mobile) with interactive tooltips
  const revenueChartData = generateInteractiveLineChart(periodData.revenue_trend, 300, 40, 'revenue');
  const revenueCharts = ['#revenue-chart', '#mobile-revenue-chart'];
  revenueCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && revenueChartData.path) {
      // Create SVG with path and invisible hover zones
      chart.innerHTML = `
        <path d="${revenueChartData.path}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        ${revenueChartData.points.map((point, index) => 
          `<circle cx="${point.x}" cy="${point.y}" r="6" fill="transparent" 
                   data-value="${point.value}" data-index="${index}" 
                   class="chart-hover-point" style="cursor: pointer;" />`
        ).join('')}
      `;
      
      // Add hover event listeners for revenue tooltips
      chart.querySelectorAll('.chart-hover-point').forEach(point => {
        point.addEventListener('mouseenter', function(e) {
          const rect = chart.getBoundingClientRect();
          const value = parseFloat(this.getAttribute('data-value'));
          const index = parseInt(this.getAttribute('data-index'));
          showTooltip(
            rect.left + parseFloat(this.getAttribute('cx')) + window.scrollX,
            rect.top + parseFloat(this.getAttribute('cy')) + window.scrollY - 50,
            value, 
            period, 
            index
          );
        });
        
        point.addEventListener('mouseleave', hideTooltip);
      });
    }
  });
  
  // Update Active Passports Bar Chart (both desktop and mobile)
  const activePassportsBars = generateBarChart(periodData.active_users_trend);
  const activePassportsCharts = ['#active-passports-chart', '#mobile-active-passports-chart'];
  activePassportsCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && periodData.active_users_trend) {
      chart.innerHTML = activePassportsBars;
    }
  });
  
  // Update Passports Created Line Chart (both desktop and mobile)
  const passportsCreatedPath = generateLineChart(periodData.pass_created_trend);
  const passportsCreatedCharts = ['#passports-created-chart', '#mobile-passports-created-chart'];
  passportsCreatedCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && passportsCreatedPath) {
      chart.innerHTML = `<path d="${passportsCreatedPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
    }
  });
  
  // Update Pending Signups Bar Chart (both desktop and mobile)
  const pendingSignupsBars = generateBarChart(periodData.pending_signups_trend);
  const pendingSignupsCharts = ['#pending-signups-chart', '#mobile-pending-signups-chart'];
  pendingSignupsCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && periodData.pending_signups_trend) {
      chart.innerHTML = pendingSignupsBars;
    }
  });
  
  // Update KPI values and performance indicators
  updateKpiValues(period, periodData);
  
  // Add fade-in animation to updated charts
  setTimeout(() => {
    const allCharts = document.querySelectorAll('.card svg');
    allCharts.forEach(chart => {
      chart.style.opacity = '1';
    });
  }, 50);
  
  }, 150); // End of main setTimeout for smooth transition
}

// Function to update KPI values and performance indicators
function updateKpiValues(period, periodData) {
  // Update Revenue KPI value
  const revenueValueEl = document.getElementById('revenue-value');
  const mobileRevenueValueEl = document.getElementById('mobile-revenue-value');
  
  if (periodData.revenue !== undefined) {
    const revenueValue = `$${Math.round(periodData.revenue).toLocaleString()}`;
    if (revenueValueEl) revenueValueEl.textContent = revenueValue;
    if (mobileRevenueValueEl) mobileRevenueValueEl.textContent = revenueValue;
  }
  
  // Update Revenue trend percentage
  const revenueTrendEl = document.getElementById('revenue-trend');
  const mobileRevenueTrendEl = document.getElementById('mobile-revenue-trend');
  
  if (periodData.revenue_change !== undefined) {
    const change = periodData.revenue_change;
    let trendClass = 'text-muted';
    let icon = 'ti-minus';
    
    if (change > 0) {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (change < 0) {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    }
    
    const trendHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    const trendClass2 = `${trendClass} me-2`;
    
    if (revenueTrendEl) {
      revenueTrendEl.className = trendClass2;
      revenueTrendEl.innerHTML = trendHTML;
    }
    if (mobileRevenueTrendEl) {
      mobileRevenueTrendEl.className = trendClass2;
      mobileRevenueTrendEl.innerHTML = trendHTML;
    }
  }
}

// Handle period dropdown clicks with smooth transitions
function attachDropdownHandlers() {
  // Find all dropdown items in KPI cards
  document.querySelectorAll('.card .dropdown-menu .dropdown-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Prevent multiple rapid clicks
      if (this.classList.contains('loading')) return;
      this.classList.add('loading');
      
      // Get period from text
      const text = this.textContent.trim();
      let period = '7d';
      if (text.includes('30')) period = '30d';
      else if (text.includes('90')) period = '90d';
      
      // Update button text with loading state
      const button = this.closest('.dropdown').querySelector('.dropdown-toggle');
      const originalText = button ? button.textContent : '';
      if (button) {
        button.style.opacity = '0.7';
        button.textContent = text + ' ...';
      }
      
      // Update current period
      currentPeriod = period;
      
      // Update charts with animation
      updateCharts(period);
      
      // Reset loading state and button text
      setTimeout(() => {
        this.classList.remove('loading');
        if (button) {
          button.style.opacity = '1';
          button.textContent = text;
        }
      }, 400);
    });
  });
}

// KPI Dropdown Functionality for Main Dashboard
function initializeKPIDropdowns() {
  // Add event listeners to all KPI dropdown items with the kpi-period-btn class
  document.querySelectorAll('.kpi-period-btn').forEach(item => {
    item.addEventListener('click', handleKPITimeChange);
  });
}

function handleKPITimeChange(event) {
  event.preventDefault();
  
  const clickedItem = event.target;
  const period = clickedItem.dataset.period;
  const dropdown = clickedItem.closest('.dropdown');
  const dropdownButton = dropdown.querySelector('.dropdown-toggle');
  
  // Prevent multiple rapid clicks
  if (clickedItem.classList.contains('loading')) return;
  clickedItem.classList.add('loading');
  
  // Update dropdown button text with loading state
  dropdownButton.style.opacity = '0.7';
  dropdownButton.textContent = clickedItem.textContent.trim() + ' ...';
  
  // Update all dropdown buttons with same period
  document.querySelectorAll('.dropdown-toggle').forEach(btn => {
    if (btn.textContent.includes('days') || btn.textContent.includes('...')) {
      btn.textContent = clickedItem.textContent.trim() + ' ...';
      btn.style.opacity = '0.7';
    }
  });
  
  // Show loading state
  showKPILoading();
  
  // Update KPI data and charts
  updateMainDashboardKPIs(period);
  
  // Reset loading state after completion
  setTimeout(() => {
    clickedItem.classList.remove('loading');
    document.querySelectorAll('.dropdown-toggle').forEach(btn => {
      if (btn.textContent.includes('...')) {
        btn.textContent = clickedItem.textContent.trim();
        btn.style.opacity = '1';
      }
    });
  }, 600);
}

function showKPILoading() {
  // Show loading for all KPI cards
  document.querySelectorAll('.card .h2').forEach(el => {
    el.style.opacity = '0.5';
  });
  document.querySelectorAll('.card .text-success, .card .text-danger, .card .text-muted').forEach(el => {
    if (el.closest('.card')) {
      el.style.opacity = '0.5';
    }
  });
}

function hideKPILoading() {
  // Hide loading for all KPI cards
  document.querySelectorAll('.card .h2').forEach(el => {
    el.style.opacity = '1';
  });
  document.querySelectorAll('.card .text-success, .card .text-danger, .card .text-muted').forEach(el => {
    if (el.closest('.card')) {
      el.style.opacity = '1';
    }
  });
}

function updateMainDashboardKPIs(period) {
  // First, try to use existing KPI data for immediate feedback
  const existingData = kpiData[period];
  if (existingData) {
    updateKPIValues(period, existingData);
  }
  
  // Then fetch fresh data from the API
  fetch(`/api/global-kpis?period=${period}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateKPIDisplays(data.kpi_data, period);
        updateCharts(period);
      } else {
        console.error('Failed to fetch KPI data:', data.error);
        // Fall back to existing data if API fails
        if (existingData) {
          updateKPIValues(period, existingData);
          updateCharts(period);
        }
      }
      hideKPILoading();
    })
    .catch(error => {
      console.error('Error fetching KPI data:', error);
      // Fall back to existing data if API fails
      if (existingData) {
        updateKPIValues(period, existingData);
        updateCharts(period);
      }
      hideKPILoading();
    });
}

function updateKPIDisplays(kpiData, period) {
  // Update Revenue - pass the full period data which contains revenue and revenue_change
  updateKPICard('revenue', kpiData);
  updateKPICard('mobile-revenue', kpiData);
  
  // Update Active Passports (we don't have exact counts in API, so skip for now)
  // updateKPICard('active-passports', kpiData.active_passports);
  
  // Update Passports Created (we don't have exact counts in API, so skip for now)
  // updateKPICard('passports-created', kpiData.passports_created);
  
  // Update Pending Signups (we don't have exact counts in API, so skip for now)
  // updateKPICard('pending-signups', kpiData.pending_signups);
}

function updateKPICard(prefix, data) {
  // Update value
  const valueEl = document.getElementById(`${prefix}-value`);
  if (valueEl && data) {
    if (prefix.includes('revenue')) {
      valueEl.textContent = `$${Math.round(data.revenue || 0).toLocaleString()}`;
    } else {
      valueEl.textContent = Math.round(data.total || 0);
    }
  }
  
  // Update trend
  const trendEl = document.getElementById(`${prefix}-trend`);
  if (trendEl && data) {
    // Use revenue_change for revenue cards, change for others
    const change = prefix.includes('revenue') ? (data.revenue_change || 0) : (data.change || 0);
    let trendClass = 'text-muted';
    let icon = 'ti-minus';
    
    if (change > 0) {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (change < 0) {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    }
    
    trendEl.className = `${trendClass} me-2`;
    trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
  }
}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
  updateCharts('7d');
  attachDropdownHandlers();
  initializeKPIDropdowns();
});
</script>
{% endblock %}