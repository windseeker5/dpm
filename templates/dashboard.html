{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-3 d-none d-md-flex">
  <div class="col-auto">
    <a href="{{ url_for('create_pass') }}" class="btn btn-primary">
      <i class="ti ti-plus"></i> Add New
    </a>
  </div>
  <div class="col-auto">
    <a href="{{ url_for('scan_qr') }}" class="btn btn-secondary">
      <i class="ti ti-scan"></i> Scan Pass
    </a>
  </div>
  <div class="col-auto ms-auto">
    <div class="input-group">
      <input type="text" id="searchBox" class="form-control" placeholder="Search by User Name..." />
    </div>
  </div>
</div>

<!-- Floating action button for mobile -->
<div class="d-md-none">
  <div class="position-fixed bottom-0 end-0 m-4">
    <a href="{{ url_for('create_pass') }}" class="btn btn-primary btn-lg rounded-circle shadow" title="Add New Pass">
      <i class="ti ti-plus"></i>
    </a>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">Active Passes</h3>
  </div>
  <div class="table-responsive">
    <table class="table card-table table-vcenter" id="passTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Activity</th>
          <th class="d-none d-md-table-cell">Created</th>

          <th class="d-none d-md-table-cell">Amount</th>

          <th class="d-none d-md-table-cell">Remain</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for pass in passes %}
        <tr>
          <td>
            <a href="{{ url_for('show_pass', pass_code=pass.pass_code) }}"
               class="d-flex align-items-center text-reset text-decoration-none"
               title="{{ pass.user_email }} (Pass ID: {{ pass.id }})">
              <span class="avatar me-2 rounded"
                    style="background-image: url('https://www.gravatar.com/avatar/{{ pass.user_email|lower|trim|encode_md5 }}?d=identicon')">
              </span>
              {{ pass.user_name }}
            </a>
          </td>
          <td>{{ pass.activity }}</td>
          <td class="d-none d-md-table-cell">{{ pass.pass_created_dt.strftime('%Y-%m-%d') }}</td>

          <td class="d-none d-md-table-cell {% if not pass.paid_ind %}text-danger fw-bold{% endif %}">
            ${{ '%.2f' % pass.sold_amt }}
          </td>
          

          <td class="d-none d-md-table-cell">{{ pass.games_remaining }}</td>
          <td>
            <div class="dropdown">
              <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</a>
              <div class="dropdown-menu">
                <a class="dropdown-item text-primary redeem-btn" href="#" data-pass="{{ pass.pass_code }}">
                  <i class="ti ti-check me-2"></i>Redeem a Game
                </a>
                {% if not pass.paid_ind %}
                <form action="{{ url_for('mark_paid', pass_id=pass.id) }}" method="POST" onsubmit="return confirm('Mark this pass as paid?');">
                  <button class="dropdown-item text-success" type="submit">
                    <i class="ti ti-currency-dollar me-2"></i>Mark as Paid
                  </button>
                </form>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination controls (pure client-side JS-based) -->
  <div class="card-footer d-flex align-items-center">
    <p class="m-0 text-muted">Showing <span id="showingCount">0</span> of {{ passes|length }}</p>
    <ul class="pagination m-0 ms-auto" id="paginationControls"></ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("searchBox");
  const rows = Array.from(document.querySelectorAll("#passTable tbody tr"));
  const tableBody = document.querySelector("#passTable tbody");

  const rowsPerPage = 25;
  let currentPage = 1;

  function renderTable(filteredRows) {
    const totalRows = filteredRows.length;
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pagedRows = filteredRows.slice(start, end);

    tableBody.innerHTML = "";
    pagedRows.forEach(row => tableBody.appendChild(row));
    document.getElementById("showingCount").textContent = pagedRows.length;

    renderPagination(totalRows);
  }

  function renderPagination(total) {
    const pageCount = Math.ceil(total / rowsPerPage);
    const pagination = document.getElementById("paginationControls");
    pagination.innerHTML = "";

    for (let i = 1; i <= pageCount; i++) {
      const li = document.createElement("li");
      li.className = `page-item ${i === currentPage ? "active" : ""}`;
      li.innerHTML = `<a href="#" class="page-link">${i}</a>`;
      li.addEventListener("click", function (e) {
        e.preventDefault();
        currentPage = i;
        renderTable(filterRows());
      });
      pagination.appendChild(li);
    }
  }

  function filterRows() {
    const filter = input.value.toLowerCase();
    return rows.filter(row => {
      const name = row.children[0].textContent.toLowerCase();
      return name.includes(filter);
    });
  }

  input.addEventListener("input", () => {
    currentPage = 1;
    renderTable(filterRows());
  });

  document.querySelectorAll(".redeem-btn").forEach(button => {
    button.addEventListener("click", function (e) {
      e.preventDefault();
      const passCode = this.dataset.pass;
      if (confirm(`Redeem 1 game from pass #${passCode}?`)) {
        window.location.href = `/redeem/${passCode}`;
      }
    });
  });

  renderTable(rows);
});
</script>
{% endblock %}
