{% extends "base.html" %}
{% block title %}Dashboard - Minipass{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none">
    <div class="dashboard-container">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h2 class="page-title mb-2">
            Welcome back{% if session.get("admin") %}, {{ session['admin'].split('@')[0].title() }}{% endif %}!
          </h2>
          <div class="text-muted">
            Here's what's happening with your activities today.
          </div>
        </div>
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <a href="{{ url_for('create_activity') }}" class="btn btn-primary d-none d-md-inline-block">
              <i class="ti ti-plus"></i>
              New Activity
            </a>
            <a href="{{ url_for('create_activity') }}" class="btn btn-primary d-md-none btn-icon" aria-label="New Activity">
              <i class="ti ti-plus"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">
      
      <!-- KPI Cards Section - Desktop Layout -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- Revenue Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">REVENUE</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">${{ "{:,.0f}".format(kpi_data['7d']['revenue']) if kpi_data and kpi_data.get('7d') else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('revenue_change') %}
                  {% if kpi_data['7d']['revenue_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['revenue_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="revenue-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Passports Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ passport_stats['active_passports'] if passport_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('passport_change') %}
                  {% if kpi_data['7d']['passport_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['passport_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="active-passports-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Passports Created Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ passport_stats['total_passports'] if passport_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('new_passports_change') %}
                  {% if kpi_data['7d']['new_passports_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['new_passports_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="passports-created-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Sign Ups Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PENDING SIGN UPS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                    <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ signup_stats['pending_signups'] if signup_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('signup_change') %}
                  {% if kpi_data['7d']['signup_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['signup_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="pending-signups-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Section - Mobile Carousel -->
      <div class="d-md-none mb-4">
        <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
          <!-- Revenue Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">REVENUE</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">${{ "{:,.0f}".format(kpi_data['7d']['revenue']) if kpi_data and kpi_data.get('7d') else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('revenue_change') %}
                    {% if kpi_data['7d']['revenue_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['revenue_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-revenue-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Active Passports Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ passport_stats['active_passports'] if passport_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('passport_change') %}
                    {% if kpi_data['7d']['passport_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['passport_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-active-passports-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Passports Created Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ passport_stats['total_passports'] if passport_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('new_passports_change') %}
                    {% if kpi_data['7d']['new_passports_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['new_passports_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-passports-created-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Sign Ups Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">PENDING SIGN UPS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                      <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ signup_stats['pending_signups'] if signup_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('signup_change') %}
                    {% if kpi_data['7d']['signup_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['signup_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-pending-signups-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Scroll indicators -->
        <div class="text-center mt-2">
          <span class="badge bg-primary me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light" style="width: 8px; height: 8px; border-radius: 50%;"></span>
        </div>
      </div>

      <!-- Activities Section -->
      <div class="mb-4">
        <h3 class="mb-3">Your Activities</h3>
        
        <!-- Desktop Layout -->
        <div class="d-none d-md-block">
          <div class="row">
            {% for activity in activities %}
            <div class="col-md-3 mb-3">
              <div class="card" style="border-radius: 12px; overflow: hidden;">
                <!-- Activity Image -->
                {% if activity.image_filename %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                </div>
                {% else %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); display: flex; align-items: center; justify-content: center;">
                  <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="card-title mb-0">{{ activity.name[:20] }}{% if activity.name|length > 20 %}...{% endif %}</h3>
                    {% if activity.days_left != "N/A" %}
                    <small class="text-muted">{{ activity.days_left }}d left</small>
                    {% endif %}
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                    <span class="badge bg-blue-lt">{{ activity.passports }} created</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- Mobile Layout -->
        <div class="d-md-none">
          <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
            {% for activity in activities %}
            <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
              <div class="card" style="border-radius: 12px; overflow: hidden;">
                <!-- Activity Image -->
                {% if activity.image_filename %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                </div>
                {% else %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); display: flex; align-items: center; justify-content: center;">
                  <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="card-title mb-0">{{ activity.name }}</h3>
                    {% if activity.days_left != "N/A" %}
                    <small class="text-muted">{{ activity.days_left }}d left</small>
                    {% endif %}
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                    <span class="badge bg-blue-lt">{{ activity.passports }} created</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          <!-- Scroll indicators for activities -->
          <div class="text-center mt-2">
            {% set activity_count = activities|length %}
            {% set max_indicators = 4 if activity_count > 4 else activity_count %}
            {% for i in range(max_indicators) %}
              <span class="badge {% if i == 0 %}bg-primary{% else %}bg-light{% endif %} me-1" 
                    style="width: 8px; height: 8px; border-radius: 50%;"></span>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Activity Log Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-header">
              <h3 class="card-title">What's Happening?</h3>
            </div>
            <div class="table-responsive">
              <table class="table card-table table-vcenter" id="logTable">
                <thead>
                  <tr>
                    <th scope="col" class="text-muted">Date/Time</th>
                    <th scope="col" class="text-muted">Type</th>
                    <th scope="col" class="text-muted">Description</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in logs[:25] %}
                  <tr>
                    <td>{{ log.timestamp | utc_to_local | datetimeformat('%Y-%m-%d %H:%M') }}</td>
                    <td data-type="{{ log.type }}">
                      {% if log.type == 'Passport Redeemed' %}
                        <i class="ti ti-ticket text-danger"></i>
                      {% elif log.type == 'Email Sent' %}
                        <i class="ti ti-mail text-info"></i>
                      {% elif log.type == 'Passport Created' %}
                        <i class="ti ti-id text-lime"></i>
                      {% elif log.type == 'Interact Payment' %}
                        <i class="ti ti-currency-dollar text-success"></i>  
                      {% elif log.type == 'Marked Paid' %}
                        <i class="ti ti-check text-green"></i>  
                      {% elif log.type == 'Reminder Sent' %}
                        <i class="ti ti-bell text-purple"></i>
                      {% elif log.type == 'Signup Submitted' %}
                        <i class="ti ti-user-plus text-success"></i>  
                      {% elif log.type == 'Signup Approved' %}
                        <i class="ti ti-user-check text-green"></i>
                      {% elif log.type == 'Signup Rejected' %}
                        <i class="ti ti-user-x text-danger"></i>
                      {% elif log.type == 'Signup Cancelled' %}
                        <i class="ti ti-user-x text-danger"></i>
                      {% elif log.type == 'Activity Created' %}
                        <i class="ti ti-target text-orange"></i>
                      {% elif log.type == 'Admin Action' %}
                        <i class="ti ti-settings text-muted"></i>
                      {% else %}
                        <i class="ti ti-activity text-muted"></i>  
                      {% endif %}
                      {{ log.type }}
                    </td>
                    <td>{{ log.details }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer d-flex align-items-center">
              <p class="m-0 text-muted">Showing <span id="showingCount">{{ logs[:25]|length }}</span> of {{ logs|length }}</p>
              <ul class="pagination m-0 ms-auto" id="paginationControls">
                <li class="page-item active"><a href="#" class="page-link">1</a></li>
                <li class="page-item"><a href="#" class="page-link">2</a></li>
                <li class="page-item"><a href="#" class="page-link">3</a></li>
                <li class="page-item disabled"><a href="#" class="page-link">...</a></li>
                <li class="page-item"><a href="#" class="page-link">{{ (logs|length / 25)|round(0, 'ceil')|int }}</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

{% endblock %}

{% block styles %}
<style>
.card {
  background-color: #fff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.table {
  background-color: #fff !important;
}

/* Mobile scroll snap styles */
.d-flex.overflow-auto {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.d-flex.overflow-auto::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

/* Hover effects */
.card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transform: translateY(-1px);
  transition: all 0.2s ease-in-out;
}

/* Mobile scroll indicators */
@media (max-width: 767.98px) {
  .flex-shrink-0 {
    scroll-snap-align: start;
  }
}
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Store KPI data from backend
const kpiData = {{ kpi_data | tojson | safe }};
let currentPeriod = '7d';

// Function to generate line chart SVG path
function generateLineChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  // Find min and max for scaling
  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;
  
  // Generate path coordinates
  const points = data.map((value, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - ((value - min) / range) * (height - 10) - 5;
    return `${index === 0 ? 'M' : 'L'} ${x},${y}`;
  });
  
  return points.join(' ');
}

// Function to generate bar chart SVG rectangles
function generateBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  const max = Math.max(...data) || 1;
  const barWidth = (width - (data.length - 1) * 2) / data.length;
  
  let svg = '';
  data.forEach((value, index) => {
    const barHeight = (value / max) * (height - 5);
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#206bc4" opacity="0.8" />`;
  });
  
  return svg;
}

// Update all charts with real data
function updateCharts(period = '7d') {
  const periodData = kpiData[period];
  if (!periodData) return;
  
  // Update Revenue Line Chart (both desktop and mobile)
  const revenuePath = generateLineChart(periodData.revenue_trend);
  const revenueCharts = ['#revenue-chart', '#mobile-revenue-chart'];
  revenueCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && revenuePath) {
      chart.innerHTML = `<path d="${revenuePath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
    }
  });
  
  // Update Active Passports Bar Chart (both desktop and mobile)
  const activePassportsBars = generateBarChart(periodData.active_users_trend);
  const activePassportsCharts = ['#active-passports-chart', '#mobile-active-passports-chart'];
  activePassportsCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && periodData.active_users_trend) {
      chart.innerHTML = activePassportsBars;
    }
  });
  
  // Update Passports Created Line Chart (both desktop and mobile)
  const passportsCreatedPath = generateLineChart(periodData.pass_created_trend);
  const passportsCreatedCharts = ['#passports-created-chart', '#mobile-passports-created-chart'];
  passportsCreatedCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && passportsCreatedPath) {
      chart.innerHTML = `<path d="${passportsCreatedPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
    }
  });
  
  // Update Pending Signups Bar Chart (both desktop and mobile)
  const pendingSignupsBars = generateBarChart(periodData.pending_signups_trend);
  const pendingSignupsCharts = ['#pending-signups-chart', '#mobile-pending-signups-chart'];
  pendingSignupsCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && periodData.pending_signups_trend) {
      chart.innerHTML = pendingSignupsBars;
    }
  });
}

// Handle period dropdown clicks
function attachDropdownHandlers() {
  // Find all dropdown items in KPI cards
  document.querySelectorAll('.card .dropdown-menu .dropdown-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Get period from text
      const text = this.textContent.trim();
      let period = '7d';
      if (text.includes('30')) period = '30d';
      else if (text.includes('90')) period = '90d';
      
      // Update button text
      const button = this.closest('.dropdown').querySelector('.dropdown-toggle');
      if (button) button.textContent = text;
      
      // Update charts
      currentPeriod = period;
      updateCharts(period);
    });
  });
}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
  updateCharts('7d');
  attachDropdownHandlers();
});
</script>
{% endblock %}