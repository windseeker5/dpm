{% extends "base.html" %}
{% block title %}{{ ORG_NAME if ORG_NAME else "Minipass" }}{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none">
    <div class="dashboard-container">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h1 class="page-title mb-3 text-center text-md-start">
            {% if current_admin and current_admin.display_name %}
              Welcome back, {{ current_admin.display_name }}!
            {% else %}
              Welcome back!
            {% endif %}
          </h1>
          <p class="text-muted mb-0 text-center text-md-start">
            Here's what's happening with your activities today.
          </p>
        </div>
      </div>
    </div>
  </div>






  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">

      <!-- New KPI Cards Section - Clean ApexCharts Implementation -->

      <!-- Desktop Version (unchanged) -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- Include ApexCharts -->
        <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
        <!-- Revenue Card (Line Chart) -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; position: relative;" data-kpi-card="revenue" data-kpi-id="{{ revenue_card.id if revenue_card else 'revenue-default' }}">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">REVENUE</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown" data-kpi-period-button="revenue">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d" data-card-type="revenue">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d" data-card-type="revenue">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d" data-card-type="revenue">Last 90 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="all" data-card-type="revenue">All time</a></li>
                  </ul>
                </div>
              </div>
              
              <div class="h2 mb-1" id="revenue-value">${{ "{:,.0f}".format(kpi_data['revenue']['current']) }}</div>

              <div class="d-flex align-items-center mb-3">
                {% set change = kpi_data['revenue']['change'] %}
                {% if change is not none %}
                  {% if change > 0 %}
                    <div class="text-success me-2" id="revenue-trend">{{ change|round|int }}% <i class="ti ti-trending-up"></i></div>
                  {% elif change < 0 %}
                    <div class="text-danger me-2" id="revenue-trend">{{ change|abs|round|int }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="revenue-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="revenue-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              
              <div id="revenue-chart" style="height: 40px; margin: 0; padding: 0;"></div>
            </div>
          </div>
        </div>

        <!-- Active Passports Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; position: relative;" data-kpi-card="active_passports" data-kpi-id="{{ active_passports_card.id if active_passports_card else 'active-passports-default' }}">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown" data-kpi-period-button="active_passports">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d" data-card-type="active_passports">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d" data-card-type="active_passports">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d" data-card-type="active_passports">Last 90 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="all" data-card-type="active_passports">All time</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="active-passports-value">
                {% if active_passports_card and active_passports_card.data %}
                  {{ "{:,.0f}".format(active_passports_card.data.value) }}
                {% else %}
                  {{ passport_stats['active_passports'] if passport_stats else '0' }}
                {% endif %}
              </div>
              <div class="d-flex align-items-center mb-3">
                {% if active_passports_card and active_passports_card.data %}
                  {% if active_passports_card.data.trend_percentage > 0 %}
                    <div class="text-success me-2" id="active-passports-trend">{{ active_passports_card.data.trend_percentage }}% <i class="ti ti-trending-up"></i></div>
                  {% elif active_passports_card.data.trend_percentage < 0 %}
                    <div class="text-danger me-2" id="active-passports-trend">{{ active_passports_card.data.trend_percentage }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="active-passports-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% elif kpi_data and kpi_data['active_users'] and kpi_data['active_users']['change'] is not none %}
                  {% if kpi_data['active_users']['change'] > 0 %}
                    <div class="text-success me-2" id="active-passports-trend">{{ kpi_data['active_users']['change']|round|int }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['active_users']['change'] < 0 %}
                    <div class="text-danger me-2" id="active-passports-trend">{{ kpi_data['active_users']['change']|abs|round|int }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="active-passports-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="active-passports-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div id="active-passports-chart" style="height: 40px;"></div>
            </div>
          </div>
        </div>

        <!-- Passports Created Card - REPLACED WITH PASSPORTS REDEEMED -->
        <!--
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; position: relative;" data-kpi-card="passports_created" data-kpi-id="{{ passports_created_card.id if passports_created_card else 'passports-created-default' }}">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown" data-kpi-period-button="passports_created">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d" data-card-type="passports_created">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d" data-card-type="passports_created">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d" data-card-type="passports_created">Last 90 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="all" data-card-type="passports_created">All time</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="passports-created-value">
                {% if passports_created_card and passports_created_card.data %}
                  {{ "{:,.0f}".format(passports_created_card.data.value) }}
                {% else %}
                  {{ passport_stats['total_passports'] if passport_stats else '0' }}
                {% endif %}
              </div>
              <div class="d-flex align-items-center mb-3">
                {% if passports_created_card and passports_created_card.data %}
                  {% if passports_created_card.data.trend_percentage > 0 %}
                    <div class="text-success me-2" id="passports-created-trend">{{ passports_created_card.data.trend_percentage }}% <i class="ti ti-trending-up"></i></div>
                  {% elif passports_created_card.data.trend_percentage < 0 %}
                    <div class="text-danger me-2" id="passports-created-trend">{{ passports_created_card.data.trend_percentage }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="passports-created-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% elif kpi_data and kpi_data['passports_created'] and kpi_data['passports_created']['change'] is not none %}
                  {% if kpi_data['passports_created']['change'] > 0 %}
                    <div class="text-success me-2" id="passports-created-trend">{{ kpi_data['passports_created']['change']|round|int }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['passports_created']['change'] < 0 %}
                    <div class="text-danger me-2" id="passports-created-trend">{{ kpi_data['passports_created']['change']|abs|round|int }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="passports-created-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="passports-created-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div id="passports-created-chart" style="height: 40px;"></div>
            </div>
          </div>
        </div>
        -->

        <!-- Passports Redeemed Card (Replaces Passports Created) -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; position: relative;" data-kpi-card="passports_redeemed" data-kpi-id="passports-redeemed-default">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PASSPORTS REDEEMED</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown" data-kpi-period-button="passports_redeemed">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d" data-card-type="passports_redeemed">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d" data-card-type="passports_redeemed">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d" data-card-type="passports_redeemed">Last 90 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="all" data-card-type="passports_redeemed">All time</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="passports-redeemed-value">
                {% if kpi_data and kpi_data['passports_redeemed'] %}
                  {{ "{:,.0f}".format(kpi_data['passports_redeemed']['current']) }}
                {% else %}
                  0
                {% endif %}
              </div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data['passports_redeemed'] and kpi_data['passports_redeemed']['change'] is not none %}
                  {% if kpi_data['passports_redeemed']['change'] > 0 %}
                    <div class="text-success me-2" id="passports-redeemed-trend">{{ kpi_data['passports_redeemed']['change']|round|int }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['passports_redeemed']['change'] < 0 %}
                    <div class="text-danger me-2" id="passports-redeemed-trend">{{ kpi_data['passports_redeemed']['change']|abs|round|int }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="passports-redeemed-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="passports-redeemed-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div id="passports-redeemed-chart" style="height: 40px;"></div>
            </div>
          </div>
        </div>

        <!-- Unpaid Passports Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; position: relative;" data-kpi-card="pending_signups" data-kpi-id="{{ pending_signups_card.id if pending_signups_card else 'pending-signups-default' }}">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">UNPAID PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown" data-kpi-period-button="pending_signups">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d" data-card-type="pending_signups">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d" data-card-type="pending_signups">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d" data-card-type="pending_signups">Last 90 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="all" data-card-type="pending_signups">All time</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="pending-signups-value">
                {% if kpi_data and kpi_data['unpaid_passports'] %}
                  {{ "{:,.0f}".format(kpi_data['unpaid_passports']['current']) }}
                {% else %}
                  0
                {% endif %}
              </div>
              <div class="d-flex align-items-center mb-3">
                {% if pending_signups_card and pending_signups_card.data %}
                  {% if pending_signups_card.data.trend_percentage > 0 %}
                    <div class="text-success me-2" id="pending-signups-trend">{{ pending_signups_card.data.trend_percentage }}% <i class="ti ti-trending-up"></i></div>
                  {% elif pending_signups_card.data.trend_percentage < 0 %}
                    <div class="text-danger me-2" id="pending-signups-trend">{{ pending_signups_card.data.trend_percentage }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="pending-signups-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% elif kpi_data and kpi_data['unpaid_passports'] and kpi_data['unpaid_passports']['change'] is not none %}
                  {% if kpi_data['unpaid_passports']['change'] > 0 %}
                    <div class="text-success me-2" id="pending-signups-trend">{{ kpi_data['unpaid_passports']['change']|round|int }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['unpaid_passports']['change'] < 0 %}
                    <div class="text-danger me-2" id="pending-signups-trend">{{ kpi_data['unpaid_passports']['change']|abs|round|int }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="pending-signups-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="pending-signups-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div id="pending-signups-chart" style="height: 40px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Version (DEAD SIMPLE) -->
      {% if mobile_kpi_data %}
      <div class="mobile-kpi-container d-md-none mb-4">
        <div class="mobile-kpi-scroll">
          <!-- Revenue Card -->
          <div class="mobile-kpi-card">
            <div class="card" style="border-radius: 12px; min-height: 130px;">
              <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="text-muted small text-uppercase mb-2">REVENUE</div>
                <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">${{ "{:,.0f}".format(mobile_kpi_data['revenue']['current']) }}</div>
                <div class="text-muted small">
                  <i class="ti ti-timeline me-1"></i>All-time
                </div>
              </div>
            </div>
          </div>

          <!-- Active Passports Card -->
          <div class="mobile-kpi-card">
            <div class="card" style="border-radius: 12px; min-height: 130px;">
              <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="text-muted small text-uppercase mb-2">ACTIVE PASSPORTS</div>
                <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ mobile_kpi_data['active_users']['current'] }}</div>
                <div class="text-muted small">
                  <i class="ti ti-timeline me-1"></i>All-time
                </div>
              </div>
            </div>
          </div>

          <!-- Passports Redeemed Card (Replaces Passports Created) -->
          <div class="mobile-kpi-card">
            <div class="card" style="border-radius: 12px; min-height: 130px;">
              <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="text-muted small text-uppercase mb-2">PASSPORTS REDEEMED</div>
                <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #0f172a;">{{ mobile_kpi_data['passports_redeemed']['current'] if mobile_kpi_data['passports_redeemed'] else 0 }}</div>
                <div class="text-muted small">
                  <i class="ti ti-timeline me-1"></i>All-time
                </div>
              </div>
            </div>
          </div>

          <!-- Unpaid Passports Card -->
          <div class="mobile-kpi-card">
            <div class="card" style="border-radius: 12px; min-height: 130px;">
              <div class="card-body text-center" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="text-muted small text-uppercase mb-2">UNPAID PASSPORTS</div>
                <div class="h1 mb-2" style="font-size: 2.5rem; font-weight: 700; color: #dc2626;">{{ mobile_kpi_data['unpaid_passports']['current'] }}</div>
                <div class="text-muted small">
                  <i class="ti ti-timeline me-1"></i>All-time
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dots Navigation -->
        <div class="mobile-kpi-dots">
          <div class="mobile-dot active" data-index="0"></div>
          <div class="mobile-dot" data-index="1"></div>
          <div class="mobile-dot" data-index="2"></div>
          <div class="mobile-dot" data-index="3"></div>
        </div>
      </div>
      {% endif %}
      
      <!-- Activities Section -->
      <div class="activities-section mb-5 pt-3">
        <div class="row mb-4">
          <div class="col">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h2 class="section-title-large mb-1 d-flex align-items-center" style="font-size: 2rem; font-weight: 700;">
                  <i class="ti ti-activity-heartbeat text-danger me-3"></i>Active Activities
                </h2>
         
              </div>
              <div>
                <a href="{{ url_for('create_activity') }}" class="btn btn-success d-none d-md-inline-block">
                  <i class="ti ti-plus"></i>
                  Activity
                </a>
                <a href="{{ url_for('create_activity') }}" class="btn btn-success d-md-none btn-icon" aria-label="Activity">
                  <i class="ti ti-plus"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Desktop Layout -->
        <div class="d-none d-md-block">
          <div class="row">
            {% for activity in activities %}
            <div class="col-md-3 mb-3">
              <div class="card" style="border-radius: 12px; position: relative;">
                <!-- Activity Image -->
                <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" style="text-decoration: none; display: block; cursor: pointer;">
                  {% if activity.image_filename %}
                  <div class="img-responsive img-responsive-21x9 card-img-top"
                       style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                  </div>
                  {% else %}
                  <div class="img-responsive img-responsive-21x9 card-img-top"
                       style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); position: relative;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center;">
                      <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                    </div>
                  </div>
                  {% endif %}
                </a>
                <div class="card-body">
                  <div class="mb-2">
                    <h3 class="card-title mb-0">{{ activity.name }}</h3>
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if activities|length < 4 %}
            <!-- Add Activity Placeholder - Skeleton design with clickable card -->
            <div class="col-md-3 mb-3 d-none d-md-block">
              <a href="{{ url_for('create_activity') }}" style="text-decoration: none;">
                <div class="card" style="border-radius: 12px; overflow: hidden; background-color: #f1f5f9; border: 1px dashed #d1d5db; height: 276.84px; cursor: pointer;">
                  <!-- Placeholder Image with large plus icon -->
                  <div class="img-responsive img-responsive-21x9 card-img-top" 
                       style="background-color: #f1f5f9; position: relative;">
                    <i class="ti ti-plus" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: #94a3b8;"></i>
                  </div>
                  <div class="card-body" style="background-color: #f1f5f9;">
                    <div class="mb-2">
                      <!-- Title placeholder - grey rectangle -->
                      <div style="background-color: #e2e8f0; height: 24px; width: 120px; border-radius: 4px;"></div>
                    </div>
                    <div class="d-flex gap-2 flex-wrap mb-3">
                      <!-- Invisible badges using exact same classes and text length to maintain height -->
                      <span class="badge bg-green-lt" style="visibility: hidden;">4 active</span>
                      <span class="badge bg-yellow-lt" style="visibility: hidden;">3 pending</span>
                    </div>
                    <!-- Button placeholder - grey rectangle positioned at bottom like real cards -->
                    <div style="background-color: #e2e8f0; height: 36px; width: 80px; border-radius: 6px;"></div>
                  </div>
                </div>
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Mobile Layout -->
        <div class="d-md-none">
          <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
            {% for activity in activities %}
            <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
              <div class="card" style="border-radius: 12px; position: relative;">
                <!-- Activity Image -->
                <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" style="text-decoration: none; display: block; cursor: pointer;">
                  {% if activity.image_filename %}
                  <div class="img-responsive img-responsive-21x9 card-img-top"
                       style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                  </div>
                  {% else %}
                  <div class="img-responsive img-responsive-21x9 card-img-top"
                       style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); position: relative;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center;">
                      <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                    </div>
                  </div>
                  {% endif %}
                </a>
                <div class="card-body">
                  <div class="mb-2">
                    <h3 class="card-title mb-0">{{ activity.name }}</h3>
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
            <!-- Mobile placeholder - always shown as last card -->
            <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
              <a href="{{ url_for('create_activity') }}" style="text-decoration: none;">
                <div class="card" style="border-radius: 12px; overflow: hidden; background-color: #f1f5f9; border: 1px dashed #d1d5db; cursor: pointer;">
                  <!-- Placeholder Image with large plus icon -->
                  <div class="img-responsive img-responsive-21x9 card-img-top" 
                       style="background-color: #f1f5f9; position: relative;">
                    <i class="ti ti-plus" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: #94a3b8;"></i>
                  </div>
                  <div class="card-body" style="background-color: #f1f5f9;">
                    <div class="mb-2">
                      <!-- Using actual h3 element with same class for exact height matching -->
                      <h3 class="card-title mb-0" style="background-color: #e2e8f0; height: 28px; width: 120px; border-radius: 4px;"></h3>
                    </div>
                    <div class="d-flex gap-2 flex-wrap mb-3">
                      <!-- Invisible badges using exact same classes and text length to maintain height -->
                      <span class="badge bg-green-lt" style="visibility: hidden;">4 active</span>
                      <span class="badge bg-yellow-lt" style="visibility: hidden;">3 pending</span>
                    </div>
                    <!-- Using actual button element with same class for exact height matching -->
                    <a class="btn btn-secondary" style="background-color: #e2e8f0; border: none; color: transparent; pointer-events: none;">Manage</a>
                  </div>
                </div>
              </a>
            </div>
          </div>
          <!-- Scroll indicators for activities -->
          <div class="text-center mt-2">
            {% set activity_count = activities|length + 1 %} <!-- +1 for placeholder card -->
            {% set max_indicators = 4 if activity_count > 4 else activity_count %}
            {% for i in range(max_indicators) %}
              <span class="badge {% if i == 0 %}bg-primary{% else %}bg-light{% endif %} me-1" 
                    style="width: 8px; height: 8px; border-radius: 50%;"></span>
            {% endfor %}
          </div>
        </div>
      </div>

      {% if logs and logs|length > 0 %}
      <!-- Activity Log Section -->
      <div class="activity-log-section mb-5">
        <div class="row mb-3">
          <div class="col">
            <h2 class="section-title mb-0"><i class="ti ti-file-description text-blue me-2"></i>Recent events</h2>
          </div>
        </div>

        <!-- Main Events Table -->
        <div class="card main-table-card">
          <div class="card-header" style="min-height: 50px;">
            <!-- Reduced header height for cleaner look -->
            <div class="d-flex justify-content-center align-items-center w-100" style="height: 26px;">
              <!-- Spacer to maintain consistent header height -->
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover" id="logTable">
            <thead>
              <tr>
                <th class="d-none d-md-table-cell" style="width: 15%;">Date/Time</th>
                <th class="d-none d-md-table-cell" style="width: 20%;">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <!-- Table content will be populated by JavaScript -->
            </tbody>
          </table>
          </div>

          <!-- Pagination -->
          <div class="card-footer d-flex justify-content-between align-items-center flex-wrap">
            <span class="text-muted" id="entriesInfo" style="font-size: 0.875rem;">Showing <span id="showingCount">1-{{ [logs|length, 10]|min }}</span> of {{ logs|length }} entries</span>
            <nav id="paginationNav">
              <ul class="pagination pagination-sm mb-0" id="paginationControls">
                <!-- Pagination will be populated by JavaScript -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
      {% endif %}
      
    </div>
  </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Dashboard Container Improvements */
.page-wrapper {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  min-height: 100vh;
}

.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

/* Enhanced Card Design */
.card {
  background: rgba(255, 255, 255, 0.95) !important;
  border: none !important;
  border-radius: 16px !important;
  box-shadow: 
    0 1px 3px rgba(0, 0, 0, 0.05),
    0 4px 16px rgba(0, 0, 0, 0.04),
    0 0 0 1px rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.table {
  background-color: #fff !important;
}

/* Mobile scroll snap styles */
.d-flex.overflow-auto {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.d-flex.overflow-auto::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

/* Enhanced Hover Effects */
.card:hover {
  box-shadow:
    0 4px 16px rgba(0, 0, 0, 0.08),
    0 8px 32px rgba(0, 0, 0, 0.06),
    0 0 0 1px rgba(255, 255, 255, 0.9);
  transform: translateY(-2px) scale(1.01);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* KPI Card Enhancements */
.card .card-body {
  padding: 1.75rem 1.5rem;
  position: relative;
}

.card .text-uppercase {
  font-weight: 600;
  letter-spacing: 0.5px;
  font-size: 0.75rem;
  color: #64748b;
}

.card .h2 {
  font-weight: 700;
  font-size: 2rem;
  line-height: 1.2;
  color: #0f172a;
  margin-bottom: 0.75rem;
}

/* Trend Indicators */
.text-success {
  color: #059669 !important;
  font-weight: 600;
}

.text-danger {
  color: #dc2626 !important;
  font-weight: 600;
}

.text-muted {
  color: #64748b !important;
}

/* KPI Chart Container Styling - Edge to Edge */
[id*="-chart"] {
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden;
}

[id*="-chart"] .apexcharts-canvas {
  margin: 0 !important;
  padding: 0 !important;
}

[id*="-chart"] .apexcharts-svg {
  background: transparent !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* Remove any chart padding/margins */
.apexcharts-graphical {
  transform: translateX(0) !important;
}

.apexcharts-inner {
  padding: 0 !important;
  margin: 0 !important;
}

/* Page Header Styling */
.page-header {
  background: transparent;
  border: none;
  margin-bottom: 3rem;
}

.organization-title {
  font-weight: 600;
  color: #475569;
  font-size: 1.25rem;
  line-height: 1.3;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.page-title {
  font-weight: 700;
  color: #0f172a;
  font-size: 2.25rem;
  line-height: 1.2;
  margin-bottom: 0.5rem;
}

.page-header .text-muted {
  color: #64748b !important;
  font-size: 1.1rem;
  line-height: 1.5;
}

/* Section Styling */
.section-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 1.5rem;
  line-height: 1.3;
}

.section-title-large {
  font-weight: 700;
  color: #0f172a;
  font-size: 1.75rem; /* 28px - Larger for primary sections */
  line-height: 1.25;
  margin-bottom: 0.75rem;
}

.section-subtitle {
  font-size: 0.95rem;
  color: #64748b;
  line-height: 1.4;
}

/* Section Spacing Hierarchy */
.kpi-section {
  margin-bottom: 5rem; /* 80px - Large separation after KPI cards */
}

.activities-section {
  margin-bottom: 4rem; /* 64px - Standard section spacing */
  padding-top: 1rem; /* 16px - Additional breathing room */
}

.activity-log-section {
  margin-bottom: 3rem; /* 48px - Standard bottom spacing */
}

/* Card Header Improvements */
.card-header {
  background: transparent;
  border-bottom: 1px solid #f1f5f9;
  padding: 1.5rem 1.5rem 1rem;
}

.card-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 1.125rem;
  margin-bottom: 0;
}

/* Activity Cards Enhancement */
.card .card-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 1.1rem;
}

.badge {
  font-weight: 500;
  font-size: 0.75rem;
  padding: 0.375rem 0.75rem;
  border-radius: 8px;
}

.badge.bg-green-lt {
  background-color: #dcfce7 !important;
  color: #166534 !important;
}

.badge.bg-yellow-lt {
  background-color: #fef3c7 !important;
  color: #92400e !important;
}

.badge.bg-blue-lt {
  background-color: #dbeafe !important;
  color: #1e40af !important;
}

/* Button Improvements */
.btn-secondary {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  border: none;
  color: white;
  font-weight: 500;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  transition: all 0.2s ease;
}

.btn-secondary:hover {
  background: linear-gradient(135deg, #475569 0%, #334155 100%);
  transform: translateY(-1px);
  color: white;
}

.btn-primary {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border: none;
  font-weight: 500;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  transition: all 0.2s ease;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-1px);
}

/* Green Success Button Styling */
.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border: none;
  font-weight: 500;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  transition: all 0.2s ease;
  color: white;
}

.btn-success:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-1px);
  color: white;
}

/* Tabler.io Placeholder Component */
.placeholder {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
}

.placeholder-image {
  background-color: #e9ecef;
  width: 100%;
  height: 100%;
}

/* Activity Log Table Styling */
.table {
  background-color: transparent !important;
}

.table th {
  border-bottom: 2px solid #e2e8f0;
  font-weight: 600;
  color: #475569;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1rem;
}

.table td {
  border-bottom: 1px solid #f1f5f9;
  padding: 1rem;
  color: #334155;
  vertical-align: middle;
}

/* Custom Spacing Utilities */
.mb-6 {
  margin-bottom: 4rem !important; /* 64px - Mobile spacing */
}

.mb-7 {
  margin-bottom: 5rem !important; /* 80px - Desktop spacing */
}

.pt-3 {
  padding-top: 1rem !important; /* 16px - Activities section breathing room */
}

.pt-5 {
  padding-top: 3rem !important; /* 48px */
}

/* Placeholder Card Styling - Minimal design */
.placeholder-card {
  position: relative;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.placeholder-card:hover {
  transform: translateY(-2px);
}

/* Mobile scroll indicators */
@media (max-width: 767.98px) {
  .flex-shrink-0 {
    scroll-snap-align: start;
  }
  
  .dashboard-container {
    padding: 0 1rem;
  }
  
  .page-title {
    font-size: 1.75rem;
  }
  
  /* Adjust spacing for mobile */
  .kpi-section {
    margin-bottom: 4rem !important; /* 64px - Override responsive utility */
  }
  
  .activities-section {
    padding-top: 0.75rem; /* 12px - Slightly more breathing room on mobile */
  }
  
  .section-title-large {
    font-size: 1.75rem !important; /* 28px - Larger on mobile for better hierarchy */
    font-weight: 700 !important;
  }
}

/* Pagination Enhancements */
.pagination .page-link {
  border: none;
  color: #6c757d;
  padding: 0.5rem 0.75rem;
  margin: 0 0.125rem;
  border-radius: 0.375rem;
  transition: all 0.2s ease;
}

.pagination .page-link:hover {
  color: #0d6efd;
  background-color: #f8f9fa;
  transform: translateY(-1px);
}

.pagination .page-item.active .page-link {
  background-color: #0d6efd;
  border-color: #0d6efd;
  color: white;
  box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.pagination .page-item.disabled .page-link {
  color: #adb5bd;
  background-color: transparent;
  cursor: not-allowed;
}

/* Table Loading State */
.table tbody tr td {
  transition: all 0.3s ease;
}

.table tbody tr:hover {
  background-color: rgba(13, 110, 253, 0.04);
}

/* Pagination Info Text */
.card-footer p {
  font-size: 0.875rem;
  font-weight: 500;
}

/* GitHub-style Filter Buttons for Events Table */
.card-header .d-flex {
  justify-content: center !important;
  align-items: center !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
}

.github-filter-group {
  display: inline-flex;
  align-items: center;
  background: #e1e4e8;
  border-radius: 6px;
  padding: 2px;
  gap: 1px;
}

.github-filter-btn {
  padding: 5px 16px;
  font-size: 14px;
  font-weight: 500;
  line-height: 20px;
  color: #24292e;
  background: transparent;
  border: none;
  border-radius: 0;
  text-decoration: none;
  transition: all 0.2s ease;
  position: relative;
  display: inline-flex;
  align-items: center;
  white-space: nowrap;
  cursor: pointer;
}

/* Inactive state - darker gray background */
.github-filter-btn:not(.active) {
  background: #e1e4e8;
  color: #586069;
}

.github-filter-btn:not(.active):hover {
  background: #d1d5da;
  color: #24292e;
  text-decoration: none;
}

/* Active state - white/light background with rounded corners */
.github-filter-btn.active {
  background: #ffffff;
  color: #24292e;
  border-radius: 6px;
  box-shadow: 0 1px 0 rgba(27,31,35,0.04);
  font-weight: 600;
  z-index: 1;
}

.github-filter-btn.active:hover {
  background: #ffffff;
  text-decoration: none;
}

/* Icons styling */
.github-filter-btn i {
  font-size: 14px;
  opacity: 0.7;
}

.github-filter-btn.active i {
  opacity: 1;
}

/* Main table card styling */
.main-table-card {
  margin-top: 0 !important;
}

/* Table styling improvements */
.table th {
  border-bottom: 2px solid #e2e8f0;
  font-weight: 600;
  color: #475569;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1rem;
}

.table td {
  border-bottom: 1px solid #f1f5f9;
  padding: 1rem;
  color: #334155;
  vertical-align: middle;
}

.table tbody tr:hover {
  background-color: rgba(13, 110, 253, 0.04);
}

/* Badge styling for log types */
.badge {
  font-size: 0.75rem;
  font-weight: 500;
  padding: 0.25rem 0.5rem;
}

/* Responsive Design for Filter Buttons */
@media (max-width: 767px) {
  .github-filter-group {
    flex-wrap: wrap;
    width: 100%;
    gap: 2px;
  }
  
  .github-filter-btn {
    flex: 1;
    min-width: calc(50% - 2px);
    margin-bottom: 2px;
    border-radius: 6px !important;
    font-size: 12px;
    padding: 6px 8px;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .github-filter-btn {
    font-size: 11px;
    padding: 5px 6px;
  }
  
  .github-filter-btn i {
    font-size: 12px;
  }
}

/* KPI Chart Enhancement - True Edge-to-edge styling like Tabler.io */
[id*="-chart"] {
  margin: 0 !important;
  padding: 0 !important;
  border-radius: 0 !important;
  overflow: hidden;
}

/* ApexCharts container elements - remove all internal spacing */
[id*="-chart"] .apexcharts-canvas,
[id*="-chart"] .apexcharts-svg,
[id*="-chart"] .apexcharts-graphical,
[id*="-chart"] .apexcharts-inner,
[id*="-chart"] .apexcharts-grid,
[id*="-chart"] .apexcharts-series {
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
}

/* Force the SVG to fill the entire container edge-to-edge */
[id*="-chart"] svg {
  width: 100% !important;
  height: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  display: block !important;
}

/* Remove any default ApexCharts margins and padding */
.apexcharts-canvas svg {
  background: transparent !important;
}

/* Ensure chart content extends to edges */
[id*="-chart"] .apexcharts-series path,
[id*="-chart"] .apexcharts-series rect {
  vector-effect: non-scaling-stroke;
}

/* Position adjustments for true edge-to-edge appearance */
[id*="-chart"] .apexcharts-inner {
  transform: translate(0, 0) !important;
}

/* Remove any default spacing around chart elements */
.apexcharts-tooltip {
  z-index: 1000 !important;
}

/* Mobile Table Responsive Styles */
@media (max-width: 767.98px) {
  /* Table cell padding with breathing room */
  #logTable td {
    padding: 0.75rem 1rem !important;
  }

  /* Description cell - enable multi-line wrapping */
  .log-description-cell {
    padding: 0.75rem 1rem !important;
  }

  /* Description text - allow wrapping, no truncation */
  .log-description-text {
    white-space: normal !important;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
  }

  /* Date badge styling */
  .badge-sm {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
  }

  /* Pagination footer adjustments */
  .card-footer {
    padding: 0.75rem 1rem;
    gap: 0.5rem;
  }

  #entriesInfo {
    font-size: 0.75rem !important;
    width: 100%;
    text-align: center;
    margin-bottom: 0.5rem;
  }

  #paginationNav {
    width: 100%;
    display: flex;
    justify-content: center;
  }

  /* Simplified pagination buttons for mobile */
  .pagination-sm .page-link {
    padding: 0.4rem 0.8rem;
    font-size: 0.875rem;
  }
}
</style>
{% endblock %}

{% block scripts %}
<style>
/* Mobile KPI Carousel CSS */
@media (max-width: 767.98px) {
  .kpi-carousel-wrapper {
    position: relative;
    width: 100%;
    padding: 0 15px;
  }
  
  .kpi-carousel {
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  
  .kpi-carousel::-webkit-scrollbar {
    display: none;
  }
  
  .kpi-track {
    display: flex;
    width: 400%; /* 4 cards Ã— 100% */
  }
  
  .kpi-slide {
    flex: 0 0 100%;
    scroll-snap-align: start;
    padding: 0 5px;
  }
  
  .kpi-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 15px;
  }
  
}

/* Mobile KPI Styles (DEAD SIMPLE) */
@media (max-width: 767.98px) {
  .mobile-kpi-container {
    position: relative;
  }
  
  .mobile-kpi-scroll {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
    gap: 1rem;
    padding: 0 1rem;
  }
  
  .mobile-kpi-scroll::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }
  
  .mobile-kpi-card {
    flex: 0 0 85%;
    scroll-snap-align: start;
  }
  
  .mobile-kpi-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 1rem;
  }
  
  .mobile-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #dee2e6;
    transition: background 0.3s ease;
    cursor: pointer;
  }
  
  .mobile-dot.active {
    background: #206bc4;
  }
}
</style>

<script>
// Store KPI data from backend as global variable
window.kpiData = {{ kpi_data | tojson | safe }};
const kpiData = window.kpiData;
console.log('KPI Data loaded:', kpiData);

// Store logs data for pagination
const allLogs = {{ logs | tojson | safe }};
let currentPeriod = '7d';

// Function to generate interactive line chart with hover points
function generateInteractiveLineChart(data, width = 300, height = 40, chartId = '') {
  if (!data || data.length === 0) return { path: '', points: [] };
  
  // Find min and max for scaling
  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;
  
  // Generate path coordinates and hover points
  const coordinates = [];
  const hoverPoints = [];
  
  data.forEach((value, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - ((value - min) / range) * (height - 10) - 5;
    
    coordinates.push(`${index === 0 ? 'M' : 'L'} ${x},${y}`);
    hoverPoints.push({ x, y, value, index });
  });
  
  return {
    path: coordinates.join(' '),
    points: hoverPoints
  };
}

// Legacy function for backward compatibility
function generateLineChart(data, width = 300, height = 40) {
  const result = generateInteractiveLineChart(data, width, height);
  return result.path;
}

// Tooltip management functions
function createTooltip() {
  let tooltip = document.getElementById('chart-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'chart-tooltip';
    tooltip.className = 'chart-tooltip';
    tooltip.style.cssText = `
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      white-space: nowrap;
    `;
    document.body.appendChild(tooltip);
  }
  return tooltip;
}

function showTooltip(x, y, value, period, index) {
  const tooltip = createTooltip();
  const formattedValue = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value);
  
  // Calculate the date based on period and index
  const daysAgo = parseInt(period) - index - 1;
  const date = new Date();
  date.setDate(date.getDate() - daysAgo);
  const formattedDate = date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric'
  });
  
  tooltip.innerHTML = `${formattedValue}<br><small>${formattedDate}</small>`;
  tooltip.style.left = `${x}px`;
  tooltip.style.top = `${y - 10}px`;
  tooltip.style.opacity = '1';
}

function hideTooltip() {
  const tooltip = document.getElementById('chart-tooltip');
  if (tooltip) {
    tooltip.style.opacity = '0';
  }
}

// Function to generate bar chart SVG rectangles
function generateBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  const max = Math.max(...data) || 1;
  const barWidth = (width - (data.length - 1) * 2) / data.length;
  
  let svg = '';
  data.forEach((value, index) => {
    const barHeight = (value / max) * (height - 5);
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#206bc4" opacity="0.8" />`;
  });
  
  return svg;
}

// Update all charts with real data with smooth animations
function updateCharts(period = '7d') {
  // Use direct KPI data structure from server
  if (!kpiData) {
    console.error('No KPI data available for chart updates');
    return;
  }
  
  console.log('Updating charts with KPI data:', kpiData);
  
  // Add fade-out animation to existing charts
  const allCharts = document.querySelectorAll('.card svg');
  allCharts.forEach(chart => {
    chart.style.transition = 'opacity 0.3s ease';
    chart.style.opacity = '0.3';
  });
  
  // Delay the chart update for smooth transition
  setTimeout(() => {
  
  // Update Revenue Line Chart with interactive tooltips
  if (kpiData.revenue && kpiData.revenue.trend) {
    const revenueChartData = generateInteractiveLineChart(kpiData.revenue.trend, 300, 40, 'revenue');
    const chart = document.querySelector('#revenue-chart');
    if (chart && revenueChartData.path) {
      // Create SVG with path and invisible hover zones
      chart.innerHTML = `
        <path d="${revenueChartData.path}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        ${revenueChartData.points.map((point, index) => 
          `<circle cx="${point.x}" cy="${point.y}" r="6" fill="transparent" 
                   data-value="${point.value}" data-index="${index}" 
                   class="chart-hover-point" style="cursor: pointer;" />`
        ).join('')}
      `;
      
      // Add hover event listeners for revenue tooltips
      chart.querySelectorAll('.chart-hover-point').forEach(point => {
        point.addEventListener('mouseenter', function(e) {
          const rect = chart.getBoundingClientRect();
          const value = parseFloat(this.getAttribute('data-value'));
          const index = parseInt(this.getAttribute('data-index'));
          showTooltip(
            rect.left + parseFloat(this.getAttribute('cx')) + window.scrollX,
            rect.top + parseFloat(this.getAttribute('cy')) + window.scrollY - 50,
            value, 
            period, 
            index
          );
        });
        
        point.addEventListener('mouseleave', hideTooltip);
      });
    }
  } else {
    console.warn('No revenue trend data available');
  }
  
  // Update Active Passports Bar Chart
  if (kpiData.active_users && kpiData.active_users.trend) {
    const activePassportsBars = generateBarChart(kpiData.active_users.trend);
    const chart = document.querySelector('#active-passports-chart');
    if (chart) {
      chart.innerHTML = activePassportsBars;
    }
  } else {
    console.warn('No active users trend data available');
  }
  
  // Update Passports Created Line Chart
  if (kpiData.passports_created && kpiData.passports_created.trend) {
    const passportsCreatedPath = generateLineChart(kpiData.passports_created.trend);
    const chart = document.querySelector('#passports-created-chart');
    if (chart && passportsCreatedPath) {
      chart.innerHTML = `<path d="${passportsCreatedPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
    }
  } else {
    console.warn('No passports created trend data available');
  }
  
  // Update Pending Signups Bar Chart
  if (kpiData.unpaid_passports && kpiData.unpaid_passports.trend) {
    const pendingSignupsBars = generateBarChart(kpiData.unpaid_passports.trend);
    const chart = document.querySelector('#pending-signups-chart');
    if (chart) {
      chart.innerHTML = pendingSignupsBars;
    }
  } else {
    console.warn('No pending signups trend data available');
  }
  
  // Update KPI values and performance indicators
  updateKpiValues(period, kpiData);
  
  // Add fade-in animation to updated charts
  setTimeout(() => {
    const allCharts = document.querySelectorAll('.card svg');
    allCharts.forEach(chart => {
      chart.style.opacity = '1';
    });
  }, 50);
  
  }, 150); // End of main setTimeout for smooth transition
}

// Function to update KPI values and performance indicators
function updateKpiValues(period, periodData) {
  // Update Revenue KPI value
  const revenueValueEl = document.getElementById('revenue-value');
  
  if (periodData.revenue !== undefined) {
    const revenueValue = `$${Math.round(periodData.revenue).toLocaleString()}`;
    if (revenueValueEl) revenueValueEl.textContent = revenueValue;
  }
  
  // Update Revenue trend percentage
  const revenueTrendEl = document.getElementById('revenue-trend');
  
  if (periodData.revenue_change !== undefined) {
    const change = periodData.revenue_change;
    let trendClass = 'text-muted';
    let icon = 'ti-minus';
    
    if (change > 0) {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (change < 0) {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    }
    
    const trendHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    const trendClass2 = `${trendClass} me-2`;
    
    if (revenueTrendEl) {
      revenueTrendEl.className = trendClass2;
      revenueTrendEl.innerHTML = trendHTML;
    }
  }
}

// Handle period dropdown clicks with smooth transitions for DASHBOARD (not activity dashboard)
// WARNING: Do NOT call updateCharts() here - it updates ALL cards globally!
// Each dropdown must only update its own specific KPI card
function attachDropdownHandlers() {
  // Find all dropdown items in KPI cards
  document.querySelectorAll('.kpi-period-btn').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Prevent multiple rapid clicks
      if (this.classList.contains('loading')) return;
      this.classList.add('loading');
      
      // Get period from data attribute
      const period = this.getAttribute('data-period');
      const text = this.textContent.trim();
      
      // Find the specific KPI card this dropdown belongs to
      const cardElement = this.closest('.card');
      
      // Add null check to prevent TypeError
      if (!cardElement) {
        console.error('Could not find card element for KPI dropdown');
        this.classList.remove('loading');
        return;
      }
      
      const kpiType = determineKPIType(cardElement);
      
      // Update button text with loading state
      const button = this.closest('.dropdown')?.querySelector('.dropdown-toggle');
      if (button) {
        button.style.opacity = '0.7';
        button.textContent = text + ' ...';
      }
      
      // Update ONLY this specific KPI card by fetching new data
      updateKPICard(period, kpiType, cardElement);
      
      // Reset loading state and button text
      setTimeout(() => {
        this.classList.remove('loading');
        if (button) {
          button.style.opacity = '1';
          button.textContent = text;
        }
      }, 300);
    });
  });
}


function showKPILoadingForCard(cardElement) {
  // Add null check to prevent errors
  if (!cardElement) {
    console.error('showKPILoadingForCard called with null cardElement');
    return;
  }
  
  // Show loading for specific card only
  const valueEl = cardElement.querySelector('.h2');
  // Find trend element using ID-based selectors
  const trendEl = cardElement.querySelector('[id*="-trend"]');
  const chartEl = cardElement.querySelector('[id*="-chart"]');
  
  if (valueEl) valueEl.style.opacity = '0.6';
  if (trendEl) trendEl.style.opacity = '0.6';
  if (chartEl) chartEl.style.opacity = '0.3';
}

function showKPILoading() {
  // Show loading for all KPI cards
  document.querySelectorAll('.card .h2').forEach(el => {
    el.style.opacity = '0.5';
  });
  document.querySelectorAll('.card .text-success, .card .text-danger, .card .text-muted').forEach(el => {
    if (el.closest('.card')) {
      el.style.opacity = '0.5';
    }
  });
}

function hideKPILoadingForCard(cardElement) {
  // Add null check to prevent errors
  if (!cardElement) {
    console.error('hideKPILoadingForCard called with null cardElement');
    return;
  }
  
  // Hide loading for specific card only
  const valueEl = cardElement.querySelector('.h2');
  // Find trend element using ID-based selectors
  const trendEl = cardElement.querySelector('[id*="-trend"]');
  const chartEl = cardElement.querySelector('[id*="-chart"]');
  
  if (valueEl) valueEl.style.opacity = '1';
  if (trendEl) trendEl.style.opacity = '1';
  if (chartEl) chartEl.style.opacity = '1';
}

function hideKPILoading() {
  // Hide loading for all KPI cards
  document.querySelectorAll('.card .h2').forEach(el => {
    el.style.opacity = '1';
  });
  document.querySelectorAll('.card .text-success, .card .text-danger, .card .text-muted').forEach(el => {
    if (el.closest('.card')) {
      el.style.opacity = '1';
    }
  });
}

// CRITICAL: This function ensures individual card updates without cross-contamination
// It identifies which specific KPI card was clicked to enable targeted updates
function determineKPIType(cardElement) {
  // Add null check to prevent errors
  if (!cardElement) {
    console.error('determineKPIType called with null cardElement');
    return 'revenue'; // fallback
  }

  // Determine KPI type based on card content - use FRONTEND keys consistently
  const cardText = cardElement.textContent.toLowerCase();
  if (cardText.includes('revenue')) return 'revenue';
  if (cardText.includes('active passports') || cardText.includes('active users')) return 'active_passports';
  if (cardText.includes('passports redeemed')) return 'passports_redeemed';
  if (cardText.includes('passports created')) return 'passports_created';
  if (cardText.includes('unpaid passports') || cardText.includes('pending sign ups')) return 'pending_signups';
  return 'revenue'; // fallback
}

// Function to update a specific KPI card with new data from API
async function updateKPICard(period, kpiType, cardElement) {
  console.log(`ðŸ”„ updateKPICard called - Period: ${period}, Type: ${kpiType}`);
  try {
    showKPILoadingForCard(cardElement);
    
    // Get activity_id if we're on activity dashboard
    const activityId = window.location.pathname.includes('activity-dashboard') 
      ? window.location.pathname.split('/').pop() 
      : null;
    
    // Build API URL
    let apiUrl = `/api/kpi-data?period=${period}`;
    if (activityId) {
      apiUrl += `&activity_id=${activityId}`;
    }
    
    // Fetch new KPI data
    const response = await fetch(apiUrl);
    if (!response.ok) {
      throw new Error(`API call failed: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('ðŸ“¦ API Response:', result);
    if (!result.success) {
      throw new Error(result.error || 'API returned error');
    }
    
    // Map frontend card types to API data keys
    const apiKeyMapping = {
      'revenue': 'revenue',
      'active_passports': 'active_users',
      'passports_created': 'passports_created',
      'passports_redeemed': 'passports_redeemed',
      'pending_signups': 'unpaid_passports'
    };
    
    const apiKey = apiKeyMapping[kpiType] || kpiType;
    const kpiData = result.kpi_data[apiKey];
    console.log(`ðŸ“ˆ KPI Data for ${kpiType} (API key: ${apiKey}):`, kpiData);
    if (!kpiData) {
      throw new Error(`No data found for KPI type: ${kpiType} (API key: ${apiKey})`);
    }
    
    // Update card value with specific ID selectors
    let valueElement = null;
    if (kpiType === 'revenue') {
      valueElement = cardElement.querySelector('#revenue-value');
    } else if (kpiType === 'active_passports') {
      valueElement = cardElement.querySelector('#active-passports-value');
    } else if (kpiType === 'passports_created') {
      valueElement = cardElement.querySelector('#passports-created-value');
    } else if (kpiType === 'passports_redeemed') {
      valueElement = cardElement.querySelector('#passports-redeemed-value');
    } else if (kpiType === 'pending_signups') {
      valueElement = cardElement.querySelector('#pending-signups-value');
    }
    
    if (valueElement) {
      let formattedValue = kpiData.current;
      if (kpiType === 'revenue') {
        formattedValue = `$${Math.round(kpiData.current).toLocaleString()}`;
      } else {
        formattedValue = Math.round(kpiData.current).toLocaleString();
      }
      valueElement.textContent = formattedValue;
    }
    
    // Update performance indicator with proper color and arrow
    // Use specific ID-based selectors to avoid overwriting title elements
    let trendElement = null;
    if (kpiType === 'revenue') {
      trendElement = cardElement.querySelector('#revenue-trend');
    } else if (kpiType === 'active_passports') {
      trendElement = cardElement.querySelector('#active-passports-trend');
    } else if (kpiType === 'passports_created') {
      trendElement = cardElement.querySelector('#passports-created-trend');
    } else if (kpiType === 'passports_redeemed') {
      trendElement = cardElement.querySelector('#passports-redeemed-trend');
    } else if (kpiType === 'pending_signups') {
      trendElement = cardElement.querySelector('#pending-signups-trend');
    }
    
    if (trendElement && kpiData.change !== null && kpiData.change !== undefined) {
      let trendClass = 'text-muted me-2';
      let icon = 'ti-minus';
      let changeText = '--';
      
      if (kpiData.change > 0) {
        trendClass = 'text-success me-2';
        icon = 'ti-trending-up';
        changeText = `${Math.round(Math.abs(kpiData.change))}%`;
      } else if (kpiData.change < 0) {
        trendClass = 'text-danger me-2';
        icon = 'ti-trending-down';
        changeText = `${Math.round(Math.abs(kpiData.change))}%`;
      } else if (kpiData.change === 0) {
        changeText = '0%';
      }
      
      trendElement.className = trendClass;
      trendElement.innerHTML = `${changeText} <i class="ti ${icon}"></i>`;
    }
    
    // Update chart with new trend data
    updateSingleChart(cardElement, kpiData, kpiType);
    
    // Update dropdown button text
    const dropdownButton = cardElement.querySelector('.dropdown-toggle');
    if (dropdownButton) {
      const periodTexts = {
        '7d': 'Last 7 days',
        '30d': 'Last 30 days', 
        '90d': 'Last 90 days',
        'all': 'All time'
      };
      dropdownButton.textContent = periodTexts[period] || period;
    }
    
    hideKPILoadingForCard(cardElement);
    
  } catch (error) {
    console.error('Error updating KPI card:', error);
    hideKPILoadingForCard(cardElement);
    
    // Show error state
    const trendElement = cardElement.querySelector('.d-flex .text-success, .d-flex .text-danger, .d-flex .text-muted');
    if (trendElement) {
      trendElement.className = 'text-danger me-2';
      trendElement.innerHTML = 'Error <i class="ti ti-alert-circle"></i>';
    }
  }
}

// Function to update a single chart in a KPI card
function updateSingleChart(cardElement, kpiData, kpiType) {
  const chartElement = cardElement.querySelector('[id*="-chart"]');
  if (!chartElement || !kpiData.trend_data || kpiData.trend_data.length === 0) {
    return;
  }
  
  // Clear existing chart
  chartElement.innerHTML = '';
  
  if (kpiType === 'revenue') {
    // Line chart for revenue
    const options = {
      series: [{ 
        name: 'Revenue',
        data: kpiData.trend_data 
      }],
      chart: { 
        type: 'area', 
        height: 40, 
        sparkline: { enabled: true },
        toolbar: { show: false },
        parentHeightOffset: 0,
        offsetX: 0,
        offsetY: 0
      },
      stroke: {
        width: 1.5,
        curve: 'smooth'
      },
      colors: ['#206bc4'],
      tooltip: {
        enabled: true,
        y: {
          formatter: (val) => `$${Math.round(val).toLocaleString()}`
        }
      },
      grid: {
        show: false,
        padding: {
          top: 0,
          right: 0,
          bottom: 0,
          left: 0
        }
      },
      markers: {
        size: 0
      },
      dataLabels: {
        enabled: false
      }
    };
    
    const chart = new ApexCharts(chartElement, options);
    chart.render();
  } else {
    // Bar chart for other KPIs
    const options = {
      series: [{
        name: kpiType === 'pending_signups' ? 'Unpaid Passports' :
              kpiType === 'passports_redeemed' ? 'Passports Redeemed' :
              kpiType.replace('_', ' '),
        data: kpiData.trend_data
      }],
      chart: { 
        type: 'bar', 
        height: 40, 
        sparkline: { enabled: true },
        toolbar: { show: false },
        parentHeightOffset: 0,
        offsetX: 0,
        offsetY: 0
      },
      plotOptions: {
        bar: {
          borderRadius: 2,
          columnWidth: '60%'
        }
      },
      colors: ['#206bc4'],
      tooltip: {
        enabled: true,
        y: {
          formatter: (val) => (val || 0).toString()
        }
      },
      grid: {
        show: false,
        padding: {
          top: 0,
          right: 0,
          bottom: 0,
          left: 0
        }
      },
      dataLabels: {
        enabled: false
      }
    };
    
    const chart = new ApexCharts(chartElement, options);
    chart.render();
  }
}

// Update single KPI card for DASHBOARD using existing kpiData (no API calls)
function updateDashboardKPICard(period, kpiType, cardElement) {
  console.log(`Updating dashboard KPI card: ${kpiType} for period: ${period}`);
  
  // Show loading state for this card only
  showKPILoadingForCard(cardElement);
  
  // Use existing KPI data from template (simplified structure)
  if (kpiData) {
    console.log(`Found KPI data:`, kpiData);
    // Update the specific KPI card with existing data
    updateSingleKPIValues(kpiType, cardElement, period, kpiData);
    updateSingleKPIChart(kpiType, cardElement, period, kpiData);
  } else {
    console.warn(`No KPI data available`);
  }
  
  // Hide loading state
  setTimeout(() => {
    hideKPILoadingForCard(cardElement);
  }, 200);
}

// WARNING: Must use specific ID selectors for revenue cards (#revenue-trend)
// Using broad selectors like '.text-muted' will overwrite title elements!
function updateSingleKPIValues(kpiType, cardElement, period, periodData) {
  // Update value and trend for the specific card only
  const valueEl = cardElement.querySelector('.h2');
  // Use specific ID selectors for trend elements to avoid matching title elements
  let trendEl = null;
  if (kpiType === 'revenue') {
    trendEl = cardElement.querySelector('#revenue-trend');
  } else {
    // For other KPI types, find the trend element by looking for elements with specific IDs
    // or fall back to more specific selector that excludes the title
    trendEl = cardElement.querySelector('.d-flex .text-success, .d-flex .text-danger, .d-flex .text-muted');
  }
  
  if (kpiType === 'revenue' && kpiData.revenue && kpiData.revenue.current !== undefined) {
    const revenueValue = `$${Math.round(kpiData.revenue.current).toLocaleString()}`;
    if (valueEl) valueEl.textContent = revenueValue;
    
    if (trendEl && kpiData.revenue.change !== undefined) {
      const change = kpiData.revenue.change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  } else if (kpiType === 'active_passports' && kpiData.active_users && kpiData.active_users.current !== undefined) {
    if (valueEl) valueEl.textContent = Math.round(kpiData.active_users.current);
    
    if (trendEl && kpiData.active_users.change !== undefined) {
      const change = kpiData.active_users.change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  } else if (kpiType === 'passports_created' && kpiData.passports_created && kpiData.passports_created.current !== undefined) {
    if (valueEl) valueEl.textContent = Math.round(kpiData.passports_created.current);
    
    if (trendEl && kpiData.passports_created.change !== undefined) {
      const change = kpiData.passports_created.change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  } else if (kpiType === 'pending_signups' && kpiData.unpaid_passports && kpiData.unpaid_passports.current !== undefined) {
    if (valueEl) valueEl.textContent = Math.round(kpiData.unpaid_passports.current);
    
    if (trendEl && kpiData.unpaid_passports.change !== undefined) {
      const change = kpiData.unpaid_passports.change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  }
}

function updateSingleKPIChart(kpiType, cardElement, period, periodData) {
  // Update chart for the specific card only
  const chartEl = cardElement.querySelector('svg');
  if (!chartEl || !kpiData) return;
  
  if (kpiType === 'revenue' && kpiData.revenue && kpiData.revenue.trend) {
    const revenueChartData = generateInteractiveLineChart(kpiData.revenue.trend, 300, 40, 'revenue');
    if (revenueChartData.path) {
      chartEl.innerHTML = `
        <path d="${revenueChartData.path}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        ${revenueChartData.points.map((point, index) => 
          `<circle cx="${point.x}" cy="${point.y}" r="6" fill="transparent" 
                   data-value="${point.value}" data-index="${index}" 
                   class="chart-hover-point" style="cursor: pointer;" />`
        ).join('')}
      `;
      
      // Add hover event listeners for revenue tooltips
      chartEl.querySelectorAll('.chart-hover-point').forEach(point => {
        point.addEventListener('mouseenter', function(e) {
          const rect = chartEl.getBoundingClientRect();
          const value = parseFloat(this.getAttribute('data-value'));
          const index = parseInt(this.getAttribute('data-index'));
          showTooltip(
            rect.left + parseFloat(this.getAttribute('cx')) + window.scrollX,
            rect.top + parseFloat(this.getAttribute('cy')) + window.scrollY - 50,
            value, 
            period, 
            index
          );
        });
        
        point.addEventListener('mouseleave', hideTooltip);
      });
    }
  } else if (kpiType === 'active_passports' && kpiData.active_users && kpiData.active_users.trend) {
    const activePassportsBars = generateBarChart(kpiData.active_users.trend);
    chartEl.innerHTML = activePassportsBars;
  } else if (kpiType === 'passports_created' && kpiData.passports_created && kpiData.passports_created.trend) {
    const passportsCreatedPath = generateLineChart(kpiData.passports_created.trend);
    chartEl.innerHTML = `<path d="${passportsCreatedPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
  } else if (kpiType === 'pending_signups' && kpiData.unpaid_passports && kpiData.unpaid_passports.trend) {
    const pendingSignupsBars = generateBarChart(kpiData.unpaid_passports.trend);
    chartEl.innerHTML = pendingSignupsBars;
  }
}

function updateMainDashboardKPIs(period) {
  // First, try to use existing KPI data for immediate feedback
  const existingData = kpiData[period];
  if (existingData) {
    updateKPIValues(period, existingData);
  }
  
  // Use server-side rendered data (no API calls needed per simplification plan)
  console.log('Using server-side KPI data, no API calls needed');

  hideKPILoading();
}

function updateKPIDisplays(kpiData, period) {
  // Update Revenue - pass the full period data which contains revenue and revenue_change
  updateKPICardLegacy('revenue', kpiData);
  
}

function updateKPICardLegacy(prefix, data) {
  // Update value - LEGACY FUNCTION (renamed to avoid conflict with async version)
  const valueEl = document.getElementById(`${prefix}-value`);
  if (valueEl && data) {
    if (prefix.includes('revenue')) {
      valueEl.textContent = `$${Math.round(data.revenue || 0).toLocaleString()}`;
    } else {
      valueEl.textContent = Math.round(data.total || 0);
    }
  }
  
  // Update trend
  const trendEl = document.getElementById(`${prefix}-trend`);
  if (trendEl && data) {
    // Use revenue_change for revenue cards, change for others
    const change = prefix.includes('revenue') ? (data.revenue_change || 0) : (data.change || 0);
    let trendClass = 'text-muted';
    let icon = 'ti-minus';
    
    if (change > 0) {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (change < 0) {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    }
    
    trendEl.className = `${trendClass} me-2`;
    trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
  }
}

// Pagination functionality for logs table
class LogsPagination {
  constructor(logs, itemsPerPage = 10) {
    this.logs = logs;
    this.itemsPerPage = itemsPerPage;
    this.currentPage = 1;
    this.totalPages = Math.ceil(logs.length / itemsPerPage);
    this.tableBody = document.querySelector('#logTable tbody');
    this.paginationControls = document.getElementById('paginationControls');
    this.showingCount = document.getElementById('showingCount');
  }

  getPageData(pageNumber) {
    const startIndex = (pageNumber - 1) * this.itemsPerPage;
    const endIndex = startIndex + this.itemsPerPage;
    return this.logs.slice(startIndex, endIndex);
  }

  renderTable(pageNumber) {
    const pageData = this.getPageData(pageNumber);
    const tbody = this.tableBody;
    
    tbody.innerHTML = '';
    
    pageData.forEach(log => {
      const row = document.createElement('tr');
      
      // Format timestamp - handle both ISO string and object formats
      let formattedDate = 'Invalid Date';
      try {
        let timestamp;
        if (typeof log.timestamp === 'string') {
          timestamp = new Date(log.timestamp);
        } else {
          // If it's already a Date object or timestamp object
          timestamp = new Date(log.timestamp);
        }
        
        // Check if date is valid
        if (!isNaN(timestamp.getTime())) {
          // Format date to match the original format (YYYY-MM-DD HH:MM)
          const year = timestamp.getFullYear();
          const month = String(timestamp.getMonth() + 1).padStart(2, '0');
          const day = String(timestamp.getDate()).padStart(2, '0');
          const hours = String(timestamp.getHours()).padStart(2, '0');
          const minutes = String(timestamp.getMinutes()).padStart(2, '0');
          formattedDate = `${year}-${month}-${day} ${hours}:${minutes}`;
        }
      } catch (e) {
        console.warn('Error formatting date for log:', log, e);
        formattedDate = 'Invalid Date';
      }
      
      // Get icon based on log type - using Tabler icons from activity_log.html
      const iconMap = {
        'Passport Redeemed': '<i class="ti ti-ticket text-danger"></i>',
        'Email Sent': '<i class="ti ti-mail text-info"></i>',
        'Passport Created': '<i class="ti ti-id text-lime"></i>',
        'Interact Payment': '<i class="ti ti-currency-dollar text-success"></i>',
        'Marked Paid': '<i class="ti ti-check text-green"></i>',
        'Reminder Sent': '<i class="ti ti-bell text-purple"></i>',
        'Signup Submitted': '<i class="ti ti-user-plus text-success"></i>',
        'Signup Approved': '<i class="ti ti-user-check text-green"></i>',
        'Signup Rejected': '<i class="ti ti-user-x text-danger"></i>',
        'Signup Cancelled': '<i class="ti ti-user-x text-danger"></i>',
        'Activity Created': '<i class="ti ti-target text-orange"></i>',
        'Admin Action': '<i class="ti ti-settings text-muted"></i>'
      };
      
      const icon = iconMap[log.type] || '<i class="ti ti-activity text-muted"></i>';
      
      row.className = 'log-row';
      row.setAttribute('data-type', log.type.toLowerCase().replace(' ', '-'));

      // Extract just the date (no time) for mobile badge
      const dateOnly = formattedDate.split(' ')[0];

      row.innerHTML = `
        <td class="d-none d-md-table-cell" style="vertical-align: middle;">
          <div class="text-nowrap">
            ${formattedDate}
          </div>
        </td>
        <td class="d-none d-md-table-cell" style="vertical-align: middle;">${icon} ${log.type}</td>
        <td class="log-description-cell" style="vertical-align: middle;">
          <div class="d-md-none mb-1">
            <span class="badge badge-sm bg-gray-lt">${dateOnly}</span>
          </div>
          <div class="log-description-text">
            ${log.details || ''}
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
    });
    
    this.updateShowingText();
  }

  updateShowingText() {
    const start = (this.currentPage - 1) * this.itemsPerPage + 1;
    const end = Math.min(this.currentPage * this.itemsPerPage, this.logs.length);
    this.showingCount.textContent = `${start}-${end}`;
    
    // Update total entries info
    const entriesInfo = document.getElementById('entriesInfo');
    if (entriesInfo) {
      const totalText = entriesInfo.textContent.split(' of ')[1];
      entriesInfo.innerHTML = `Showing <span id="showingCount">${start}-${end}</span> of ${this.logs.length} entries`;
    }
  }

  renderPagination() {
    const pagination = this.paginationControls;
    pagination.innerHTML = '';

    const isMobile = window.innerWidth < 768;

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a href="#" class="page-link" data-page="${this.currentPage - 1}">Previous</a>`;
    pagination.appendChild(prevLi);

    // Only show page numbers on desktop
    if (!isMobile) {
      // Page numbers logic
      const maxVisiblePages = 5;
      let startPage, endPage;

      if (this.totalPages <= maxVisiblePages) {
        startPage = 1;
        endPage = this.totalPages;
      } else {
        if (this.currentPage <= 3) {
          startPage = 1;
          endPage = maxVisiblePages;
        } else if (this.currentPage >= this.totalPages - 2) {
          startPage = this.totalPages - maxVisiblePages + 1;
          endPage = this.totalPages;
        } else {
          startPage = this.currentPage - 2;
          endPage = this.currentPage + 2;
        }
      }

      // First page + ellipsis if needed
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = '<a href="#" class="page-link" data-page="1">1</a>';
        pagination.appendChild(firstLi);

        if (startPage > 2) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = '<a href="#" class="page-link">...</a>';
          pagination.appendChild(ellipsisLi);
        }
      }

      // Main page numbers
      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
        li.innerHTML = `<a href="#" class="page-link" data-page="${i}">${i}</a>`;
        pagination.appendChild(li);
      }

      // Last page + ellipsis if needed
      if (endPage < this.totalPages) {
        if (endPage < this.totalPages - 1) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = '<a href="#" class="page-link">...</a>';
          pagination.appendChild(ellipsisLi);
        }

        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a href="#" class="page-link" data-page="${this.totalPages}">${this.totalPages}</a>`;
        pagination.appendChild(lastLi);
      }
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${this.currentPage === this.totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a href="#" class="page-link" data-page="${this.currentPage + 1}">Next</a>`;
    pagination.appendChild(nextLi);

    // Add click event listeners
    pagination.addEventListener('click', (e) => {
      e.preventDefault();
      if (e.target.classList.contains('page-link') && !e.target.parentElement.classList.contains('disabled')) {
        const page = parseInt(e.target.dataset.page);
        if (page && page !== this.currentPage) {
          this.goToPage(page);
        }
      }
    });
  }

  goToPage(pageNumber) {
    if (pageNumber >= 1 && pageNumber <= this.totalPages) {
      this.currentPage = pageNumber;
      this.renderTable(pageNumber);
      this.renderPagination();
    }
  }

  init() {
    // Add loading state
    this.tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border spinner-border-sm text-muted me-2" role="status"></div>Loading events...</td></tr>';
    
    // Show/hide pagination based on number of pages
    const paginationNav = document.getElementById('paginationNav');
    if (paginationNav) {
      paginationNav.style.display = this.totalPages > 1 ? 'block' : 'none';
    }
    
    // Small delay to show loading state, then render content
    setTimeout(() => {
      this.renderTable(1);
      this.renderPagination();
    }, 100);
  }
}

// Logs data is already available as allLogs from line 1125

// Initialize pagination instance
let logsPagination;

// Initialize ApexCharts on page load  
function initializeApexCharts() {
  if (!kpiData || typeof ApexCharts === 'undefined') return;
  
  // Revenue line chart
  if (kpiData.revenue && kpiData.revenue.trend_data) {
    const el = document.querySelector('#revenue-chart');
    if (el) new ApexCharts(el, {series: [{data: kpiData.revenue.trend_data}], chart: {type: 'area', height: 40, sparkline: {enabled: true}}, colors: ['#206bc4']}).render();
  }

  // Active passports bar chart
  if (kpiData.active_users && kpiData.active_users.trend_data) {
    const el = document.querySelector('#active-passports-chart');
    if (el) new ApexCharts(el, {series: [{data: kpiData.active_users.trend_data}], chart: {type: 'bar', height: 40, sparkline: {enabled: true}}, colors: ['#206bc4']}).render();
  }

  // Passports created bar chart
  if (kpiData.passports_created && kpiData.passports_created.trend_data) {
    const el = document.querySelector('#passports-created-chart');
    if (el) new ApexCharts(el, {series: [{data: kpiData.passports_created.trend_data}], chart: {type: 'bar', height: 40, sparkline: {enabled: true}}, colors: ['#206bc4']}).render();
  }

  // Unpaid passports bar chart
  if (kpiData.unpaid_passports && kpiData.unpaid_passports.trend_data) {
    const el = document.querySelector('#pending-signups-chart');
    if (el) new ApexCharts(el, {series: [{data: kpiData.unpaid_passports.trend_data}], chart: {type: 'bar', height: 40, sparkline: {enabled: true}}, colors: ['#206bc4']}).render();
  }

  // Passports redeemed bar chart (NEW)
  if (kpiData.passports_redeemed && kpiData.passports_redeemed.trend_data) {
    const el = document.querySelector('#passports-redeemed-chart');
    if (el) new ApexCharts(el, {series: [{data: kpiData.passports_redeemed.trend_data}], chart: {type: 'bar', height: 40, sparkline: {enabled: true}}, colors: ['#206bc4']}).render();
  }
}

// Simple mobile carousel - swipe handling only (< 20 lines)
function initializeMobileCarousel() {
  const carousel = document.querySelector('.kpi-carousel');
  const dots = document.querySelectorAll('.dot');
  if (carousel && window.innerWidth < 768) {
    carousel.addEventListener('scroll', () => {
      const index = Math.round(carousel.scrollLeft / carousel.offsetWidth);
      dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
    });
  }
}

// Initialize charts with server-provided data
function initializeMobileCharts() {
  {% if mobile_kpi_data %}
    if (typeof ApexCharts !== 'undefined') {
      // Revenue chart
      {% if mobile_kpi_data['revenue'] and mobile_kpi_data['revenue']['trend_data'] %}
        const revenueEl = document.getElementById('mobile-revenue-chart');
        if (revenueEl) {
          const revenueChart = new ApexCharts(revenueEl, {
            series: [{data: {{ mobile_kpi_data['revenue']['trend_data'] | tojson }}}],
            chart: {type: 'area', height: 40, sparkline: {enabled: true}},
            colors: ['#206bc4']
          });
          revenueChart.render();
        }
      {% endif %}
      
      // Active passports chart
      {% if mobile_kpi_data['active_users'] and mobile_kpi_data['active_users']['trend_data'] %}
        const activeEl = document.getElementById('mobile-active-passports-chart');
        if (activeEl) {
          const activeChart = new ApexCharts(activeEl, {
            series: [{data: {{ mobile_kpi_data['active_users']['trend_data'] | tojson }}}],
            chart: {type: 'bar', height: 40, sparkline: {enabled: true}},
            colors: ['#206bc4']
          });
          activeChart.render();
        }
      {% endif %}
      
      // Passports created chart
      {% if mobile_kpi_data['passports_created'] and mobile_kpi_data['passports_created']['trend_data'] %}
        const createdEl = document.getElementById('mobile-passports-created-chart');
        if (createdEl) {
          const createdChart = new ApexCharts(createdEl, {
            series: [{data: {{ mobile_kpi_data['passports_created']['trend_data'] | tojson }}}],
            chart: {type: 'bar', height: 40, sparkline: {enabled: true}},
            colors: ['#206bc4']
          });
          createdChart.render();
        }
      {% endif %}
      
      // Unpaid passports chart
      {% if mobile_kpi_data['unpaid_passports'] and mobile_kpi_data['unpaid_passports']['trend_data'] %}
        const unpaidEl = document.getElementById('mobile-unpaid-passports-chart');
        if (unpaidEl) {
          const unpaidChart = new ApexCharts(unpaidEl, {
            series: [{data: {{ mobile_kpi_data['unpaid_passports']['trend_data'] | tojson }}}],
            chart: {type: 'bar', height: 40, sparkline: {enabled: true}},
            colors: ['#206bc4']
          });
          unpaidChart.render();
        }
      {% endif %}
    }
  {% endif %}
}

// Initialize charts and filtering on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing charts...');
  initializeApexCharts();
  attachDropdownHandlers();
  
  // Initialize mobile carousel and charts
  initializeMobileCarousel();
  
  // Ensure ApexCharts is loaded before initializing mobile charts
  if (typeof ApexCharts !== 'undefined') {
    initializeMobileCharts();
  } else {
    // Wait for ApexCharts to load
    setTimeout(function() {
      initializeMobileCharts();
    }, 100);
  }
  
  // Handle case where there are no logs
  if (!allLogs || allLogs.length === 0) {
    const tbody = document.querySelector('#logTable tbody');
    const entriesInfo = document.getElementById('entriesInfo');
    
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">No system events found</td></tr>';
    }
    if (entriesInfo) {
      entriesInfo.textContent = 'No entries found';
    }
  }
  
  // Initial setup - show all logs
  if (allLogs && allLogs.length > 0) {
    logsPagination = new LogsPagination(allLogs, 10);
    logsPagination.init();
  }

  // Re-render pagination on window resize for responsive behavior
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (logsPagination) {
        logsPagination.renderPagination();
      }
    }, 150);
  });
});

// Filter functionality
window.filterLogs = function(filterType) {
    const filterButtons = document.querySelectorAll('.github-filter-btn');
    
    // Update button states
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.cssText = btn.style.cssText.replace(/background: #ffffff[^;]*;/, 'background: rgba(0, 0, 0, 0.03);')
                                          .replace(/color: #24292e[^;]*;/, 'color: #586069;')
                                          .replace(/font-weight: 600[^;]*;/, '')
                                          .replace(/border: 1px solid #d1d5da[^;]*;/, '')
                                          .replace(/margin: -1px[^;]*;/, 'margin: 0;')
                                          .replace(/z-index: 1[^;]*;/, '')
                                          .replace(/border-radius: 6px[^;]*;/, '')
                                          .replace(/box-shadow: 0 1px 0 rgba\(27,31,35,0\.04\)[^;]*;/, '');
        
        // Add background pattern for inactive buttons (except last one)
        if (!btn.id.includes('admin')) {
            btn.style.backgroundImage = 'linear-gradient(to right, transparent 0%, transparent 100%), linear-gradient(180deg, transparent 20%, #d1d5da 20%, #d1d5da 80%, transparent 80%)';
            btn.style.backgroundSize = '100% 100%, 1px 100%';
            btn.style.backgroundPosition = 'center, right center';
            btn.style.backgroundRepeat = 'no-repeat';
            btn.style.borderRight = '1px solid transparent';
            btn.style.backgroundClip = 'padding-box';
        }
    });
    
    // Activate selected button
    const activeButton = document.getElementById(`filter-${filterType}`);
    if (activeButton) {
        activeButton.classList.add('active');
        activeButton.style.background = '#ffffff';
        activeButton.style.color = '#24292e';
        activeButton.style.fontWeight = '600';
        activeButton.style.border = '1px solid #d1d5da';
        activeButton.style.margin = '-1px';
        activeButton.style.zIndex = '1';
        activeButton.style.borderRadius = '6px';
        activeButton.style.boxShadow = '0 1px 0 rgba(27,31,35,0.04)';
        activeButton.style.backgroundImage = 'none';
        activeButton.style.borderRight = 'none';
    }
    
    // Filter logs data
    let filteredLogs = allLogs.filter(log => {
        const logType = log.type.toLowerCase();
        
        if (filterType === 'all') {
            return true;
        } else if (filterType === 'passport') {
            return logType.includes('passport');
        } else if (filterType === 'signup') {
            return logType.includes('signup');
        } else if (filterType === 'payment') {
            return logType.includes('paid') || logType.includes('payment');
        } else if (filterType === 'admin') {
            return logType.includes('admin') || logType.includes('activity');
        }
        return false;
    });
    
    // Create new pagination with filtered data
    logsPagination = new LogsPagination(filteredLogs, 10);
    logsPagination.init();
    
    return false; // Prevent navigation
};

function updateFilterCounts() {
    const counts = {
        all: allLogs.length,
        passport: 0,
        signup: 0,
        payment: 0,
        admin: 0
    };
    
    allLogs.forEach(log => {
        const logType = log.type.toLowerCase();
        
        if (logType.includes('passport')) {
            counts.passport++;
        }
        if (logType.includes('signup')) {
            counts.signup++;
        }
        if (logType.includes('paid') || logType.includes('payment')) {
            counts.payment++;
        }
        if (logType.includes('admin') || logType.includes('activity')) {
            counts.admin++;
        }
    });
    
    // Update count displays
    Object.keys(counts).forEach(type => {
        const countElement = document.getElementById(`count-${type}`);
        if (countElement) {
            countElement.textContent = `(${counts[type]})`;
        }
    });
}

// DEAD SIMPLE Mobile KPI dot navigation (< 10 lines)
document.addEventListener('DOMContentLoaded', function() {
  const scroll = document.querySelector('.mobile-kpi-scroll');
  const dots = document.querySelectorAll('.mobile-dot');
  if (scroll && dots.length > 0) {
    scroll.addEventListener('scroll', () => {
      const cardWidth = scroll.querySelector('.mobile-kpi-card').offsetWidth + 16;
      const index = Math.min(dots.length - 1, Math.round(scroll.scrollLeft / cardWidth));
      dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
    });
  }
});

// Clean Duplicate Logs function (called from settings page)
function cleanDuplicateLogs() {
  const modal = new bootstrap.Modal(document.getElementById('cleanupLogsModal'));
  modal.show();
}

</script>

<!-- Clean Duplicate Logs Confirmation Modal -->
<div class="modal modal-blur fade" id="cleanupLogsModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M4 7h16"/>
          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/>
          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/>
          <path d="M10 12l0 6"/>
          <path d="M14 12l0 6"/>
        </svg>
        <h3>Clean Duplicate Logs?</h3>
        <div class="text-secondary">Delete all duplicate Payment No Match logs? Only the latest entry for each unique payment will be kept.</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <button class="btn w-100" data-bs-dismiss="modal">Cancel</button>
            </div>
            <div class="col">
              <button type="button" class="btn btn-danger w-100" id="confirmCleanupLogs">
                <i class="ti ti-trash me-1"></i>Clean Logs
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Handle cleanup logs confirmation
document.addEventListener('DOMContentLoaded', () => {
  const confirmBtn = document.getElementById('confirmCleanupLogs');
  if (confirmBtn) {
    confirmBtn.onclick = async () => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('cleanupLogsModal'));
      modal.hide();

      confirmBtn.disabled = true;
      confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cleaning...';

      try {
        const res = await fetch('/api/cleanup-duplicate-logs', {
          method: 'POST',
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (data.success) {
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-success alert-dismissible position-fixed top-0 start-50 translate-middle-x mt-3';
          successAlert.style.zIndex = '9999';
          successAlert.style.minWidth = '300px';
          successAlert.innerHTML = `
            <div class="d-flex">
              <div><svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><path d="M9 12l2 2l4 -4"/></svg></div>
              <div><strong>Success!</strong> Deleted ${data.deleted_count} duplicate logs.</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(successAlert);
          setTimeout(() => location.reload(), 2000);
        } else {
          throw new Error(data.error || data.message || 'Unknown error');
        }
      } catch (err) {
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible position-fixed top-0 start-50 translate-middle-x mt-3';
        errorAlert.style.zIndex = '9999';
        errorAlert.style.minWidth = '300px';
        errorAlert.innerHTML = `
          <div class="d-flex">
            <div><svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
            <div><strong>Error:</strong> ${err.message}</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(errorAlert);
        setTimeout(() => errorAlert.remove(), 5000);

        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="ti ti-trash me-1"></i>Clean Logs';
      }
    };
  }
});
</script>

{% endblock %}