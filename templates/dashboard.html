{% extends "base.html" %}
{% block title %}Dashboard - Minipass{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Page Header -->
  <div class="page-header d-print-none">
    <div class="dashboard-container">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h1 class="page-title mb-3">
            Welcome back !
          </h1>
          <p class="text-muted mb-0">
            Here's what's happening with your activities today.
          </p>
        </div>
      </div>
    </div>
  </div>






  <!-- Page Body -->
  <div class="page-body">
    <div class="dashboard-container">
      
      <!-- KPI Cards Section - Desktop Layout -->
      <div class="kpi-section mb-6 mb-md-7">
        <div class="row mb-2">

        </div>
        <div class="row d-none d-md-flex">
        <!-- Revenue Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">REVENUE</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1" id="revenue-value">${{ "{:,.0f}".format(kpi_data['7d']['revenue']) if kpi_data and kpi_data.get('7d') else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('revenue_change') %}
                  {% if kpi_data['7d']['revenue_change'] > 0 %}
                    <div class="text-success me-2" id="revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['revenue_change'] < 0 %}
                    <div class="text-danger me-2" id="revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2" id="revenue-trend">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2" id="revenue-trend">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="revenue-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Passports Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ passport_stats['active_passports'] if passport_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('passport_change') %}
                  {% if kpi_data['7d']['passport_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['passport_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="active-passports-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Passports Created Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ passport_stats['total_passports'] if passport_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('new_passports_change') %}
                  {% if kpi_data['7d']['new_passports_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['new_passports_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="passports-created-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Sign Ups Card -->
        <div class="col-md-3 mb-3">
          <div class="card" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-muted small text-uppercase">PENDING SIGN UPS</div>
                <div class="dropdown">
                  <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Last 7 days
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                    <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                  </ul>
                </div>
              </div>
              <div class="h2 mb-1">{{ signup_stats['pending_signups'] if signup_stats else '0' }}</div>
              <div class="d-flex align-items-center mb-3">
                {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('signup_change') %}
                  {% if kpi_data['7d']['signup_change'] > 0 %}
                    <div class="text-success me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-up"></i></div>
                  {% elif kpi_data['7d']['signup_change'] < 0 %}
                    <div class="text-danger me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-down"></i></div>
                  {% else %}
                    <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                  {% endif %}
                {% else %}
                  <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                {% endif %}
              </div>
              <div style="height: 40px; position: relative; overflow: hidden;">
                <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="pending-signups-chart">
                  <!-- Chart will be dynamically rendered -->
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Section - Mobile Carousel -->
      <div class="d-md-none">
        <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
          <!-- Revenue Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">REVENUE</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1" id="mobile-revenue-value">${{ "{:,.0f}".format(kpi_data['7d']['revenue']) if kpi_data and kpi_data.get('7d') else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('revenue_change') %}
                    {% if kpi_data['7d']['revenue_change'] > 0 %}
                      <div class="text-success me-2" id="mobile-revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['revenue_change'] < 0 %}
                      <div class="text-danger me-2" id="mobile-revenue-trend">{{ kpi_data['7d']['revenue_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2" id="mobile-revenue-trend">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2" id="mobile-revenue-trend">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-revenue-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Active Passports Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">ACTIVE PASSPORTS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ passport_stats['active_passports'] if passport_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('passport_change') %}
                    {% if kpi_data['7d']['passport_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['passport_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['passport_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-active-passports-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Passports Created Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">PASSPORTS CREATED</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ passport_stats['total_passports'] if passport_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('new_passports_change') %}
                    {% if kpi_data['7d']['new_passports_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['new_passports_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['new_passports_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-passports-created-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Sign Ups Card -->
          <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
            <div class="card" style="border-radius: 12px; overflow: hidden;">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="text-muted small text-uppercase">PENDING SIGN UPS</div>
                  <div class="dropdown">
                    <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      Last 7 days
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="7d">Last 7 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="30d">Last 30 days</a></li>
                      <li><a class="dropdown-item kpi-period-btn" href="#" data-period="90d">Last 90 days</a></li>
                    </ul>
                  </div>
                </div>
                <div class="h2 mb-1">{{ signup_stats['pending_signups'] if signup_stats else '0' }}</div>
                <div class="d-flex align-items-center mb-3">
                  {% if kpi_data and kpi_data.get('7d') and kpi_data['7d'].get('signup_change') %}
                    {% if kpi_data['7d']['signup_change'] > 0 %}
                      <div class="text-success me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-up"></i></div>
                    {% elif kpi_data['7d']['signup_change'] < 0 %}
                      <div class="text-danger me-2">{{ kpi_data['7d']['signup_change'] }}% <i class="ti ti-trending-down"></i></div>
                    {% else %}
                      <div class="text-muted me-2">0% <i class="ti ti-minus"></i></div>
                    {% endif %}
                  {% else %}
                    <div class="text-muted me-2">-- <i class="ti ti-minus"></i></div>
                  {% endif %}
                </div>
                <div style="height: 40px; position: relative; overflow: hidden;">
                  <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="mobile-pending-signups-chart">
                    <!-- Chart will be dynamically rendered -->
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Scroll indicators -->
        <div class="text-center mt-2">
          <span class="badge bg-primary me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"></span>
          <span class="badge bg-light" style="width: 8px; height: 8px; border-radius: 50%;"></span>
        </div>
      </div>

      <!-- Activities Section -->
      <div class="activities-section mb-5 pt-3">
        <div class="row mb-4">
          <div class="col">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h2 class="section-title-large mb-1 d-flex align-items-center" style="font-size: 2rem; font-weight: 700;">
                  <i class="ti ti-activity-heartbeat text-danger me-3"></i>Your Active Activities 
                </h2>
         
              </div>
              <div>
                <a href="{{ url_for('create_activity') }}" class="btn btn-success d-none d-md-inline-block">
                  <i class="ti ti-plus"></i>
                  New Activity
                </a>
                <a href="{{ url_for('create_activity') }}" class="btn btn-success d-md-none btn-icon" aria-label="New Activity">
                  <i class="ti ti-plus"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Desktop Layout -->
        <div class="d-none d-md-block">
          <div class="row">
            {% for activity in activities %}
            <div class="col-md-3 mb-3">
              <div class="card" style="border-radius: 12px; overflow: hidden;">
                <!-- Activity Image -->
                {% if activity.image_filename %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                </div>
                {% else %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); display: flex; align-items: center; justify-content: center;">
                  <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                  <div class="mb-2">
                    <h3 class="card-title mb-0">{{ activity.name }}</h3>
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if activities|length < 4 %}
            <!-- Add Activity Placeholder - Skeleton design with clickable card -->
            <div class="col-md-3 mb-3 d-none d-md-block">
              <a href="{{ url_for('create_activity') }}" style="text-decoration: none;">
                <div class="card" style="border-radius: 12px; overflow: hidden; background-color: #f1f5f9; border: 1px dashed #d1d5db; height: 276.84px; cursor: pointer;">
                  <!-- Placeholder Image with large plus icon -->
                  <div class="img-responsive img-responsive-21x9 card-img-top" 
                       style="background-color: #f1f5f9; position: relative;">
                    <i class="ti ti-plus" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: #94a3b8;"></i>
                  </div>
                  <div class="card-body" style="background-color: #f1f5f9;">
                    <div class="mb-2">
                      <!-- Title placeholder - grey rectangle -->
                      <div style="background-color: #e2e8f0; height: 24px; width: 120px; border-radius: 4px;"></div>
                    </div>
                    <div class="d-flex gap-2 flex-wrap mb-3">
                      <!-- Invisible badges using exact same classes and text length to maintain height -->
                      <span class="badge bg-green-lt" style="visibility: hidden;">4 active</span>
                      <span class="badge bg-yellow-lt" style="visibility: hidden;">3 pending</span>
                    </div>
                    <!-- Button placeholder - grey rectangle positioned at bottom like real cards -->
                    <div style="background-color: #e2e8f0; height: 36px; width: 80px; border-radius: 6px;"></div>
                  </div>
                </div>
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Mobile Layout -->
        <div class="d-md-none">
          <div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;">
            {% for activity in activities %}
            <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
              <div class="card" style="border-radius: 12px; overflow: hidden;">
                <!-- Activity Image -->
                {% if activity.image_filename %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background-image: url('{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}');">
                </div>
                {% else %}
                <div class="img-responsive img-responsive-21x9 card-img-top" 
                     style="background: linear-gradient(45deg, #e3f2fd 0%, #2196f3 100%); display: flex; align-items: center; justify-content: center;">
                  <i class="ti ti-calendar-event" style="font-size: 3rem; color: #1976d2; opacity: 0.8;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                  <div class="mb-2">
                    <h3 class="card-title mb-0">{{ activity.name }}</h3>
                  </div>
                  <div class="d-flex gap-2 flex-wrap mb-3">
                    <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                    <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                  </div>
                  <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-secondary">Manage</a>
                </div>
              </div>
            </div>
            {% endfor %}
            <!-- Mobile placeholder - always shown as last card -->
            <div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;">
              <a href="{{ url_for('create_activity') }}" style="text-decoration: none;">
                <div class="card" style="border-radius: 12px; overflow: hidden; background-color: #f1f5f9; border: 1px dashed #d1d5db; cursor: pointer;">
                  <!-- Placeholder Image with large plus icon -->
                  <div class="img-responsive img-responsive-21x9 card-img-top" 
                       style="background-color: #f1f5f9; position: relative;">
                    <i class="ti ti-plus" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: #94a3b8;"></i>
                  </div>
                  <div class="card-body" style="background-color: #f1f5f9;">
                    <div class="mb-2">
                      <!-- Using actual h3 element with same class for exact height matching -->
                      <h3 class="card-title mb-0" style="background-color: #e2e8f0; height: 28px; width: 120px; border-radius: 4px;"></h3>
                    </div>
                    <div class="d-flex gap-2 flex-wrap mb-3">
                      <!-- Invisible badges using exact same classes and text length to maintain height -->
                      <span class="badge bg-green-lt" style="visibility: hidden;">4 active</span>
                      <span class="badge bg-yellow-lt" style="visibility: hidden;">3 pending</span>
                    </div>
                    <!-- Using actual button element with same class for exact height matching -->
                    <a class="btn btn-secondary" style="background-color: #e2e8f0; border: none; color: transparent; pointer-events: none;">Manage</a>
                  </div>
                </div>
              </a>
            </div>
          </div>
          <!-- Scroll indicators for activities -->
          <div class="text-center mt-2">
            {% set activity_count = activities|length + 1 %} <!-- +1 for placeholder card -->
            {% set max_indicators = 4 if activity_count > 4 else activity_count %}
            {% for i in range(max_indicators) %}
              <span class="badge {% if i == 0 %}bg-primary{% else %}bg-light{% endif %} me-1" 
                    style="width: 8px; height: 8px; border-radius: 50%;"></span>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Activity Log Section -->
      <div class="activity-log-section mb-5">
        <div class="row mb-3">
          <div class="col">
            <h2 class="section-title mb-0"><i class="ti ti-file-description text-blue me-2"></i>Recent system events</h2>

  
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header border-0 pb-0">
                
              </div>
            <div class="table-responsive">
              <table class="table card-table table-vcenter" id="logTable">
                <thead>
                  <tr>
                    <th scope="col" class="text-muted">Date/Time</th>
                    <th scope="col" class="text-muted">Type</th>
                    <th scope="col" class="text-muted">Description</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Table content will be populated by JavaScript pagination -->
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer d-flex align-items-center">
              <p class="m-0 text-muted">Showing <span id="showingCount">0</span> of {{ logs[:10]|length }}</p>
              <ul class="pagination m-0 ms-auto" id="paginationControls">
                <!-- Pagination controls will be populated by JavaScript -->
              </ul>
            </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Dashboard Container Improvements */
.page-wrapper {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  min-height: 100vh;
}

.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

/* Enhanced Card Design */
.card {
  background: rgba(255, 255, 255, 0.95) !important;
  border: none !important;
  border-radius: 16px !important;
  box-shadow: 
    0 1px 3px rgba(0, 0, 0, 0.05),
    0 4px 16px rgba(0, 0, 0, 0.04),
    0 0 0 1px rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.table {
  background-color: #fff !important;
}

/* Mobile scroll snap styles */
.d-flex.overflow-auto {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.d-flex.overflow-auto::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

/* Enhanced Hover Effects */
.card:hover {
  box-shadow: 
    0 4px 16px rgba(0, 0, 0, 0.08),
    0 8px 32px rgba(0, 0, 0, 0.06),
    0 0 0 1px rgba(255, 255, 255, 0.9);
  transform: translateY(-2px) scale(1.01);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* KPI Card Enhancements */
.card .card-body {
  padding: 1.75rem 1.5rem;
  position: relative;
}

.card .text-uppercase {
  font-weight: 600;
  letter-spacing: 0.5px;
  font-size: 0.75rem;
  color: #64748b;
}

.card .h2 {
  font-weight: 700;
  font-size: 2rem;
  line-height: 1.2;
  color: #0f172a;
  margin-bottom: 0.75rem;
}

/* Trend Indicators */
.text-success {
  color: #059669 !important;
  font-weight: 600;
}

.text-danger {
  color: #dc2626 !important;
  font-weight: 600;
}

.text-muted {
  color: #64748b !important;
}

/* Page Header Styling */
.page-header {
  background: transparent;
  border: none;
  margin-bottom: 3rem;
}

.page-title {
  font-weight: 700;
  color: #0f172a;
  font-size: 2.25rem;
  line-height: 1.2;
  margin-bottom: 0.5rem;
}

.page-header .text-muted {
  color: #64748b !important;
  font-size: 1.1rem;
  line-height: 1.5;
}

/* Section Styling */
.section-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 1.5rem;
  line-height: 1.3;
}

.section-title-large {
  font-weight: 700;
  color: #0f172a;
  font-size: 1.75rem; /* 28px - Larger for primary sections */
  line-height: 1.25;
  margin-bottom: 0.75rem;
}

.section-subtitle {
  font-size: 0.95rem;
  color: #64748b;
  line-height: 1.4;
}

/* Section Spacing Hierarchy */
.kpi-section {
  margin-bottom: 5rem; /* 80px - Large separation after KPI cards */
}

.activities-section {
  margin-bottom: 4rem; /* 64px - Standard section spacing */
  padding-top: 1rem; /* 16px - Additional breathing room */
}

.activity-log-section {
  margin-bottom: 3rem; /* 48px - Standard bottom spacing */
}

/* Card Header Improvements */
.card-header {
  background: transparent;
  border-bottom: 1px solid #f1f5f9;
  padding: 1.5rem 1.5rem 1rem;
}

.card-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 1.125rem;
  margin-bottom: 0;
}

/* Activity Cards Enhancement */
.card .card-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 1.1rem;
}

.badge {
  font-weight: 500;
  font-size: 0.75rem;
  padding: 0.375rem 0.75rem;
  border-radius: 8px;
}

.badge.bg-green-lt {
  background-color: #dcfce7 !important;
  color: #166534 !important;
}

.badge.bg-yellow-lt {
  background-color: #fef3c7 !important;
  color: #92400e !important;
}

.badge.bg-blue-lt {
  background-color: #dbeafe !important;
  color: #1e40af !important;
}

/* Button Improvements */
.btn-secondary {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  border: none;
  color: white;
  font-weight: 500;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  transition: all 0.2s ease;
}

.btn-secondary:hover {
  background: linear-gradient(135deg, #475569 0%, #334155 100%);
  transform: translateY(-1px);
  color: white;
}

.btn-primary {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border: none;
  font-weight: 500;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  transition: all 0.2s ease;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-1px);
}

/* Green Success Button Styling */
.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border: none;
  font-weight: 500;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  transition: all 0.2s ease;
  color: white;
}

.btn-success:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-1px);
  color: white;
}

/* Tabler.io Placeholder Component */
.placeholder {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
}

.placeholder-image {
  background-color: #e9ecef;
  width: 100%;
  height: 100%;
}

/* Activity Log Table Styling */
.table {
  background-color: transparent !important;
}

.table th {
  border-bottom: 2px solid #e2e8f0;
  font-weight: 600;
  color: #475569;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1rem;
}

.table td {
  border-bottom: 1px solid #f1f5f9;
  padding: 1rem;
  color: #334155;
  vertical-align: middle;
}

/* Custom Spacing Utilities */
.mb-6 {
  margin-bottom: 4rem !important; /* 64px - Mobile spacing */
}

.mb-7 {
  margin-bottom: 5rem !important; /* 80px - Desktop spacing */
}

.pt-3 {
  padding-top: 1rem !important; /* 16px - Activities section breathing room */
}

.pt-5 {
  padding-top: 3rem !important; /* 48px */
}

/* Placeholder Card Styling - Minimal design */
.placeholder-card {
  position: relative;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.placeholder-card:hover {
  transform: translateY(-2px);
}

/* Mobile scroll indicators */
@media (max-width: 767.98px) {
  .flex-shrink-0 {
    scroll-snap-align: start;
  }
  
  .dashboard-container {
    padding: 0 1rem;
  }
  
  .page-title {
    font-size: 1.75rem;
  }
  
  /* Adjust spacing for mobile */
  .kpi-section {
    margin-bottom: 4rem !important; /* 64px - Override responsive utility */
  }
  
  .activities-section {
    padding-top: 0.75rem; /* 12px - Slightly more breathing room on mobile */
  }
  
  .section-title-large {
    font-size: 1.75rem !important; /* 28px - Larger on mobile for better hierarchy */
    font-weight: 700 !important;
  }
}

/* Pagination Enhancements */
.pagination .page-link {
  border: none;
  color: #6c757d;
  padding: 0.5rem 0.75rem;
  margin: 0 0.125rem;
  border-radius: 0.375rem;
  transition: all 0.2s ease;
}

.pagination .page-link:hover {
  color: #0d6efd;
  background-color: #f8f9fa;
  transform: translateY(-1px);
}

.pagination .page-item.active .page-link {
  background-color: #0d6efd;
  border-color: #0d6efd;
  color: white;
  box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.pagination .page-item.disabled .page-link {
  color: #adb5bd;
  background-color: transparent;
  cursor: not-allowed;
}

/* Table Loading State */
.table tbody tr td {
  transition: all 0.3s ease;
}

.table tbody tr:hover {
  background-color: rgba(13, 110, 253, 0.04);
}

/* Pagination Info Text */
.card-footer p {
  font-size: 0.875rem;
  font-weight: 500;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Store KPI data from backend
const kpiData = {{ kpi_data | tojson | safe }};

// Store logs data for pagination
const allLogs = {{ logs | tojson | safe }};
let currentPeriod = '7d';

// Function to generate interactive line chart with hover points
function generateInteractiveLineChart(data, width = 300, height = 40, chartId = '') {
  if (!data || data.length === 0) return { path: '', points: [] };
  
  // Find min and max for scaling
  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;
  
  // Generate path coordinates and hover points
  const coordinates = [];
  const hoverPoints = [];
  
  data.forEach((value, index) => {
    const x = (index / (data.length - 1)) * width;
    const y = height - ((value - min) / range) * (height - 10) - 5;
    
    coordinates.push(`${index === 0 ? 'M' : 'L'} ${x},${y}`);
    hoverPoints.push({ x, y, value, index });
  });
  
  return {
    path: coordinates.join(' '),
    points: hoverPoints
  };
}

// Legacy function for backward compatibility
function generateLineChart(data, width = 300, height = 40) {
  const result = generateInteractiveLineChart(data, width, height);
  return result.path;
}

// Tooltip management functions
function createTooltip() {
  let tooltip = document.getElementById('chart-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'chart-tooltip';
    tooltip.className = 'chart-tooltip';
    tooltip.style.cssText = `
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      white-space: nowrap;
    `;
    document.body.appendChild(tooltip);
  }
  return tooltip;
}

function showTooltip(x, y, value, period, index) {
  const tooltip = createTooltip();
  const formattedValue = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value);
  
  // Calculate the date based on period and index
  const daysAgo = parseInt(period) - index - 1;
  const date = new Date();
  date.setDate(date.getDate() - daysAgo);
  const formattedDate = date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric'
  });
  
  tooltip.innerHTML = `${formattedValue}<br><small>${formattedDate}</small>`;
  tooltip.style.left = `${x}px`;
  tooltip.style.top = `${y - 10}px`;
  tooltip.style.opacity = '1';
}

function hideTooltip() {
  const tooltip = document.getElementById('chart-tooltip');
  if (tooltip) {
    tooltip.style.opacity = '0';
  }
}

// Function to generate bar chart SVG rectangles
function generateBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  const max = Math.max(...data) || 1;
  const barWidth = (width - (data.length - 1) * 2) / data.length;
  
  let svg = '';
  data.forEach((value, index) => {
    const barHeight = (value / max) * (height - 5);
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#206bc4" opacity="0.8" />`;
  });
  
  return svg;
}

// Update all charts with real data with smooth animations
function updateCharts(period = '7d') {
  const periodData = kpiData[period];
  if (!periodData) return;
  
  // Add fade-out animation to existing charts
  const allCharts = document.querySelectorAll('.card svg');
  allCharts.forEach(chart => {
    chart.style.transition = 'opacity 0.3s ease';
    chart.style.opacity = '0.3';
  });
  
  // Delay the chart update for smooth transition
  setTimeout(() => {
  
  // Update Revenue Line Chart (both desktop and mobile) with interactive tooltips
  const revenueChartData = generateInteractiveLineChart(periodData.revenue_trend, 300, 40, 'revenue');
  const revenueCharts = ['#revenue-chart', '#mobile-revenue-chart'];
  revenueCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && revenueChartData.path) {
      // Create SVG with path and invisible hover zones
      chart.innerHTML = `
        <path d="${revenueChartData.path}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        ${revenueChartData.points.map((point, index) => 
          `<circle cx="${point.x}" cy="${point.y}" r="6" fill="transparent" 
                   data-value="${point.value}" data-index="${index}" 
                   class="chart-hover-point" style="cursor: pointer;" />`
        ).join('')}
      `;
      
      // Add hover event listeners for revenue tooltips
      chart.querySelectorAll('.chart-hover-point').forEach(point => {
        point.addEventListener('mouseenter', function(e) {
          const rect = chart.getBoundingClientRect();
          const value = parseFloat(this.getAttribute('data-value'));
          const index = parseInt(this.getAttribute('data-index'));
          showTooltip(
            rect.left + parseFloat(this.getAttribute('cx')) + window.scrollX,
            rect.top + parseFloat(this.getAttribute('cy')) + window.scrollY - 50,
            value, 
            period, 
            index
          );
        });
        
        point.addEventListener('mouseleave', hideTooltip);
      });
    }
  });
  
  // Update Active Passports Bar Chart (both desktop and mobile)
  const activePassportsBars = generateBarChart(periodData.active_users_trend);
  const activePassportsCharts = ['#active-passports-chart', '#mobile-active-passports-chart'];
  activePassportsCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && periodData.active_users_trend) {
      chart.innerHTML = activePassportsBars;
    }
  });
  
  // Update Passports Created Line Chart (both desktop and mobile)
  const passportsCreatedPath = generateLineChart(periodData.pass_created_trend);
  const passportsCreatedCharts = ['#passports-created-chart', '#mobile-passports-created-chart'];
  passportsCreatedCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && passportsCreatedPath) {
      chart.innerHTML = `<path d="${passportsCreatedPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
    }
  });
  
  // Update Pending Signups Bar Chart (both desktop and mobile)
  const pendingSignupsBars = generateBarChart(periodData.pending_signups_trend);
  const pendingSignupsCharts = ['#pending-signups-chart', '#mobile-pending-signups-chart'];
  pendingSignupsCharts.forEach(selector => {
    const chart = document.querySelector(selector);
    if (chart && periodData.pending_signups_trend) {
      chart.innerHTML = pendingSignupsBars;
    }
  });
  
  // Update KPI values and performance indicators
  updateKpiValues(period, periodData);
  
  // Add fade-in animation to updated charts
  setTimeout(() => {
    const allCharts = document.querySelectorAll('.card svg');
    allCharts.forEach(chart => {
      chart.style.opacity = '1';
    });
  }, 50);
  
  }, 150); // End of main setTimeout for smooth transition
}

// Function to update KPI values and performance indicators
function updateKpiValues(period, periodData) {
  // Update Revenue KPI value
  const revenueValueEl = document.getElementById('revenue-value');
  const mobileRevenueValueEl = document.getElementById('mobile-revenue-value');
  
  if (periodData.revenue !== undefined) {
    const revenueValue = `$${Math.round(periodData.revenue).toLocaleString()}`;
    if (revenueValueEl) revenueValueEl.textContent = revenueValue;
    if (mobileRevenueValueEl) mobileRevenueValueEl.textContent = revenueValue;
  }
  
  // Update Revenue trend percentage
  const revenueTrendEl = document.getElementById('revenue-trend');
  const mobileRevenueTrendEl = document.getElementById('mobile-revenue-trend');
  
  if (periodData.revenue_change !== undefined) {
    const change = periodData.revenue_change;
    let trendClass = 'text-muted';
    let icon = 'ti-minus';
    
    if (change > 0) {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (change < 0) {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    }
    
    const trendHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    const trendClass2 = `${trendClass} me-2`;
    
    if (revenueTrendEl) {
      revenueTrendEl.className = trendClass2;
      revenueTrendEl.innerHTML = trendHTML;
    }
    if (mobileRevenueTrendEl) {
      mobileRevenueTrendEl.className = trendClass2;
      mobileRevenueTrendEl.innerHTML = trendHTML;
    }
  }
}

// Handle period dropdown clicks with smooth transitions for DASHBOARD (not activity dashboard)
// WARNING: Do NOT call updateCharts() here - it updates ALL cards globally!
// Each dropdown must only update its own specific KPI card
function attachDropdownHandlers() {
  // Find all dropdown items in KPI cards
  document.querySelectorAll('.kpi-period-btn').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Prevent multiple rapid clicks
      if (this.classList.contains('loading')) return;
      this.classList.add('loading');
      
      // Get period from data attribute
      const period = this.getAttribute('data-period');
      const text = this.textContent.trim();
      
      // Find the specific KPI card this dropdown belongs to
      const cardElement = this.closest('.card');
      const kpiType = determineKPIType(cardElement);
      
      // Update button text with loading state
      const button = this.closest('.dropdown').querySelector('.dropdown-toggle');
      if (button) {
        button.style.opacity = '0.7';
        button.textContent = text + ' ...';
      }
      
      // Update ONLY this specific KPI card using existing kpiData
      updateDashboardKPICard(period, kpiType, cardElement);
      
      // Reset loading state and button text
      setTimeout(() => {
        this.classList.remove('loading');
        if (button) {
          button.style.opacity = '1';
          button.textContent = text;
        }
      }, 300);
    });
  });
}


function showKPILoadingForCard(cardElement) {
  // Show loading for specific card only
  const valueEl = cardElement.querySelector('.h2');
  // Use more specific selector to avoid matching title elements
  const trendEl = cardElement.querySelector('.d-flex .text-success, .d-flex .text-danger, .d-flex .text-muted');
  const chartEl = cardElement.querySelector('svg');
  
  if (valueEl) valueEl.style.opacity = '0.6';
  if (trendEl) trendEl.style.opacity = '0.6';
  if (chartEl) chartEl.style.opacity = '0.3';
}

function showKPILoading() {
  // Show loading for all KPI cards
  document.querySelectorAll('.card .h2').forEach(el => {
    el.style.opacity = '0.5';
  });
  document.querySelectorAll('.card .text-success, .card .text-danger, .card .text-muted').forEach(el => {
    if (el.closest('.card')) {
      el.style.opacity = '0.5';
    }
  });
}

function hideKPILoadingForCard(cardElement) {
  // Hide loading for specific card only
  const valueEl = cardElement.querySelector('.h2');
  // Use more specific selector to avoid matching title elements
  const trendEl = cardElement.querySelector('.d-flex .text-success, .d-flex .text-danger, .d-flex .text-muted');
  const chartEl = cardElement.querySelector('svg');
  
  if (valueEl) valueEl.style.opacity = '1';
  if (trendEl) trendEl.style.opacity = '1';
  if (chartEl) chartEl.style.opacity = '1';
}

function hideKPILoading() {
  // Hide loading for all KPI cards
  document.querySelectorAll('.card .h2').forEach(el => {
    el.style.opacity = '1';
  });
  document.querySelectorAll('.card .text-success, .card .text-danger, .card .text-muted').forEach(el => {
    if (el.closest('.card')) {
      el.style.opacity = '1';
    }
  });
}

// CRITICAL: This function ensures individual card updates without cross-contamination
// It identifies which specific KPI card was clicked to enable targeted updates
function determineKPIType(cardElement) {
  // Determine KPI type based on card content
  const cardText = cardElement.textContent.toLowerCase();
  if (cardText.includes('revenue')) return 'revenue';
  if (cardText.includes('active passports')) return 'active_passports';
  if (cardText.includes('passports created')) return 'passports_created';
  if (cardText.includes('pending sign ups')) return 'pending_signups';
  return 'revenue'; // fallback
}

// Update single KPI card for DASHBOARD using existing kpiData (no API calls)
function updateDashboardKPICard(period, kpiType, cardElement) {
  console.log(`Updating dashboard KPI card: ${kpiType} for period: ${period}`);
  
  // Show loading state for this card only
  showKPILoadingForCard(cardElement);
  
  // Use existing KPI data from template
  const periodData = kpiData[period];
  if (periodData) {
    console.log(`Found data for ${period}:`, periodData);
    // Update the specific KPI card with existing data
    updateSingleKPIValues(kpiType, cardElement, period, periodData);
    updateSingleKPIChart(kpiType, cardElement, period, periodData);
  } else {
    console.warn(`No data available for period: ${period}`);
    console.log('Available periods in kpiData:', Object.keys(kpiData));
  }
  
  // Hide loading state
  setTimeout(() => {
    hideKPILoadingForCard(cardElement);
  }, 200);
}

// WARNING: Must use specific ID selectors for revenue cards (#revenue-trend, #mobile-revenue-trend)
// Using broad selectors like '.text-muted' will overwrite title elements!
function updateSingleKPIValues(kpiType, cardElement, period, periodData) {
  // Update value and trend for the specific card only
  const valueEl = cardElement.querySelector('.h2');
  // Use specific ID selectors for trend elements to avoid matching title elements
  let trendEl = null;
  if (kpiType === 'revenue') {
    trendEl = cardElement.querySelector('#revenue-trend, #mobile-revenue-trend');
  } else {
    // For other KPI types, find the trend element by looking for elements with specific IDs
    // or fall back to more specific selector that excludes the title
    trendEl = cardElement.querySelector('.d-flex .text-success, .d-flex .text-danger, .d-flex .text-muted');
  }
  
  if (kpiType === 'revenue' && periodData.revenue !== undefined) {
    const revenueValue = `$${Math.round(periodData.revenue).toLocaleString()}`;
    if (valueEl) valueEl.textContent = revenueValue;
    
    if (trendEl && periodData.revenue_change !== undefined) {
      const change = periodData.revenue_change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  } else if (kpiType === 'active_passports' && periodData.active_passports !== undefined) {
    if (valueEl) valueEl.textContent = Math.round(periodData.active_passports);
    
    if (trendEl && periodData.passport_change !== undefined) {
      const change = periodData.passport_change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  } else if (kpiType === 'passports_created' && periodData.new_passports !== undefined) {
    if (valueEl) valueEl.textContent = Math.round(periodData.new_passports);
    
    if (trendEl && periodData.new_passports_change !== undefined) {
      const change = periodData.new_passports_change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  } else if (kpiType === 'pending_signups' && periodData.pending_signups !== undefined) {
    if (valueEl) valueEl.textContent = Math.round(periodData.pending_signups);
    
    if (trendEl && periodData.signup_change !== undefined) {
      const change = periodData.signup_change;
      let trendClass = 'text-muted';
      let icon = 'ti-minus';
      
      if (change > 0) {
        trendClass = 'text-success';
        icon = 'ti-trending-up';
      } else if (change < 0) {
        trendClass = 'text-danger';
        icon = 'ti-trending-down';
      }
      
      trendEl.className = `${trendClass} me-2`;
      trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
    }
  }
}

function updateSingleKPIChart(kpiType, cardElement, period, periodData) {
  // Update chart for the specific card only
  const chartEl = cardElement.querySelector('svg');
  if (!chartEl || !periodData) return;
  
  if (kpiType === 'revenue' && periodData.revenue_trend) {
    const revenueChartData = generateInteractiveLineChart(periodData.revenue_trend, 300, 40, 'revenue');
    if (revenueChartData.path) {
      chartEl.innerHTML = `
        <path d="${revenueChartData.path}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        ${revenueChartData.points.map((point, index) => 
          `<circle cx="${point.x}" cy="${point.y}" r="6" fill="transparent" 
                   data-value="${point.value}" data-index="${index}" 
                   class="chart-hover-point" style="cursor: pointer;" />`
        ).join('')}
      `;
      
      // Add hover event listeners for revenue tooltips
      chartEl.querySelectorAll('.chart-hover-point').forEach(point => {
        point.addEventListener('mouseenter', function(e) {
          const rect = chartEl.getBoundingClientRect();
          const value = parseFloat(this.getAttribute('data-value'));
          const index = parseInt(this.getAttribute('data-index'));
          showTooltip(
            rect.left + parseFloat(this.getAttribute('cx')) + window.scrollX,
            rect.top + parseFloat(this.getAttribute('cy')) + window.scrollY - 50,
            value, 
            period, 
            index
          );
        });
        
        point.addEventListener('mouseleave', hideTooltip);
      });
    }
  } else if (kpiType === 'active_passports' && periodData.active_users_trend) {
    const activePassportsBars = generateBarChart(periodData.active_users_trend);
    chartEl.innerHTML = activePassportsBars;
  } else if (kpiType === 'passports_created' && periodData.pass_created_trend) {
    const passportsCreatedPath = generateLineChart(periodData.pass_created_trend);
    chartEl.innerHTML = `<path d="${passportsCreatedPath}" fill="none" stroke="#206bc4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;
  } else if (kpiType === 'pending_signups' && periodData.pending_signups_trend) {
    const pendingSignupsBars = generateBarChart(periodData.pending_signups_trend);
    chartEl.innerHTML = pendingSignupsBars;
  }
}

function updateMainDashboardKPIs(period) {
  // First, try to use existing KPI data for immediate feedback
  const existingData = kpiData[period];
  if (existingData) {
    updateKPIValues(period, existingData);
  }
  
  // Then fetch fresh data from the API
  fetch(`/api/global-kpis?period=${period}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateKPIDisplays(data.kpi_data, period);
        updateCharts(period);
      } else {
        console.error('Failed to fetch KPI data:', data.error);
        // Fall back to existing data if API fails
        if (existingData) {
          updateKPIValues(period, existingData);
          updateCharts(period);
        }
      }
      hideKPILoading();
    })
    .catch(error => {
      console.error('Error fetching KPI data:', error);
      // Fall back to existing data if API fails
      if (existingData) {
        updateKPIValues(period, existingData);
        updateCharts(period);
      }
      hideKPILoading();
    });
}

function updateKPIDisplays(kpiData, period) {
  // Update Revenue - pass the full period data which contains revenue and revenue_change
  updateKPICard('revenue', kpiData);
  updateKPICard('mobile-revenue', kpiData);
  
  // Update Active Passports (we don't have exact counts in API, so skip for now)
  // updateKPICard('active-passports', kpiData.active_passports);
  
  // Update Passports Created (we don't have exact counts in API, so skip for now)
  // updateKPICard('passports-created', kpiData.passports_created);
  
  // Update Pending Signups (we don't have exact counts in API, so skip for now)
  // updateKPICard('pending-signups', kpiData.pending_signups);
}

function updateKPICard(prefix, data) {
  // Update value
  const valueEl = document.getElementById(`${prefix}-value`);
  if (valueEl && data) {
    if (prefix.includes('revenue')) {
      valueEl.textContent = `$${Math.round(data.revenue || 0).toLocaleString()}`;
    } else {
      valueEl.textContent = Math.round(data.total || 0);
    }
  }
  
  // Update trend
  const trendEl = document.getElementById(`${prefix}-trend`);
  if (trendEl && data) {
    // Use revenue_change for revenue cards, change for others
    const change = prefix.includes('revenue') ? (data.revenue_change || 0) : (data.change || 0);
    let trendClass = 'text-muted';
    let icon = 'ti-minus';
    
    if (change > 0) {
      trendClass = 'text-success';
      icon = 'ti-trending-up';
    } else if (change < 0) {
      trendClass = 'text-danger';
      icon = 'ti-trending-down';
    }
    
    trendEl.className = `${trendClass} me-2`;
    trendEl.innerHTML = `${Math.round(Math.abs(change))}% <i class="ti ${icon}"></i>`;
  }
}

// Pagination functionality for logs table
class LogsPagination {
  constructor(logs, itemsPerPage = 10) {
    this.logs = logs;
    this.itemsPerPage = itemsPerPage;
    this.currentPage = 1;
    this.totalPages = Math.ceil(logs.length / itemsPerPage);
    this.tableBody = document.querySelector('#logTable tbody');
    this.paginationControls = document.getElementById('paginationControls');
    this.showingCount = document.getElementById('showingCount');
  }

  getPageData(pageNumber) {
    const startIndex = (pageNumber - 1) * this.itemsPerPage;
    const endIndex = startIndex + this.itemsPerPage;
    return this.logs.slice(startIndex, endIndex);
  }

  renderTable(pageNumber) {
    const pageData = this.getPageData(pageNumber);
    const tbody = this.tableBody;
    
    tbody.innerHTML = '';
    
    pageData.forEach(log => {
      const row = document.createElement('tr');
      
      // Format timestamp - handle both ISO string and object formats
      let formattedDate = 'Invalid Date';
      try {
        let timestamp;
        if (typeof log.timestamp === 'string') {
          timestamp = new Date(log.timestamp);
        } else {
          // If it's already a Date object or timestamp object
          timestamp = new Date(log.timestamp);
        }
        
        // Check if date is valid
        if (!isNaN(timestamp.getTime())) {
          // Format date to match the original format (YYYY-MM-DD HH:MM)
          const year = timestamp.getFullYear();
          const month = String(timestamp.getMonth() + 1).padStart(2, '0');
          const day = String(timestamp.getDate()).padStart(2, '0');
          const hours = String(timestamp.getHours()).padStart(2, '0');
          const minutes = String(timestamp.getMinutes()).padStart(2, '0');
          formattedDate = `${year}-${month}-${day} ${hours}:${minutes}`;
        }
      } catch (e) {
        console.warn('Error formatting date for log:', log, e);
        formattedDate = 'Invalid Date';
      }
      
      // Get icon based on log type
      const iconMap = {
        'Passport Redeemed': '<i class="ti ti-ticket text-danger"></i>',
        'Email Sent': '<i class="ti ti-mail text-info"></i>',
        'Passport Created': '<i class="ti ti-id text-lime"></i>',
        'Interact Payment': '<i class="ti ti-currency-dollar text-success"></i>',
        'Marked Paid': '<i class="ti ti-check text-green"></i>',
        'Reminder Sent': '<i class="ti ti-bell text-purple"></i>',
        'Signup Submitted': '<i class="ti ti-user-plus text-success"></i>',
        'Signup Approved': '<i class="ti ti-user-check text-green"></i>',
        'Signup Rejected': '<i class="ti ti-user-x text-danger"></i>',
        'Signup Cancelled': '<i class="ti ti-user-x text-danger"></i>',
        'Activity Created': '<i class="ti ti-target text-orange"></i>',
        'Admin Action': '<i class="ti ti-settings text-muted"></i>'
      };
      
      const icon = iconMap[log.type] || '<i class="ti ti-activity text-muted"></i>';
      
      row.innerHTML = `
        <td>${formattedDate}</td>
        <td data-type="${log.type}">${icon} ${log.type}</td>
        <td>${log.details}</td>
      `;
      
      tbody.appendChild(row);
    });
    
    this.updateShowingText();
  }

  updateShowingText() {
    const start = (this.currentPage - 1) * this.itemsPerPage + 1;
    const end = Math.min(this.currentPage * this.itemsPerPage, this.logs.length);
    this.showingCount.textContent = `${start}-${end}`;
  }

  renderPagination() {
    const pagination = this.paginationControls;
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a href="#" class="page-link" data-page="${this.currentPage - 1}">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers logic
    const maxVisiblePages = 5;
    let startPage, endPage;
    
    if (this.totalPages <= maxVisiblePages) {
      startPage = 1;
      endPage = this.totalPages;
    } else {
      if (this.currentPage <= 3) {
        startPage = 1;
        endPage = maxVisiblePages;
      } else if (this.currentPage >= this.totalPages - 2) {
        startPage = this.totalPages - maxVisiblePages + 1;
        endPage = this.totalPages;
      } else {
        startPage = this.currentPage - 2;
        endPage = this.currentPage + 2;
      }
    }
    
    // First page + ellipsis if needed
    if (startPage > 1) {
      const firstLi = document.createElement('li');
      firstLi.className = 'page-item';
      firstLi.innerHTML = '<a href="#" class="page-link" data-page="1">1</a>';
      pagination.appendChild(firstLi);
      
      if (startPage > 2) {
        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = '<a href="#" class="page-link">...</a>';
        pagination.appendChild(ellipsisLi);
      }
    }
    
    // Main page numbers
    for (let i = startPage; i <= endPage; i++) {
      const li = document.createElement('li');
      li.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
      li.innerHTML = `<a href="#" class="page-link" data-page="${i}">${i}</a>`;
      pagination.appendChild(li);
    }
    
    // Last page + ellipsis if needed
    if (endPage < this.totalPages) {
      if (endPage < this.totalPages - 1) {
        const ellipsisLi = document.createElement('li');
        ellipsisLi.className = 'page-item disabled';
        ellipsisLi.innerHTML = '<a href="#" class="page-link">...</a>';
        pagination.appendChild(ellipsisLi);
      }
      
      const lastLi = document.createElement('li');
      lastLi.className = 'page-item';
      lastLi.innerHTML = `<a href="#" class="page-link" data-page="${this.totalPages}">${this.totalPages}</a>`;
      pagination.appendChild(lastLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${this.currentPage === this.totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a href="#" class="page-link" data-page="${this.currentPage + 1}">Next</a>`;
    pagination.appendChild(nextLi);
    
    // Add click event listeners
    pagination.addEventListener('click', (e) => {
      e.preventDefault();
      if (e.target.classList.contains('page-link') && !e.target.parentElement.classList.contains('disabled')) {
        const page = parseInt(e.target.dataset.page);
        if (page && page !== this.currentPage) {
          this.goToPage(page);
        }
      }
    });
  }

  goToPage(pageNumber) {
    if (pageNumber >= 1 && pageNumber <= this.totalPages) {
      this.currentPage = pageNumber;
      this.renderTable(pageNumber);
      this.renderPagination();
    }
  }

  init() {
    // Add loading state
    this.tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border spinner-border-sm text-muted me-2" role="status"></div>Loading events...</td></tr>';
    
    // Small delay to show loading state, then render content
    setTimeout(() => {
      this.renderTable(1);
      this.renderPagination();
    }, 100);
  }
}

// Initialize pagination instance
let logsPagination;

// Initialize charts and pagination on page load
document.addEventListener('DOMContentLoaded', function() {
  updateCharts('7d');
  attachDropdownHandlers();
  
  // Initialize logs pagination
  if (allLogs && allLogs.length > 0) {
    logsPagination = new LogsPagination(allLogs, 10);
    logsPagination.init();
  } else {
    // Handle case where there are no logs
    const tbody = document.querySelector('#logTable tbody');
    const showingCount = document.getElementById('showingCount');
    const paginationControls = document.getElementById('paginationControls');
    
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">No system events found</td></tr>';
    }
    if (showingCount) {
      showingCount.textContent = '0';
    }
    if (paginationControls) {
      paginationControls.innerHTML = '';
    }
  }
});
</script>
{% endblock %}