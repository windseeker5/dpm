{% extends "base.html" %}
{% block title %}Income Ledger - {{ activity.name }}{% endblock %}

{% block content %}
<div class="container-xl mt-4">
  <div class="row justify-content-center">
    <!-- Income Management -->
    <div class="col-12 col-lg-10">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="ti ti-cash me-2"></i>
            {{ "Edit Income" if income else "Add Income" }}
          </h3>
        </div>
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="mb-3">
              <label class="form-label">Category</label>
              <select name="category" class="form-select" required>
                {% for cat in categories %}
                  <option value="{{ cat }}" {% if income and income.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Amount ($)</label>
              <input type="number" name="amount" step="0.01" min="0" class="form-control"
                     value="{{ income.amount if income else '' }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Date</label>
              {% set income_display_date = (income.date|utc_to_local) if income else now() %}
              <input type="date" name="date" class="form-control"
                     value="{{ income_display_date.strftime('%Y-%m-%d') if income_display_date else now().strftime('%Y-%m-%d') }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Note (optional)</label>
              <textarea name="note" class="form-control" rows="2">{{ income.note if income else '' }}</textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success">
                <i class="ti ti-check me-1"></i> {{ "Update Income" if income else "Add Income" }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">
          <h3 class="card-title"><i class="ti ti-list-details me-2"></i> Income Ledger</h3>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter text-nowrap">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Note</th>
                <th>Receipt / Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for i in incomes %}
              <tr>
                {% set i_display_date = i.date|utc_to_local %}<td>{{ i_display_date.strftime('%Y-%m-%d') if i_display_date else '-' }}</td>
                <td>{{ i.category }}</td>
                <td>${{ "%.2f"|format(i.amount) }}</td>
                <td>{{ i.note or "-" }}</td>
                <td>
                  {% if i.receipt_filename %}
                    <a href="{{ url_for('static', filename='uploads/receipts/' + i.receipt_filename) }}"
                       target="_blank" title="View Receipt">
                      <i class="ti ti-file-search me-1"></i>
                    </a>
                  {% else %}
                    <span class="text-muted me-1">-</span>
                  {% endif %}

                  <a href="{{ url_for('activity_income', activity_id=activity.id, income_id=i.id) }}" class="text-primary" title="Edit">
                    <i class="ti ti-edit"></i>
                  </a>

                  <button type="button" class="text-danger btn btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#delete-income-modal-{{ i.id }}">
                    <i class="ti ti-trash"></i>
                  </button>

                  <!-- Delete Modal -->


<div class="modal modal-blur fade" id="delete-income-modal-{{ i.id }}" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-status bg-danger"></div>
      <div class="modal-header">
        <h5 class="modal-title text-danger"><i class="ti ti-trash me-2"></i> Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p class="text-muted mb-3">Are you sure you want to delete this income?</p>
      </div>
      <div class="modal-footer">
        <form method="POST" action="{{ url_for('delete_income', income_id=i.id) }}" class="w-100">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>










                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-muted text-center">No income recorded yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
