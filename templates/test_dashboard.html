{% extends "base.html" %}

{% block title %}Dashboard - Minipass{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="page-header d-print-none">
    <div class="dashboard-container">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h1 class="page-title mb-3 text-center text-md-start">
            {% if current_admin and current_admin.display_name %}
              Welcome back, {{ current_admin.display_name }}!
            {% else %}
              Welcome back!
            {% endif %}
          </h1>
          <p class="text-muted mb-0 text-center text-md-start">
            Here's what's happening with your activities today.
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="page-body">
    <div class="dashboard-container">
      
      <!-- Include ApexCharts -->
      <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
      
      
      <div class="row">
        <!-- Revenue Card (Line Chart) -->
        {{ revenue_card | safe }}
        
        <!-- Active Users Card (Bar Chart) -->  
        {{ active_users_card | safe }}
        
        <!-- Passports Created Card (Bar Chart) -->
        {{ passports_created_card | safe }}
        
        <!-- Passports Unpaid Card (Bar Chart) -->
        {{ passports_unpaid_card | safe }}
      </div>
      
      
      <!-- Activities Section -->
      <div class="activities-section mb-5 pt-3">
        <div class="row mb-4">
          <div class="col">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h2 class="section-title-large mb-1 d-flex align-items-center" style="font-size: 2rem; font-weight: 700;">
                  <i class="ti ti-activity-heartbeat text-danger me-3"></i>Your Active Activities 
                </h2>
              </div>
              <div>
                <a href="{{ url_for('create_activity') }}" class="btn btn-success d-none d-md-inline-block">
                  <i class="ti ti-plus"></i>
                  New Activity
                </a>
                <a href="{{ url_for('create_activity') }}" class="btn btn-success d-md-none btn-icon" aria-label="New Activity">
                  <i class="ti ti-plus"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Activities Grid -->
        <div class="row">
          {% for activity in activities %}
          <div class="col-md-3 mb-3">
            <div class="card" style="border-radius: 12px;">
              <div class="card-body">
                <h3 class="card-title">{{ activity.name }}</h3>
                <div class="d-flex gap-2 flex-wrap mb-3">
                  <span class="badge bg-green-lt">{{ activity.active_passports }} active</span>
                  <span class="badge bg-yellow-lt">{{ activity.pending_signups }} pending</span>
                </div>
                <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-primary">
                  Manage
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('Test dashboard loaded with new KPI cards');
  
  // Add period change functionality
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      
      const period = this.dataset.period;
      const cardId = this.dataset.card;
      
      console.log(`Changing period to ${period} for card ${cardId}`);
      
      // Update dropdown button text
      const button = document.querySelector(`[data-period-button="${cardId}"]`);
      const periodText = {
        '7d': 'Last 7 days',
        '30d': 'Last 30 days', 
        '90d': 'Last 90 days',
        'all': 'All time'
      };
      button.textContent = periodText[period];
      
      // Here we would normally make AJAX call to update the card data
      // For now just log the action
      console.log(`Would update ${cardId} card with ${period} data`);
    });
  });
});
</script>

{% endblock %}