{% extends "base.html" %}

{% block title %}Email Template Customization - {{ activity.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/email-template-customization.css') }}">
{% endblock %}

{% block content %}
<!-- Modern Activity Header -->
<div class="page-wrapper">
  <div class="page-body">
    <div class="dashboard-container">
      <!-- Activity Context Header -->
      <div class="activity-header-clean mb-4">
        <div class="header-split-layout">
          <!-- Left Content Section -->
          <div class="content-section">
            <!-- Activity Subtitle with Badge -->
            <div class="activity-subtitle-line">
              <span class="subtitle-text">EMAIL TEMPLATES</span>
              <span class="badge-active">
                Active
                <span class="pulse-dot"></span>
              </span>
            </div>

            <!-- Activity Title -->
            <h1 class="activity-title">{{ activity.name }}</h1>
            
            <!-- Description -->
            <p class="activity-description">
              Customize the content and appearance of automated emails sent to your users.
            </p>

            <!-- Action Buttons -->
            <div class="activity-actions-modern">
              <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-outline-primary">
                <i class="ti ti-arrow-left me-2"></i>
                Back to Activity
              </a>
            </div>
          </div>

          <!-- Right Image Section -->
          <div class="image-section">
            <!-- Activity Avatar -->
            <div class="activity-image-modern">
              {% if activity.image %}
                <img src="{{ url_for('uploaded_file', filename=activity.image) }}" alt="{{ activity.name }}">
              {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 bg-light rounded">
                  <span class="avatar avatar-xl" style="background-color: #206bc4; color: white; font-size: 2rem;">
                    {{ activity.name[0].upper() }}
                  </span>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Information Alert -->
      <div class="alert alert-info">
        <div class="d-flex">
          <i class="ti ti-info-circle alert-icon me-3"></i>
          <div>
            <h4 class="alert-title">How it works</h4>
            <div class="text-muted">
              Customize email templates for this activity. Any field left empty will use the system default. 
              Changes apply only to this activity.
            </div>
          </div>
        </div>
      </div>

      <!-- Email Template Form -->
      <form method="POST" action="{{ url_for('save_email_templates', activity_id=activity.id) }}" enctype="multipart/form-data" id="email-templates-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Template Accordion Sections -->
        <div class="accordion" id="templateAccordion">
          {% for template_key, template_name in template_types.items() %}
          {% set template_data = current_templates.get(template_key, {}) %}
          <div class="accordion-item">
            <!-- Accordion Header -->
            <h2 class="accordion-header" id="heading-{{ template_key }}">
              <button class="accordion-button{% if not loop.first %} collapsed{% endif %}" 
                      type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#collapse-{{ template_key }}" 
                      aria-expanded="{{ 'true' if loop.first else 'false' }}" 
                      aria-controls="collapse-{{ template_key }}">
                <i class="ti ti-mail me-2"></i>
                <strong>{{ template_name }}</strong>
                <small class="ms-2 text-muted">
                  {% if template_data.get('subject') %}
                    (Customized)
                  {% else %}
                    (Using default)
                  {% endif %}
                </small>
              </button>
            </h2>
            
            <!-- Accordion Content -->
            <div id="collapse-{{ template_key }}" 
                 class="accordion-collapse collapse{% if loop.first %} show{% endif %}" 
                 aria-labelledby="heading-{{ template_key }}" 
                 data-bs-parent="#templateAccordion">
              <div class="accordion-body">
                <div class="row">
                  <!-- Form Fields Column -->
                  <div class="col-lg-8">
                    <div class="mb-4">
                      <h5 class="text-muted mb-3">{{ template_name }} Settings</h5>
                                            
                      <!-- Email Subject -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_subject" class="form-label">Email Subject</label>
                        <input type="text" 
                               name="{{ template_key }}_subject" 
                               id="{{ template_key }}_subject"
                               class="form-control" 
                               value="{{ template_data.get('subject', '') }}"
                               placeholder="Leave empty to use system default">
                      </div>
                      
                      <!-- Email Title -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_title" class="form-label">Email Title</label>
                        <input type="text" 
                               name="{{ template_key }}_title" 
                               id="{{ template_key }}_title"
                               class="form-control" 
                               value="{{ template_data.get('title', '') }}"
                               placeholder="Main heading shown in the email">
                      </div>
                      
                      <!-- Introduction Text -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_intro_text" class="form-label">Introduction Text</label>
                        <textarea name="{{ template_key }}_intro_text" 
                                  id="{{ template_key }}_intro_text"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Opening message for the email">{{ template_data.get('intro_text', '') }}</textarea>
                      </div>
                                            
                      <!-- Hero Image (Activity-wide, not per template) -->
                      {% if loop.first %}
                      <div class="mb-3">
                        <label class="form-label">Hero Image (applies to all templates)</label>
                        <div class="d-flex align-items-center gap-3">
                          <div class="current-image-preview">
                            {% set hero_filename = activity.id|string + '_hero.png' %}
                            <img id="hero-preview" 
                                 src="{{ url_for('static', filename='uploads/' + hero_filename) }}?t={{ range(1, 999999) | random }}" 
                                 alt="Current hero image" 
                                 onerror="this.src='{{ url_for('static', filename='uploads/defaults/default_hero.png') }}';"
                                 style="width: 100px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; background: white;">
                          </div>
                          <div class="flex-fill">
                            <input type="file" 
                                   id="hero-upload"
                                   name="{{ template_key }}_hero_image" 
                                   class="form-control" 
                                   accept="image/*"
                                   onchange="previewImage(this, 'hero-preview')">
                            <small class="form-hint">Banner image shown at top of email (replaces ticket icon)</small>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Owner Card Logo (Activity-wide, not per template) -->
                      <div class="mb-3">
                        <label class="form-label">Owner Card Logo (applies to all templates)</label>
                        <div class="d-flex align-items-center gap-3">
                          <div class="current-logo-preview">
                            {% set owner_logo_filename = activity.id|string + '_owner_logo.png' %}
                            <img id="owner-preview"
                                 src="{{ url_for('static', filename='uploads/' + owner_logo_filename) }}?t={{ range(1, 999999) | random }}" 
                                 alt="Current owner logo" 
                                 onerror="this.src='{{ url_for('static', filename='uploads/flhgi.png') }}';"
                                 style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 6px; padding: 4px; background: white;">
                          </div>
                          <div class="flex-fill">
                            <input type="file" 
                                   id="owner-upload"
                                   name="{{ template_key }}_owner_logo" 
                                   class="form-control" 
                                   accept="image/*"
                                   onchange="previewImage(this, 'owner-preview')">
                            <small class="form-hint">Logo shown in organization card at bottom of email</small>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                                            
                      <!-- Conclusion Text -->
                      <div class="mb-3">
                        <label for="{{ template_key }}_conclusion_text" class="form-label">Conclusion Text</label>
                        <textarea name="{{ template_key }}_conclusion_text" 
                                  id="{{ template_key }}_conclusion_text"
                                  class="form-control tinymce" 
                                  rows="3"
                                  placeholder="Closing message for the email">{{ template_data.get('conclusion_text', '') }}</textarea>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Preview Column -->
                  <div class="col-lg-4">
                    <div class="sticky-top" style="top: 1rem;">
                      <h5 class="text-muted mb-3">
                        <i class="ti ti-eye me-1"></i>
                        Preview & Test
                      </h5>
                      <div class="card">
                        <div class="card-body">
                          <div class="d-grid gap-2">
                            <a href="{{ url_for('email_preview', activity_id=activity.id, template_type=template_key) }}" 
                               target="_blank" 
                               class="btn btn-outline-primary">
                              <i class="ti ti-eye me-1"></i>
                              Preview Template
                            </a>
                            <button type="button" class="btn btn-outline-secondary send-test-email" 
                                    data-activity-id="{{ activity.id }}" 
                                    data-template-type="{{ template_key }}">
                              <i class="ti ti-send me-1"></i>
                              Send Test Email
                            </button>
                          </div>
                          <hr class="my-3">
                          <div class="d-flex align-items-center">
                            <span class="text-muted me-2">
                              <i class="ti ti-info-circle"></i>
                              Template Status:
                            </span>
                            <span class="badge bg-primary">Customized</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        
        <!-- Save Button -->
        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="ti ti-device-floppy me-1"></i>
            Save All Templates
          </button>
          <a href="{{ url_for('activity_dashboard', activity_id=activity.id) }}" class="btn btn-ghost-secondary">
            <i class="ti ti-x me-1"></i>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Simple file preview function
function previewImage(input, previewId) {
    const file = input.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(previewId).src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}
</script>
{% endblock %}