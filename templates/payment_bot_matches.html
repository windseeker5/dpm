{% extends "base.html" %}
{% block title %}Inbox Payments{% endblock %}

{% block content %}
<!-- CSS Imports -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dropdown-fix.css') }}?v=4.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/search-component.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter-component.css') }}?v=1.0">

<div class="page-wrapper">
  <div class="page-body">
    <div class="dashboard-container">

      <!-- Page Title -->
      <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h2 class="mb-0">
          <i class="ti ti-mail-dollar me-2" style="color: #e03131;"></i>Inbox Payments
        </h2>
        <a href="/admin/unified-settings?test_payment_bot=1" class="btn btn-primary">
          Refresh
        </a>
      </div>

      <!-- Enhanced Dynamic Search -->
      <form method="GET" action="{{ url_for('payment_bot_matches') }}" class="mb-4" id="dynamicSearchForm">
        <div class="input-icon position-relative">
          <span class="input-icon-addon">
            <i class="ti ti-search fs-3"></i>
          </span>
          <input type="text"
                 name="q"
                 id="enhancedSearchInput"
                 class="form-control form-control-lg shadow-sm"
                 placeholder="Start typing to search"
                 value="{{ current_filters.q or '' }}"
                 style="padding-right: 100px; border-radius: 0.5rem;"
                 autocomplete="off"
                 data-bs-toggle="false">
          <div class="position-absolute end-0 top-50 translate-middle-y me-3 d-flex align-items-center gap-2">
            <small id="searchCharCounter" class="text-muted" style="font-size: 0.75rem; display: none;"></small>
            <kbd id="searchKbdHint" class="text-muted d-none d-md-inline">Ctrl</kbd>
            <kbd class="text-muted d-none d-md-inline">K</kbd>
            <button id="searchClearBtn" type="button" class="btn btn-link p-0 border-0" style="display: none; width: 24px; height: 24px;" aria-label="Clear search">
              <i class="ti ti-x" style="font-size: 18px; color: #6c757d;"></i>
            </button>
          </div>
        </div>
      </form>

      <!-- Main Table -->
      <div class="card main-table-card" style="margin-top: 1.5rem !important;">
        <div class="card-header">
          <div class="d-flex justify-content-center align-items-center w-100">
            <!-- Filter Buttons -->
            <div class="github-filter-group" role="group" aria-label="Filter buttons" style="display: inline-flex; align-items: center; background: #f6f8fa; border: 1px solid #d1d5da; border-radius: 6px; padding: 0;">
              <a href="{{ url_for('payment_bot_matches', status='no_match') }}"
                 class="github-filter-btn {% if current_filters.status == 'no_match' and not current_filters.show_all %}active{% endif %}"
                 style="{% if current_filters.status == 'no_match' and not current_filters.show_all %}background: #ffffff; color: #24292e; font-weight: 600; border: 1px solid #d1d5da; margin: -1px; z-index: 1; border-radius: 6px; box-shadow: 0 1px 0 rgba(27,31,35,0.04);{% else %}background: rgba(0, 0, 0, 0.03); color: #586069; margin: 0; border-right: 1px solid transparent; background-clip: padding-box; background-image: linear-gradient(to right, transparent 0%, transparent 100%), linear-gradient(180deg, transparent 20%, #d1d5da 20%, #d1d5da 80%, transparent 80%); background-size: 100% 100%, 1px 100%; background-position: center, right center; background-repeat: no-repeat;{% endif %} padding: 5px 12px; font-size: 14px; line-height: 20px; text-decoration: none; display: inline-flex; align-items: center; white-space: nowrap; position: relative;">
                No Match <span style="opacity: 0.6; margin-left: 4px;">({{ statistics.no_match_count|default(0) }})</span>
              </a>
              <a href="{{ url_for('payment_bot_matches', status='matched') }}"
                 class="github-filter-btn {% if current_filters.status == 'matched' %}active{% endif %}"
                 style="{% if current_filters.status == 'matched' %}background: #ffffff; color: #24292e; font-weight: 600; border: 1px solid #d1d5da; margin: -1px; z-index: 1; border-radius: 6px; box-shadow: 0 1px 0 rgba(27,31,35,0.04);{% else %}background: rgba(0, 0, 0, 0.03); color: #586069; margin: 0; border-right: 1px solid transparent; background-clip: padding-box; background-image: linear-gradient(to right, transparent 0%, transparent 100%), linear-gradient(180deg, transparent 20%, #d1d5da 20%, #d1d5da 80%, transparent 80%); background-size: 100% 100%, 1px 100%; background-position: center, right center; background-repeat: no-repeat;{% endif %} padding: 5px 12px; font-size: 14px; line-height: 20px; text-decoration: none; display: inline-flex; align-items: center; white-space: nowrap; position: relative;">
                <i class="ti ti-circle-check" style="font-size: 16px; margin-right: 4px;"></i>Match <span style="opacity: 0.6; margin-left: 4px;">({{ statistics.matched_count|default(0) }})</span>
              </a>
              <a href="{{ url_for('payment_bot_matches', show_all='true') }}"
                 class="github-filter-btn {% if current_filters.show_all %}active{% endif %}"
                 style="{% if current_filters.show_all %}background: #ffffff; color: #24292e; font-weight: 600; border: 1px solid #d1d5da; margin: -1px; z-index: 1; border-radius: 6px; box-shadow: 0 1px 0 rgba(27,31,35,0.04);{% else %}background: rgba(0, 0, 0, 0.03); color: #586069; margin: 0; border-right: 1px solid transparent; background-clip: padding-box; background-image: linear-gradient(to right, transparent 0%, transparent 100%), linear-gradient(180deg, transparent 20%, #d1d5da 20%, #d1d5da 80%, transparent 80%); background-size: 100% 100%, 1px 100%; background-position: center, right center; background-repeat: no-repeat;{% endif %} padding: 5px 12px; font-size: 14px; line-height: 20px; text-decoration: none; display: inline-flex; align-items: center; white-space: nowrap; position: relative;">
                <i class="ti ti-list" style="font-size: 16px; margin-right: 4px;"></i>All <span style="opacity: 0.6; margin-left: 4px;">({{ statistics.total_payments|default(0) }})</span>
              </a>
            </div>
          </div>
        </div>

        {% if is_first_time_empty %}
          <!-- First-Time Empty State -->
          <div class="empty-state-container text-center py-5">
            <div class="empty-state-icon mb-3">
              <i class="ti ti-mail" style="font-size: 48px; color: #20c997;"></i>
            </div>
            <h3 class="empty-state-title mb-2">No payment emails yet</h3>
            <p class="empty-state-description text-muted mb-3">
              Email notifications from Interac e-Transfer will appear here for automatic payment matching.
            </p>
          </div>

        {% elif is_zero_results %}
          <!-- Zero Results Empty State -->
          <div class="empty-state-container text-center py-5">
            <div class="empty-state-icon mb-3">
              <i class="ti ti-search" style="font-size: 48px; color: #6c757d;"></i>
            </div>
            <h3 class="empty-state-title mb-2">No payments match your filters</h3>
            <p class="empty-state-description text-muted mb-3">
              Try adjusting your search or filter criteria.
            </p>
            <a href="{{ url_for('payment_bot_matches', show_all='true') }}" class="btn btn-link">
              Clear all filters
            </a>
          </div>

        {% else %}
          <!-- Normal Table View -->
          <div class="table-responsive">
            <table class="table table-hover">
            <thead>
              <tr>
                <th style="padding-left: 1.5rem;">Payment Sender</th>
                <th class="d-none d-md-table-cell">Payment Date</th>
                <th class="d-md-none text-center">Status</th>
                <th class="d-none d-md-table-cell text-center">Amount</th>
                <th class="d-none d-md-table-cell text-center">Status</th>
                <th class="d-none d-lg-table-cell">Matched To</th>
                <th class="d-none d-lg-table-cell">Reason</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
            <tr>
              <!-- Payment Sender Column: Always visible -->
              <td style="vertical-align: middle; padding-left: 1.5rem;">
                <div>
                  <div class="fw-bold">{{ payment.bank_info_name or 'Unknown' }}</div>
                  <div class="text-muted small">{{ payment.from_email or 'No email' }}</div>
                </div>
              </td>

              <!-- Payment Date: Desktop only -->
              <td class="d-none d-md-table-cell" style="vertical-align: middle;">
                {% set display_date = (payment.email_received_date or payment.timestamp)|utc_to_local %}
                {% if display_date %}
                  <div style="line-height: 1.4;">
                    <div>{{ display_date.strftime('%Y-%m-%d') }}</div>
                    <div class="text-muted" style="font-size: 0.875rem;">{{ display_date.strftime('%H:%M:%S') }}</div>
                  </div>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>

              <!-- Status & Amount: Mobile only -->
              <td class="d-md-none text-center" style="vertical-align: middle;">
                <!-- Status badge -->
                <div class="mb-1">
                  {% if payment.result == 'MATCHED' %}
                    <span class="badge bg-green-lt text-green-lt-fg">Matched</span>
                  {% elif payment.result == 'NO_MATCH' %}
                    <span class="badge bg-orange-lt text-orange-lt-fg">No Match</span>
                  {% elif payment.result == 'MANUAL_PROCESSED' %}
                    <span class="badge bg-blue-lt text-blue-lt-fg">Archived</span>
                  {% else %}
                    <span class="badge bg-gray-lt">Unknown</span>
                  {% endif %}
                </div>
                <!-- Amount below badge -->
                {% if payment.bank_info_amt %}
                  <span class="fw-bold">${{ "%.0f"|format(payment.bank_info_amt) }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>

              <!-- Amount: Desktop (full precision) -->
              <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                {% if payment.bank_info_amt %}
                  <span class="fw-bold">${{ "%.2f"|format(payment.bank_info_amt) }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>

              <!-- Status: Desktop only -->
              <td class="d-none d-md-table-cell text-center" style="vertical-align: middle;">
                {% if payment.result == 'MATCHED' %}
                  <span class="badge bg-green-lt text-green-lt-fg">Matched</span>
                {% elif payment.result == 'NO_MATCH' %}
                  <span class="badge bg-orange-lt text-orange-lt-fg">No Match</span>
                {% elif payment.result == 'MANUAL_PROCESSED' %}
                  <span class="badge bg-blue-lt text-blue-lt-fg">Archived</span>
                {% else %}
                  <span class="badge bg-gray-lt">Unknown</span>
                {% endif %}
              </td>

              <!-- Matched To: Large screens only -->
              <td class="d-none d-lg-table-cell" style="vertical-align: middle;">
                {% if payment.matched_pass_id %}
                  <span class="text-muted">Passport #{{ payment.matched_pass_id }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>

              <!-- Reason: Large screens only -->
              <td class="d-none d-lg-table-cell" style="vertical-align: middle; max-width: 400px;">
                {% if payment.note %}
                  <small class="text-muted" style="word-wrap: break-word; white-space: normal; display: block;">{{ payment.note }}</small>
                {% else %}
                  <small class="text-muted">-</small>
                {% endif %}
              </td>

              <!-- Actions Column: Always visible -->
              <td class="text-center" style="vertical-align: middle;">
                <div class="dropdown d-inline-block">
                  <!-- Desktop: Text button with dropdown arrow -->
                  <a href="#" class="btn btn-outline-secondary dropdown-toggle d-none d-md-inline-block" data-bs-toggle="dropdown">
                    Actions
                  </a>
                  <!-- Mobile: Icon-only button without dropdown arrow -->
                  <a href="#" class="btn btn-outline-secondary d-md-none" data-bs-toggle="dropdown" style="padding: 0.375rem 0.5rem;">
                    <i class="ti ti-menu-2"></i>
                  </a>
                  <div class="dropdown-menu dropdown-menu-end">
                    {% if payment.result == 'NO_MATCH' %}
                      <a href="#" class="dropdown-item create-passport-btn"
                         data-payment-id="{{ payment.id }}"
                         data-name="{{ payment.bank_info_name }}"
                         data-amount="{{ payment.bank_info_amt }}">
                        <i class="ti ti-ticket me-2"></i>Create Passport
                      </a>
                      <div class="dropdown-divider"></div>
                      <a href="#" class="dropdown-item archive-payment-btn"
                         data-name="{{ payment.bank_info_name }}"
                         data-amount="{{ payment.bank_info_amt }}"
                         data-email="{{ payment.from_email }}">
                        <i class="ti ti-archive me-2"></i>Archive Email
                      </a>
                    {% elif payment.result == 'MANUAL_PROCESSED' %}
                      <span class="dropdown-item text-muted">
                        <i class="ti ti-check me-2"></i>Archived
                      </span>
                    {% else %}
                      <span class="dropdown-item text-muted">No actions</span>
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

        <!-- Pagination -->
        <div class="card-footer d-flex justify-content-between align-items-center">
          {% if payments|length > 0 %}
            <span class="text-muted">Showing {{ payments|length }} of {{ pagination.total }} entries (Page {{ pagination.page }} of {{ pagination.pages }})</span>

            <!-- Pagination Controls -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Page navigation">
              <ul class="pagination m-0">
                {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('payment_bot_matches', page=pagination.prev_num, q=current_filters.q, status=current_filters.status) }}">
                    <i class="ti ti-chevron-left"></i> Previous
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="ti ti-chevron-left"></i> Previous</span>
                </li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                  {% if page_num %}
                    {% if page_num == pagination.page %}
                      <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                    {% else %}
                      <li class="page-item">
                        <a class="page-link" href="{{ url_for('payment_bot_matches', page=page_num, q=current_filters.q, status=current_filters.status) }}">{{ page_num }}</a>
                      </li>
                    {% endif %}
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('payment_bot_matches', page=pagination.next_num, q=current_filters.q, status=current_filters.status) }}">
                    Next <i class="ti ti-chevron-right"></i>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next <i class="ti ti-chevron-right"></i></span>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          {% else %}
            <span class="text-muted">No entries found</span>
          {% endif %}
        </div>
        </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<!-- Archive Email Confirmation Modal -->
<div class="modal modal-blur fade" id="archivePaymentModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-warning"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-warning icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M3 4m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z"/>
          <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10"/>
          <path d="M10 12l4 0"/>
        </svg>
        <h3>Archive Payment Email?</h3>
        <div class="text-secondary mb-3">
          Move email for <strong id="archiveName"></strong> ($<strong id="archiveAmount"></strong>) to ManualProcessed folder?
        </div>
        <div class="text-start">
          <label class="form-label">Reason (optional - replace default reason):</label>
          <textarea class="form-control" id="archiveNote" rows="3" placeholder="e.g., Passport created under different name, payment verified manually"></textarea>
          <small class="text-muted">Leave empty to keep default reason</small>
        </div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <button class="btn w-100" data-bs-dismiss="modal">Cancel</button>
            </div>
            <div class="col">
              <button class="btn btn-warning w-100" id="confirmArchiveBtn">Yes, Archive</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Passport from Payment Modal -->
<div class="modal modal-blur fade" id="createPassportModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-ticket me-2"></i>Create Passport from Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Warning Banner -->
        <div class="alert alert-danger mb-4">
          <div class="d-flex">
            <div class="me-2">
              <i class="ti ti-alert-triangle" style="color: #e03131;"></i>
            </div>
            <div>
              <strong>Before creating a new passport, double-check:</strong><br>
              This person might already have an unpaid passport under a different name.<br>
              <small class="text-muted">Example: "Roger Ouellet" might have paid as "Gestion Roger Inc"</small>
            </div>
          </div>
        </div>

        <form id="createPassportForm">
          <input type="hidden" id="cpPaymentId" name="payment_id">

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required">Name</label>
              <div class="position-relative">
                <input type="text" class="form-control" id="cpName" name="name" required autocomplete="off">
                <div id="cpNameSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
              </div>
              <small class="text-muted">Pre-filled from payment sender</small>
            </div>
            <div class="col-md-6">
              <label class="form-label required">Email</label>
              <input type="email" class="form-control" id="cpEmail" name="email" required placeholder="Required for passport confirmation">
              <small class="text-muted" id="cpEmailHint">Auto-filled if matching user found</small>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" id="cpPhone" name="phone" placeholder="Optional">
            </div>
            <div class="col-md-6">
              <label class="form-label required">Activity</label>
              <select class="form-select" id="cpActivity" name="activity_id" required>
                <option value="">Select an activity...</option>
                {% for activity in activities %}
                  <option value="{{ activity.id }}">{{ activity.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required">Passport Type</label>
              <select class="form-select" id="cpPassportType" name="passport_type_id" required disabled>
                <option value="">Select activity first...</option>
              </select>
              <small class="text-muted" id="cpPassportTypeHint"></small>
            </div>
            <div class="col-md-3">
              <label class="form-label">Amount ($)</label>
              <input type="number" class="form-control" id="cpAmount" name="amount" step="0.01" min="0">
              <small class="text-muted">From payment</small>
            </div>
            <div class="col-md-3">
              <label class="form-label">Sessions</label>
              <input type="number" class="form-control" id="cpSessions" name="sessions" min="1">
              <small class="text-muted">From type</small>
            </div>
          </div>

          <!-- Amount Mismatch Warning -->
          <div class="alert alert-info mb-0" id="cpAmountWarning" style="display: none;">
            <i class="ti ti-info-circle me-2"></i>
            <span id="cpAmountWarningText"></span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCreatePassportBtn">
          <i class="ti ti-ticket me-2"></i>Create Passport
        </button>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search component
    if (window.SearchComponent) {
        window.SearchComponent.init({
            formId: 'dynamicSearchForm',
            inputId: 'enhancedSearchInput',
            preserveParams: ['status']
        });
    }

    // Initialize filter component
    if (window.FilterComponent) {
        window.FilterComponent.init({
            filterClass: 'github-filter-btn',
            mode: 'server',
            preserveScrollPosition: true,
            enableSearchPreservation: true
        });
    }

    // Validation for debugging
    console.log('ðŸ’³ Payment Bot Matches page loaded');
    console.log('ðŸ”§ Global dropdown fix available:', typeof window.dropdownFix !== 'undefined');
    console.log('ðŸ“Š Bootstrap available:', typeof bootstrap !== 'undefined');
    console.log('ðŸ” Dropdown toggles found:', document.querySelectorAll('[data-bs-toggle="dropdown"]').length);

    // Debug: Check if Bootstrap is properly loaded
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded! Dropdown functionality may not work.');
    } else {
        console.log('Bootstrap is loaded. Dropdown functionality should work.');
    }
});

// Archive payment email functionality
let currentArchiveData = null;

function archivePaymentEmail(name, amount, email) {
  currentArchiveData = { name, amount, email };

  document.getElementById('archiveName').textContent = name;
  document.getElementById('archiveAmount').textContent = amount.toFixed(2);

  // Clear the custom note textarea
  document.getElementById('archiveNote').value = '';

  const modal = new bootstrap.Modal(document.getElementById('archivePaymentModal'));
  modal.show();
}

// Event listener for archive buttons with data attributes
document.addEventListener('click', function(e) {
  if (e.target.closest('.archive-payment-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.archive-payment-btn');
    const name = btn.dataset.name;
    const amount = parseFloat(btn.dataset.amount);
    const email = btn.dataset.email;
    archivePaymentEmail(name, amount, email);
  }
});

// ========================================
// Create Passport from Payment functionality
// ========================================
let userCache = [];
let currentCreatePassportData = null;

// Load user cache on page load
async function loadUserCache() {
  try {
    const response = await fetch('/users.json');
    if (response.ok) {
      userCache = await response.json();
      console.log('User cache loaded:', userCache.length, 'users');
    }
  } catch (error) {
    console.error('Failed to load user cache:', error);
  }
}

// Search user cache for matching name
function findUserByName(name) {
  if (!name || !userCache.length) return null;
  const normalizedName = name.toLowerCase().trim();
  return userCache.find(u => u.name && u.name.toLowerCase().trim() === normalizedName);
}

// Get name suggestions from cache
function getNameSuggestions(query) {
  if (!query || query.length < 2 || !userCache.length) return [];
  const normalizedQuery = query.toLowerCase().trim();
  return userCache.filter(u =>
    u.name && u.name.toLowerCase().includes(normalizedQuery)
  ).slice(0, 5);
}

// Open Create Passport modal
function openCreatePassportModal(paymentId, name, amount) {
  currentCreatePassportData = { paymentId, name, amount };

  // Reset form
  document.getElementById('createPassportForm').reset();
  document.getElementById('cpPaymentId').value = paymentId;
  document.getElementById('cpName').value = name || '';
  document.getElementById('cpAmount').value = amount ? parseFloat(amount).toFixed(2) : '';
  document.getElementById('cpEmail').value = '';
  document.getElementById('cpPhone').value = '';
  document.getElementById('cpActivity').value = '';
  document.getElementById('cpPassportType').innerHTML = '<option value="">Select activity first...</option>';
  document.getElementById('cpPassportType').disabled = true;
  document.getElementById('cpSessions').value = '';
  document.getElementById('cpAmountWarning').style.display = 'none';
  document.getElementById('cpEmailHint').textContent = 'Auto-filled if matching user found';

  // Try to find user in cache by name
  const matchedUser = findUserByName(name);
  if (matchedUser) {
    if (matchedUser.email) {
      document.getElementById('cpEmail').value = matchedUser.email;
      document.getElementById('cpEmailHint').innerHTML = '<i class="ti ti-check text-success"></i> Found in user cache';
    }
    if (matchedUser.phone) {
      document.getElementById('cpPhone').value = matchedUser.phone;
    }
  }

  const modal = new bootstrap.Modal(document.getElementById('createPassportModal'));
  modal.show();
}

// Handle name input for autocomplete suggestions
document.getElementById('cpName').addEventListener('input', function(e) {
  const query = e.target.value;
  const suggestions = getNameSuggestions(query);
  const suggestionsDiv = document.getElementById('cpNameSuggestions');

  if (suggestions.length > 0) {
    suggestionsDiv.innerHTML = suggestions.map(u =>
      `<div class="suggestion-item" data-name="${u.name}" data-email="${u.email || ''}" data-phone="${u.phone || ''}">
        <strong>${u.name}</strong>
        ${u.email ? `<small class="text-muted ms-2">${u.email}</small>` : ''}
      </div>`
    ).join('');
    suggestionsDiv.style.display = 'block';
  } else {
    suggestionsDiv.style.display = 'none';
  }
});

// Handle suggestion click
document.getElementById('cpNameSuggestions').addEventListener('click', function(e) {
  const item = e.target.closest('.suggestion-item');
  if (item) {
    document.getElementById('cpName').value = item.dataset.name;
    if (item.dataset.email) {
      document.getElementById('cpEmail').value = item.dataset.email;
      document.getElementById('cpEmailHint').innerHTML = '<i class="ti ti-check text-success"></i> Found in user cache';
    }
    if (item.dataset.phone) {
      document.getElementById('cpPhone').value = item.dataset.phone;
    }
    document.getElementById('cpNameSuggestions').style.display = 'none';
  }
});

// Hide suggestions when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('#cpName') && !e.target.closest('#cpNameSuggestions')) {
    document.getElementById('cpNameSuggestions').style.display = 'none';
  }
});

// Handle activity change - load passport types
document.getElementById('cpActivity').addEventListener('change', async function() {
  const activityId = this.value;
  const passportTypeSelect = document.getElementById('cpPassportType');
  const sessionsInput = document.getElementById('cpSessions');
  const amountWarning = document.getElementById('cpAmountWarning');

  amountWarning.style.display = 'none';

  if (!activityId) {
    passportTypeSelect.innerHTML = '<option value="">Select activity first...</option>';
    passportTypeSelect.disabled = true;
    sessionsInput.value = '';
    document.getElementById('cpPassportTypeHint').textContent = '';
    return;
  }

  passportTypeSelect.innerHTML = '<option value="">Loading...</option>';
  passportTypeSelect.disabled = true;

  try {
    const response = await fetch(`/api/get-passport-types/${activityId}`);
    const passportTypes = await response.json();

    if (passportTypes.length === 0) {
      passportTypeSelect.innerHTML = '<option value="">No active passport types</option>';
      document.getElementById('cpPassportTypeHint').textContent = 'This activity has no active passport types';
    } else {
      passportTypeSelect.innerHTML = '<option value="">Select passport type...</option>' +
        passportTypes.map(pt =>
          `<option value="${pt.id}" data-price="${pt.price}" data-sessions="${pt.sessions}">${pt.name} ($${pt.price})</option>`
        ).join('');
      passportTypeSelect.disabled = false;
      document.getElementById('cpPassportTypeHint').textContent = '';

      // Auto-select if only one passport type
      if (passportTypes.length === 1) {
        passportTypeSelect.value = passportTypes[0].id;
        passportTypeSelect.dispatchEvent(new Event('change'));
      }
    }
  } catch (error) {
    console.error('Failed to load passport types:', error);
    passportTypeSelect.innerHTML = '<option value="">Error loading types</option>';
    document.getElementById('cpPassportTypeHint').textContent = 'Failed to load passport types';
  }
});

// Handle passport type change - update sessions and check amount
document.getElementById('cpPassportType').addEventListener('change', function() {
  const selected = this.options[this.selectedIndex];
  const sessionsInput = document.getElementById('cpSessions');
  const amountWarning = document.getElementById('cpAmountWarning');
  const amountInput = document.getElementById('cpAmount');

  if (selected && selected.dataset.sessions) {
    sessionsInput.value = selected.dataset.sessions;

    // Check for amount mismatch
    const typePrice = parseFloat(selected.dataset.price) || 0;
    const paymentAmount = parseFloat(amountInput.value) || 0;

    if (typePrice > 0 && paymentAmount > 0 && Math.abs(typePrice - paymentAmount) > 0.01) {
      document.getElementById('cpAmountWarningText').textContent =
        `Payment amount ($${paymentAmount.toFixed(2)}) differs from passport type price ($${typePrice.toFixed(2)})`;
      amountWarning.style.display = 'block';
    } else {
      amountWarning.style.display = 'none';
    }
  } else {
    sessionsInput.value = '';
    amountWarning.style.display = 'none';
  }
});

// Handle Create Passport button click
document.addEventListener('click', function(e) {
  if (e.target.closest('.create-passport-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.create-passport-btn');
    const paymentId = btn.dataset.paymentId;
    const name = btn.dataset.name;
    const amount = btn.dataset.amount;
    openCreatePassportModal(paymentId, name, amount);
  }
});

// Handle Create Passport form submission
document.getElementById('confirmCreatePassportBtn').addEventListener('click', async function() {
  const btn = this;
  const form = document.getElementById('createPassportForm');

  // Basic validation
  const name = document.getElementById('cpName').value.trim();
  const email = document.getElementById('cpEmail').value.trim();
  const activityId = document.getElementById('cpActivity').value;
  const passportTypeId = document.getElementById('cpPassportType').value;

  if (!name) {
    alert('Please enter a name');
    return;
  }
  if (!email) {
    alert('Email is required - all passport communications are sent via email');
    return;
  }
  // Basic email format validation
  if (!email.includes('@') || !email.includes('.')) {
    alert('Please enter a valid email address');
    return;
  }
  if (!activityId) {
    alert('Please select an activity');
    return;
  }
  if (!passportTypeId) {
    alert('Please select a passport type');
    return;
  }

  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

  try {
    const response = await fetch('/api/create-passport-from-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({
        payment_id: parseInt(document.getElementById('cpPaymentId').value),
        name: name,
        email: document.getElementById('cpEmail').value.trim() || null,
        phone: document.getElementById('cpPhone').value.trim() || null,
        activity_id: parseInt(activityId),
        passport_type_id: parseInt(passportTypeId),
        amount: parseFloat(document.getElementById('cpAmount').value) || null,
        sessions: parseInt(document.getElementById('cpSessions').value) || null
      })
    });

    const data = await response.json();

    if (data.success) {
      // Close modal and reload page - flash message will be shown by server
      bootstrap.Modal.getInstance(document.getElementById('createPassportModal')).hide();
      window.location.reload();
    } else {
      // Reload page to show error flash message
      window.location.reload();
    }
  } catch (error) {
    console.error('Create passport error:', error);
    alert('Failed to create passport: ' + error.message);
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

// Load user cache when page loads
loadUserCache();

// Handle archive confirmation
document.getElementById('confirmArchiveBtn').addEventListener('click', async function() {
  if (!currentArchiveData) return;

  const btn = this;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Archiving...';

  try {
    // Get custom note from textarea
    const customNote = document.getElementById('archiveNote').value.trim();

    const response = await fetch('/api/move-payment-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({
        bank_info_name: currentArchiveData.name,
        bank_info_amt: currentArchiveData.amount,
        from_email: currentArchiveData.email,
        custom_note: customNote || null
      })
    });

    const data = await response.json();

    if (data.success) {
      // Close modal
      bootstrap.Modal.getInstance(document.getElementById('archivePaymentModal')).hide();

      // Reload page to show updated status
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to archive email'));
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Archive error:', error);
    alert('Failed to archive email: ' + error.message);
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});
</script>

<style>
/* Plain white cards - NO fancy effects */
.card {
  background-color: #fff !important;
  border: none !important;
  border-radius: 0.5rem !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
}

/* NO HOVER EFFECTS on table rows - per CLAUDE.md constraints */
.table-hover tbody tr:hover {
  background-color: transparent !important;
}

/* Autocomplete suggestions for Create Passport modal */
.autocomplete-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 1050;
  max-height: 200px;
  overflow-y: auto;
}

.suggestion-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-item:hover {
  background-color: #f8f9fa;
}
</style>

{% endblock %}
