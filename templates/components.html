{% extends "base.html" %}

{% block head %}
<style>
  .components-section {
    margin-bottom: 3rem;
  }
  
  .code-preview {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
    position: relative;
  }
  
  .code-copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0.7;
    z-index: 10;
  }
  
  .code-copy-btn:hover {
    opacity: 1;
  }
  
  .component-demo {
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 2rem;
    margin-bottom: 1rem;
    background: white;
  }
  
  .nav-pills .nav-link.active {
    background-color: #007bff;
  }
  
  /* KPI Card Styles for Components */
  .kpi-card-rounded {
    border-radius: 12px;
    border: 1px solid #e6e8eb;
    transition: box-shadow 0.2s ease;
  }
  
  .kpi-card-rounded:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }
  
  .implementation-note {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
  }
  
  .critical-note {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
  }
  
  .success-note {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
  }
  
  /* Syntax highlighting for code blocks */
  .language-html { color: #d73a49; }
  .language-javascript { color: #6f42c1; }
  .language-css { color: #005cc5; }
  
  /* Sample KPI Card for demo */
  .demo-kpi-card {
    max-width: 300px;
  }
  
  /* Chart container for demos */
  .demo-chart-container {
    height: 40px;
    position: relative;
    overflow: hidden;
  }
</style>
{% endblock %}

{% block title %}Minipass Components Reference{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="page-body">
    <div class="container-xl">
      
      <!-- Header -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="page-header">
            <div class="row align-items-center">
              <div class="col">
                <h1 class="page-title">
                  <i class="ti ti-components me-2"></i>
                  Minipass Components Reference
                </h1>
                <div class="text-muted mt-1">
                  Complete documentation of working UI components, patterns, and implementation guidelines
                </div>
                <div class="alert alert-info mt-3">
                  <div class="d-flex">
                    <div>
                      <i class="ti ti-info-circle alert-icon"></i>
                    </div>
                    <div>
                      <h4 class="alert-title">Design System</h4>
                      <div class="text-muted">For general UI components and brand guidelines, see the <a href="{{ url_for('style_guide') }}" class="alert-link">Style Guide</a></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
          <div class="card sticky-top" style="top: 1rem;">
            <div class="card-body">
              <h4 class="card-title">Components</h4>
              <nav class="nav nav-pills flex-column">
                <a class="nav-link active" href="#kpi-cards">KPI Cards</a>
                <a class="nav-link" href="#implementation-notes">Implementation Notes</a>
                <a class="nav-link" href="#chart-components">Chart Components</a>
                <a class="nav-link" href="#common-patterns">Common Patterns</a>
                <a class="nav-link" href="#javascript-functions">JavaScript Functions</a>
                <a class="nav-link" href="#mobile-responsive">Mobile Responsive</a>
                <a class="nav-link" href="#common-pitfalls">Common Pitfalls & Solutions</a>
              </nav>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
          
          <!-- KPI Cards Section -->
          <section id="kpi-cards" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">KPI Cards</h3>
                <div class="card-subtitle">Working implementation from activity_dashboard.html</div>
              </div>
              <div class="card-body">
                
                <!-- Revenue KPI Card Demo -->
                <h4>Revenue KPI Card</h4>
                <div class="component-demo">
                  <div class="demo-kpi-card">
                    <div class="card kpi-card-rounded">
                      <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <div class="text-muted small text-uppercase">REVENUE</div>
                          <div class="dropdown">
                            <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              Last 7 days
                            </button>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                            </ul>
                          </div>
                        </div>
                        <div class="h2 mb-1">$1,248</div>
                        <div class="d-flex align-items-center mb-3">
                          <div class="text-success me-2">12% <i class="ti ti-trending-up"></i></div>
                        </div>
                        <div class="demo-chart-container">
                          <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                            <path d="M 0,30 L 50,25 L 100,28 L 150,20 L 200,15 L 250,18 L 300,12" 
                                  fill="none" stroke="#206bc4" stroke-width="1.5" 
                                  stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-html">&lt;div class="col-md-3 mb-3"&gt;
  &lt;div class="card kpi-card-rounded"&gt;
    &lt;div class="card-body"&gt;
      &lt;div class="d-flex align-items-center justify-content-between mb-2"&gt;
        &lt;div class="text-muted small text-uppercase"&gt;REVENUE&lt;/div&gt;
        &lt;div class="dropdown"&gt;
          &lt;button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown"&gt;
            Last 7 days
          &lt;/button&gt;
          &lt;ul class="dropdown-menu"&gt;
            &lt;li&gt;&lt;a class="dropdown-item kpi-period-btn" href="#" data-period="7"&gt;Last 7 days&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a class="dropdown-item kpi-period-btn" href="#" data-period="30"&gt;Last 30 days&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a class="dropdown-item kpi-period-btn" href="#" data-period="90"&gt;Last 90 days&lt;/a&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="h2 mb-1" id="revenue-value"&gt;$1,248&lt;/div&gt;
      &lt;div class="d-flex align-items-center mb-3"&gt;
        &lt;div class="text-success me-2" id="revenue-trend"&gt;12% &lt;i class="ti ti-trending-up"&gt;&lt;/i&gt;&lt;/div&gt;
      &lt;/div&gt;
      &lt;div style="height: 40px; position: relative; overflow: hidden;"&gt;
        &lt;svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none" id="revenue-chart"&gt;
          &lt;!-- Chart will be populated by JavaScript --&gt;
        &lt;/svg&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
                </div>

                <!-- Active Users KPI Card Demo -->
                <h4 class="mt-5">Active Users KPI Card</h4>
                <div class="component-demo">
                  <div class="demo-kpi-card">
                    <div class="card kpi-card-rounded">
                      <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <div class="text-muted small text-uppercase">ACTIVE USERS</div>
                          <div class="dropdown">
                            <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              Last 7 days
                            </button>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                            </ul>
                          </div>
                        </div>
                        <div class="h2 mb-1">847</div>
                        <div class="d-flex align-items-center mb-3">
                          <div class="text-success me-2">8% <i class="ti ti-trending-up"></i></div>
                        </div>
                        <div class="demo-chart-container">
                          <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                            <!-- Bar chart for active users -->
                            <rect x="10" y="28" width="8" height="12" fill="#206bc4" opacity="0.8" />
                            <rect x="25" y="25" width="8" height="15" fill="#206bc4" opacity="0.8" />
                            <rect x="40" y="30" width="8" height="10" fill="#206bc4" opacity="0.8" />
                            <rect x="55" y="22" width="8" height="18" fill="#206bc4" opacity="0.8" />
                            <rect x="70" y="26" width="8" height="14" fill="#206bc4" opacity="0.8" />
                            <rect x="85" y="20" width="8" height="20" fill="#206bc4" opacity="0.8" />
                            <rect x="100" y="15" width="8" height="25" fill="#206bc4" opacity="0.8" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Unpaid Passports KPI Card Demo -->
                <h4 class="mt-5">Unpaid Passports KPI Card</h4>
                <div class="component-demo">
                  <div class="demo-kpi-card">
                    <div class="card kpi-card-rounded">
                      <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <div class="text-muted small text-uppercase">UNPAID PASSPORTS</div>
                          <div class="dropdown">
                            <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              Last 7 days
                            </button>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                            </ul>
                          </div>
                        </div>
                        <div class="h2 mb-1">23</div>
                        <div class="d-flex align-items-center mb-3">
                          <div class="text-danger me-2">3 overdue <i class="ti ti-alert-circle"></i></div>
                        </div>
                        <div class="demo-chart-container">
                          <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                            <!-- Bar chart for unpaid passports -->
                            <rect x="10" y="30" width="8" height="10" fill="#f76707" opacity="0.8" />
                            <rect x="25" y="28" width="8" height="12" fill="#f76707" opacity="0.8" />
                            <rect x="40" y="32" width="8" height="8" fill="#f76707" opacity="0.8" />
                            <rect x="55" y="26" width="8" height="14" fill="#f76707" opacity="0.8" />
                            <rect x="70" y="24" width="8" height="16" fill="#f76707" opacity="0.8" />
                            <rect x="85" y="29" width="8" height="11" fill="#f76707" opacity="0.8" />
                            <rect x="100" y="27" width="8" height="13" fill="#f76707" opacity="0.8" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Activity Profit KPI Card Demo -->
                <h4 class="mt-5">Activity Profit KPI Card</h4>
                <div class="component-demo">
                  <div class="demo-kpi-card">
                    <div class="card kpi-card-rounded">
                      <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <div class="text-muted small text-uppercase">ACTIVITY PROFIT</div>
                          <div class="dropdown">
                            <button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              Last 7 days
                            </button>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#">Last 7 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 30 days</a></li>
                              <li><a class="dropdown-item" href="#">Last 90 days</a></li>
                            </ul>
                          </div>
                        </div>
                        <div class="h2 mb-1">$892</div>
                        <div class="d-flex align-items-center mb-3">
                          <div class="text-success me-2">71% margin <i class="ti ti-trending-up"></i></div>
                        </div>
                        <div class="demo-chart-container">
                          <svg width="100%" height="40" viewBox="0 0 300 40" preserveAspectRatio="none">
                            <path d="M 0,32 L 50,28 L 100,30 L 150,22 L 200,18 L 250,20 L 300,15" 
                                  fill="none" stroke="#2fb344" stroke-width="1.5" 
                                  stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </section>

          <!-- Implementation Notes Section -->
          <section id="implementation-notes" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Critical Implementation Notes</h3>
              </div>
              <div class="card-body">
                
                <div class="critical-note">
                  <h5><i class="ti ti-alert-triangle me-2"></i>Icon Class Format</h5>
                  <p><strong>MUST use full format:</strong> <code>ti ti-trending-up</code> (not just <code>ti-trending-up</code>)</p>
                  <div class="code-preview">
                    <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                      <i class="ti ti-copy"></i>
                    </button>
                    <pre><code class="language-html">&lt;!-- CORRECT --&gt;
&lt;i class="ti ti-trending-up"&gt;&lt;/i&gt;

&lt;!-- INCORRECT --&gt;
&lt;i class="ti-trending-up"&gt;&lt;/i&gt;</code></pre>
                  </div>
                </div>

                <div class="implementation-note">
                  <h5><i class="ti ti-code me-2"></i>CSS Classes Required</h5>
                  <p>The <code>.kpi-card-rounded</code> class provides the proper styling:</p>
                  <div class="code-preview">
                    <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                      <i class="ti ti-copy"></i>
                    </button>
                    <pre><code class="language-css">.kpi-card-rounded {
  border-radius: 12px;
  border: 1px solid #e6e8eb;
  transition: box-shadow 0.2s ease;
}

.kpi-card-rounded:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}</code></pre>
                  </div>
                </div>

                <div class="success-note">
                  <h5><i class="ti ti-check me-2"></i>Individual Card Updates</h5>
                  <p>Use the <code>updateSingleKPIData()</code> function to update individual cards without affecting others:</p>
                  <div class="code-preview">
                    <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                      <i class="ti ti-copy"></i>
                    </button>
                    <pre><code class="language-javascript">// Update specific KPI card
updateSingleKPIData(period, kpiType, cardElement, periodText);

// Where:
// period: 7, 30, or 90 (days)
// kpiType: 'revenue', 'active_users', 'unpaid_passports', 'profit'
// cardElement: the card DOM element
// periodText: 'Last 7 days', 'Last 30 days', etc.</code></pre>
                  </div>
                </div>

                <div class="implementation-note">
                  <h5><i class="ti ti-database me-2"></i>Data Validation</h5>
                  <p>Always validate data before rendering to prevent chart errors:</p>
                  <div class="code-preview">
                    <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                      <i class="ti ti-copy"></i>
                    </button>
                    <pre><code class="language-javascript">// Clean data before chart generation
const cleanData = data.map(val => {
  const num = parseFloat(val);
  return isNaN(num) ? 0 : num;
});

// Ensure valid formatting
const safeValue = Math.round(parseFloat(data.total) || 0);
const safePercentage = Math.round(parseFloat(data.percentage) || 0);</code></pre>
                  </div>
                </div>

              </div>
            </div>
          </section>

          <!-- Chart Components Section -->
          <section id="chart-components" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Chart Components</h3>
              </div>
              <div class="card-body">
                
                <h4>Line Chart Generation</h4>
                <p>Use <code>generateCleanLineChart()</code> for reliable SVG path generation:</p>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">function generateCleanLineChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) {
    return `M 0,${height/2} L ${width},${height/2}`;
  }
  
  const cleanData = data.map(val => {
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num;
  });
  
  const max = Math.max(...cleanData);
  const min = Math.min(...cleanData);
  const range = max - min || 1;
  
  const points = [];
  for (let i = 0; i < cleanData.length; i++) {
    const x = cleanData.length === 1 ? width / 2 : (i / (cleanData.length - 1)) * width;
    const y = height - ((cleanData[i] - min) / range) * (height - 10) - 5;
    
    const cleanX = isNaN(x) ? 0 : Math.round(x * 100) / 100;
    const cleanY = isNaN(y) ? height / 2 : Math.round(y * 100) / 100;
    
    points.push({
      x: cleanX,
      y: cleanY,
      command: i === 0 ? 'M' : 'L'
    });
  }
  
  return points.map(point => `${point.command} ${point.x},${point.y}`).join(' ');
}</code></pre>
                </div>

                <h4 class="mt-4">Bar Chart Generation</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">function generateBarChart(data, width = 300, height = 40) {
  if (!data || data.length === 0) return '';
  
  const cleanData = data.map(val => parseFloat(val) || 0);
  const max = Math.max(...cleanData) || 1;
  const barWidth = Math.max(8, (width - (cleanData.length - 1) * 2) / cleanData.length);
  
  let svg = '';
  cleanData.forEach((value, index) => {
    const barHeight = Math.max(1, (value / max) * (height - 5));
    const x = index * (barWidth + 2);
    const y = height - barHeight;
    svg += `&lt;rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="#206bc4" opacity="0.8" /&gt;`;
  });
  
  return svg;
}</code></pre>
                </div>

                <h4 class="mt-4">Chart Colors</h4>
                <div class="row">
                  <div class="col-md-6">
                    <div class="component-demo">
                      <h6>Revenue Charts</h6>
                      <div style="width: 30px; height: 30px; background: #206bc4; border-radius: 4px; display: inline-block; margin-right: 10px;"></div>
                      <code>#206bc4</code>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="component-demo">
                      <h6>Profit Charts</h6>
                      <div style="width: 30px; height: 30px; background: #2fb344; border-radius: 4px; display: inline-block; margin-right: 10px;"></div>
                      <code>#2fb344</code>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="component-demo">
                      <h6>Active Users Charts</h6>
                      <div style="width: 30px; height: 30px; background: #206bc4; border-radius: 4px; display: inline-block; margin-right: 10px;"></div>
                      <code>#206bc4</code>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="component-demo">
                      <h6>Unpaid Passports Charts</h6>
                      <div style="width: 30px; height: 30px; background: #f76707; border-radius: 4px; display: inline-block; margin-right: 10px;"></div>
                      <code>#f76707</code>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </section>

          <!-- Common Patterns Section -->
          <section id="common-patterns" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Common Patterns</h3>
              </div>
              <div class="card-body">
                
                <h4>Dropdown Period Selector</h4>
                <p>Standard pattern for time period selection in KPI cards:</p>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-html">&lt;div class="dropdown"&gt;
  &lt;button class="btn btn-sm text-muted dropdown-toggle" type="button" data-bs-toggle="dropdown"&gt;
    Last 7 days
  &lt;/button&gt;
  &lt;ul class="dropdown-menu"&gt;
    &lt;li&gt;&lt;a class="dropdown-item kpi-period-btn" href="#" data-period="7"&gt;Last 7 days&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a class="dropdown-item kpi-period-btn" href="#" data-period="30"&gt;Last 30 days&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a class="dropdown-item kpi-period-btn" href="#" data-period="90"&gt;Last 90 days&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;</code></pre>
                </div>

                <h4 class="mt-4">Loading States</h4>
                <p>Show loading state for individual KPI cards during updates:</p>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">function showKPILoading(cardElement) {
  const valueEl = cardElement.querySelector('.h2');
  const trendEl = cardElement.querySelector('.text-success, .text-danger, .text-muted');
  const chartEl = cardElement.querySelector('svg');
  
  if (valueEl) valueEl.style.opacity = '0.6';
  if (trendEl) trendEl.style.opacity = '0.6';
  if (chartEl) chartEl.style.opacity = '0.3';
}

function hideKPILoading(cardElement) {
  const valueEl = cardElement.querySelector('.h2');
  const trendEl = cardElement.querySelector('.text-success, .text-danger, .text-muted');
  const chartEl = cardElement.querySelector('svg');
  
  if (valueEl) valueEl.style.opacity = '1';
  if (trendEl) trendEl.style.opacity = '1';
  if (chartEl) chartEl.style.opacity = '1';
}</code></pre>
                </div>

                <h4 class="mt-4">Value Formatting</h4>
                <p>Consistent formatting for different value types:</p>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">// Currency formatting
const formattedRevenue = `$${Math.round(parseFloat(data.total) || 0)}`;

// Percentage formatting
const formattedPercentage = `${Math.round(parseFloat(data.percentage) || 0)}%`;

// Count formatting
const formattedCount = Math.round(parseFloat(data.total) || 0);

// Margin formatting
const formattedMargin = `${Math.round(parseFloat(data.margin) || 0)}% margin`;</code></pre>
                </div>

              </div>
            </div>
          </section>

          <!-- JavaScript Functions Section -->
          <section id="javascript-functions" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Key JavaScript Functions</h3>
              </div>
              <div class="card-body">
                
                <h4>KPI Dropdown Handler</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">function initializeKPIDropdowns() {
  document.querySelectorAll('.kpi-period-btn').forEach(item => {
    item.addEventListener('click', handleKPITimeChange);
  });
}

function handleKPITimeChange(event) {
  event.preventDefault();
  
  const clickedItem = event.target;
  const period = parseInt(clickedItem.dataset.period);
  const dropdown = clickedItem.closest('.dropdown');
  const kpiCard = dropdown.closest('.card');
  const kpiType = determineKPIType(kpiCard);
  
  showKPILoading(kpiCard);
  updateSingleKPIData(period, kpiType, kpiCard, clickedItem.textContent.trim());
}</code></pre>
                </div>

                <h4 class="mt-4">KPI Type Detection</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">function determineKPIType(cardElement) {
  const cardText = cardElement.textContent.toLowerCase();
  if (cardText.includes('revenue')) return 'revenue';
  if (cardText.includes('active users')) return 'active_users';
  if (cardText.includes('unpaid')) return 'unpaid_passports';
  if (cardText.includes('profit')) return 'profit';
  return 'revenue'; // fallback
}</code></pre>
                </div>

                <h4 class="mt-4">Chart Update Function</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-javascript">function updateKPICard(prefix, data, chartType, period) {
  // Update value
  const valueEl = document.getElementById(`${prefix}-value`);
  if (valueEl) {
    if (prefix.includes('revenue') || prefix.includes('profit')) {
      valueEl.textContent = `$${Math.round(parseFloat(data.total) || 0)}`;
    } else {
      valueEl.textContent = Math.round(parseFloat(data.total) || 0);
    }
  }
  
  // Update trend
  const trendEl = document.getElementById(`${prefix}-trend`);
  if (trendEl) {
    let trendClass = data.trend === 'up' ? 'text-success' : 
                     data.trend === 'down' ? 'text-danger' : 'text-muted';
    let icon = `ti ti-trending-${data.trend || 'up'}`;
    
    if (prefix.includes('unpaid-passports')) {
      trendEl.innerHTML = `${data.overdue} overdue &lt;i class="ti ti-alert-circle"&gt;&lt;/i&gt;`;
      trendEl.className = `${data.overdue > 0 ? 'text-danger' : 'text-muted'} me-2`;
    } else {
      const value = prefix.includes('profit') ? 
        `${Math.round(parseFloat(data.margin) || 0)}% margin` :
        `${Math.round(parseFloat(data.percentage) || 0)}%`;
      trendEl.innerHTML = `${value} &lt;i class="${icon}"&gt;&lt;/i&gt;`;
      trendEl.className = `${trendClass} me-2`;
    }
  }
  
  // Update chart
  const chartEl = document.getElementById(`${prefix}-chart`);
  if (chartEl && data.trend_data) {
    let chartContent = '';
    if (chartType === 'line') {
      const color = prefix.includes('revenue') ? '#206bc4' : '#2fb344';
      const cleanPath = generateCleanLineChart(data.trend_data, 300, 40);
      chartContent = `&lt;path d="${cleanPath}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /&gt;`;
    } else if (chartType === 'bar') {
      chartContent = generateBarChart(data.trend_data);
    } else if (chartType === 'unpaid-bar') {
      chartContent = generateUnpaidBarChart(data.trend_data);
    }
    chartEl.innerHTML = chartContent;
  }
}</code></pre>
                </div>

              </div>
            </div>
          </section>

          <!-- Mobile Responsive Section -->
          <section id="mobile-responsive" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Mobile Responsive Implementation</h3>
              </div>
              <div class="card-body">
                
                <h4>Desktop Layout</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-html">&lt;!-- Desktop Layout - Visible on md+ screens --&gt;
&lt;div class="row mb-4 d-none d-md-flex"&gt;
  &lt;div class="col-md-3 mb-3"&gt;
    &lt;!-- Revenue KPI Card --&gt;
  &lt;/div&gt;
  &lt;div class="col-md-3 mb-3"&gt;
    &lt;!-- Active Users KPI Card --&gt;
  &lt;/div&gt;
  &lt;div class="col-md-3 mb-3"&gt;
    &lt;!-- Unpaid Passports KPI Card --&gt;
  &lt;/div&gt;
  &lt;div class="col-md-3 mb-3"&gt;
    &lt;!-- Profit KPI Card --&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
                </div>

                <h4 class="mt-4">Mobile Carousel</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-html">&lt;!-- Mobile Carousel - Visible on sm and below --&gt;
&lt;div class="d-md-none mb-4"&gt;
  &lt;div class="d-flex overflow-auto pb-2" style="scroll-snap-type: x mandatory;"&gt;
    &lt;div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;"&gt;
      &lt;!-- Revenue KPI Card with mobile- prefix IDs --&gt;
    &lt;/div&gt;
    &lt;div class="flex-shrink-0 me-3" style="width: 280px; scroll-snap-align: start;"&gt;
      &lt;!-- Active Users KPI Card with mobile- prefix IDs --&gt;
    &lt;/div&gt;
    &lt;!-- Additional cards... --&gt;
  &lt;/div&gt;
  
  &lt;!-- Scroll indicators --&gt;
  &lt;div class="text-center mt-2"&gt;
    &lt;span class="badge bg-primary me-1" style="width: 8px; height: 8px; border-radius: 50%;"&gt;&lt;/span&gt;
    &lt;span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"&gt;&lt;/span&gt;
    &lt;span class="badge bg-light me-1" style="width: 8px; height: 8px; border-radius: 50%;"&gt;&lt;/span&gt;
    &lt;span class="badge bg-light" style="width: 8px; height: 8px; border-radius: 50%;"&gt;&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
                </div>

                <h4 class="mt-4">Mobile CSS</h4>
                <div class="code-preview">
                  <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                    <i class="ti ti-copy"></i>
                  </button>
                  <pre><code class="language-css">/* Mobile scroll snap styles for KPI cards */
.d-flex.overflow-auto {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.d-flex.overflow-auto::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

/* Mobile scroll indicators */
@media (max-width: 767.98px) {
  .flex-shrink-0 {
    scroll-snap-align: start;
  }
}</code></pre>
                </div>

                <div class="implementation-note">
                  <h5><i class="ti ti-device-mobile me-2"></i>Important Mobile Notes</h5>
                  <ul>
                    <li>Each mobile KPI card needs unique IDs (e.g., <code>mobile-revenue-value</code>)</li>
                    <li>Both desktop and mobile cards must be updated when data changes</li>
                    <li>Mobile cards have fixed width of 280px for consistent scrolling</li>
                    <li>Scroll snap ensures cards align properly during horizontal scrolling</li>
                  </ul>
                </div>

              </div>
            </div>
          </section>

          <!-- Common Pitfalls & Solutions Section -->
          <section id="common-pitfalls" class="components-section">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="ti ti-alert-triangle text-warning me-2"></i>
                  Common Pitfalls & Solutions
                </h3>
                <div class="card-subtitle">Critical issues we've encountered and their solutions</div>
              </div>
              <div class="card-body">
                
                <!-- The Title Overwrite Bug -->
                <div class="alert alert-danger" role="alert">
                  <div class="d-flex">
                    <div>
                      <i class="ti ti-bug alert-icon"></i>
                    </div>
                    <div>
                      <h4 class="alert-title">The Title Overwrite Bug</h4>
                      <div class="text-muted mb-2">
                        <strong>Symptom:</strong> Revenue title shows "0% -" instead of "REVENUE"
                      </div>
                      <div class="text-muted mb-2">
                        <strong>Cause:</strong> CSS selector <code>.text-muted</code> too broad, matches title elements
                      </div>
                      <div class="text-muted mb-3">
                        <strong>Solution:</strong> Use specific IDs like <code>#revenue-trend</code>
                      </div>
                      
                      <div class="code-preview">
                        <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                          <i class="ti ti-copy"></i>
                        </button>
                        <pre><code class="language-html">&lt;!-- WRONG: This will update ALL .text-muted elements --&gt;
&lt;div class="text-muted small text-uppercase"&gt;REVENUE&lt;/div&gt;
&lt;div class="text-muted me-2"&gt;12% &lt;i class="ti ti-trending-up"&gt;&lt;/i&gt;&lt;/div&gt;

&lt;!-- RIGHT: Use specific IDs for trend elements --&gt;
&lt;div class="text-muted small text-uppercase"&gt;REVENUE&lt;/div&gt;
&lt;div class="text-success me-2" id="revenue-trend"&gt;12% &lt;i class="ti ti-trending-up"&gt;&lt;/i&gt;&lt;/div&gt;

&lt;!-- JavaScript update --&gt;
const trendEl = document.getElementById('revenue-trend'); // Specific element
// NOT: document.querySelector('.text-muted'); // Too broad!</code></pre>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Chart Cross-Contamination -->
                <div class="alert alert-warning" role="alert">
                  <div class="d-flex">
                    <div>
                      <i class="ti ti-refresh alert-icon"></i>
                    </div>
                    <div>
                      <h4 class="alert-title">Chart Cross-Contamination</h4>
                      <div class="text-muted mb-2">
                        <strong>Symptom:</strong> All KPI cards update when changing one period
                      </div>
                      <div class="text-muted mb-2">
                        <strong>Cause:</strong> Calling global <code>updateCharts()</code> function
                      </div>
                      <div class="text-muted mb-3">
                        <strong>Solution:</strong> Use <code>updateSingleKPICard()</code> for individual updates
                      </div>
                      
                      <div class="code-preview">
                        <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                          <i class="ti ti-copy"></i>
                        </button>
                        <pre><code class="language-javascript">// WRONG: Updates all charts globally
function handleKPITimeChange(event) {
  const period = parseInt(event.target.dataset.period);
  updateCharts(period); // This affects ALL KPI cards!
}

// RIGHT: Update only the specific card
function handleKPITimeChange(event) {
  const clickedItem = event.target;
  const period = parseInt(clickedItem.dataset.period);
  const dropdown = clickedItem.closest('.dropdown');
  const kpiCard = dropdown.closest('.card');
  const kpiType = determineKPIType(kpiCard);
  
  // Update only this specific card
  updateSingleKPIData(period, kpiType, kpiCard, clickedItem.textContent.trim());
}</code></pre>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Icon Encoding Issues -->
                <div class="alert alert-info" role="alert">
                  <div class="d-flex">
                    <div>
                      <i class="ti ti-icons alert-icon"></i>
                    </div>
                    <div>
                      <h4 class="alert-title">Icon Encoding Issues</h4>
                      <div class="text-muted mb-2">
                        <strong>Symptom:</strong> Shows "â��" instead of trend icons
                      </div>
                      <div class="text-muted mb-2">
                        <strong>Cause:</strong> Incomplete icon class names
                      </div>
                      <div class="text-muted mb-3">
                        <strong>Solution:</strong> Always use full format <code>ti ti-trending-up</code>
                      </div>
                      
                      <div class="code-preview">
                        <button class="btn btn-sm btn-outline-secondary code-copy-btn" onclick="copyCode(this)">
                          <i class="ti ti-copy"></i>
                        </button>
                        <pre><code class="language-html">&lt;!-- WRONG: Missing 'ti' prefix --&gt;
&lt;i class="ti-trending-up"&gt;&lt;/i&gt;
&lt;i class="trending-up"&gt;&lt;/i&gt;

&lt;!-- WRONG: Inconsistent format --&gt;
&lt;i class="tabler-trending-up"&gt;&lt;/i&gt;

&lt;!-- RIGHT: Always use full Tabler format --&gt;
&lt;i class="ti ti-trending-up"&gt;&lt;/i&gt;
&lt;i class="ti ti-trending-down"&gt;&lt;/i&gt;
&lt;i class="ti ti-alert-circle"&gt;&lt;/i&gt;

&lt;!-- JavaScript icon updates --&gt;
let icon = `ti ti-trending-${data.trend || 'up'}`; // Ensures 'ti ti-' prefix
trendEl.innerHTML = `${value} &lt;i class="${icon}"&gt;&lt;/i&gt;`;</code></pre>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Testing Checklist -->
                <div class="card mt-4">
                  <div class="card-header">
                    <h4 class="card-title">
                      <i class="ti ti-checklist text-success me-2"></i>
                      Testing Checklist for KPI Changes
                    </h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>Functional Tests</h6>
                        <div class="list-group list-group-flush">
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-success"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Change period on one card</strong> - only that card updates
                              </div>
                            </div>
                          </div>
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-success"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Titles remain unchanged</strong> when updating values
                              </div>
                            </div>
                          </div>
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-success"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Icons display correctly</strong> (no weird characters)
                              </div>
                            </div>
                          </div>
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-success"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Charts update independently</strong>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <h6>Visual Tests</h6>
                        <div class="list-group list-group-flush">
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-info"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Desktop layout</strong> displays 4 cards in row
                              </div>
                            </div>
                          </div>
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-info"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Mobile carousel</strong> scrolls horizontally
                              </div>
                            </div>
                          </div>
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-info"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Loading states</strong> show during updates
                              </div>
                            </div>
                          </div>
                          <div class="list-group-item">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-info"></span>
                              </div>
                              <div class="col text-truncate">
                                <strong>Hover effects</strong> work on card interactions
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="mt-3">
                      <div class="alert alert-primary" role="alert">
                        <div class="d-flex">
                          <div>
                            <i class="ti ti-lightbulb alert-icon"></i>
                          </div>
                          <div>
                            <h4 class="alert-title">Pro Tip</h4>
                            Test KPI changes on both desktop and mobile views. Use browser dev tools to simulate different screen sizes and ensure the mobile carousel works smoothly.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </section>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Copy code functionality
function copyCode(button) {
  const codeBlock = button.nextElementSibling;
  const code = codeBlock.textContent || codeBlock.innerText;
  
  navigator.clipboard.writeText(code).then(function() {
    // Show success feedback
    const originalIcon = button.innerHTML;
    button.innerHTML = '<i class="ti ti-check text-success"></i>';
    setTimeout(() => {
      button.innerHTML = originalIcon;
    }, 2000);
  }, function(err) {
    console.error('Could not copy text: ', err);
  });
}

// Smooth scrolling for navigation links
document.querySelectorAll('.nav-pills .nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    
    // Update active state
    document.querySelectorAll('.nav-pills .nav-link').forEach(l => l.classList.remove('active'));
    this.classList.add('active');
    
    // Smooth scroll to section
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
});

// Update active nav based on scroll position
window.addEventListener('scroll', function() {
  const sections = document.querySelectorAll('.components-section');
  const navLinks = document.querySelectorAll('.nav-pills .nav-link');
  
  let current = '';
  sections.forEach(section => {
    const sectionTop = section.offsetTop;
    const sectionHeight = section.clientHeight;
    if (window.pageYOffset >= (sectionTop - 200)) {
      current = section.getAttribute('id');
    }
  });
  
  navLinks.forEach(link => {
    link.classList.remove('active');
    if (link.getAttribute('href') === '#' + current) {
      link.classList.add('active');
    }
  });
});
</script>

{% endblock %}