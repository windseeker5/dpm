{% extends "base.html" %}
{% block title %}Dashboard | Activities Overview{% endblock %}

{% block content %}
<div class="container-xl mt-4">
  <!-- Title -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="ti ti-dashboard text-primary me-2"></i> Dashboard: Your Activities Overview
    </h2>
  </div>

  <!-- KPI Cards -->
  <div class="row g-3 mb-4">
    <!-- Revenue -->
    <div class="col-md-3">
      <div class="card card-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted text-uppercase small">Revenue</div>
              <div class="h2 mb-1" id="revenue-value">$0</div>
              <div class="small" id="revenue-trend">0%</div>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm dropdown-toggle text-muted border-0 bg-transparent" data-bs-toggle="dropdown">
                <span id="revenue-period">Last 7 days</span>
              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item revenue-option" data-period="7d">Last 7 days</a>
                <a class="dropdown-item revenue-option" data-period="30d">Last 30 days</a>
                <a class="dropdown-item revenue-option" data-period="90d">Last 90 days</a>
                <a class="dropdown-item revenue-option" data-period="all">All time</a>
              </div>
            </div>
          </div>
          <canvas id="revenue-sparkline" height="30" class="mt-2 w-100"></canvas>
        </div>
      </div>
    </div>

    <!-- Active Passports -->
    <div class="col-md-3">
      <div class="card card-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted text-uppercase small">Active Passports</div>
              <div class="h2 mb-1" id="users-value">0</div>
              <div class="small" id="users-trend">0%</div>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm dropdown-toggle text-muted border-0 bg-transparent" data-bs-toggle="dropdown">
                <span id="users-period">Last 7 days</span>
              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item users-option" data-period="7d">Last 7 days</a>
                <a class="dropdown-item users-option" data-period="30d">Last 30 days</a>
                <a class="dropdown-item users-option" data-period="90d">Last 90 days</a>
                <a class="dropdown-item users-option" data-period="all">All time</a>
              </div>
            </div>
          </div>
          <canvas id="users-sparkline" height="30" class="mt-2 w-100"></canvas>
        </div>
      </div>
    </div>

    <!-- Passports Created -->
    <div class="col-md-3">
      <div class="card card-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted text-uppercase small">Passports Created</div>
              <div class="h2 mb-1" id="passes-value">0</div>
              <div class="small" id="passes-trend">0%</div>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm dropdown-toggle text-muted border-0 bg-transparent" data-bs-toggle="dropdown">
                <span id="passes-period">Last 7 days</span>
              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item passes-option" data-period="7d">Last 7 days</a>
                <a class="dropdown-item passes-option" data-period="30d">Last 30 days</a>
                <a class="dropdown-item passes-option" data-period="90d">Last 90 days</a>
                <a class="dropdown-item passes-option" data-period="all">All time</a>
              </div>
            </div>
          </div>
          <canvas id="passes-sparkline" height="30" class="mt-2 w-100"></canvas>
        </div>
      </div>
    </div>

    <!-- Pending Signups -->
    <div class="col-md-3">
      <div class="card card-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-muted text-uppercase small">Pending Signups</div>
              <div class="h2 mb-1" id="pending-value">0</div>
              <div class="small" id="pending-trend">0%</div>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm dropdown-toggle text-muted border-0 bg-transparent" data-bs-toggle="dropdown">
                <span id="pending-period">Last 7 days</span>
              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item pending-option" data-period="7d">Last 7 days</a>
                <a class="dropdown-item pending-option" data-period="30d">Last 30 days</a>
                <a class="dropdown-item pending-option" data-period="90d">Last 90 days</a>
                <a class="dropdown-item pending-option" data-period="all">All time</a>
              </div>
            </div>
          </div>
          <canvas id="pending-sparkline" height="30" class="mt-2 w-100"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Activities List -->
  <div class="row">
    {% for a in activities %}
      <div class="col-md-6 col-xl-4 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
              <i class="ti ti-calendar-event text-primary me-2"></i>{{ a.name }}
            </h3>
            <span class="badge bg-blue">{{ a.sessions_included }} sessions</span>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <i class="ti ti-user-check text-muted me-1"></i>
              <strong>{{ a.signups }}</strong> signups
            </div>
            <div class="mb-2">
              <i class="ti ti-ticket text-muted me-1"></i>
              <strong>{{ a.passports }}</strong> passports created
            </div>
            <div class="mb-2">
              <i class="ti ti-currency-dollar text-muted me-1"></i>
              <strong>{{ a.paid_passports }}</strong> paid
            </div>
            <div class="mb-2">
              <i class="ti ti-coin text-muted me-1"></i>
              Revenue: <strong>${{ "%.2f"|format(a.revenue) }}</strong>
            </div>
          </div>
          <div class="card-footer text-end">
            <a href="{{ url_for('activity_dashboard', activity_id=a.id) }}" class="btn btn-sm btn-outline-dark">
              <i class="ti ti-eye"></i> View Details
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const kpiData = {{ kpi_data | tojson }};

  function createSparkline(ctxId, type, trendList) {
    const ctx = document.getElementById(ctxId).getContext("2d");
    new Chart(ctx, {
      type: type,
      data: {
        labels: Array(trendList.length).fill(""),
        datasets: [{
          data: trendList,
          backgroundColor: type === "bar" ? "#206bc4" : "rgba(32,107,196,0.08)",
          borderColor: type === "line" ? "#206bc4" : undefined,
          fill: type === "line",
          tension: 0.4
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { x: { display: false }, y: { display: false } }
      }
    });
  }

  function updateCard(id, metric, period) {
    const current = kpiData[period][metric];
    const previous = kpiData[period][`${metric}_prev`] || 0;
    const trendList = kpiData[period][`${metric}_trend`] || [];
    const percent = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : "0.0";

    const val = metric === "revenue" ? `$${current.toLocaleString()}` : current;
    const trend = `<span class="${percent >= 0 ? 'text-green' : 'text-red'}">${percent}% ${percent >= 0 ? '↑' : '↓'}</span>`;

    document.getElementById(`${id}-value`).textContent = val;
    document.getElementById(`${id}-trend`).innerHTML = trend;

    const labelMap = {
      "7d": "Last 7 days",
      "30d": "Last 30 days",
      "90d": "Last 90 days",
      "all": "All time"
    };
    document.getElementById(`${id}-period`).textContent = labelMap[period];

    const chartType = id === "revenue" ? "line" : "bar";
    createSparkline(`${id}-sparkline`, chartType, trendList);
  }

  [
    { id: "revenue", metric: "revenue", selector: ".revenue-option" },
    { id: "passes", metric: "pass_created", selector: ".passes-option" },
    { id: "users", metric: "active_users", selector: ".users-option" },
    { id: "pending", metric: "pending_signups", selector: ".pending-option" }
  ].forEach(({ id, metric, selector }) => {
    document.querySelectorAll(selector).forEach(el => {
      el.addEventListener("click", () => updateCard(id, metric, el.dataset.period));
    });
    updateCard(id, metric, "7d");
  });
});
</script>
{% endblock %}
