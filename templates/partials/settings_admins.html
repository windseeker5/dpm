<!-- Gravatar Information Panel (shown only when needed) -->
<div class="alert alert-info mb-4 d-none" id="gravatar-info-panel" role="alert">
  <div class="d-flex">
    <div>
      <i class="ti ti-info-circle me-2"></i>
    </div>
    <div>
      <h4 class="alert-title">About Admin Avatars</h4>
      <div class="text-muted">
        Some admin accounts don't have a Gravatar profile picture. You can either:
        <a href="https://gravatar.com/connect" target="_blank" class="alert-link">
          Create a free Gravatar account
        </a> or upload a custom avatar image below.
      </div>
    </div>
  </div>
</div>

<!-- Admin List -->
<div id="admin-list">
  {% for admin in admins %}
  <div class="card admin-block mb-3" data-loaded="true">
    <div class="card-body">
      <div class="row g-3 align-items-start">
        <!-- Avatar Section -->
        <div class="col-12 col-md-2 text-center">
          <div class="avatar avatar-xl mx-auto mb-2" id="avatar-{{ loop.index }}" 
               data-email="{{ admin.email }}" 
               data-first-name="{{ admin.first_name or '' }}" 
               data-last-name="{{ admin.last_name or '' }}"
               data-avatar-filename="{{ admin.avatar_filename or '' }}">
            <!-- Avatar will be loaded via JavaScript -->
          </div>
          <div class="small text-muted admin-name-display" id="name-display-{{ loop.index }}">
            {% if admin.first_name or admin.last_name %}
              {{ admin.first_name or '' }} {{ admin.last_name or '' }}
            {% else %}
              <i class="ti ti-user me-1"></i>
              Admin
            {% endif %}
          </div>
          <!-- Avatar upload section (hidden by default) -->
          <div class="avatar-upload-section mt-2 d-none" style="font-size: 0.875rem;">
            <label class="btn btn-sm btn-outline-primary" style="cursor: pointer;">
              <i class="ti ti-upload me-1"></i> Upload
              <input type="file" name="admin_avatar_{{ loop.index }}" 
                     accept="image/*" class="d-none avatar-upload-input" 
                     data-index="{{ loop.index }}">
            </label>
            <div class="avatar-preview mt-2 d-none">
              <img src="" alt="Preview" class="img-thumbnail" style="max-width: 80px; max-height: 80px;">
            </div>
          </div>
        </div>
        
        <!-- Form Fields -->
        <div class="col-12 col-md-8">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Email Address</label>
              <input type="email" name="admin_email[]" value="{{ admin.email }}" 
                     class="form-control admin-email" required>
              <div class="form-hint">Used for login and Gravatar avatar</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">First Name</label>
              <input type="text" name="admin_first_name[]" value="{{ admin.first_name or '' }}" 
                     class="form-control admin-first-name" placeholder="John">
              <div class="form-hint">Used for display name and avatar initials</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name</label>
              <input type="text" name="admin_last_name[]" value="{{ admin.last_name or '' }}" 
                     class="form-control admin-last-name" placeholder="Doe">
              <div class="form-hint">Used for display name and avatar initials</div>
            </div>
            <div class="col-12">
              <label class="form-label">Password</label>
              <div class="input-group">
                <input type="password" name="admin_password[]" value="********"
                       class="form-control admin-password" data-is-placeholder="true" required>
                <button class="btn btn-outline-secondary toggle-password" type="button">
                  <i class="ti ti-eye"></i>
                </button>
              </div>
              <div class="password-strength mt-2 d-none">
                <div class="progress progress-sm">
                  <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="form-hint password-strength-text">Leave blank to keep current password</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="col-12 col-md-2 text-end">
          {% if admin.email != session.get('admin') %}
          <button type="button" class="btn btn-outline-danger remove-admin-btn">
            <i class="ti ti-trash"></i>
            <span class="d-none d-md-inline ms-1">Remove</span>
          </button>
          {% else %}
          <span class="badge bg-blue-lt">This is you</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Add Admin Button -->
<div class="d-grid gap-2 d-md-flex justify-content-md-start">
  <button type="button" class="btn btn-primary" id="add-admin-btn">
    <i class="ti ti-plus me-2"></i>
    Add New Admin
  </button>
</div>

<!-- Deletion tracking -->
<input type="hidden" name="deleted_admins" id="deleted_admins">

<!-- Error Container for friendly alerts -->
<div id="admin-errors"></div>

<!-- Custom CSS for avatar initials -->
<style>
.avatar-initials {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1.2rem;
  text-transform: uppercase;
  background-size: cover;
  background-position: center;
}

.avatar-initials:empty {
  background: #f8f9fa;
  border: 2px dashed #dee2e6;
}

/* Ensure proper sizing for different avatar sizes */
.avatar.avatar-xl.avatar-initials {
  width: 5rem;
  height: 5rem;
  font-size: 1.4rem;
}

.admin-name-display {
  font-weight: 500;
  margin-top: 0.5rem;
}

@media (max-width: 768px) {
  .admin-name-display {
    font-size: 0.875rem;
  }
}
</style>

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // MD5 implementation for Gravatar
  function md5(str) {
    // Simple MD5 implementation - good enough for Gravatar
    function rotateLeft(n, s) {
      return (n << s) | (n >>> (32 - s));
    }
    
    function addUnsigned(x, y) {
      const x4 = (x & 0x40000000);
      const y4 = (y & 0x40000000);
      const x8 = (x & 0x80000000);
      const y8 = (y & 0x80000000);
      const result = (x & 0x3FFFFFFF) + (y & 0x3FFFFFFF);
      if (x4 & y4) return (result ^ 0x80000000 ^ x8 ^ y8);
      if (x4 | y4) {
        if (result & 0x40000000) return (result ^ 0xC0000000 ^ x8 ^ y8);
        else return (result ^ 0x40000000 ^ x8 ^ y8);
      } else return (result ^ x8 ^ y8);
    }
    
    function f(x, y, z) { return (x & y) | ((~x) & z); }
    function g(x, y, z) { return (x & z) | (y & (~z)); }
    function h(x, y, z) { return (x ^ y ^ z); }
    function i(x, y, z) { return (y ^ (x | (~z))); }
    
    function ff(a, b, c, d, x, s, ac) {
      a = addUnsigned(a, addUnsigned(addUnsigned(f(b, c, d), x), ac));
      return addUnsigned(rotateLeft(a, s), b);
    }
    
    function gg(a, b, c, d, x, s, ac) {
      a = addUnsigned(a, addUnsigned(addUnsigned(g(b, c, d), x), ac));
      return addUnsigned(rotateLeft(a, s), b);
    }
    
    function hh(a, b, c, d, x, s, ac) {
      a = addUnsigned(a, addUnsigned(addUnsigned(h(b, c, d), x), ac));
      return addUnsigned(rotateLeft(a, s), b);
    }
    
    function ii(a, b, c, d, x, s, ac) {
      a = addUnsigned(a, addUnsigned(addUnsigned(i(b, c, d), x), ac));
      return addUnsigned(rotateLeft(a, s), b);
    }
    
    function convertToWordArray(str) {
      let lWordCount;
      const lMessageLength = str.length;
      const lNumberOfWords_temp1 = lMessageLength + 8;
      const lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
      const lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
      const lWordArray = Array(lNumberOfWords - 1);
      let lBytePosition = 0;
      let lByteCount = 0;
      while (lByteCount < lMessageLength) {
        lWordCount = (lByteCount - (lByteCount % 4)) / 4;
        lBytePosition = (lByteCount % 4) * 8;
        lWordArray[lWordCount] = (lWordArray[lWordCount] | (str.charCodeAt(lByteCount) << lBytePosition));
        lByteCount++;
      }
      lWordCount = (lByteCount - (lByteCount % 4)) / 4;
      lBytePosition = (lByteCount % 4) * 8;
      lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
      lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
      lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
      return lWordArray;
    }
    
    function wordToHex(lValue) {
      let wordToHexValue = '', wordToHexValue_temp = '', lByte, lCount;
      for (lCount = 0; lCount <= 3; lCount++) {
        lByte = (lValue >>> (lCount * 8)) & 255;
        wordToHexValue_temp = '0' + lByte.toString(16);
        wordToHexValue = wordToHexValue + wordToHexValue_temp.substr(wordToHexValue_temp.length - 2, 2);
      }
      return wordToHexValue;
    }
    
    const x = convertToWordArray(str);
    let a = 0x67452301, b = 0xEFCDAB89, c = 0x98BADCFE, d = 0x10325476;
    const S11 = 7, S12 = 12, S13 = 17, S14 = 22;
    const S21 = 5, S22 = 9, S23 = 14, S24 = 20;
    const S31 = 4, S32 = 11, S33 = 16, S34 = 23;
    const S41 = 6, S42 = 10, S43 = 15, S44 = 21;
    
    for (let k = 0; k < x.length; k += 16) {
      const AA = a, BB = b, CC = c, DD = d;
      a = ff(a, b, c, d, x[k], S11, 0xD76AA478);
      d = ff(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
      c = ff(c, d, a, b, x[k + 2], S13, 0x242070DB);
      b = ff(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
      a = ff(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
      d = ff(d, a, b, c, x[k + 5], S12, 0x4787C62A);
      c = ff(c, d, a, b, x[k + 6], S13, 0xA8304613);
      b = ff(b, c, d, a, x[k + 7], S14, 0xFD469501);
      a = ff(a, b, c, d, x[k + 8], S11, 0x698098D8);
      d = ff(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
      c = ff(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
      b = ff(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
      a = ff(a, b, c, d, x[k + 12], S11, 0x6B901122);
      d = ff(d, a, b, c, x[k + 13], S12, 0xFD987193);
      c = ff(c, d, a, b, x[k + 14], S13, 0xA679438E);
      b = ff(b, c, d, a, x[k + 15], S14, 0x49B40821);
      a = gg(a, b, c, d, x[k + 1], S21, 0xF61E2562);
      d = gg(d, a, b, c, x[k + 6], S22, 0xC040B340);
      c = gg(c, d, a, b, x[k + 11], S23, 0x265E5A51);
      b = gg(b, c, d, a, x[k], S24, 0xE9B6C7AA);
      a = gg(a, b, c, d, x[k + 5], S21, 0xD62F105D);
      d = gg(d, a, b, c, x[k + 10], S22, 0x2441453);
      c = gg(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
      b = gg(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
      a = gg(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
      d = gg(d, a, b, c, x[k + 14], S22, 0xC33707D6);
      c = gg(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
      b = gg(b, c, d, a, x[k + 8], S24, 0x455A14ED);
      a = gg(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
      d = gg(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
      c = gg(c, d, a, b, x[k + 7], S23, 0x676F02D9);
      b = gg(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
      a = hh(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
      d = hh(d, a, b, c, x[k + 8], S32, 0x8771F681);
      c = hh(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
      b = hh(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
      a = hh(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
      d = hh(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
      c = hh(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
      b = hh(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
      a = hh(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
      d = hh(d, a, b, c, x[k], S32, 0xEAA127FA);
      c = hh(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
      b = hh(b, c, d, a, x[k + 6], S34, 0x4881D05);
      a = hh(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
      d = hh(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
      c = hh(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
      b = hh(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
      a = ii(a, b, c, d, x[k], S41, 0xF4292244);
      d = ii(d, a, b, c, x[k + 7], S42, 0x432AFF97);
      c = ii(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
      b = ii(b, c, d, a, x[k + 5], S44, 0xFC93A039);
      a = ii(a, b, c, d, x[k + 12], S41, 0x655B59C3);
      d = ii(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
      c = ii(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
      b = ii(b, c, d, a, x[k + 1], S44, 0x85845DD1);
      a = ii(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
      d = ii(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
      c = ii(c, d, a, b, x[k + 6], S43, 0xA3014314);
      b = ii(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
      a = ii(a, b, c, d, x[k + 4], S41, 0xF7537E82);
      d = ii(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
      c = ii(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
      b = ii(b, c, d, a, x[k + 9], S44, 0xEB86D391);
      a = addUnsigned(a, AA);
      b = addUnsigned(b, BB);
      c = addUnsigned(c, CC);
      d = addUnsigned(d, DD);
    }
    
    const temp = wordToHex(a) + wordToHex(b) + wordToHex(c) + wordToHex(d);
    return temp.toLowerCase();
  }

  // Generate initials from name
  function generateInitials(firstName, lastName) {
    const first = (firstName || '').trim();
    const last = (lastName || '').trim();
    
    if (!first && !last) return 'AD'; // Admin Default
    if (!last) return first.charAt(0).toUpperCase();
    return (first.charAt(0) + last.charAt(0)).toUpperCase();
  }

  // Track which admins have no Gravatar
  let adminsWithoutGravatar = new Set();
  
  // Load avatars with smart detection
  function loadAvatars() {
    let hasAnyWithoutGravatar = false;
    const promises = [];
    
    document.querySelectorAll('[id^="avatar-"]').forEach(avatarDiv => {
      const adminBlock = avatarDiv.closest('.admin-block');
      const email = avatarDiv.dataset.email || adminBlock.querySelector('.admin-email')?.value;
      const firstName = avatarDiv.dataset.firstName || adminBlock.querySelector('.admin-first-name')?.value || '';
      const lastName = avatarDiv.dataset.lastName || adminBlock.querySelector('.admin-last-name')?.value || '';
      const avatarFilename = avatarDiv.dataset.avatarFilename;
      const uploadSection = adminBlock.querySelector('.avatar-upload-section');
      
      // Generate initials for fallback
      const initials = generateInitials(firstName, lastName);
      avatarDiv.dataset.initials = initials;
      
      // Check if custom avatar exists
      if (avatarFilename && avatarFilename !== '') {
        // Use custom uploaded avatar
        avatarDiv.style.backgroundImage = `url(/static/uploads/avatars/${avatarFilename})`;
        avatarDiv.textContent = '';
        avatarDiv.classList.remove('avatar-initials');
        if (uploadSection) uploadSection.classList.add('d-none');
      } else if (email) {
        // Try Gravatar
        const emailLower = email.trim().toLowerCase();
        const gravatarHash = md5(emailLower);
        
        const promise = new Promise((resolve) => {
          const testImg = new Image();
          testImg.onload = function() {
            // Gravatar exists, use it
            avatarDiv.style.backgroundImage = `url(https://www.gravatar.com/avatar/${gravatarHash}?s=96)`;
            avatarDiv.textContent = '';
            avatarDiv.classList.remove('avatar-initials');
            if (uploadSection) uploadSection.classList.add('d-none');
            resolve(true);
          };
          testImg.onerror = function() {
            // No Gravatar - show upload option and use initials
            avatarDiv.style.backgroundImage = '';
            avatarDiv.textContent = initials;
            avatarDiv.classList.add('avatar-initials');
            if (uploadSection) uploadSection.classList.remove('d-none');
            adminsWithoutGravatar.add(email);
            hasAnyWithoutGravatar = true;
            resolve(false);
          };
          testImg.src = `https://www.gravatar.com/avatar/${gravatarHash}?d=404&s=96`;
        });
        promises.push(promise);
      } else {
        // No email - just use initials
        avatarDiv.textContent = initials;
        avatarDiv.classList.add('avatar-initials');
        if (uploadSection) uploadSection.classList.remove('d-none');
      }
    });
    
    // After all checks, show/hide the info panel
    Promise.all(promises).then(() => {
      const infoPanel = document.getElementById('gravatar-info-panel');
      if (infoPanel) {
        if (hasAnyWithoutGravatar) {
          infoPanel.classList.remove('d-none');
        } else {
          infoPanel.classList.add('d-none');
        }
      }
    });
  }

  // Update display name
  function updateDisplayName(adminBlock) {
    const firstName = adminBlock.querySelector('.admin-first-name')?.value?.trim() || '';
    const lastName = adminBlock.querySelector('.admin-last-name')?.value?.trim() || '';
    const nameDisplay = adminBlock.querySelector('.admin-name-display');
    
    if (nameDisplay) {
      if (firstName || lastName) {
        nameDisplay.innerHTML = `${firstName} ${lastName}`.trim();
      } else {
        nameDisplay.innerHTML = '<i class="ti ti-user me-1"></i>Admin';
      }
    }
  }

  // Initial load of avatars
  loadAvatars();

  // Handle avatar file uploads
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('avatar-upload-input')) {
      const file = e.target.files[0];
      const adminBlock = e.target.closest('.admin-block');
      const avatarDiv = adminBlock.querySelector('[id^="avatar-"]');
      const previewSection = adminBlock.querySelector('.avatar-preview');
      const previewImg = previewSection?.querySelector('img');
      
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Update avatar display
          if (avatarDiv) {
            avatarDiv.style.backgroundImage = `url(${e.target.result})`;
            avatarDiv.textContent = '';
            avatarDiv.classList.remove('avatar-initials');
          }
          // Show preview
          if (previewImg) {
            previewImg.src = e.target.result;
            previewSection.classList.remove('d-none');
          }
        };
        reader.readAsDataURL(file);
      }
    }
  });
  
  // Update avatar and display name on input changes
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('admin-email') || 
        e.target.classList.contains('admin-first-name') || 
        e.target.classList.contains('admin-last-name')) {
      const adminBlock = e.target.closest('.admin-block');
      const avatarDiv = adminBlock.querySelector('[id^="avatar-"]');
      const uploadSection = adminBlock.querySelector('.avatar-upload-section');
      
      if (avatarDiv) {
        const email = adminBlock.querySelector('.admin-email')?.value || '';
        const firstName = adminBlock.querySelector('.admin-first-name')?.value || '';
        const lastName = adminBlock.querySelector('.admin-last-name')?.value || '';
        const avatarFilename = avatarDiv.dataset.avatarFilename;
        
        // Update avatar data attributes
        avatarDiv.dataset.email = email;
        avatarDiv.dataset.firstName = firstName;
        avatarDiv.dataset.lastName = lastName;
        
        // Generate initials
        const initials = generateInitials(firstName, lastName);
        avatarDiv.dataset.initials = initials;
        
        // Only update avatar if no custom upload
        const fileInput = adminBlock.querySelector('.avatar-upload-input');
        if (!fileInput?.files?.length && !avatarFilename) {
          avatarDiv.textContent = initials;
          avatarDiv.classList.add('avatar-initials');
          
          // Try Gravatar if email exists
          if (email) {
            const emailLower = email.trim().toLowerCase();
            const gravatarHash = md5(emailLower);
            
            const testImg = new Image();
            testImg.onload = function() {
              avatarDiv.style.backgroundImage = `url(https://www.gravatar.com/avatar/${gravatarHash}?s=96)`;
              avatarDiv.textContent = '';
              avatarDiv.classList.remove('avatar-initials');
              if (uploadSection) uploadSection.classList.add('d-none');
              // Remove from no-gravatar set
              adminsWithoutGravatar.delete(email);
              updateGravatarInfoPanel();
            };
            testImg.onerror = function() {
              avatarDiv.style.backgroundImage = '';
              avatarDiv.textContent = initials;
              avatarDiv.classList.add('avatar-initials');
              if (uploadSection) uploadSection.classList.remove('d-none');
              // Add to no-gravatar set
              adminsWithoutGravatar.add(email);
              updateGravatarInfoPanel();
            };
            testImg.src = `https://www.gravatar.com/avatar/${gravatarHash}?d=404&s=96`;
          } else {
            avatarDiv.style.backgroundImage = '';
            if (uploadSection) uploadSection.classList.remove('d-none');
          }
        }
        
        // Update display name
        updateDisplayName(adminBlock);
      }
    }
  });
  
  // Helper to update Gravatar info panel visibility
  function updateGravatarInfoPanel() {
    const infoPanel = document.getElementById('gravatar-info-panel');
    if (infoPanel) {
      if (adminsWithoutGravatar.size > 0) {
        infoPanel.classList.remove('d-none');
      } else {
        infoPanel.classList.add('d-none');
      }
    }
  }

  // Password strength indicator
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('admin-password')) {
      const password = e.target.value;
      const adminBlock = e.target.closest('.admin-block');
      const strengthDiv = adminBlock.querySelector('.password-strength');
      const progressBar = strengthDiv.querySelector('.progress-bar');
      const strengthText = strengthDiv.querySelector('.password-strength-text');
      
      // Mark as not placeholder once user starts typing
      if (e.target.dataset.isPlaceholder === 'true' && password !== '********') {
        e.target.dataset.isPlaceholder = 'false';
      }
      
      if (password && password !== '********') {
        strengthDiv.classList.remove('d-none');
        
        // Calculate password strength
        let strength = 0;
        let strengthClass = 'bg-danger';
        let strengthMessage = 'Weak password';
        
        if (password.length >= 8) strength += 25;
        if (/[a-z]/.test(password)) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 12.5;
        if (/[^A-Za-z0-9]/.test(password)) strength += 12.5;
        
        if (strength >= 75) {
          strengthClass = 'bg-success';
          strengthMessage = 'Strong password';
        } else if (strength >= 50) {
          strengthClass = 'bg-warning';
          strengthMessage = 'Fair password';
        }
        
        progressBar.style.width = strength + '%';
        progressBar.className = 'progress-bar ' + strengthClass;
        strengthText.textContent = strengthMessage;
      } else if (password === '' || password === '********') {
        strengthDiv.classList.add('d-none');
      }
    }
  });

  // Toggle password visibility
  document.addEventListener("click", function (e) {
    if (e.target.closest(".toggle-password")) {
      const button = e.target.closest(".toggle-password");
      const group = button.closest(".input-group");
      const input = group.querySelector("input");
      const icon = button.querySelector("i");
      
      if (input.type === "password") {
        input.type = "text";
        icon.classList.replace("ti-eye", "ti-eye-off");
      } else {
        input.type = "password";
        icon.classList.replace("ti-eye-off", "ti-eye");
      }
    }
  });

  // Remove admin with confirmation
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-admin-btn')) {
      const button = e.target.closest('.remove-admin-btn');
      const block = button.closest(".admin-block");
      const email = block.querySelector('.admin-email').value;
      
      if (confirm(`Are you sure you want to remove admin: ${email}?`)) {
        // Track deletion
        const deletedField = document.getElementById("deleted_admins");
        let current = deletedField.value ? deletedField.value.split(",") : [];
        if (email && !current.includes(email)) {
          current.push(email);
          deletedField.value = current.join(",");
        }
        
        // Animate removal
        block.style.transition = 'opacity 0.3s, transform 0.3s';
        block.style.opacity = '0';
        block.style.transform = 'translateX(-20px)';
        setTimeout(() => block.remove(), 300);
      }
    }
  });

  // Add new admin
  document.getElementById('add-admin-btn').addEventListener('click', function() {
    const adminList = document.getElementById("admin-list");
    const newIndex = adminList.children.length + 1;
    
    const newCard = document.createElement("div");
    newCard.className = "card admin-block mb-3";
    newCard.style.opacity = '0';
    newCard.innerHTML = `
      <div class="card-body">
        <div class="row g-3 align-items-start">
          <!-- Avatar Section -->
          <div class="col-12 col-md-2 text-center">
            <div class="avatar avatar-xl mx-auto mb-2 avatar-initials" id="avatar-${newIndex}" 
                 data-email="" data-first-name="" data-last-name="" data-avatar-filename="">
              AD
            </div>
            <div class="small text-muted admin-name-display">
              <i class="ti ti-user me-1"></i>
              New Admin
            </div>
            <!-- Avatar upload section -->
            <div class="avatar-upload-section mt-2" style="font-size: 0.875rem;">
              <label class="btn btn-sm btn-outline-primary" style="cursor: pointer;">
                <i class="ti ti-upload me-1"></i> Upload
                <input type="file" name="admin_avatar_${newIndex}" 
                       accept="image/*" class="d-none avatar-upload-input" 
                       data-index="${newIndex}">
              </label>
              <div class="avatar-preview mt-2 d-none">
                <img src="" alt="Preview" class="img-thumbnail" style="max-width: 80px; max-height: 80px;">
              </div>
            </div>
          </div>
          
          <!-- Form Fields -->
          <div class="col-12 col-md-8">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Email Address</label>
                <input type="email" name="admin_email[]" 
                       class="form-control admin-email" required placeholder="admin@example.com">
                <div class="form-hint">Used for login and Gravatar avatar</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" name="admin_first_name[]" 
                       class="form-control admin-first-name" placeholder="John" required>
                <div class="form-hint">Required for new admins</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Last Name</label>
                <input type="text" name="admin_last_name[]" 
                       class="form-control admin-last-name" placeholder="Doe">
                <div class="form-hint">Used for display name and avatar initials</div>
              </div>
              <div class="col-12">
                <label class="form-label">Password</label>
                <div class="input-group">
                  <input type="password" name="admin_password[]" 
                         class="form-control admin-password" required placeholder="Enter password">
                  <button class="btn btn-outline-secondary toggle-password" type="button">
                    <i class="ti ti-eye"></i>
                  </button>
                </div>
                <div class="password-strength mt-2 d-none">
                  <div class="progress progress-sm">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                  </div>
                  <div class="form-hint password-strength-text">Enter a strong password</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Actions -->
          <div class="col-12 col-md-2 text-end">
            <button type="button" class="btn btn-outline-danger remove-admin-btn">
              <i class="ti ti-trash"></i>
              <span class="d-none d-md-inline ms-1">Remove</span>
            </button>
          </div>
        </div>
      </div>
    `;
    
    adminList.appendChild(newCard);
    
    // Animate appearance
    setTimeout(() => {
      newCard.style.transition = 'opacity 0.3s';
      newCard.style.opacity = '1';
    }, 10);
    
    // Focus on email field
    newCard.querySelector('.admin-email').focus();
  });

  // Enhanced form validation
  document.querySelector("form").addEventListener("submit", function (e) {
    // Clear previous errors
    const existingErrors = document.querySelector('.alert-danger');
    if (existingErrors) existingErrors.remove();
    
    let valid = true;
    const errors = [];
    const emails = new Set();

    document.querySelectorAll('.admin-block').forEach(block => {
      const email = block.querySelector('input[name="admin_email[]"]').value.trim();
      const passwordInput = block.querySelector('input[name="admin_password[]"]');
      const password = passwordInput.value.trim();

      // Check for duplicate emails
      if (email) {
        if (emails.has(email.toLowerCase())) {
          errors.push(`Duplicate email address: ${email}`);
          valid = false;
        }
        emails.add(email.toLowerCase());
      }

      // Handle placeholder passwords
      if (password === "********" && passwordInput.dataset.isPlaceholder === "true") {
        passwordInput.value = "";
      }

      // Check if new admin has password and first name
      if (!block.dataset.loaded) {
        const firstName = block.querySelector('input[name="admin_first_name[]"]').value.trim();
        
        if (email && !password) {
          errors.push(`Please enter a password for new admin: ${email}`);
          valid = false;
        }
        
        if (email && !firstName) {
          errors.push(`Please enter a first name for new admin: ${email}`);
          valid = false;
        }
      }
    });

    if (!valid) {
      e.preventDefault();
      
      // Show errors using Tabler alert
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible mb-3';
      alertDiv.innerHTML = `
        <div class="d-flex">
          <div>
            <i class="ti ti-alert-circle me-2"></i>
          </div>
          <div>
            <h4 class="alert-title">Please fix the following errors:</h4>
            <ul class="mb-0">
              ${errors.map(err => `<li>${err}</li>`).join('')}
            </ul>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      const adminList = document.getElementById('admin-list');
      adminList.parentNode.insertBefore(alertDiv, adminList);
      
      // Scroll to error
      alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
});
</script>