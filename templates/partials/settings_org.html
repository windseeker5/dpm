<!-- Organization Settings with Tabler.io -->
<div class="card mb-4">
  <div class="card-body">

    <!-- Organization Name -->
    <div class="mb-3">
      <label class="form-label">Organization Name</label>
      <input type="text" name="ORG_NAME" class="form-control" value="{{ settings.get('ORG_NAME', '') }}">
    </div>

    <!-- Call-Back Days -->
    <div class="mb-3">
      <label class="form-label">Call-Back Delay (days) if unpaid</label>
      <input type="number" name="CALL_BACK_DAYS" class="form-control" min="0" value="{{ settings.get('CALL_BACK_DAYS', '0') }}">
    </div>

    <!-- Default Pass Settings -->
    <div class="mb-3">
      <label class="form-label">Default Pass Amount ($)</label>
      <input type="number" name="default_pass_amount" class="form-control" min="0" value="{{ settings.get('DEFAULT_PASS_AMOUNT', '50') }}">
    </div>

    <div class="mb-3">
      <label class="form-label">Default Session Quantity</label>
      <input type="number" name="default_session_qt" class="form-control" min="1" value="{{ settings.get('DEFAULT_SESSION_QT', '4') }}">
    </div>

    <!-- Email Templates Text -->
    <div class="mb-3">
      <label class="form-label">Email Info Text</label>
      <textarea name="email_info_text" class="form-control" rows="3" placeholder="Additional info text for emails">{{ settings.get('EMAIL_INFO_TEXT', '') }}</textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Email Footer Text</label>
      <textarea name="email_footer_text" class="form-control" rows="3" placeholder="Footer text for emails">{{ settings.get('EMAIL_FOOTER_TEXT', '') }}</textarea>
    </div>

    <!-- Activity Tags -->
    <div class="mb-3">
      <label class="form-label">Activity Tags (comma-separated)</label>
      <input type="text" name="activities" class="form-control" value="{% if settings.get('ACTIVITY_LIST') %}{{ settings.ACTIVITY_LIST | replace('["', '') | replace('"]', '') | replace('"', '') | replace(',', ', ') }}{% endif %}" placeholder="swimming, running, cycling, yoga">
      <div class="form-text">Enter activity categories separated by commas</div>
    </div>

    <!-- Logo Upload -->
    <div class="mb-3">
      <label class="form-label">Upload Logo</label>
    
      <div class="mb-2">
        <img id="logo-preview" 
             src="{{ url_for('static', filename='uploads/' ~ settings.LOGO_FILENAME) if settings.LOGO_FILENAME else '' }}" 
             alt="Logo Preview"
             style="max-height: 80px; display: {{ 'block' if settings.LOGO_FILENAME else 'none' }};">
      </div>
    
      <input type="file" name="ORG_LOGO_FILE" class="form-control" accept="image/*" id="logo-file-input">
    </div>
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("logo-file-input");
        const preview = document.getElementById("logo-preview");
      
        if (fileInput && preview) {
          fileInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith("image/")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = "block";
              };
              reader.readAsDataURL(file);
            } else {
              preview.src = "";
              preview.style.display = "none";
            }
          });
        }
      });
      </script>
      






  </div>
</div>

<!-- Organization Email Configuration -->
<div class="card mb-4">
  <div class="card-header">
    <h4 class="card-title">
      <i class="ti ti-mail"></i>
      Organization Email Settings
    </h4>
    <p class="text-muted mb-0">Configure custom email settings for different organizations</p>
  </div>
  <div class="card-body">
    
    <!-- Organization List -->
    <div id="organizations-list" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Configured Organizations</h5>
        <button class="btn btn-primary btn-sm" onclick="showCreateOrgModal()">
          <i class="ti ti-plus"></i>
          Add Organization
        </button>
      </div>
      
      <div id="organizations-container">
        <div class="text-muted text-center py-4">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 mb-0">Loading organizations...</p>
        </div>
      </div>
    </div>
    
    <!-- Quick Test Organization Button (Development) -->
    <div class="border-top pt-3">
      <h6>Development Tools</h6>
      <button class="btn btn-outline-info btn-sm" onclick="createTestOrg()">
        <i class="ti ti-flask"></i>
        Create LHGI Test Organization
      </button>
      <small class="form-text text-muted">Creates a test organization with provided credentials</small>
    </div>
  </div>
</div>


<!-- JavaScript for Organization Management -->
<script>
// Global variables
let currentOrgId = null;
let isEditMode = false;

// Load organizations on page load
document.addEventListener('DOMContentLoaded', function() {
  loadOrganizations();
});

// Load and display organizations
function loadOrganizations() {
  fetch('/admin/organizations')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('organizations-container');
      
      if (data.organizations && data.organizations.length > 0) {
        container.innerHTML = '';
        data.organizations.forEach(org => {
          container.appendChild(createOrganizationCard(org));
        });
      } else {
        container.innerHTML = '<div class="text-muted text-center py-4"><p>No organizations configured yet.</p></div>';
      }
    })
    .catch(error => {
      console.error('Error loading organizations:', error);
      document.getElementById('organizations-container').innerHTML = 
        '<div class="alert alert-danger">Failed to load organizations</div>';
    });
}

// Create organization card HTML
function createOrganizationCard(org) {
  const card = document.createElement('div');
  card.className = 'card mb-3';
  card.innerHTML = `
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col">
          <h6 class="mb-1">${org.name}</h6>
          <p class="text-muted mb-1">
            <i class="ti ti-mail"></i> ${org.full_email}
            ${org.sender_name ? ` • Sender: ${org.sender_name}` : ''}
          </p>
          <small class="text-muted">
            Server: ${org.mail_server || 'Not configured'} • 
            Status: <span class="badge ${org.email_enabled ? 'bg-success' : 'bg-secondary'}">
              ${org.email_enabled ? 'Enabled' : 'Disabled'}
            </span>
          </small>
        </div>
        <div class="col-auto">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="testOrganizationEmail(${org.id})" 
                    title="Test Email">
              <i class="ti ti-mail-check"></i>
            </button>
            <button class="btn btn-outline-secondary" onclick="editOrganization(${org.id})" 
                    title="Edit">
              <i class="ti ti-edit"></i>
            </button>
            <button class="btn ${org.email_enabled ? 'btn-outline-warning' : 'btn-outline-success'}" 
                    onclick="toggleOrganizationEmail(${org.id})" 
                    title="${org.email_enabled ? 'Disable' : 'Enable'}">
              <i class="ti ${org.email_enabled ? 'ti-eye-off' : 'ti-eye'}"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteOrganization(${org.id})" 
                    title="Delete">
              <i class="ti ti-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  return card;
}

// Show create organization modal
function showCreateOrgModal() {
  isEditMode = false;
  currentOrgId = null;
  document.getElementById('orgModalLabel').textContent = 'Add Organization';
  document.getElementById('orgForm').reset();
  document.getElementById('orgUseTLS').checked = true;
  
  const modal = new bootstrap.Modal(document.getElementById('orgModal'));
  modal.show();
}

// Edit organization
function editOrganization(orgId) {
  // In a real implementation, you'd fetch the organization data
  // For now, just show the modal
  isEditMode = true;
  currentOrgId = orgId;
  document.getElementById('orgModalLabel').textContent = 'Edit Organization';
  
  const modal = new bootstrap.Modal(document.getElementById('orgModal'));
  modal.show();
}

// Save organization (create or update)
function saveOrganization() {
  const form = document.getElementById('orgForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  
  // Convert checkbox to boolean
  data.org_mail_use_tls = document.getElementById('orgUseTLS').checked;
  
  const url = isEditMode ? `/admin/organizations/${currentOrgId}/update` : '/admin/organizations/create';
  const method = isEditMode ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      bootstrap.Modal.getInstance(document.getElementById('orgModal')).hide();
      loadOrganizations();
      showAlert(result.message, 'success');
    } else {
      showAlert(result.error || 'Failed to save organization', 'danger');
    }
  })
  .catch(error => {
    console.error('Error saving organization:', error);
    showAlert('Failed to save organization', 'danger');
  });
}

// Test organization email configuration
function testOrganizationEmail(orgId) {
  fetch(`/admin/organizations/${orgId}/test`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(result => {
    const alertType = result.success ? 'success' : 'danger';
    showAlert(result.message, alertType);
  })
  .catch(error => {
    console.error('Error testing email:', error);
    showAlert('Failed to test email configuration', 'danger');
  });
}

// Toggle organization email enabled/disabled
function toggleOrganizationEmail(orgId) {
  fetch(`/admin/organizations/${orgId}/toggle`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      loadOrganizations();
      showAlert(result.message, 'success');
    } else {
      showAlert(result.error || 'Failed to toggle organization', 'danger');
    }
  })
  .catch(error => {
    console.error('Error toggling organization:', error);
    showAlert('Failed to toggle organization', 'danger');
  });
}

// Delete organization
function deleteOrganization(orgId) {
  if (!confirm('Are you sure you want to deactivate this organization? This will disable its email configuration.')) {
    return;
  }
  
  fetch(`/admin/organizations/${orgId}/delete`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      loadOrganizations();
      showAlert(result.message, 'success');
    } else {
      showAlert(result.error || 'Failed to delete organization', 'danger');
    }
  })
  .catch(error => {
    console.error('Error deleting organization:', error);
    showAlert('Failed to delete organization', 'danger');
  });
}

// Create test organization
function createTestOrg() {
  if (!confirm('This will create a test LHGI organization with the provided credentials. Continue?')) {
    return;
  }
  
  fetch('/admin/create-test-org', {
    method: 'POST'
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      loadOrganizations();
      showAlert(result.message, 'success');
    } else {
      showAlert(result.error || 'Failed to create test organization', 'danger');
    }
  })
  .catch(error => {
    console.error('Error creating test organization:', error);
    showAlert('Failed to create test organization', 'danger');
  });
}

// Show alert message
function showAlert(message, type = 'info') {
  // Create alert element
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show`;
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  // Insert at top of organizations section
  const container = document.getElementById('organizations-list');
  container.insertBefore(alert, container.firstChild);
  
  // Auto-dismiss after 5 seconds
  setTimeout(() => {
    if (alert.parentNode) {
      alert.remove();
    }
  }, 5000);
}
</script>

