{% extends "base.html" %}
{% block title %}
  {{ "Edit Activity" if activity else "Create New Activity" }}
{% endblock %}

{% block content %}
<div class="container-xl mt-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <form method="POST" enctype="multipart/form-data" class="card shadow-sm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="card-header">
          <h3 class="card-title">
            <i class="ti ti-activity me-2"></i>
            {{ "Edit Activity" if activity else "Create New Activity" }}
          </h3>
        </div>

        <div class="card-body">

          <!-- Activity Name -->
          <div class="mb-3">
            <label class="form-label required">Activity Name</label>
            <input type="text" class="form-control" name="name"
                   value="{{ activity.name if activity else '' }}" 
                   placeholder="Enter activity name (e.g., Hockey Training, Yoga Classes)"
                   required>
          </div>

          <div class="row">
            <!-- Activity Type -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Activity Type</label>
              <input type="text" class="form-control" name="type"
                     value="{{ activity.type if activity else '' }}"
                     placeholder="e.g., Sports, Fitness, Workshop">
            </div>

            <!-- Activity Status -->
            <div class="col-md-6 mb-3">
              <label class="form-label required">Status</label>
              <select class="form-select" name="status" required>
                {% set current_status = activity.status if activity else 'active' %}
                <option value="active" {{ 'selected' if current_status == 'active' else '' }}>Active</option>
                <option value="draft" {{ 'selected' if current_status == 'draft' else '' }}>Draft</option>
                <option value="archived" {{ 'selected' if current_status == 'archived' else '' }}>Archived</option>
              </select>
            </div>
          </div>



          <!-- Description -->
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="3">{{ activity.description if activity else '' }}</textarea>
          </div>

          <!-- Location Section (Optional) -->
          <div class="mb-3">
            <label class="form-label">Activity Location (Optional)</label>
            <div class="row g-3">
              <div class="col-12">
                <input type="text"
                       class="form-control"
                       id="locationInput"
                       placeholder="Enter address (e.g., Complexe Desjardins, Montreal)"
                       value="{{ activity.location_address_raw if activity and activity.location_address_raw else '' }}">
                <small class="form-text text-muted">
                  Enter the location where this activity takes place (e.g., arena, gym, studio)
                </small>
              </div>
              <div class="col-12">
                <button type="button" id="verifyLocationBtn" class="btn btn-primary">
                  <i class="ti ti-search me-2"></i>Verify Location
                </button>
              </div>
            </div>

            <!-- Verified Location Display (hidden initially) -->
            <div id="locationVerifiedSection" class="mt-3" style="display: none;">
              <div id="locationVerifiedAlert" class="alert alert-success d-flex align-items-center" role="alert">
                <i class="ti ti-check icon me-2"></i>
                <div class="flex-grow-1">
                  <strong id="locationStatusTitle">Location Verified!</strong>
                  <div id="verifiedAddressDisplay" class="mt-1"></div>
                  <div id="locationApprovedMessage" class="mt-1 text-muted small" style="display: none;">
                    Ready to save this activity
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="button" id="approveLocationBtn" class="btn btn-success">
                  <i class="ti ti-check me-2"></i>Approve Location
                </button>
                <button type="button" id="clearLocationBtn" class="btn btn-secondary">
                  <i class="ti ti-refresh me-2"></i>Change Location
                </button>
                <a href="#" id="viewOnMapLink" target="_blank" class="btn btn-outline-primary">
                  <i class="ti ti-map-pin me-2"></i>View on Map
                </a>
              </div>
            </div>

            <!-- Location Error Display (hidden initially) -->
            <div id="locationErrorSection" class="mt-3 alert alert-warning" style="display: none;">
              <i class="ti ti-alert-circle icon me-2"></i>
              <span id="locationErrorMessage"></span>
            </div>

            <!-- Loading Indicator -->
            <div id="locationLoadingSection" class="mt-3" style="display: none;">
              <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <span>Verifying location...</span>
              </div>
            </div>

            <!-- Hidden fields to store location data -->
            <input type="hidden" name="location_address_raw" id="locationAddressRaw" value="{{ activity.location_address_raw if activity and activity.location_address_raw else '' }}">
            <input type="hidden" name="location_address_formatted" id="locationAddressFormatted" value="{{ activity.location_address_formatted if activity and activity.location_address_formatted else '' }}">
            <input type="hidden" name="location_coordinates" id="locationCoordinates" value="{{ activity.location_coordinates if activity and activity.location_coordinates else '' }}">
          </div>

          <!-- Start and End Dates (with spacing) -->
          <div class="row mt-4">
            <div class="col-md-6 mb-3">
              <label class="form-label">Activity Start Date</label>
              <input type="date" name="start_date" class="form-control" value="{{ activity.start_date.strftime('%Y-%m-%d') if activity and activity.start_date else '' }}">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Activity End Date</label>
              <input type="date" name="end_date" class="form-control" value="{{ activity.end_date.strftime('%Y-%m-%d') if activity and activity.end_date else '' }}">
            </div>
          </div>

          <!-- Activity Target Revenue -->
          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label">Activity Target Revenue (Optional)</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number"
                       class="form-control"
                       name="goal_revenue"
                       step="0.01"
                       min="0"
                       placeholder="0.00"
                       value="{{ '%.2f'|format(activity.goal_revenue) if activity and activity.goal_revenue else '' }}">
              </div>
              <small class="form-text text-muted">
                Set a revenue goal to track progress on your activity dashboard
              </small>
            </div>
          </div>

          <!-- Image Section -->
          <div class="mb-3 image-section">
            <label class="form-label">Activity Cover Photo</label>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="toggleOnlineImage">
                  <span class="form-check-label">Search images from the Web</span>
                </label>
              </div>
              <div class="col-md-6">
                <label class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="toggleUploadImage">
                  <span class="form-check-label">Upload your own image</span>
                </label>
              </div>
            </div>

            <div id="onlineImageSection" class="mt-3" style="display:none;">
              <div class="input-group">
                <input type="text" id="imageDescription" class="form-control" placeholder="e.g., Hockey, Yoga, Cooking">
                <button type="button" id="searchImagesBtn" class="btn btn-primary">
                  <i class="ti ti-search"></i> Search
                </button>
              </div>
            </div>
          </div>

          <div id="uploadImageSection" class="mt-3" style="display:none;">
            <label class="form-label">Upload Image (Max 10MB)</label>
            <input type="file" name="upload_image" class="form-control" id="uploadInput">
          </div>



          <!-- Selected Image Preview -->
          <div id="imagePreviewContainer" class="mt-4 text-start" style="{{ 'display:block;' if activity and activity.image_filename else 'display:none;' }}">
            <h6 id="imagePreviewTitle" class="mb-3" style="{{ 'display:block;' if activity and activity.image_filename else 'display:none;' }}">Selected Image Preview</h6>
            <div class="position-relative d-inline-block">
              {% if activity and activity.image_filename %}
                <img id="selectedImagePreview"
                    src="{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}"
                    class="img-fluid rounded shadow-sm mb-2"
                    style="max-height:250px;">
              {% else %}
                <img id="selectedImagePreview"
                    src=""
                    class="img-fluid rounded shadow-sm mb-2"
                    style="max-height:250px;">
              {% endif %}
              
              <button type="button"
                      id="removeImageBtn"
                      class="btn btn-danger position-absolute top-0 end-0 m-2"
                      style="z-index:10;"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteImageModal">
                <i class="ti ti-trash"></i>
              </button>
            </div>
          </div>

          <input type="hidden" name="selected_image_filename" id="selectedImageFilename" value="{{ activity.image_filename if activity else '' }}">




          <!-- Passport Types Section -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Passport Types</h4>
              <button type="button" class="btn btn-primary" id="addPassportTypeBtn" data-bs-toggle="modal" data-bs-target="#addPassportTypeModal">
                <i class="ti ti-plus me-2"></i>Passport Type
              </button>
            </div>
            
            <div class="card">
              <div class="table-responsive">
                <table class="table table-vcenter card-table" id="passportTypesTable" style="display: none;">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th class="d-none d-md-table-cell">Type</th>
                      <th class="d-none d-md-table-cell">Price</th>
                      <th class="d-none d-md-table-cell">Sessions</th>
                      <th class="d-none d-md-table-cell">Signup Link</th>
                      <th class="w-1">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="passportTypesContainer">
                    <!-- Passport types will be dynamically added here -->
                  </tbody>
                </table>
              </div>

              <div id="noPassportTypes" class="text-center p-4">
                <i class="ti ti-id-off text-muted mb-3" style="font-size: 3rem;"></i>
                <h5 class="text-muted mb-2">No passport types defined</h5>
                <p class="text-muted mb-3">Create different pricing options and user types for this activity</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPassportTypeModal">
                  <i class="ti ti-plus me-2"></i>Add Your First Passport Type
                </button>
              </div>
            </div>
          </div>

          <!-- Financial Management Section -->
          {% if activity %}
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Activity Finances</h4>
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addIncomeModal">
                    <i class="ti ti-plus me-2"></i>Add Income
                  </a>
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                    <i class="ti ti-plus me-2"></i>Add Expense
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="{{ url_for('financial_report') }}?activity_id={{ activity.id }}" target="_blank">
                    <i class="ti ti-edit me-2"></i>Edit Financial
                  </a>
                </div>
              </div>
            </div>
            
            <!-- Income Statement (Profit & Loss) -->
            {% if summary %}
            <div class="card">
              <div class="card-body">
                <!-- Revenue Section -->
                <div class="mb-4">
                  <h6 class="text-uppercase text-muted fw-bold mb-3">Revenue</h6>
                  <div class="row">
                    <div class="col-8">
                      <div class="ps-3 mb-2">Passport Income</div>
                      <div class="ps-3 mb-2">Other Income</div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="mb-2 text-muted fw-bold">{{ summary.passport_income|accounting_format }}</div>
                      <div class="mb-2 text-muted fw-bold">{{ summary.other_income|accounting_format }}</div>
                    </div>
                  </div>
                  <hr class="my-2">
                  <div class="row">
                    <div class="col-8">
                      <div class="fw-bold">Total Revenue</div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="fw-bold">{{ (summary.passport_income + summary.other_income)|accounting_format }}</div>
                    </div>
                  </div>
                </div>

                <!-- Expenses Section -->
                <div class="mb-4">
                  <h6 class="text-uppercase text-muted fw-bold mb-3">Expenses</h6>
                  <div class="row">
                    <div class="col-8">
                      <div class="ps-3 mb-2">Total Expenses</div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="mb-2 text-muted fw-bold">{{ summary.total_expenses|accounting_format }}</div>
                    </div>
                  </div>
                </div>

                <!-- Net Income Section -->
                <hr class="border-2">
                <div class="row">
                  <div class="col-8">
                    <div class="fw-bold mb-0" style="font-size: 1.1rem;">Net Income</div>
                  </div>
                  <div class="col-4 text-end">
                    <div class="fw-bold mb-0" style="font-size: 1.1rem;">
                      {{ summary.net_income|accounting_format }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- Signup Links Section - Now integrated into Passport Types table -->
          {% if activity %}
          <div id="signupLinksContainer" style="display: none;">
            <!-- Legacy container - functionality moved to table -->
          </div>
          {% endif %}
          

        </div>

        <div class="card-footer text-end">
          <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">
            <i class="ti ti-check me-1"></i>
            {{ "Update Activity" if activity else "Create Activity" }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

 
<!-- Modal for Unsplash Images -->
<!-- Modal for Unsplash Images -->
<div class="modal modal-blur fade" id="unsplashModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title">Select an Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">

        <!-- Image Grid -->
        <div id="unsplashImages" class="row g-3"></div>

        <!-- Pagination Controls -->
        <div id="unsplashPagination" class="d-flex justify-content-between align-items-center pt-3" style="display: none;">
          <button class="btn btn-outline-secondary" id="prevPageBtn">Previous</button>
          <span id="pageIndicator" class="text-muted small">Page 1</span>
          <button class="btn btn-outline-primary" id="nextPageBtn">Next</button>
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- Delete Image Confirmation Modal -->
<div class="modal modal-blur fade" id="deleteImageModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Remove Image?</div>
        <div>Are you sure you want to remove this image? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRemoveImage">Remove Image</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Passport Type Modal -->
<div class="modal modal-blur fade" id="addPassportTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-plus me-2"></i>Add New Passport Type
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label required">Passport Type Name</label>
            <input type="text" class="form-control" id="newPassportTypeName" 
                   placeholder="e.g., Regular, Premium, Student" required>
            <div class="form-text">This will be visible to users during signup</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">User Type</label>
            <select class="form-select" id="newPassportTypeType" required>
              <option value="permanent">Permanent User</option>
              <option value="substitute">Substitute User</option>
            </select>
            <div class="form-text">Permanent users attend regularly, substitutes fill in when needed</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Price per User ($)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="newPassportTypePrice" 
                   value="0.00" required>
            <div class="form-text">Amount each user pays for this passport type</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Sessions Included</label>
            <input type="number" min="1" class="form-control" id="newPassportTypeSessions" 
                   value="1" required>
            <div class="form-text">Number of sessions included in this price</div>
          </div>
          <div class="col-12">
            <label class="form-label">Target Revenue ($)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="newPassportTypeRevenue" 
                   value="0.00">
            <div class="form-text">Optional: Expected total revenue from this passport type</div>
          </div>
          <div class="col-12">
            <label class="form-label">Payment Instructions</label>
            <textarea class="form-control" id="newPassportTypeInstructions" rows="3" 
                      placeholder="Enter specific payment instructions for users with this passport type..."></textarea>
            <div class="form-text">These instructions will be shown to users during signup</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveNewPassportType">
          <i class="ti ti-check me-2"></i>Add Passport Type
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Passport Type Modal -->
<div class="modal modal-blur fade" id="editPassportTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-edit me-2"></i>Edit Passport Type
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label required">Passport Type Name</label>
            <input type="text" class="form-control" id="editPassportTypeName" required>
            <div class="form-text">This will be visible to users during signup</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">User Type</label>
            <select class="form-select" id="editPassportTypeType" required>
              <option value="permanent">Permanent User</option>
              <option value="substitute">Substitute User</option>
            </select>
            <div class="form-text">Permanent users attend regularly, substitutes fill in when needed</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Price per User ($)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="editPassportTypePrice" required>
            <div class="form-text">Amount each user pays for this passport type</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Sessions Included</label>
            <input type="number" min="1" class="form-control" id="editPassportTypeSessions" required>
            <div class="form-text">Number of sessions included in this price</div>
          </div>
          <div class="col-12">
            <label class="form-label">Target Revenue ($)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="editPassportTypeRevenue">
            <div class="form-text">Optional: Expected total revenue from this passport type</div>
          </div>
          <div class="col-12">
            <label class="form-label">Payment Instructions</label>
            <textarea class="form-control" id="editPassportTypeInstructions" rows="3" 
                      placeholder="Enter specific payment instructions for users with this passport type..."></textarea>
            <div class="form-text">These instructions will be shown to users during signup</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="saveEditPassportType">
          <i class="ti ti-check me-2"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div class="modal modal-blur fade" id="addIncomeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-cash me-2"></i>Add Income
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addIncomeForm" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="activity_id" value="{{ activity.id if activity }}">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Category</label>
              <select name="category" class="form-select" required>
                <option value="Ticket Sales">Ticket Sales</option>
                <option value="Sponsorship">Sponsorship</option>
                <option value="Donations">Donations</option>
                <option value="Vendor Fees">Vendor Fees</option>
                <option value="Service Income">Service Income</option>
                <option value="Merchandise Sales">Merchandise Sales</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Amount ($)</label>
              <input type="number" name="amount" step="0.01" min="0" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Date</label>
              <input type="date" name="date" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>
            
            <div class="col-12">
              <label class="form-label">Note (optional)</label>
              <textarea name="note" class="form-control" rows="2" placeholder="Add any additional notes..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="saveIncomeBtn">
          <i class="ti ti-check me-2"></i>Add Income
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Expense Modal -->
<div class="modal modal-blur fade" id="addExpenseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-currency-dollar me-2"></i>Add Expense
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addExpenseForm" method="POST" action="{{ url_for('activity_expenses', activity_id=activity.id) if activity else '#' }}" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="return_to" value="activity_form">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Category</label>
              <select name="category" class="form-select" required>
                <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                <option value="Staff">Staff</option>
                <option value="Venue">Venue</option>
                <option value="Equipment Rental">Equipment Rental</option>
                <option value="Insurance">Insurance</option>
                <option value="Marketing">Marketing</option>
                <option value="Travel">Travel</option>
                <option value="Supplies">Supplies</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Amount ($)</label>
              <input type="number" name="amount" step="0.01" min="0" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Date</label>
              <input type="date" name="date" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>
            
            <div class="col-12">
              <label class="form-label">Description (optional)</label>
              <textarea name="description" class="form-control" rows="2" placeholder="Add any additional notes..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="saveExpenseBtn">
          <i class="ti ti-check me-2"></i>Add Expense
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal modal-blur fade" id="editExpenseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-edit me-2"></i>Edit Expense
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editExpenseForm" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="return_to" value="activity_form">
          <input type="hidden" id="editExpenseId" name="expense_id">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Category</label>
              <select name="category" id="editExpenseCategory" class="form-select" required>
                <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                <option value="Staff">Staff</option>
                <option value="Venue">Venue</option>
                <option value="Equipment Rental">Equipment Rental</option>
                <option value="Insurance">Insurance</option>
                <option value="Marketing">Marketing</option>
                <option value="Travel">Travel</option>
                <option value="Supplies">Supplies</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Amount ($)</label>
              <input type="number" name="amount" id="editExpenseAmount" step="0.01" min="0" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Date</label>
              <input type="date" name="date" id="editExpenseDate" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>
            
            <div class="col-12">
              <label class="form-label">Description (optional)</label>
              <textarea name="description" id="editExpenseDescription" class="form-control" rows="2" placeholder="Add any additional notes..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="updateExpenseBtn">
          <i class="ti ti-check me-2"></i>Update Expense
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Income Confirmation Modal -->
<div class="modal modal-blur fade" id="deleteIncomeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Delete Income Entry?</div>
        <div>Are you sure you want to delete the <strong id="deleteIncomeCategory"></strong> income entry? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteIncome">
          <i class="ti ti-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Expense Confirmation Modal -->
<div class="modal modal-blur fade" id="deleteExpenseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Delete Expense Entry?</div>
        <div>Are you sure you want to delete the <strong id="deleteExpenseCategory"></strong> expense entry? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteExpense">
          <i class="ti ti-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Passport Type Confirmation Modal -->
<div class="modal modal-blur fade" id="deletePassportTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Delete Passport Type?</div>
        <div>Are you sure you want to delete "<span id="deletePassportTypeName"></span>"? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeletePassportType">
          <i class="ti ti-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block styles %}
<style>
.form-label.required::after {
  content: " *";
  color: #d63384;
}

.card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  background-color: #fff !important;
}

.form-control:focus,
.form-select:focus {
  border-color: #0054a6;
  box-shadow: 0 0 0 0.2rem rgba(0, 84, 166, 0.15);
}

.btn-primary {
  background-color: #0054a6;
  border-color: #0054a6;
}

.btn-primary:hover {
  background-color: #004494;
  border-color: #004494;
}

.image-section {
  background-color: #f8f9fa;
  border-radius: 0.375rem;
  padding: 1rem;
}

/* Passport type table styling */
#passportTypesTable td {
  vertical-align: middle;
}

#passportTypesTable .input-group-flat {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

#passportTypesTable .input-group-flat .form-control {
  border: 0;
}

#passportTypesTable .input-group-text {
  border: 0;
  background: transparent;
  padding: 0.25rem 0.5rem;
}

.btn-floating {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  z-index: 1000;
}

.financial-quick-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}


@media (max-width: 768px) {
  .financial-quick-actions {
    grid-template-columns: 1fr;
  }

  .card-body {
    padding: 1rem;
  }

  .modal-dialog {
    margin: 1rem;
  }
}


.signup-link-card {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background-color: #fff !important;
}

.badge-type {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}

{% block scripts %}

<script>
  function copyToClipboard(button) {
    const input = button.closest('.input-group').querySelector('input');
    input.select();
    document.execCommand("copy");
    button.innerHTML = '<i class="ti ti-check"></i>';
    setTimeout(() => { button.innerHTML = '<i class="ti ti-copy"></i>'; }, 1500);
  }
  
  document.addEventListener('DOMContentLoaded', function () {
    // Image handling variables
    const toggleOnline = document.getElementById('toggleOnlineImage');
    const onlineSection = document.getElementById('onlineImageSection');
    const toggleUpload = document.getElementById('toggleUploadImage');
    const uploadSection = document.getElementById('uploadImageSection');
    const removeImageBtn = document.getElementById('removeImageBtn');
    const selectedImagePreview = document.getElementById('selectedImagePreview');
    const selectedImageFilename = document.getElementById('selectedImageFilename');
    const uploadInput = document.getElementById('uploadInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    
    // Passport type variables
    const addPassportTypeBtn = document.getElementById('addPassportTypeBtn');
    const passportTypesContainer = document.getElementById('passportTypesContainer');
    const noPassportTypes = document.getElementById('noPassportTypes');
    const signupLinksContainer = document.getElementById('signupLinksContainer');
    
    let passportTypeCounter = 0;
    let passportTypes = [];
  
    const searchBtn = document.getElementById('searchImagesBtn');
    const imageDescInput = document.getElementById('imageDescription');
    const unsplashModal = new bootstrap.Modal(document.getElementById('unsplashModal'));
    const unsplashImagesDiv = document.getElementById('unsplashImages');
    const paginationControls = document.getElementById('unsplashPagination');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
  
    let currentPage = 1;
    let currentQuery = "";
  
    toggleOnline.addEventListener('change', () => {
      onlineSection.style.display = toggleOnline.checked ? 'block' : 'none';
      if (toggleOnline.checked) {
        toggleUpload.checked = false;
        uploadSection.style.display = 'none';
      }
    });
  
    toggleUpload.addEventListener('change', () => {
      uploadSection.style.display = toggleUpload.checked ? 'block' : 'none';
      if (toggleUpload.checked) {
        toggleOnline.checked = false;
        onlineSection.style.display = 'none';
      }
    });
  
    // Handle confirmation modal for remove image
    const confirmRemoveImageBtn = document.getElementById('confirmRemoveImage');
    const imagePreviewTitle = document.getElementById('imagePreviewTitle');
    
    if (confirmRemoveImageBtn) {
      confirmRemoveImageBtn.addEventListener('click', function () {
        selectedImagePreview.src = "";
        selectedImageFilename.value = "";
        uploadInput.value = "";
        imagePreviewContainer.style.display = 'none';
        imagePreviewTitle.style.display = 'none';
        
        // Close the modal
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteImageModal'));
        if (deleteModal) deleteModal.hide();
      });
    }
  
    uploadInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          selectedImagePreview.src = e.target.result;
          selectedImageFilename.value = "";
          imagePreviewContainer.style.display = 'block';
          imagePreviewTitle.style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    });
  
    imageDescInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchBtn.click();
      }
    });
  
    searchBtn.addEventListener('click', function () {
      const query = imageDescInput.value.trim();
      if (!query) {
        alert("Please enter a description first.");
        return;
      }
      currentQuery = query;
      currentPage = 1;
      loadUnsplashImages(currentPage);
      unsplashModal.show();
    });
  
    prevPageBtn.addEventListener('click', function () {
      if (currentPage > 1) {
        currentPage--;
        loadUnsplashImages(currentPage);
      }
    });
  
    nextPageBtn.addEventListener('click', function () {
      currentPage++;
      loadUnsplashImages(currentPage);
    });
  
    function loadUnsplashImages(page = 1) {
      if (!currentQuery) return;
      
      // Show loading state
      unsplashImagesDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
  
      fetch(`/unsplash-search?q=${encodeURIComponent(currentQuery)}&page=${page}`)
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
              throw new Error(errorData.error || 'Search failed');
            });
          }
          return response.json();
        })
        .then(data => {
          unsplashImagesDiv.innerHTML = '';
          if (data.length === 0) {
            unsplashImagesDiv.innerHTML = '<div class="text-center p-4"><p class="text-muted">No images found for this search.</p></div>';
            paginationControls.style.display = 'none';
            return;
          }
  
          data.forEach(image => {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-3';
            col.innerHTML = `
              <div class="card card-link card-border shadow-sm h-100">
                <img src="${image.thumb}" class="card-img-top" style="cursor:pointer; height: 200px; object-fit: cover;" alt="Unsplash Image">
              </div>
            `;
            col.querySelector('img').addEventListener('click', function () {
              // Show loading state on the clicked image
              this.style.opacity = '0.5';
              this.style.cursor = 'wait';
              
              fetch(`/download-unsplash-image?url=${encodeURIComponent(image.full)}`)
                .then(response => response.json())
                .then(result => {
                  if (result.success) {
                    selectedImagePreview.src = `/static/uploads/activity_images/${result.filename}`;
                    selectedImageFilename.value = result.filename;
                    uploadInput.value = "";
                    imagePreviewContainer.style.display = 'block';
                    imagePreviewTitle.style.display = 'block';
                    unsplashModal.hide();
                  } else {
                    alert("Failed to download image. Please try again.");
                    this.style.opacity = '1';
                    this.style.cursor = 'pointer';
                  }
                })
                .catch(error => {
                  console.error('Error downloading image:', error);
                  alert("Error downloading image. Please try again.");
                  this.style.opacity = '1';
                  this.style.cursor = 'pointer';
                });
            });
            unsplashImagesDiv.appendChild(col);
          });
  
          paginationControls.style.display = 'flex';
          prevPageBtn.disabled = page === 1;
        })
        .catch(error => {
          console.error('Error loading images:', error);
          let errorMessage = 'Error loading images. Please try again.';
          
          // Provide more specific error messages
          if (error.message.includes('API key')) {
            errorMessage = 'Image search is not available. The API key needs to be configured by an administrator.';
          } else if (error.message.includes('temporarily unavailable')) {
            errorMessage = 'Image search service is temporarily unavailable. Please try again later.';
          }
          
          unsplashImagesDiv.innerHTML = `
            <div class="text-center p-4">
              <div class="alert alert-warning border-warning mb-3">
                <div class="d-flex align-items-center">
                  <i class="ti ti-alert-triangle me-2"></i>
                  <strong>Image Search Unavailable</strong>
                </div>
                <p class="mb-0 mt-2">${errorMessage}</p>
              </div>
              <div class="text-muted small">
                <p class="mb-2"><strong>Alternative options:</strong></p>
                <ul class="list-unstyled">
                  <li>• Use the "Upload your own image" option instead</li>
                  <li>• Contact your administrator to configure image search</li>
                  <li>• Proceed without an image for now</li>
                </ul>
              </div>
            </div>
          `;
          paginationControls.style.display = 'none';
        });
    }
    
    // Passport Type Management Functions
    function createPassportTypeTableRow(passportType) {
      const id = passportType.id || `new_${passportTypeCounter++}`;
      const typeBadgeClass = passportType.type === 'permanent' ? 'bg-green-lt text-green' : 'bg-yellow-lt text-yellow';

      // Check if this is an existing passport type for signup link
      const isExisting = id && !id.toString().startsWith('new_');
      let signupUrl = '[Available after saving]';
      let signupButtonsDisabled = true;

      if (isExisting && '{{ activity.id if activity }}') {
        signupUrl = `{{ url_for('signup', activity_id=activity.id, _external=True) if activity }}?passport_type_id=${id}`;
        signupButtonsDisabled = false;
      }

      return `
        <tr data-id="${id}">
          <td>
            <div class="fw-bold">${passportType.name || 'New Passport Type'}</div>
          </td>
          <td class="d-none d-md-table-cell">
            <span class="badge ${typeBadgeClass}">${passportType.type || 'permanent'}</span>
          </td>
          <td class="d-none d-md-table-cell">
            <span class="fw-bold text-muted">$${passportType.price_per_user || '0.00'}</span>
          </td>
          <td class="d-none d-md-table-cell">
            <span class="text-muted">${passportType.sessions_included || '1'} sessions</span>
          </td>
          <td class="d-none d-md-table-cell">
            <div class="input-group input-group-flat" style="max-width: 300px;">
              <input type="text" class="form-control form-control-sm signup-url-input" readonly value="${signupUrl}">
              <span class="input-group-text">
                <button class="btn btn-sm btn-outline-secondary copy-signup-btn" type="button" ${signupButtonsDisabled ? 'disabled' : ''}
                        onclick="copySignupLink(this)" title="Copy link">
                  <i class="ti ti-copy"></i>
                </button>
                ${!signupButtonsDisabled ? `<a class="btn btn-sm btn-outline-secondary ms-1" target="_blank" href="${signupUrl}" title="Open in new tab"><i class="ti ti-external-link"></i></a>` : ''}
              </span>
            </div>
          </td>
          <td>
            <div class="dropdown">
              <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                Actions
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="#" onclick="editPassportType('${id}')">
                  <i class="ti ti-edit me-2"></i> Edit
                </a>
                ${!signupButtonsDisabled ? `
                <a class="dropdown-item" href="#" onclick="copySignupLinkFromDropdown('${id}', '${signupUrl}')">
                  <i class="ti ti-copy me-2"></i> Copy Signup Link
                </a>
                ` : ''}
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-danger" href="#" onclick="confirmDeletePassportType('${id}', '${passportType.name || 'New Passport Type'}')">
                  <i class="ti ti-trash me-2"></i> Delete
                </a>
              </div>
            </div>
          </td>
          <!-- Hidden form inputs for server submission -->
          <input type="hidden" name="passport_types[${id}][name]" value="${passportType.name || ''}">
          <input type="hidden" name="passport_types[${id}][type]" value="${passportType.type || 'permanent'}">
          <input type="hidden" name="passport_types[${id}][price_per_user]" value="${passportType.price_per_user || '0.00'}">
          <input type="hidden" name="passport_types[${id}][sessions_included]" value="${passportType.sessions_included || '1'}">
          <input type="hidden" name="passport_types[${id}][target_revenue]" value="${passportType.target_revenue || '0.00'}">
          <input type="hidden" name="passport_types[${id}][payment_instructions]" value="${passportType.payment_instructions || ''}">
        </tr>
      `;
    }

    // Modal Management Functions
    const addPassportTypeModal = new bootstrap.Modal(document.getElementById('addPassportTypeModal'));
    const editPassportTypeModal = new bootstrap.Modal(document.getElementById('editPassportTypeModal'));
    const deletePassportTypeModal = new bootstrap.Modal(document.getElementById('deletePassportTypeModal'));
    
    let currentEditingId = null;
    let currentDeletingId = null;
    
    function addNewPassportType() {
      // Get values from modal
      const name = document.getElementById('newPassportTypeName').value.trim();
      const type = document.getElementById('newPassportTypeType').value;
      const price = document.getElementById('newPassportTypePrice').value;
      const sessions = document.getElementById('newPassportTypeSessions').value;
      const revenue = document.getElementById('newPassportTypeRevenue').value;
      const instructions = document.getElementById('newPassportTypeInstructions').value.trim();

      // Validation
      if (!name) {
        alert('Please enter a passport type name.');
        return;
      }

      const newPassportType = {
        id: `new_${passportTypeCounter++}`,
        name: name,
        type: type,
        price_per_user: price,
        sessions_included: sessions,
        target_revenue: revenue,
        payment_instructions: instructions
      };

      passportTypes.push(newPassportType);

      const rowHtml = createPassportTypeTableRow(newPassportType);
      passportTypesContainer.insertAdjacentHTML('beforeend', rowHtml);

      updateVisibility();

      // Clear modal and close
      clearAddModal();
      addPassportTypeModal.hide();
    }
    
    function editPassportType(id) {
      const passportType = passportTypes.find(pt => pt.id == id) || getPassportTypeFromRow(id);
      if (!passportType) return;
      
      currentEditingId = id;
      
      // Populate edit modal
      document.getElementById('editPassportTypeName').value = passportType.name || '';
      document.getElementById('editPassportTypeType').value = passportType.type || 'permanent';
      document.getElementById('editPassportTypePrice').value = passportType.price_per_user || '0.00';
      document.getElementById('editPassportTypeSessions').value = passportType.sessions_included || '1';
      document.getElementById('editPassportTypeRevenue').value = passportType.target_revenue || '0.00';
      document.getElementById('editPassportTypeInstructions').value = passportType.payment_instructions || '';
      
      editPassportTypeModal.show();
    }
    
    function saveEditPassportType() {
      if (!currentEditingId) return;

      // Get values from modal
      const name = document.getElementById('editPassportTypeName').value.trim();
      const type = document.getElementById('editPassportTypeType').value;
      const price = document.getElementById('editPassportTypePrice').value;
      const sessions = document.getElementById('editPassportTypeSessions').value;
      const revenue = document.getElementById('editPassportTypeRevenue').value;
      const instructions = document.getElementById('editPassportTypeInstructions').value.trim();

      // Validation
      if (!name) {
        alert('Please enter a passport type name.');
        return;
      }

      // Update passport type
      const updatedPassportType = {
        id: currentEditingId,
        name: name,
        type: type,
        price_per_user: price,
        sessions_included: sessions,
        target_revenue: revenue,
        payment_instructions: instructions
      };

      // Update in array
      const index = passportTypes.findIndex(pt => pt.id == currentEditingId);
      if (index !== -1) {
        passportTypes[index] = updatedPassportType;
      }

      // Update UI
      const row = document.querySelector(`[data-id="${currentEditingId}"]`);
      if (row) {
        row.outerHTML = createPassportTypeTableRow(updatedPassportType);
      }

      editPassportTypeModal.hide();
      currentEditingId = null;
    }
    
    function confirmDeletePassportType(id, name) {
      currentDeletingId = id;
      document.getElementById('deletePassportTypeName').textContent = name;
      
      // Check if this is an existing passport type (not new)
      if (id && !id.toString().startsWith('new_')) {
        // Check for dependencies before allowing deletion
        checkPassportTypeDependencies(id, name);
      } else {
        // It's a new passport type, safe to delete
        deletePassportTypeModal.show();
      }
    }
    
    function checkPassportTypeDependencies(id, name) {
      fetch(`/api/passport-type-dependencies/${id}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.has_dependencies) {
              // Show archive confirmation instead of delete
              showArchivePassportTypeModal(id, name, data.passport_count, data.signup_count);
            } else {
              // Safe to delete
              deletePassportTypeModal.show();
            }
          } else {
            alert('Error checking dependencies: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error checking dependencies. Please try again.');
        });
    }
    
    function showArchivePassportTypeModal(id, name, passportCount, signupCount) {
      // Create usage list items
      let usageItems = '';
      if (passportCount > 0) {
        const passportText = passportCount === 1 ? 'existing passport' : 'existing passports';
        usageItems += '<li><strong>' + passportCount + '</strong> ' + passportText + '</li>';
      }
      if (signupCount > 0) {
        const signupText = signupCount === 1 ? 'signup' : 'signups';
        usageItems += '<li><strong>' + signupCount + '</strong> ' + signupText + '</li>';
      }
      
      const modalHtml = 
        '<div class="modal modal-blur fade" id="archivePassportTypeModal" tabindex="-1">' +
          '<div class="modal-dialog modal-dialog-centered">' +
            '<div class="modal-content">' +
              '<div class="modal-header">' +
                '<h5 class="modal-title">' +
                  '<i class="ti ti-alert-triangle text-warning me-2"></i>' +
                  'Cannot Delete Passport Type' +
                '</h5>' +
                '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
              '</div>' +
              '<div class="modal-body">' +
                '<div class="alert alert-warning border-warning">' +
                  '<div class="d-flex align-items-center">' +
                    '<i class="ti ti-shield-exclamation me-2"></i>' +
                    '<strong>This passport type is currently in use and cannot be deleted</strong>' +
                  '</div>' +
                '</div>' +
                '<p class="mb-3">The passport type <strong>"' + name + '"</strong> is currently being used by:</p>' +
                '<ul class="mb-4">' + usageItems + '</ul>' +
                '<div class="card bg-light">' +
                  '<div class="card-body">' +
                    '<h6 class="card-title">' +
                      '<i class="ti ti-archive me-2"></i>' +
                      'Archive Instead' +
                    '</h6>' +
                    '<p class="mb-2">Instead of deleting, you can <strong>archive</strong> this passport type. This will:</p>' +
                    '<ul class="mb-0">' +
                      '<li>Hide it from new signups</li>' +
                      '<li>Preserve all existing passport data</li>' +
                      '<li>Maintain complete historical records</li>' +
                      '<li>Allow you to restore it later if needed</li>' +
                    '</ul>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">' +
                  '<i class="ti ti-x me-2"></i>Cancel' +
                '</button>' +
                '<button type="button" class="btn btn-warning" onclick="archivePassportType(' + id + ', \'' + name.replace(/'/g, "\\'") + '\')">' +
                  '<i class="ti ti-archive me-2"></i>Archive This Type' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      
      // Remove existing modal if any
      const existingModal = document.getElementById('archivePassportTypeModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add new modal to DOM
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show the modal
      const archiveModal = new bootstrap.Modal(document.getElementById('archivePassportTypeModal'));
      archiveModal.show();
    }
    
    function archivePassportType(id, name) {
      // Show loading state
      const archiveButton = document.querySelector('button[onclick*="archivePassportType"]');
      const originalText = archiveButton.innerHTML;
      archiveButton.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Archiving...';
      archiveButton.disabled = true;
      
      fetch(`/api/passport-type-archive/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove from UI (archive is like deletion from user perspective)
          const row = document.querySelector(`[data-id="${id}"]`);
          if (row) {
            row.remove();
          }

          passportTypes = passportTypes.filter(pt => pt.id != id);
          updateVisibility();
          
          // Close modal and reset
          const archiveModal = bootstrap.Modal.getInstance(document.getElementById('archivePassportTypeModal'));
          if (archiveModal) {
            archiveModal.hide();
          }
          currentDeletingId = null;
          
          // Show success message
          showSuccessMessage(`✅ Passport type "${name}" has been archived successfully!`);
          
        } else {
          // Restore button state
          archiveButton.innerHTML = originalText;
          archiveButton.disabled = false;
          
          showErrorMessage('Failed to archive passport type: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        
        // Restore button state
        archiveButton.innerHTML = originalText;
        archiveButton.disabled = false;
        
        showErrorMessage('Connection error. Please check your internet connection and try again.');
      });
    }
    
    function showSuccessMessage(message) {
      // Create and show a Bootstrap alert for success
      const alertHtml = 
        '<div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
          '<div class="d-flex align-items-center">' +
            '<i class="ti ti-check-circle me-2"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>';
      
      document.body.insertAdjacentHTML('beforeend', alertHtml);
      
      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        const alert = document.querySelector('.alert-success');
        if (alert) {
          alert.remove();
        }
      }, 5000);
    }
    
    function showErrorMessage(message) {
      // Create and show a Bootstrap alert for errors
      const alertHtml = 
        '<div class="alert alert-danger alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
          '<div class="d-flex align-items-center">' +
            '<i class="ti ti-alert-circle me-2"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>';
      
      document.body.insertAdjacentHTML('beforeend', alertHtml);
      
      // Auto-dismiss after 8 seconds (longer for errors)
      setTimeout(() => {
        const alert = document.querySelector('.alert-danger');
        if (alert) {
          alert.remove();
        }
      }, 8000);
    }
    
    function deletePassportType() {
      if (!currentDeletingId) return;

      // Check if this is a new unsaved passport type
      if (currentDeletingId.toString().startsWith('new_')) {
        // It's a new passport type - just remove from UI
        const row = document.querySelector(`[data-id="${currentDeletingId}"]`);
        if (row) {
          row.remove();
        }
        passportTypes = passportTypes.filter(pt => pt.id != currentDeletingId);
        updateVisibility();
        deletePassportTypeModal.hide();
        currentDeletingId = null;
        return;
      }

      // It's an existing passport type - call API to archive it
      const deleteButton = document.querySelector('#confirmDeletePassportType');
      const originalText = deleteButton.innerHTML;
      deleteButton.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Deleting...';
      deleteButton.disabled = true;

      fetch(`/api/passport-type-archive/${currentDeletingId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Redirect with success parameter
          window.location.href = window.location.pathname + '?deleted=' + encodeURIComponent(data.passport_type_name);
        } else {
          // Redirect with error parameter
          window.location.href = window.location.pathname + '?error=' + encodeURIComponent(data.error || 'Unknown error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Redirect with error parameter
        window.location.href = window.location.pathname + '?error=Connection error';
      });
    }
    
    function getPassportTypeFromRow(id) {
      const row = document.querySelector(`[data-id="${id}"]`);
      if (!row) return null;
      
      return {
        id: id,
        name: row.querySelector('input[name*="[name]"]').value,
        type: row.querySelector('input[name*="[type]"]').value,
        price_per_user: row.querySelector('input[name*="[price_per_user]"]').value,
        sessions_included: row.querySelector('input[name*="[sessions_included]"]').value,
        target_revenue: row.querySelector('input[name*="[target_revenue]"]').value,
        payment_instructions: row.querySelector('input[name*="[payment_instructions]"]').value
      };
    }
    
    function clearAddModal() {
      document.getElementById('newPassportTypeName').value = '';
      document.getElementById('newPassportTypeType').value = 'permanent';
      document.getElementById('newPassportTypePrice').value = '0.00';
      document.getElementById('newPassportTypeSessions').value = '1';
      document.getElementById('newPassportTypeRevenue').value = '0.00';
      document.getElementById('newPassportTypeInstructions').value = '';
    }
    
    function updateVisibility() {
      const hasPassportTypes = passportTypesContainer.children.length > 0;
      const passportTypesTable = document.getElementById('passportTypesTable');

      if (hasPassportTypes) {
        noPassportTypes.style.display = 'none';
        passportTypesTable.style.display = 'table';
      } else {
        noPassportTypes.style.display = 'block';
        passportTypesTable.style.display = 'none';
      }
    }
    
    function updateSignupLinks() {
      // Signup links are now integrated into the table rows
      // Legacy function - functionality moved to table rows
      // No longer needed as signup links are integrated into createPassportTypeTableRow
    }
    
    function copySignupLink(button) {
      const input = button.closest('.input-group').querySelector('.signup-url-input');
      input.select();
      document.execCommand("copy");
      button.innerHTML = '<i class="ti ti-check"></i>';
      setTimeout(() => { button.innerHTML = '<i class="ti ti-copy"></i>'; }, 1500);
    }

    function copySignupLinkFromDropdown(id, url) {
      event.preventDefault();
      navigator.clipboard.writeText(url).then(() => {
        showFlashMessage('Signup link copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showFlashMessage('Failed to copy link', 'error');
      });
    }

    function showFlashMessage(message, category = 'success') {
      // Create or get flash overlay
      let overlay = document.getElementById('flashAlertOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'flashAlertOverlay';
        overlay.className = 'flash-alert-overlay';
        overlay.innerHTML = '<div class="flash-alert-container"></div>';
        document.body.insertBefore(overlay, document.body.firstChild);
      }

      const container = overlay.querySelector('.flash-alert-container');

      // Determine alert style
      const alertClass = category === 'success' ? 'alert-success' :
                         category === 'error' ? 'alert-danger' :
                         category === 'warning' ? 'alert-warning' : 'alert-info';
      const iconClass = category === 'success' ? 'ti-check-circle' :
                        category === 'error' ? 'ti-alert-circle' :
                        category === 'warning' ? 'ti-alert-triangle' : 'ti-info-circle';
      const title = category === 'success' ? 'Success' :
                    category === 'error' ? 'Error' :
                    category === 'warning' ? 'Warning' : 'Information';

      // Create flash alert
      const alert = document.createElement('div');
      alert.className = `flash-alert alert ${alertClass} alert-dismissible`;
      alert.setAttribute('role', 'alert');
      alert.setAttribute('aria-live', 'polite');
      alert.setAttribute('aria-atomic', 'true');
      alert.innerHTML = `
        <div class="d-flex">
          <div class="alert-icon-container">
            <i class="ti ${iconClass} alert-icon"></i>
          </div>
          <div class="flex-fill">
            <div class="alert-title">${title}</div>
            <div class="alert-message">${message}</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close notification"></button>
        </div>
        <div class="flash-alert-progress"></div>
      `;

      container.appendChild(alert);

      // Animate in
      setTimeout(() => alert.classList.add('show'), 10);

      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        alert.classList.add('hide');
        setTimeout(() => {
          alert.remove();
          if (container.children.length === 0) {
            overlay.remove();
          }
        }, 400);
      }, 3000);

      // Handle manual close
      const closeBtn = alert.querySelector('.btn-close');
      closeBtn.addEventListener('click', () => {
        alert.classList.add('hide');
        setTimeout(() => {
          alert.remove();
          if (container.children.length === 0) {
            overlay.remove();
          }
        }, 400);
      });
    }

    // Make functions global
    window.copySignupLink = copySignupLink;
    window.copySignupLinkFromDropdown = copySignupLinkFromDropdown;
    
    // Event Listeners for modals
    document.getElementById('saveNewPassportType').addEventListener('click', addNewPassportType);
    document.getElementById('saveEditPassportType').addEventListener('click', saveEditPassportType);
    document.getElementById('confirmDeletePassportType').addEventListener('click', deletePassportType);
    
    // Make functions global for onclick handlers
    window.editPassportType = editPassportType;
    window.confirmDeletePassportType = confirmDeletePassportType;
    window.copySignupLink = copySignupLink;
    
    // Income Management Functions
    const addIncomeModal = new bootstrap.Modal(document.getElementById('addIncomeModal'));
    const deleteIncomeModal = new bootstrap.Modal(document.getElementById('deleteIncomeModal'));
    
    let currentDeletingIncomeId = null;
    
    // Set default date to today for add income modal
    const today = new Date().toISOString().split('T')[0];
    const addIncomeDateInput = document.querySelector('#addIncomeForm input[name="date"]');
    if (addIncomeDateInput) {
      addIncomeDateInput.value = today;
    }
    
    function addNewIncome() {
      const form = document.getElementById('addIncomeForm');
      
      // Validate form
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Show loading state
      const saveBtn = document.getElementById('saveIncomeBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Adding...';
      saveBtn.disabled = true;
      
      // Submit form to add income and return to activity form
      form.action = '/admin/activity-income/{{ activity.id if activity }}?return_to=activity_form';
      form.method = 'POST';
      form.submit();
    }
    
    function editIncome(incomeId) {
      // For now, redirect to the existing edit page
      // We can enhance this later with a modal approach
      window.location.href = `/admin/activity-income/{{ activity.id if activity }}/${incomeId}?return_to=activity_form`;
    }
    
    
    function confirmDeleteIncome(incomeId, category) {
      currentDeletingIncomeId = incomeId;
      document.getElementById('deleteIncomeCategory').textContent = category;
      deleteIncomeModal.show();
    }
    
    function deleteIncome() {
      if (!currentDeletingIncomeId) return;
      
      // Create a form to submit the delete request
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/admin/delete-income/${currentDeletingIncomeId}?return_to=activity_form`;
      
      const csrfToken = document.createElement('input');
      csrfToken.type = 'hidden';
      csrfToken.name = 'csrf_token';
      csrfToken.value = document.querySelector('input[name="csrf_token"]').value;
      
      form.appendChild(csrfToken);
      document.body.appendChild(form);
      form.submit();
    }
    
    // Event listeners for income modals
    document.getElementById('saveIncomeBtn').addEventListener('click', addNewIncome);
    document.getElementById('confirmDeleteIncome').addEventListener('click', deleteIncome);
    
    // Expense Management Functions
    let currentDeletingExpenseId = null;
    const deleteExpenseModal = new bootstrap.Modal(document.getElementById('deleteExpenseModal'));
    const addExpenseModal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
    const editExpenseModal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
    
    function addNewExpense() {
      const form = document.getElementById('addExpenseForm');
      
      // Validate form
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Show loading state
      const saveBtn = document.getElementById('saveExpenseBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Adding...';
      saveBtn.disabled = true;
      
      // Submit form to add expense and return to activity form
      form.submit();
    }
    
    function editExpense(expenseId) {
      // For now, redirect to the existing edit page
      // We can enhance this later with a modal approach
      window.location.href = `/admin/activity-expenses/{{ activity.id if activity }}/edit/${expenseId}?return_to=activity_form`;
    }
    
    function confirmDeleteExpense(expenseId, category) {
      currentDeletingExpenseId = expenseId;
      document.getElementById('deleteExpenseCategory').textContent = category;
      deleteExpenseModal.show();
    }
    
    function deleteExpense() {
      if (!currentDeletingExpenseId) return;
      
      // Create a form to submit the delete request
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/admin/delete-expense/${currentDeletingExpenseId}?return_to=activity_form`;
      
      const csrfToken = document.createElement('input');
      csrfToken.type = 'hidden';
      csrfToken.name = 'csrf_token';
      csrfToken.value = document.querySelector('input[name="csrf_token"]').value;
      
      form.appendChild(csrfToken);
      document.body.appendChild(form);
      form.submit();
    }
    
    // Event listeners for expense modals
    document.getElementById('saveExpenseBtn').addEventListener('click', addNewExpense);
    document.getElementById('confirmDeleteExpense').addEventListener('click', deleteExpense);
    
    // Function to open receipt in new window
    function openReceiptWindow(receiptUrl) {
      const windowFeatures = 'width=800,height=600,scrollbars=yes,resizable=yes,toolbar=no,location=no,directories=no,status=no,menubar=no';
      window.open(receiptUrl, 'receiptWindow', windowFeatures);
    }
    
    // Make functions global for onclick handlers
    window.editIncome = editIncome;
    window.confirmDeleteIncome = confirmDeleteIncome;
    window.editExpense = editExpense;
    window.confirmDeleteExpense = confirmDeleteExpense;
    window.openReceiptWindow = openReceiptWindow;
    
    // Load existing passport types for editing
    {% if passport_types %}
    try {
      const existingPassportTypesData = {{ passport_types|tojson }};

      existingPassportTypesData.forEach((pt, index) => {
        const existingPassportType = {
          id: pt.id.toString(),
          name: pt.name,
          type: pt.type,
          price_per_user: pt.price_per_user.toString(),
          sessions_included: pt.sessions_included.toString(),
          target_revenue: pt.target_revenue.toString(),
          payment_instructions: pt.payment_instructions || ''
        };

        passportTypes.push(existingPassportType);
        const rowHtml = createPassportTypeTableRow(existingPassportType);
        passportTypesContainer.insertAdjacentHTML('beforeend', rowHtml);
      });
    } catch (error) {
      console.error('Error loading passport types:', error);
    }
    {% endif %}
    
    // Initialize
    updateVisibility();
    updateSignupLinks();

    // ========================================
    // LOCATION VERIFICATION FUNCTIONALITY
    // ========================================
    const locationInput = document.getElementById('locationInput');
    const verifyLocationBtn = document.getElementById('verifyLocationBtn');
    const locationVerifiedSection = document.getElementById('locationVerifiedSection');
    const locationErrorSection = document.getElementById('locationErrorSection');
    const locationLoadingSection = document.getElementById('locationLoadingSection');
    const approveLocationBtn = document.getElementById('approveLocationBtn');
    const clearLocationBtn = document.getElementById('clearLocationBtn');
    const verifiedAddressDisplay = document.getElementById('verifiedAddressDisplay');
    const viewOnMapLink = document.getElementById('viewOnMapLink');

    let pendingLocationData = null;

    // Verify location button click
    verifyLocationBtn.addEventListener('click', function() {
      const address = locationInput.value.trim();
      if (!address) {
        alert('Please enter a location address first');
        return;
      }
      verifyLocation(address);
    });

    // Enter key on location input
    locationInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        verifyLocationBtn.click();
      }
    });

    // Approve location
    approveLocationBtn.addEventListener('click', function() {
      if (pendingLocationData) {
        document.getElementById('locationAddressRaw').value = pendingLocationData.raw;
        document.getElementById('locationAddressFormatted').value = pendingLocationData.formatted;
        document.getElementById('locationCoordinates').value = pendingLocationData.coordinates;

        // Visual feedback: Update UI to show approved state
        document.getElementById('locationStatusTitle').textContent = 'LOCATION APPROVED!';
        document.getElementById('locationApprovedMessage').style.display = 'block';
        document.getElementById('locationVerifiedAlert').className = 'alert alert-success d-flex align-items-center border-success';
        document.getElementById('locationVerifiedAlert').style.backgroundColor = '#d1f2eb'; // Light green background
        approveLocationBtn.style.display = 'none'; // Hide approve button (already approved)
      }
    });

    // Clear/reset location
    clearLocationBtn.addEventListener('click', function() {
      locationVerifiedSection.style.display = 'none';
      locationErrorSection.style.display = 'none';
      pendingLocationData = null;

      // Reset UI state
      document.getElementById('locationStatusTitle').textContent = 'Location Verified!';
      document.getElementById('locationApprovedMessage').style.display = 'none';
      document.getElementById('locationVerifiedAlert').className = 'alert alert-success d-flex align-items-center';
      document.getElementById('locationVerifiedAlert').style.backgroundColor = ''; // Reset to default (white)
      approveLocationBtn.style.display = 'inline-block'; // Show approve button again
    });

    // Verify location via API
    function verifyLocation(address) {
      locationLoadingSection.style.display = 'block';
      locationVerifiedSection.style.display = 'none';
      locationErrorSection.style.display = 'none';

      fetch('/api/geocode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address: address })
      })
      .then(r => r.json())
      .then(data => {
        locationLoadingSection.style.display = 'none';
        if (data.success) {
          pendingLocationData = {
            raw: address,
            formatted: data.formatted_address,
            coordinates: data.coordinates
          };
          verifiedAddressDisplay.textContent = data.formatted_address;
          viewOnMapLink.href = `https://maps.google.com/?q=${data.coordinates}`;
          locationVerifiedSection.style.display = 'block';
        } else {
          document.getElementById('locationErrorMessage').textContent = data.error || 'Location not found';
          locationErrorSection.style.display = 'block';
        }
      })
      .catch(err => {
        locationLoadingSection.style.display = 'none';
        document.getElementById('locationErrorMessage').textContent = 'Error verifying location. Please try again.';
        locationErrorSection.style.display = 'block';
      });
    }

    // Show existing location if editing activity
    {% if activity and activity.location_address_formatted %}
    pendingLocationData = {
      raw: '{{ activity.location_address_raw }}',
      formatted: '{{ activity.location_address_formatted }}',
      coordinates: '{{ activity.location_coordinates }}'
    };
    verifiedAddressDisplay.textContent = '{{ activity.location_address_formatted }}';
    viewOnMapLink.href = 'https://maps.google.com/?q={{ activity.location_coordinates }}';
    locationVerifiedSection.style.display = 'block';

    // Apply approved state since location is already saved in database
    document.getElementById('locationStatusTitle').textContent = 'LOCATION APPROVED!';
    document.getElementById('locationApprovedMessage').style.display = 'block';
    document.getElementById('locationVerifiedAlert').className = 'alert alert-success d-flex align-items-center border-success';
    document.getElementById('locationVerifiedAlert').style.backgroundColor = '#d1f2eb'; // Light green background
    approveLocationBtn.style.display = 'none'; // Hide approve button (already approved)

    // Also populate hidden form fields
    document.getElementById('locationAddressRaw').value = '{{ activity.location_address_raw }}';
    document.getElementById('locationAddressFormatted').value = '{{ activity.location_address_formatted }}';
    document.getElementById('locationCoordinates').value = '{{ activity.location_coordinates }}';
    {% endif %}

  });
  </script>
  

{% endblock %}
