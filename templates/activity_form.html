{% extends "base.html" %}
{% block title %}
  {{ "Edit Activity" if activity else "New Activity" }}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
<style>
.form-label.required::after {
  content: " *";
  color: #d63384;
}

/* Page header sticky styling */
.page-header {
  border-bottom: 1px solid rgba(98, 105, 118, 0.16);
  margin-bottom: 0;
}

.card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  background-color: #fff !important;
}

.form-control:focus,
.form-select:focus {
  border-color: #0054a6;
  box-shadow: 0 0 0 0.2rem rgba(0, 84, 166, 0.15);
}

.btn-primary {
  background-color: #0054a6;
  border-color: #0054a6;
}

.btn-primary:hover {
  background-color: #004494;
  border-color: #004494;
}

/* Section headers */
.section-header {
  font-weight: 600;
  font-size: 1rem;
  color: #1e293b;
}

/* Workflow card icon container */
.form-selectgroup-boxes .avatar {
  --tblr-avatar-size: 3.6rem;
  --tblr-avatar-box-shadow: none;
  background-color: rgba(var(--tblr-primary-rgb), 0.15);
  color: var(--tblr-primary);
}
.form-selectgroup-boxes .avatar .ti {
  font-size: 2.5rem;
}

/* Form hint styling */
.form-hint {
  display: block;
  margin-top: 0.25rem;
  font-size: 0.75rem;
  color: #626976;
}

/* Passport type table styling */
#passportTypesTable td {
  vertical-align: middle;
}

#passportTypesTable .input-group-flat {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

#passportTypesTable .input-group-flat .form-control {
  border: 0;
}

#passportTypesTable .input-group-text {
  border: 0;
  background: transparent;
  padding: 0.25rem 0.5rem;
}

/* Google Places Autocomplete dropdown fix */
.pac-container {
  z-index: 10000 !important;
}

/* Ghost button for back */
.btn-ghost-secondary {
  color: #626976;
  background: transparent;
  border: none;
}

.btn-ghost-secondary:hover {
  background-color: rgba(98, 105, 118, 0.1);
  color: #1d2332;
}

@media (max-width: 768px) {
  .card-body {
    padding: 1rem;
  }

  .modal-dialog {
    margin: 1rem;
  }

  .page-header .row {
    padding: 0.75rem 0 !important;
  }

  .page-title {
    font-size: 1rem;
  }

  .form-selectgroup {
    flex-direction: column;
  }

  .form-selectgroup-label {
    width: 100%;
    justify-content: center;
  }

  .section-divider {
    margin-top: 1.5rem !important;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container-xl">
  <form method="POST" enctype="multipart/form-data" id="activityForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center py-3 px-3">
          <h2 class="page-title mb-0">
            {{ "Edit Activity" if activity else "New Activity" }}
          </h2>
          <div>
            <a href="{{ url_for('dashboard') }}" class="btn me-2 d-none d-md-inline-flex">Cancel</a>
            <button type="submit" class="btn btn-success">
              <i class="ti ti-check me-1"></i>Save
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-body">

            <!-- ============================================ -->
            <!-- BASIC INFORMATION SECTION (Always Expanded)  -->
            <!-- ============================================ -->
            <div class="mb-4">
              <!-- Status Toggle (Own Row - First) -->
              <div class="mb-3 d-flex align-items-center">
                {% set current_status = activity.status if activity else 'active' %}
                <span class="me-2" id="statusLabel">{{ 'Active' if current_status == 'active' else 'Archived' }}</span>
                <label class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" id="statusToggle"
                         {{ 'checked' if current_status == 'active' else '' }}
                         onchange="updateStatusValue()">
                </label>
                <input type="hidden" name="status" id="statusValue" value="{{ current_status }}">
              </div>

              <!-- Activity Name (Own Row - Second) -->
              <div class="mb-3">
                <label class="form-label required">Activity Name</label>
                <input type="text" class="form-control" name="name"
                       value="{{ activity.name if activity else '' }}"
                       placeholder="Enter activity name (e.g., Hockey Training, Yoga Classes)"
                       required>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="3" placeholder="What? Where? When? Describe your activity...">{{ activity.description if activity else '' }}</textarea>
              </div>

              <!-- Activity Target Revenue -->
              <div class="mb-3">
                <label class="form-label">Target Revenue (Optional)</label>
                <div class="input-group" style="max-width: 300px;">
                  <span class="input-group-text">$</span>
                  <input type="number"
                         class="form-control"
                         name="goal_revenue"
                         step="0.01"
                         min="0"
                         placeholder="0.00"
                         value="{{ '%.2f'|format(activity.goal_revenue) if activity and activity.goal_revenue else '' }}">
                </div>
                <small class="form-hint">
                  Set a revenue goal to track progress on your activity dashboard
                </small>
              </div>

              <!-- Cover Photo -->
              <div class="mb-3">
                <label class="form-label">Cover Photo</label>

                <div class="d-flex align-items-stretch rounded bg-secondary-lt overflow-hidden"
                     style="border: 1px solid rgba(98,105,118,0.2); width: fit-content; max-width: 100%;">

                  <!-- Left: Thumbnail — always visible -->
                  <div class="position-relative flex-shrink-0 d-flex flex-column align-items-center justify-content-center"
                       style="width: 100px; min-height: 100px; cursor: pointer;" id="coverPhotoWrapper">
                    {% if activity and activity.image_filename %}
                      <img id="coverThumbnail"
                           src="{{ url_for('static', filename='uploads/activity_images/' + activity.image_filename) }}"
                           class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
                      <span class="position-absolute top-0 end-0 badge bg-danger rounded-circle p-2"
                            style="cursor: pointer;" id="deleteImageBtn">
                        <i class="ti ti-x text-white" style="font-size: 14px;"></i>
                      </span>
                    {% else %}
                      <div id="coverThumbnail" class="d-flex flex-column align-items-center justify-content-center"
                           style="width: 100px; height: 100px;">
                        <i class="ti ti-photo text-muted fs-2"></i>
                        <small class="text-muted">Add photo</small>
                      </div>
                    {% endif %}
                  </div>

                  <!-- Right: Panel — border-left as divider, no extra inner wrapper -->
                  <div id="imageOptions" class="flex-grow-1 p-2"
                       style="display: none; border-left: 1px solid rgba(98,105,118,0.2);">
                    <!-- Source toggle: Search ↔ Upload -->
                    <div class="d-flex align-items-center gap-2 mb-3">
                      <small class="text-muted fw-medium">
                        <i class="ti ti-world-search" style="font-size:13px;"></i> Search
                      </small>
                      <label class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="sourceToggle" role="switch">
                      </label>
                      <small class="text-muted">
                        <i class="ti ti-upload" style="font-size:13px;"></i> Upload
                      </small>
                    </div>

                    <!-- Search Web Content -->
                    <div id="searchWebContent">
                      <div class="input-group">
                        <input type="text" id="imageDescription" class="form-control" placeholder="e.g., Hockey, Yoga">
                        <button type="button" id="searchImagesBtn" class="btn btn-primary">
                          <i class="ti ti-search"></i>
                        </button>
                      </div>
                    </div>

                    <!-- Upload Content -->
                    <div id="uploadContent" style="display: none;">
                      <input type="file" name="upload_image" class="form-control" id="uploadInput">
                    </div>
                  </div>

                </div>

                <input type="hidden" name="selected_image_filename" id="selectedImageFilename" value="{{ activity.image_filename if activity else '' }}">
              </div>

              <!-- Activity Type (Hidden - kept for backwards compatibility) -->
              <input type="hidden" name="type" value="{{ activity.type if activity else '' }}">
            </div>

            <!-- Section Divider -->
            <div class="section-divider mt-5 mb-3"></div>

            <!-- ============================================ -->
            <!-- SIGNUP SETTINGS SECTION                      -->
            <!-- ============================================ -->
            <div class="mb-4">
              <h3 class="mb-3">Signup Settings</h3>
              <div class="ps-0">

                    <!-- Signup Workflow -->
                    <div class="mb-4 form-selectgroup form-selectgroup-boxes">

                      <!-- Review First Card -->
                      <label class="form-selectgroup-item w-100 mb-3">
                        <input type="checkbox" name="workflow_type" value="approval_first" class="form-selectgroup-input"
                               {{ 'checked' if not activity or not activity.workflow_type or activity.workflow_type == 'approval_first' else '' }}>
                        <div class="form-selectgroup-label w-100 p-3">
                          <span class="form-selectgroup-check form-selectgroup-check-floated"></span>
                          <div class="d-flex align-items-center">
                            <div class="me-3">
                              <span class="avatar border-0">
                                <i class="ti ti-clipboard-check"></i>
                              </span>
                            </div>
                            <div class="flex-fill">
                              <strong>Review First</strong>
                              <div class="text-secondary mt-1">
                                You decide who gets in. Approved signups receive a passport with payment instructions.
                                <br><em>Ideal for: tryouts, limited spots, skill-based groups</em>
                              </div>
                            </div>
                          </div>
                        </div>
                      </label>

                      <!-- Pay First Card -->
                      <label class="form-selectgroup-item w-100">
                        <input type="checkbox" name="workflow_type" value="payment_first" class="form-selectgroup-input"
                               {{ 'checked' if activity and activity.workflow_type == 'payment_first' else '' }}>
                        <div class="form-selectgroup-label w-100 p-3">
                          <span class="form-selectgroup-check form-selectgroup-check-floated"></span>
                          <div class="d-flex align-items-center">
                            <div class="me-3">
                              <span class="avatar border-0">
                                <i class="ti ti-credit-card"></i>
                              </span>
                            </div>
                            <div class="flex-fill">
                              <strong>Pay First</strong>
                              <div class="text-secondary mt-1">
                                Signups immediately receive payment instructions by email. Once they pay, their passport is delivered automatically — nothing for you to approve.
                                <br><em>Ideal for: open events, concerts, classes, large groups</em>
                              </div>
                            </div>
                          </div>
                        </div>
                      </label>

                    </div>

                    <!-- Capacity Options -->
                    <div class="mb-3">
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="is_quantity_limited" id="isQuantityLimited"
                               {{ 'checked' if activity and activity.is_quantity_limited else '' }}
                               onchange="toggleCapacityFields()">
                        <span class="form-check-label">Limit capacity</span>
                      </label>
                    </div>
                    <div class="mb-3" id="maxSessionsField" style="{{ 'display: block;' if activity and activity.is_quantity_limited else 'display: none;' }}">
                      <label class="form-label">Maximum spots</label>
                      <input type="number" class="form-control" name="max_sessions" min="1"
                             value="{{ activity.max_sessions if activity and activity.max_sessions else '' }}"
                             placeholder="e.g., 80" style="max-width: 150px;">
                      <small class="form-hint">Signups are blocked when all spots are taken</small>
                    </div>
                    <div id="showRemainingField" style="{{ 'display: block;' if activity and activity.is_quantity_limited else 'display: none;' }}">
                      <label class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="show_remaining_quantity"
                               {{ 'checked' if activity and activity.show_remaining_quantity else '' }}>
                        <span class="form-check-label">Show remaining spots on signup form</span>
                      </label>
                    </div>

                    <!-- Additional Options -->
                    <div class="mb-3">
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="allow_quantity_selection" id="allowQuantitySelection"
                               {{ 'checked' if activity and activity.allow_quantity_selection else '' }}>
                        <span class="form-check-label">Allow users to select quantity during signup</span>
                      </label>
                      <small class="form-hint">Users can choose how many passports to purchase at once</small>
                    </div>

                    <div class="mb-3">
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="offer_passport_renewal"
                               {{ 'checked' if activity and activity.offer_passport_renewal else '' }}>
                        <span class="form-check-label">Offer passport renewal when all sessions are used</span>
                      </label>
                      <small class="form-hint">When a passport runs out, prompt to renew at the scan screen</small>
                    </div>

                    {% if stripe_configured %}
                    <div class="mb-3">
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="accept_credit_card"
                               {{ 'checked' if activity and activity.accept_credit_card else '' }}>
                        <span class="form-check-label">Accept credit card payments (Stripe)</span>
                      </label>
                      <small class="form-hint">Customers can pay by credit card via Stripe Checkout</small>
                    </div>
                    {% endif %}

              </div>
            </div>

            <div class="section-divider mt-5 mb-3"></div>

            <!-- ============================================ -->
            <!-- SCHEDULE & LOCATION SECTION                  -->
            <!-- ============================================ -->
            <div class="mb-4 pt-3">
              <h3 class="mb-3">Schedule & Location</h3>
              <div class="ps-0">

                    <!-- Start and End Dates -->
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="datetime-local" name="start_date" class="form-control" value="{{ activity.start_date.strftime('%Y-%m-%dT%H:%M') if activity and activity.start_date else '' }}">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">End Date</label>
                        <input type="datetime-local" name="end_date" class="form-control" value="{{ activity.end_date.strftime('%Y-%m-%dT%H:%M') if activity and activity.end_date else '' }}">
                      </div>
                    </div>

                    <!-- Location Section -->
                    <div class="mb-3">
                      <label class="form-label">Location (Optional)</label>
                      <div class="input-group">
                        <input type="text"
                               id="locationAutocomplete"
                               class="form-control"
                               placeholder="Enter address (e.g., 821 rue des sables rimouski)"
                               autocomplete="off"
                               value="{{ activity.location_address_raw if activity and activity.location_address_raw else '' }}">
                        <button type="button" id="lookupLocationBtn" class="btn btn-primary">
                          <i class="ti ti-search me-1"></i>Lookup
                        </button>
                      </div>
                      <small id="locationHint" class="form-hint">
                        Where will this activity take place?
                      </small>

                      <!-- Loading indicator -->
                      <div id="locationLoading" class="mt-2" style="display: none;">
                        <span class="spinner-border spinner-border-sm me-2"></span>Looking up address...
                      </div>

                      <!-- Error display -->
                      <div id="locationError" class="alert alert-warning mt-2" style="display: none;">
                        <i class="ti ti-alert-circle me-1"></i><span id="locationErrorText"></span>
                      </div>

                      <!-- Multiple results selection list -->
                      <div id="locationResults" class="list-group mt-2" style="display: none;"></div>

                      <!-- Confirmed location display -->
                      <div id="locationConfirmed" class="align-items-center border rounded p-3 mt-2" style="display: none;">
                        <a id="viewMapLink" href="#" target="_blank" class="text-reset text-decoration-none">
                          <i class="ti ti-map-pin me-2 text-muted"></i>
                          <span id="confirmedAddressText"></span>
                        </a>
                        <span class="ms-auto text-secondary" style="cursor: pointer;"
                              id="clearLocationBtn">
                          <i class="ti ti-x" style="font-size: 18px;"></i>
                        </span>
                      </div>

                      <!-- Hidden fields to store location data -->
                      <input type="hidden" name="location_address_raw" id="locationAddressRaw" value="{{ activity.location_address_raw if activity and activity.location_address_raw else '' }}">
                      <input type="hidden" name="location_address_formatted" id="locationAddressFormatted" value="{{ activity.location_address_formatted if activity and activity.location_address_formatted else '' }}">
                      <input type="hidden" name="location_coordinates" id="locationCoordinates" value="{{ activity.location_coordinates if activity and activity.location_coordinates else '' }}">
                    </div>

              </div>
            </div>

            <div class="section-divider mt-5 mb-3"></div>

            <!-- ============================================ -->
            <!-- PASSPORT TYPES SECTION (Always Visible)      -->
            <!-- ============================================ -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">
                  Passport Types
                </h3>
                <button type="button" class="btn btn-primary" id="addPassportTypeBtn" data-bs-toggle="modal" data-bs-target="#addPassportTypeModal">
                  <i class="ti ti-plus me-1"></i>Type
                </button>
              </div>

              <div class="card">
                <div class="table-responsive">
                  <table class="table table-vcenter card-table" id="passportTypesTable" style="display: none;">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th class="d-none d-md-table-cell">Price</th>
                        <th class="d-none d-md-table-cell">Sessions</th>
                        <th class="d-none d-md-table-cell">Signup Link</th>
                        <th class="w-1">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="passportTypesContainer">
                      <!-- Passport types will be dynamically added here -->
                    </tbody>
                  </table>
                </div>

                <div id="noPassportTypes" class="text-center p-4">
                  <i class="ti ti-id-off text-muted mb-3" style="font-size: 3rem;"></i>
                  <h5 class="text-muted mb-2">No passport types defined</h5>
                  <p class="text-muted mb-3">Create different pricing options and user types for this activity</p>
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPassportTypeModal">
                    <i class="ti ti-plus me-2"></i>Add Your First Passport Type
                  </button>
                </div>
              </div>
            </div>

            <div class="section-divider mt-5 mb-3"></div>

            <!-- ============================================ -->
            <!-- FINANCIAL MANAGEMENT SECTION (Edit Only)     -->
            <!-- ============================================ -->
            {% if activity %}
            <div class="mb-4" id="finances">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h3 class="mb-0">Finances</h3>
                <div class="dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addIncomeModal">
                      <i class="ti ti-plus me-2"></i>Add Income
                    </a>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                      <i class="ti ti-plus me-2"></i>Add Expense
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{{ url_for('financial_report') }}?activity_id={{ activity.id }}" target="_blank">
                      <i class="ti ti-edit me-2"></i>Edit Financial
                    </a>
                  </div>
                </div>
              </div>
              <div class="d-flex align-items-center gap-2 mb-3">
                <span class="text-muted small">{{ period_display }}</span>
                <div class="dropdown">
                  <button class="btn btn-sm btn-link text-muted dropdown-toggle p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="ti ti-filter"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item {% if current_period == 'fy' %}active{% endif %}" href="{{ url_for('edit_activity', activity_id=activity.id, period='fy') }}#finances">Fiscal Year</a></li>
                    <li><a class="dropdown-item {% if current_period == 'all' %}active{% endif %}" href="{{ url_for('edit_activity', activity_id=activity.id, period='all') }}#finances">All Time</a></li>
                  </ul>
                </div>
              </div>

              <!-- Income Statement (Profit & Loss) -->
              {% if summary %}
              <div class="card">
                <div class="card-body">
                  <!-- Revenue Section -->
                  <div class="mb-4">
                    <h6 class="text-uppercase text-muted fw-bold mb-3">Revenue</h6>
                    <div class="row">
                      <div class="col-8">
                        <div class="ps-3 mb-2">Passport Income</div>
                        <div class="ps-3 mb-2">Other Income</div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="mb-2 text-muted fw-bold">{{ summary.passport_income|accounting_format }}</div>
                        <div class="mb-2 text-muted fw-bold">{{ summary.other_income|accounting_format }}</div>
                      </div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                      <div class="col-8">
                        <div class="fw-bold">Total Revenue</div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="fw-bold">{{ (summary.passport_income + summary.other_income)|accounting_format }}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Expenses Section -->
                  <div class="mb-4">
                    <h6 class="text-uppercase text-muted fw-bold mb-3">Expenses</h6>
                    <div class="row">
                      <div class="col-8">
                        <div class="ps-3 mb-2">Total Expenses</div>
                      </div>
                      <div class="col-4 text-end">
                        <div class="mb-2 text-muted fw-bold">{{ summary.total_expenses|accounting_format }}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Net Income Section -->
                  <hr class="border-2">
                  <div class="row">
                    <div class="col-8">
                      <div class="fw-bold mb-0" style="font-size: 1.1rem;">Net Income</div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="fw-bold mb-0" style="font-size: 1.1rem;">
                        {{ summary.net_income|accounting_format }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
            {% endif %}

            <!-- Signup Links Container (Legacy - Hidden) -->
            {% if activity %}
            <div id="signupLinksContainer" style="display: none;">
              <!-- Legacy container - functionality moved to table -->
            </div>
            {% endif %}

          </div>

          <!-- Bottom Save Button -->
          <div class="card-footer text-end">
            <a href="{{ url_for('dashboard') }}" class="btn me-2">Cancel</a>
            <button type="submit" class="btn btn-success">
              <i class="ti ti-check me-1"></i>Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>


<!-- Cover Photo Crop Modal -->
<div class="modal modal-blur fade" id="cropModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-crop me-2"></i>Adjust Cover Photo
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0" style="background:#1a1a2e;">
        <div style="max-height:60vh; overflow:hidden; display:flex; align-items:center; justify-content:center;">
          <img id="cropImage" src="" alt="Crop preview"
               style="display:block; max-width:100%; max-height:60vh;">
        </div>
        <div class="p-3 text-center">
          <small class="text-muted">
            <i class="ti ti-arrows-move me-1"></i>Drag to reposition
            <span class="mx-2">|</span>
            <i class="ti ti-zoom-in me-1"></i>Pinch or scroll to zoom
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="ti ti-x me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary" id="cropConfirmBtn">
          <i class="ti ti-check me-1"></i>Use Photo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Unsplash Images -->
<div class="modal modal-blur fade" id="unsplashModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select an Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="unsplashImages" class="row g-3"></div>
        <div id="unsplashPagination" class="d-flex justify-content-between align-items-center pt-3" style="display: none;">
          <button class="btn btn-outline-secondary" id="prevPageBtn">Previous</button>
          <span id="pageIndicator" class="text-muted small">Page 1</span>
          <button class="btn btn-outline-primary" id="nextPageBtn">Next</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Add Passport Type Modal -->
<div class="modal modal-blur fade" id="addPassportTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-plus me-2"></i>Add New Passport Type
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label required">Passport Type Name</label>
            <input type="text" class="form-control" id="newPassportTypeName"
                   placeholder="e.g., Regular, Premium, Student" required>
            <div class="form-hint">This will be visible to users during signup</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Price per User ($)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="newPassportTypePrice"
                   value="0.00" required>
            <div class="form-hint">Amount each user pays for this passport type</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Sessions Included</label>
            <input type="number" min="1" class="form-control" id="newPassportTypeSessions"
                   value="1" required>
            <div class="form-hint">Number of sessions included in this price</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveNewPassportType">
          <i class="ti ti-check me-2"></i>Add Passport Type
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Passport Type Modal -->
<div class="modal modal-blur fade" id="editPassportTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-edit me-2"></i>Edit Passport Type
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label required">Passport Type Name</label>
            <input type="text" class="form-control" id="editPassportTypeName" required>
            <div class="form-hint">This will be visible to users during signup</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Price per User ($)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="editPassportTypePrice" required>
            <div class="form-hint">Amount each user pays for this passport type</div>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Sessions Included</label>
            <input type="number" min="1" class="form-control" id="editPassportTypeSessions" required>
            <div class="form-hint">Number of sessions included in this price</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveEditPassportType">
          <i class="ti ti-check me-2"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div class="modal modal-blur fade" id="addIncomeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-cash me-2"></i>Add Income
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addIncomeForm" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="activity_id" value="{{ activity.id if activity }}">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Category</label>
              <select name="category" class="form-select" required>
                <option value="Ticket Sales">Ticket Sales</option>
                <option value="Sponsorship">Sponsorship</option>
                <option value="Donations">Donations</option>
                <option value="Vendor Fees">Vendor Fees</option>
                <option value="Service Income">Service Income</option>
                <option value="Merchandise Sales">Merchandise Sales</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Amount ($)</label>
              <input type="number" name="amount" step="0.01" min="0" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Date</label>
              <input type="date" name="date" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Note (optional)</label>
              <textarea name="note" class="form-control" rows="2" placeholder="Add any additional notes..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveIncomeBtn">
          <i class="ti ti-check me-2"></i>Add Income
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Expense Modal -->
<div class="modal modal-blur fade" id="addExpenseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-currency-dollar me-2"></i>Add Expense
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addExpenseForm" method="POST" action="{{ url_for('activity_expenses', activity_id=activity.id) if activity else '#' }}" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="return_to" value="activity_form">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Category</label>
              <select name="category" class="form-select" required>
                <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                <option value="Staff">Staff</option>
                <option value="Venue">Venue</option>
                <option value="Equipment Rental">Equipment Rental</option>
                <option value="Insurance">Insurance</option>
                <option value="Marketing">Marketing</option>
                <option value="Travel">Travel</option>
                <option value="Supplies">Supplies</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Amount ($)</label>
              <input type="number" name="amount" step="0.01" min="0" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Date</label>
              <input type="date" name="date" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Description (optional)</label>
              <textarea name="description" class="form-control" rows="2" placeholder="Add any additional notes..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="saveExpenseBtn">
          <i class="ti ti-check me-2"></i>Add Expense
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal modal-blur fade" id="editExpenseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ti ti-edit me-2"></i>Edit Expense
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editExpenseForm" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="return_to" value="activity_form">
          <input type="hidden" id="editExpenseId" name="expense_id">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Category</label>
              <select name="category" id="editExpenseCategory" class="form-select" required>
                <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                <option value="Staff">Staff</option>
                <option value="Venue">Venue</option>
                <option value="Equipment Rental">Equipment Rental</option>
                <option value="Insurance">Insurance</option>
                <option value="Marketing">Marketing</option>
                <option value="Travel">Travel</option>
                <option value="Supplies">Supplies</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Amount ($)</label>
              <input type="number" name="amount" id="editExpenseAmount" step="0.01" min="0" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label required">Date</label>
              <input type="date" name="date" id="editExpenseDate" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Upload Receipt (optional)</label>
              <input type="file" name="receipt" accept="image/*" capture="environment" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Description (optional)</label>
              <textarea name="description" id="editExpenseDescription" class="form-control" rows="2" placeholder="Add any additional notes..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="updateExpenseBtn">
          <i class="ti ti-check me-2"></i>Update Expense
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Income Confirmation Modal -->
<div class="modal modal-blur fade" id="deleteIncomeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Delete Income Entry?</div>
        <div>Are you sure you want to delete the <strong id="deleteIncomeCategory"></strong> income entry? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteIncome">
          <i class="ti ti-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Expense Confirmation Modal -->
<div class="modal modal-blur fade" id="deleteExpenseModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Delete Expense Entry?</div>
        <div>Are you sure you want to delete the <strong id="deleteExpenseCategory"></strong> expense entry? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteExpense">
          <i class="ti ti-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Passport Type Confirmation Modal -->
<div class="modal modal-blur fade" id="deletePassportTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Delete Passport Type?</div>
        <div>Are you sure you want to delete "<span id="deletePassportTypeName"></span>"? This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeletePassportType">
          <i class="ti ti-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initLocationAutocomplete" async defer></script>
{% endif %}

<script>
  function copyToClipboard(button) {
    const input = button.closest('.input-group').querySelector('input');
    input.select();
    document.execCommand("copy");
    button.innerHTML = '<i class="ti ti-check"></i>';
    setTimeout(() => { button.innerHTML = '<i class="ti ti-copy"></i>'; }, 1500);
  }

  // Update status value based on toggle
  function updateStatusValue() {
    const toggle = document.getElementById('statusToggle');
    const statusValue = document.getElementById('statusValue');
    const statusLabel = document.getElementById('statusLabel');
    if (toggle.checked) {
      statusValue.value = 'active';
      statusLabel.textContent = 'Active';
    } else {
      statusValue.value = 'archived';
      statusLabel.textContent = 'Archived';
    }
  }

  // Toggle capacity limit fields visibility
  function toggleCapacityFields() {
    const isLimited = document.getElementById('isQuantityLimited').checked;
    document.getElementById('maxSessionsField').style.display = isLimited ? 'block' : 'none';
    document.getElementById('showRemainingField').style.display = isLimited ? 'block' : 'none';
  }

  // Initialize Google Places Autocomplete (called by Google Maps API callback)
  function initLocationAutocomplete() {
    console.log('initLocationAutocomplete called');
    const input = document.getElementById('locationAutocomplete');
    if (!input) {
      console.log('locationAutocomplete input not found');
      return;
    }
    console.log('Creating autocomplete for input:', input);

    const options = {
      componentRestrictions: { country: 'ca' },
      types: ['geocode', 'establishment'],
      fields: ['formatted_address', 'geometry', 'name']
    };

    try {
      const autocomplete = new google.maps.places.Autocomplete(input, options);
      console.log('Autocomplete created successfully:', autocomplete);

      autocomplete.addListener('place_changed', function() {
        console.log('place_changed event fired');
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          console.log('No geometry in place:', place);
          return;
        }

        setLocationConfirmed(input.value, place.formatted_address,
          place.geometry.location.lat() + ',' + place.geometry.location.lng());
      });
    } catch (error) {
      console.error('Error creating autocomplete:', error);
    }
  }

  // Set location as confirmed
  function setLocationConfirmed(rawAddress, formattedAddress, coordinates) {
    const input = document.getElementById('locationAutocomplete');
    const inputGroup = input.closest('.input-group');

    // Populate hidden fields
    document.getElementById('locationAddressRaw').value = rawAddress;
    document.getElementById('locationAddressFormatted').value = formattedAddress;
    document.getElementById('locationCoordinates').value = coordinates;

    // Show confirmation, hide input group and hint
    document.getElementById('confirmedAddressText').textContent = formattedAddress;
    document.getElementById('viewMapLink').href = 'https://www.google.com/maps?q=' + coordinates;
    document.getElementById('locationConfirmed').style.display = 'flex';
    document.getElementById('locationError').style.display = 'none';
    document.getElementById('locationHint').style.display = 'none';

    // Hide input and lookup button when confirmed
    inputGroup.style.display = 'none';
  }

  // Clear location and show input again
  function clearLocation() {
    const input = document.getElementById('locationAutocomplete');
    const inputGroup = input.closest('.input-group');

    // Clear values
    input.value = '';
    document.getElementById('locationAddressRaw').value = '';
    document.getElementById('locationAddressFormatted').value = '';
    document.getElementById('locationCoordinates').value = '';

    // Hide confirmation, results, and errors - show input and hint
    document.getElementById('locationConfirmed').style.display = 'none';
    document.getElementById('locationError').style.display = 'none';
    document.getElementById('locationResults').style.display = 'none';
    document.getElementById('locationHint').style.display = 'block';
    inputGroup.style.display = 'flex';
    input.focus();
  }

  // Manual lookup using Places Autocomplete API
  function lookupLocation() {
    const input = document.getElementById('locationAutocomplete');
    const address = input.value.trim();

    if (!address) {
      alert('Please enter an address first');
      return;
    }

    document.getElementById('locationLoading').style.display = 'block';
    document.getElementById('locationError').style.display = 'none';
    document.getElementById('locationResults').style.display = 'none';

    fetch('/api/places/autocomplete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input: address })
    })
    .then(r => r.json())
    .then(data => {
      document.getElementById('locationLoading').style.display = 'none';
      if (data.success && data.results && data.results.length > 0) {
        showLocationResults(address, data.results);
      } else {
        document.getElementById('locationErrorText').textContent = data.error || 'No addresses found. Try a more specific address.';
        document.getElementById('locationError').style.display = 'block';
      }
    })
    .catch(err => {
      document.getElementById('locationLoading').style.display = 'none';
      document.getElementById('locationErrorText').textContent = 'Error looking up address. Please try again.';
      document.getElementById('locationError').style.display = 'block';
    });
  }

  // Display location results for user selection
  function showLocationResults(rawAddress, results) {
    const container = document.getElementById('locationResults');
    container.innerHTML = '<div class="list-group-item list-group-item-secondary py-2"><small><strong>Select the correct address:</strong></small></div>';
    results.forEach(function(result) {
      const item = document.createElement('a');
      item.href = '#';
      item.className = 'list-group-item list-group-item-action py-2';
      item.innerHTML = '<i class="ti ti-map-pin me-2 text-muted"></i>' + result.description;
      item.onclick = function(e) {
        e.preventDefault();
        selectPlaceResult(rawAddress, result.place_id, result.description);
      };
      container.appendChild(item);
    });
    container.style.display = 'block';
  }

  // Get full details for selected place and confirm
  function selectPlaceResult(rawAddress, placeId, description) {
    document.getElementById('locationResults').style.display = 'none';
    document.getElementById('locationLoading').style.display = 'block';

    fetch('/api/places/details', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ place_id: placeId })
    })
    .then(r => r.json())
    .then(data => {
      document.getElementById('locationLoading').style.display = 'none';
      if (data.success) {
        setLocationConfirmed(rawAddress, data.formatted_address, data.coordinates);
      } else {
        document.getElementById('locationErrorText').textContent = data.error || 'Could not get address details.';
        document.getElementById('locationError').style.display = 'block';
      }
    })
    .catch(err => {
      document.getElementById('locationLoading').style.display = 'none';
      document.getElementById('locationErrorText').textContent = 'Error getting address details.';
      document.getElementById('locationError').style.display = 'block';
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Image handling variables
    const coverPhotoWrapper = document.getElementById('coverPhotoWrapper');
    const selectedImageFilename = document.getElementById('selectedImageFilename');
    const uploadInput = document.getElementById('uploadInput');
    const imageOptionsCollapse = document.getElementById('imageOptions');

    // Passport type variables
    const addPassportTypeBtn = document.getElementById('addPassportTypeBtn');
    const passportTypesContainer = document.getElementById('passportTypesContainer');
    const noPassportTypes = document.getElementById('noPassportTypes');
    const signupLinksContainer = document.getElementById('signupLinksContainer');

    let passportTypeCounter = 0;
    let passportTypes = [];

    const searchBtn = document.getElementById('searchImagesBtn');
    const imageDescInput = document.getElementById('imageDescription');
    const unsplashModal = new bootstrap.Modal(document.getElementById('unsplashModal'));
    const unsplashImagesDiv = document.getElementById('unsplashImages');
    const paginationControls = document.getElementById('unsplashPagination');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');

    let currentPage = 1;
    let currentQuery = "";

    // Click on thumbnail to toggle options panel (using event delegation for dynamic content)
    document.addEventListener('click', function(e) {
      const wrapper = e.target.closest('#coverPhotoWrapper');
      if (!wrapper) return;
      // Don't trigger if clicking the delete X badge
      if (e.target.closest('#deleteImageBtn')) return;
      // Toggle the right-side options panel
      const panel = document.getElementById('imageOptions');
      panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    });

    // Delete image immediately (no confirmation modal)
    function setupDeleteButton() {
      const deleteBtn = document.getElementById('deleteImageBtn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          // Clear the image filename
          selectedImageFilename.value = '';
          if (uploadInput) uploadInput.value = '';
          // Reset thumbnail to placeholder (100x100 square)
          const wrapper = document.getElementById('coverPhotoWrapper');
          wrapper.innerHTML = `
            <div id="coverThumbnail" class="d-flex flex-column align-items-center justify-content-center"
                 style="width: 100px; height: 100px;">
              <i class="ti ti-photo text-muted fs-2"></i>
              <small class="text-muted">Add photo</small>
            </div>`;
        });
      }
    }
    setupDeleteButton();

    // Source toggle: unchecked = Search Web, checked = Upload
    const sourceToggle = document.getElementById('sourceToggle');
    const searchWebContent = document.getElementById('searchWebContent');
    const uploadContent = document.getElementById('uploadContent');

    if (sourceToggle) {
      sourceToggle.addEventListener('change', function() {
        searchWebContent.style.display = this.checked ? 'none' : 'block';
        uploadContent.style.display = this.checked ? 'block' : 'none';
      });
    }

    // Helper function to update thumbnail with image and delete badge (100x100 square)
    function updateThumbnailWithImage(imgSrc) {
      const wrapper = document.getElementById('coverPhotoWrapper');
      wrapper.innerHTML = `
        <img id="coverThumbnail"
             src="${imgSrc}"
             class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
        <span class="position-absolute top-0 end-0 badge bg-danger rounded-circle p-2"
              style="cursor: pointer;"
              id="deleteImageBtn">
          <i class="ti ti-x text-white" style="font-size: 14px;"></i>
        </span>`;
      // Re-setup delete button event listener
      setupDeleteButton();
    }

    // Crop tool state
    let cropperInstance = null;
    const cropModalEl = document.getElementById('cropModal');
    const cropModal = cropModalEl ? new bootstrap.Modal(cropModalEl) : null;
    const cropImage = document.getElementById('cropImage');
    const cropConfirmBtn = document.getElementById('cropConfirmBtn');

    if (uploadInput) {
      uploadInput.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          cropImage.src = e.target.result;
          cropModal.show();
        };
        reader.readAsDataURL(file);
        this.value = ''; // reset so same file triggers change again if re-selected
      });
    }

    if (cropModalEl) {
      cropModalEl.addEventListener('shown.bs.modal', function () {
        if (cropperInstance) cropperInstance.destroy();
        cropperInstance = new Cropper(cropImage, {
          aspectRatio: 16 / 9,
          viewMode: 1,
          autoCropArea: 0.9,
          movable: true,
          zoomable: true,
          rotatable: false,
          scalable: false,
          responsive: true
        });
      });
      cropModalEl.addEventListener('hidden.bs.modal', function () {
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
      });
    }

    if (cropConfirmBtn) {
      cropConfirmBtn.addEventListener('click', function () {
        if (!cropperInstance) return;
        cropperInstance.getCroppedCanvas({ maxWidth: 1200, maxHeight: 675, imageSmoothingQuality: 'high' })
          .toBlob(function (blob) {
            const dt = new DataTransfer();
            dt.items.add(new File([blob], 'cover.jpg', { type: 'image/jpeg' }));
            uploadInput.files = dt.files;
            selectedImageFilename.value = '';
            updateThumbnailWithImage(URL.createObjectURL(blob));
            cropModal.hide();
          }, 'image/jpeg', 0.92);
      });
    }

    if (imageDescInput) {
      imageDescInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchBtn.click();
        }
      });
    }

    if (searchBtn) {
      searchBtn.addEventListener('click', function () {
        const query = imageDescInput.value.trim();
        if (!query) {
          alert("Please enter a description first.");
          return;
        }
        currentQuery = query;
        currentPage = 1;
        loadUnsplashImages(currentPage);
        unsplashModal.show();
      });
    }

    if (prevPageBtn) {
      prevPageBtn.addEventListener('click', function () {
        if (currentPage > 1) {
          currentPage--;
          loadUnsplashImages(currentPage);
        }
      });
    }

    if (nextPageBtn) {
      nextPageBtn.addEventListener('click', function () {
        currentPage++;
        loadUnsplashImages(currentPage);
      });
    }

    function loadUnsplashImages(page = 1) {
      if (!currentQuery) return;

      unsplashImagesDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

      fetch(`/unsplash-search?q=${encodeURIComponent(currentQuery)}&page=${page}`)
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
              throw new Error(errorData.error || 'Search failed');
            });
          }
          return response.json();
        })
        .then(data => {
          unsplashImagesDiv.innerHTML = '';
          if (data.length === 0) {
            unsplashImagesDiv.innerHTML = '<div class="text-center p-4"><p class="text-muted">No images found for this search.</p></div>';
            paginationControls.style.display = 'none';
            return;
          }

          data.forEach(image => {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-3';
            col.innerHTML = `
              <div class="card card-link card-border shadow-sm h-100">
                <img src="${image.thumb}" class="card-img-top" style="cursor:pointer; height: 200px; object-fit: cover;" alt="Unsplash Image">
              </div>
            `;
            col.querySelector('img').addEventListener('click', function () {
              this.style.opacity = '0.5';
              this.style.cursor = 'wait';

              fetch(`/download-unsplash-image?url=${encodeURIComponent(image.full)}`)
                .then(response => response.json())
                .then(result => {
                  if (result.success) {
                    const imgUrl = `/static/uploads/activity_images/${result.filename}`;
                    selectedImageFilename.value = result.filename;
                    if (uploadInput) uploadInput.value = "";

                    // Update thumbnail with the downloaded image
                    updateThumbnailWithImage(imgUrl);

                    unsplashModal.hide();
                  } else {
                    alert("Failed to download image. Please try again.");
                    this.style.opacity = '1';
                    this.style.cursor = 'pointer';
                  }
                })
                .catch(error => {
                  console.error('Error downloading image:', error);
                  alert("Error downloading image. Please try again.");
                  this.style.opacity = '1';
                  this.style.cursor = 'pointer';
                });
            });
            unsplashImagesDiv.appendChild(col);
          });

          paginationControls.style.display = 'flex';
          prevPageBtn.disabled = page === 1;
        })
        .catch(error => {
          console.error('Error loading images:', error);
          let errorMessage = 'Error loading images. Please try again.';

          if (error.message.includes('API key')) {
            errorMessage = 'Image search is not available. The API key needs to be configured by an administrator.';
          } else if (error.message.includes('temporarily unavailable')) {
            errorMessage = 'Image search service is temporarily unavailable. Please try again later.';
          }

          unsplashImagesDiv.innerHTML = `
            <div class="text-center p-4">
              <div class="alert alert-warning border-warning mb-3">
                <div class="d-flex align-items-center">
                  <i class="ti ti-alert-triangle me-2"></i>
                  <strong>Image Search Unavailable</strong>
                </div>
                <p class="mb-0 mt-2">${errorMessage}</p>
              </div>
              <div class="text-muted small">
                <p class="mb-2"><strong>Alternative options:</strong></p>
                <ul class="list-unstyled">
                  <li>Use the "Upload your own image" option instead</li>
                  <li>Contact your administrator to configure image search</li>
                  <li>Proceed without an image for now</li>
                </ul>
              </div>
            </div>
          `;
          paginationControls.style.display = 'none';
        });
    }

    // Passport Type Management Functions
    function createPassportTypeTableRow(passportType) {
      const id = passportType.id || `new_${passportTypeCounter++}`;

      const isExisting = id && !id.toString().startsWith('new_');
      let signupUrl = '[Available after saving]';
      let signupButtonsDisabled = true;

      if (isExisting && '{{ activity.id if activity }}') {
        signupUrl = `{{ url_for('signup', activity_id=activity.id, _external=True) if activity }}?passport_type_id=${id}`;
        signupButtonsDisabled = false;
      }

      return `
        <tr data-id="${id}">
          <td>
            <div class="fw-bold">${passportType.name || 'New Passport Type'}</div>
          </td>
          <td class="d-none d-md-table-cell">
            <span class="fw-bold text-muted">$${passportType.price_per_user || '0.00'}</span>
          </td>
          <td class="d-none d-md-table-cell">
            <span class="text-muted">${passportType.sessions_included || '1'} sessions</span>
          </td>
          <td class="d-none d-md-table-cell">
            <div class="input-group input-group-flat" style="max-width: 300px;">
              <input type="text" class="form-control form-control-sm signup-url-input" readonly value="${signupUrl}">
              <span class="input-group-text">
                <button class="btn btn-sm btn-outline-secondary copy-signup-btn" type="button" ${signupButtonsDisabled ? 'disabled' : ''}
                        onclick="copySignupLink(this)" title="Copy link">
                  <i class="ti ti-copy"></i>
                </button>
                ${!signupButtonsDisabled ? `<a class="btn btn-sm btn-outline-secondary ms-1" target="_blank" href="${signupUrl}" title="Open in new tab"><i class="ti ti-external-link"></i></a>` : ''}
              </span>
            </div>
          </td>
          <td>
            <div class="dropdown">
              <a href="#" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                Actions
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="#" onclick="editPassportType('${id}')">
                  <i class="ti ti-edit me-2"></i> Edit
                </a>
                ${!signupButtonsDisabled ? `
                <a class="dropdown-item" href="#" onclick="copySignupLinkFromDropdown('${id}', '${signupUrl}')">
                  <i class="ti ti-copy me-2"></i> Copy Signup Link
                </a>
                ` : ''}
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-danger" href="#" onclick="confirmDeletePassportType('${id}', '${passportType.name || 'New Passport Type'}')">
                  <i class="ti ti-trash me-2"></i> Delete
                </a>
              </div>
            </div>
          </td>
          <!-- Hidden form inputs for server submission -->
          <input type="hidden" name="passport_types[${id}][name]" value="${passportType.name || ''}">
          <input type="hidden" name="passport_types[${id}][price_per_user]" value="${passportType.price_per_user || '0.00'}">
          <input type="hidden" name="passport_types[${id}][sessions_included]" value="${passportType.sessions_included || '1'}">
        </tr>
      `;
    }

    // Modal Management Functions
    const addPassportTypeModal = new bootstrap.Modal(document.getElementById('addPassportTypeModal'));
    const editPassportTypeModal = new bootstrap.Modal(document.getElementById('editPassportTypeModal'));
    const deletePassportTypeModal = new bootstrap.Modal(document.getElementById('deletePassportTypeModal'));

    let currentEditingId = null;
    let currentDeletingId = null;

    function addNewPassportType() {
      const name = document.getElementById('newPassportTypeName').value.trim();
      const price = document.getElementById('newPassportTypePrice').value;
      const sessions = document.getElementById('newPassportTypeSessions').value;

      if (!name) {
        alert('Please enter a passport type name.');
        return;
      }

      const newPassportType = {
        id: `new_${passportTypeCounter++}`,
        name: name,
        price_per_user: price,
        sessions_included: sessions
      };

      passportTypes.push(newPassportType);

      const rowHtml = createPassportTypeTableRow(newPassportType);
      passportTypesContainer.insertAdjacentHTML('beforeend', rowHtml);

      updateVisibility();

      clearAddModal();
      addPassportTypeModal.hide();
    }

    function editPassportType(id) {
      const passportType = passportTypes.find(pt => pt.id == id) || getPassportTypeFromRow(id);
      if (!passportType) return;

      currentEditingId = id;

      document.getElementById('editPassportTypeName').value = passportType.name || '';
      document.getElementById('editPassportTypePrice').value = passportType.price_per_user || '0.00';
      document.getElementById('editPassportTypeSessions').value = passportType.sessions_included || '1';

      editPassportTypeModal.show();
    }

    function saveEditPassportType() {
      if (!currentEditingId) return;

      const name = document.getElementById('editPassportTypeName').value.trim();
      const price = document.getElementById('editPassportTypePrice').value;
      const sessions = document.getElementById('editPassportTypeSessions').value;

      if (!name) {
        alert('Please enter a passport type name.');
        return;
      }

      const updatedPassportType = {
        id: currentEditingId,
        name: name,
        price_per_user: price,
        sessions_included: sessions
      };

      const index = passportTypes.findIndex(pt => pt.id == currentEditingId);
      if (index !== -1) {
        passportTypes[index] = updatedPassportType;
      }

      const row = document.querySelector(`[data-id="${currentEditingId}"]`);
      if (row) {
        row.outerHTML = createPassportTypeTableRow(updatedPassportType);
      }

      editPassportTypeModal.hide();
      currentEditingId = null;
    }

    function confirmDeletePassportType(id, name) {
      currentDeletingId = id;
      document.getElementById('deletePassportTypeName').textContent = name;

      if (id && !id.toString().startsWith('new_')) {
        checkPassportTypeDependencies(id, name);
      } else {
        deletePassportTypeModal.show();
      }
    }

    function checkPassportTypeDependencies(id, name) {
      fetch(`/api/passport-type-dependencies/${id}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.has_dependencies) {
              showArchivePassportTypeModal(id, name, data.passport_count, data.signup_count);
            } else {
              deletePassportTypeModal.show();
            }
          } else {
            alert('Error checking dependencies: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error checking dependencies. Please try again.');
        });
    }

    function showArchivePassportTypeModal(id, name, passportCount, signupCount) {
      let usageItems = '';
      if (passportCount > 0) {
        const passportText = passportCount === 1 ? 'existing passport' : 'existing passports';
        usageItems += '<li><strong>' + passportCount + '</strong> ' + passportText + '</li>';
      }
      if (signupCount > 0) {
        const signupText = signupCount === 1 ? 'signup' : 'signups';
        usageItems += '<li><strong>' + signupCount + '</strong> ' + signupText + '</li>';
      }

      const modalHtml =
        '<div class="modal modal-blur fade" id="archivePassportTypeModal" tabindex="-1">' +
          '<div class="modal-dialog modal-dialog-centered">' +
            '<div class="modal-content">' +
              '<div class="modal-header">' +
                '<h5 class="modal-title">' +
                  '<i class="ti ti-alert-triangle text-warning me-2"></i>' +
                  'Cannot Delete Passport Type' +
                '</h5>' +
                '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
              '</div>' +
              '<div class="modal-body">' +
                '<div class="alert alert-warning border-warning">' +
                  '<div class="d-flex align-items-center">' +
                    '<i class="ti ti-shield-exclamation me-2"></i>' +
                    '<strong>This passport type is currently in use and cannot be deleted</strong>' +
                  '</div>' +
                '</div>' +
                '<p class="mb-3">The passport type <strong>"' + name + '"</strong> is currently being used by:</p>' +
                '<ul class="mb-4">' + usageItems + '</ul>' +
                '<div class="card bg-light">' +
                  '<div class="card-body">' +
                    '<h6 class="card-title">' +
                      '<i class="ti ti-archive me-2"></i>' +
                      'Archive Instead' +
                    '</h6>' +
                    '<p class="mb-2">Instead of deleting, you can <strong>archive</strong> this passport type. This will:</p>' +
                    '<ul class="mb-0">' +
                      '<li>Hide it from new signups</li>' +
                      '<li>Preserve all existing passport data</li>' +
                      '<li>Maintain complete historical records</li>' +
                      '<li>Allow you to restore it later if needed</li>' +
                    '</ul>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">' +
                  '<i class="ti ti-x me-2"></i>Cancel' +
                '</button>' +
                '<button type="button" class="btn btn-warning" onclick="archivePassportType(' + id + ', \'' + name.replace(/'/g, "\\'") + '\')">' +
                  '<i class="ti ti-archive me-2"></i>Archive This Type' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      const existingModal = document.getElementById('archivePassportTypeModal');
      if (existingModal) {
        existingModal.remove();
      }

      document.body.insertAdjacentHTML('beforeend', modalHtml);

      const archiveModal = new bootstrap.Modal(document.getElementById('archivePassportTypeModal'));
      archiveModal.show();
    }

    function archivePassportType(id, name) {
      const archiveButton = document.querySelector('button[onclick*="archivePassportType"]');
      const originalText = archiveButton.innerHTML;
      archiveButton.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Archiving...';
      archiveButton.disabled = true;

      fetch(`/api/passport-type-archive/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const row = document.querySelector(`[data-id="${id}"]`);
          if (row) {
            row.remove();
          }

          passportTypes = passportTypes.filter(pt => pt.id != id);
          updateVisibility();

          const archiveModal = bootstrap.Modal.getInstance(document.getElementById('archivePassportTypeModal'));
          if (archiveModal) {
            archiveModal.hide();
          }
          currentDeletingId = null;

          showSuccessMessage(`Passport type "${name}" has been archived successfully!`);

        } else {
          archiveButton.innerHTML = originalText;
          archiveButton.disabled = false;

          showErrorMessage('Failed to archive passport type: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);

        archiveButton.innerHTML = originalText;
        archiveButton.disabled = false;

        showErrorMessage('Connection error. Please check your internet connection and try again.');
      });
    }

    function showSuccessMessage(message) {
      const alertHtml =
        '<div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;">' +
          '<div class="d-flex align-items-center">' +
            '<i class="ti ti-check-circle me-2"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>';

      document.body.insertAdjacentHTML('beforeend', alertHtml);

      setTimeout(() => {
        const alert = document.querySelector('.alert-success');
        if (alert) {
          alert.remove();
        }
      }, 5000);
    }

    function showErrorMessage(message) {
      const alertHtml =
        '<div class="alert alert-danger alert-dismissible fade show position-fixed" style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;">' +
          '<div class="d-flex align-items-center">' +
            '<i class="ti ti-alert-circle me-2"></i>' +
            '<span>' + message + '</span>' +
          '</div>' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>';

      document.body.insertAdjacentHTML('beforeend', alertHtml);

      setTimeout(() => {
        const alert = document.querySelector('.alert-danger');
        if (alert) {
          alert.remove();
        }
      }, 8000);
    }

    function deletePassportType() {
      if (!currentDeletingId) return;

      if (currentDeletingId.toString().startsWith('new_')) {
        const row = document.querySelector(`[data-id="${currentDeletingId}"]`);
        if (row) {
          row.remove();
        }
        passportTypes = passportTypes.filter(pt => pt.id != currentDeletingId);
        updateVisibility();
        deletePassportTypeModal.hide();
        currentDeletingId = null;
        return;
      }

      const deleteButton = document.querySelector('#confirmDeletePassportType');
      const originalText = deleteButton.innerHTML;
      deleteButton.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Deleting...';
      deleteButton.disabled = true;

      fetch(`/api/passport-type-archive/${currentDeletingId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = window.location.pathname + '?deleted=' + encodeURIComponent(data.passport_type_name);
        } else {
          window.location.href = window.location.pathname + '?error=' + encodeURIComponent(data.error || 'Unknown error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        window.location.href = window.location.pathname + '?error=Connection error';
      });
    }

    function getPassportTypeFromRow(id) {
      const row = document.querySelector(`[data-id="${id}"]`);
      if (!row) return null;

      return {
        id: id,
        name: row.querySelector('input[name*="[name]"]').value,
        price_per_user: row.querySelector('input[name*="[price_per_user]"]').value,
        sessions_included: row.querySelector('input[name*="[sessions_included]"]').value
      };
    }

    function clearAddModal() {
      document.getElementById('newPassportTypeName').value = '';
      document.getElementById('newPassportTypePrice').value = '0.00';
      document.getElementById('newPassportTypeSessions').value = '1';
    }

    function updateVisibility() {
      const hasPassportTypes = passportTypesContainer.children.length > 0;
      const passportTypesTable = document.getElementById('passportTypesTable');

      if (hasPassportTypes) {
        noPassportTypes.style.display = 'none';
        passportTypesTable.style.display = 'table';
      } else {
        noPassportTypes.style.display = 'block';
        passportTypesTable.style.display = 'none';
      }
    }

    function updateSignupLinks() {
      // Legacy function - functionality moved to table rows
    }

    function copySignupLink(button) {
      const input = button.closest('.input-group').querySelector('.signup-url-input');
      input.select();
      document.execCommand("copy");
      button.innerHTML = '<i class="ti ti-check"></i>';
      setTimeout(() => { button.innerHTML = '<i class="ti ti-copy"></i>'; }, 1500);
    }

    function copySignupLinkFromDropdown(id, url) {
      event.preventDefault();
      navigator.clipboard.writeText(url).then(() => {
        showFlashMessage('Signup link copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showFlashMessage('Failed to copy link', 'error');
      });
    }

    function showFlashMessage(message, category = 'success') {
      let overlay = document.getElementById('flashAlertOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'flashAlertOverlay';
        overlay.className = 'flash-alert-overlay';
        overlay.innerHTML = '<div class="flash-alert-container"></div>';
        document.body.insertBefore(overlay, document.body.firstChild);
      }

      const container = overlay.querySelector('.flash-alert-container');

      const alertClass = category === 'success' ? 'alert-success' :
                         category === 'error' ? 'alert-danger' :
                         category === 'warning' ? 'alert-warning' : 'alert-info';
      const iconClass = category === 'success' ? 'ti-check-circle' :
                        category === 'error' ? 'ti-alert-circle' :
                        category === 'warning' ? 'ti-alert-triangle' : 'ti-info-circle';
      const title = category === 'success' ? 'Success' :
                    category === 'error' ? 'Error' :
                    category === 'warning' ? 'Warning' : 'Information';

      const alert = document.createElement('div');
      alert.className = `flash-alert alert ${alertClass} alert-dismissible`;
      alert.setAttribute('role', 'alert');
      alert.setAttribute('aria-live', 'polite');
      alert.setAttribute('aria-atomic', 'true');
      alert.innerHTML = `
        <div class="d-flex">
          <div class="alert-icon-container">
            <i class="ti ${iconClass} alert-icon"></i>
          </div>
          <div class="flex-fill">
            <div class="alert-title">${title}</div>
            <div class="alert-message">${message}</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close notification"></button>
        </div>
        <div class="flash-alert-progress"></div>
      `;

      container.appendChild(alert);

      setTimeout(() => alert.classList.add('show'), 10);

      setTimeout(() => {
        alert.classList.add('hide');
        setTimeout(() => {
          alert.remove();
          if (container.children.length === 0) {
            overlay.remove();
          }
        }, 400);
      }, 3000);

      const closeBtn = alert.querySelector('.btn-close');
      closeBtn.addEventListener('click', () => {
        alert.classList.add('hide');
        setTimeout(() => {
          alert.remove();
          if (container.children.length === 0) {
            overlay.remove();
          }
        }, 400);
      });
    }

    // Make functions global
    window.copySignupLink = copySignupLink;
    window.copySignupLinkFromDropdown = copySignupLinkFromDropdown;

    // Event Listeners for modals
    document.getElementById('saveNewPassportType').addEventListener('click', addNewPassportType);
    document.getElementById('saveEditPassportType').addEventListener('click', saveEditPassportType);
    document.getElementById('confirmDeletePassportType').addEventListener('click', deletePassportType);

    // Make functions global for onclick handlers
    window.editPassportType = editPassportType;
    window.confirmDeletePassportType = confirmDeletePassportType;
    window.archivePassportType = archivePassportType;

    // Income Management Functions
    const addIncomeModal = new bootstrap.Modal(document.getElementById('addIncomeModal'));
    const deleteIncomeModal = new bootstrap.Modal(document.getElementById('deleteIncomeModal'));

    let currentDeletingIncomeId = null;

    // Set default date to today for add income modal
    const today = new Date().toISOString().split('T')[0];
    const addIncomeDateInput = document.querySelector('#addIncomeForm input[name="date"]');
    if (addIncomeDateInput) {
      addIncomeDateInput.value = today;
    }

    function addNewIncome() {
      const form = document.getElementById('addIncomeForm');

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const saveBtn = document.getElementById('saveIncomeBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Adding...';
      saveBtn.disabled = true;

      form.action = '/admin/activity-income/{{ activity.id if activity }}?return_to=activity_form';
      form.method = 'POST';
      form.submit();
    }

    function editIncome(incomeId) {
      window.location.href = `/admin/activity-income/{{ activity.id if activity }}/${incomeId}?return_to=activity_form`;
    }

    function confirmDeleteIncome(incomeId, category) {
      currentDeletingIncomeId = incomeId;
      document.getElementById('deleteIncomeCategory').textContent = category;
      deleteIncomeModal.show();
    }

    function deleteIncome() {
      if (!currentDeletingIncomeId) return;

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/admin/delete-income/${currentDeletingIncomeId}?return_to=activity_form`;

      const csrfToken = document.createElement('input');
      csrfToken.type = 'hidden';
      csrfToken.name = 'csrf_token';
      csrfToken.value = document.querySelector('input[name="csrf_token"]').value;

      form.appendChild(csrfToken);
      document.body.appendChild(form);
      form.submit();
    }

    // Event listeners for income modals
    document.getElementById('saveIncomeBtn').addEventListener('click', addNewIncome);
    document.getElementById('confirmDeleteIncome').addEventListener('click', deleteIncome);

    // Expense Management Functions
    let currentDeletingExpenseId = null;
    const deleteExpenseModal = new bootstrap.Modal(document.getElementById('deleteExpenseModal'));
    const addExpenseModal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
    const editExpenseModal = new bootstrap.Modal(document.getElementById('editExpenseModal'));

    function addNewExpense() {
      const form = document.getElementById('addExpenseForm');

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const saveBtn = document.getElementById('saveExpenseBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="ti ti-loader-2 spinner-border spinner-border-sm me-2"></i>Adding...';
      saveBtn.disabled = true;

      form.submit();
    }

    // Event listener for expense modal
    document.getElementById('saveExpenseBtn').addEventListener('click', addNewExpense);

    // Initialize location button handlers
    const lookupLocationBtn = document.getElementById('lookupLocationBtn');
    if (lookupLocationBtn) {
      lookupLocationBtn.addEventListener('click', lookupLocation);
    }

    const clearLocationBtn = document.getElementById('clearLocationBtn');
    if (clearLocationBtn) {
      clearLocationBtn.addEventListener('click', clearLocation);
    }

    // Show confirmed location if data exists
    {% if activity and activity.location_address_formatted %}
    const inputGroup = document.getElementById('locationAutocomplete').closest('.input-group');
    inputGroup.style.display = 'none';
    document.getElementById('locationHint').style.display = 'none';
    document.getElementById('confirmedAddressText').textContent = '{{ activity.location_address_formatted }}';
    document.getElementById('viewMapLink').href = 'https://www.google.com/maps?q={{ activity.location_coordinates }}';
    document.getElementById('locationConfirmed').style.display = 'flex';
    {% endif %}

    // Load existing passport types
    {% if activity and activity.passport_types %}
    const existingPassportTypes = [
      {% for pt in activity.passport_types if not pt.is_archived %}
      {
        id: {{ pt.id }},
        name: "{{ pt.name|e }}",
        price_per_user: "{{ '%.2f'|format(pt.price_per_user) }}",
        sessions_included: "{{ pt.sessions_included }}"
      },
      {% endfor %}
    ];

    existingPassportTypes.forEach(pt => {
      passportTypes.push(pt);
      const rowHtml = createPassportTypeTableRow(pt);
      passportTypesContainer.insertAdjacentHTML('beforeend', rowHtml);
    });

    updateVisibility();
    {% endif %}


    // Workflow type checkbox mutual exclusion
    document.querySelectorAll('input[name="workflow_type"]').forEach(function(cb) {
      cb.addEventListener('change', function() {
        if (this.checked) {
          document.querySelectorAll('input[name="workflow_type"]').forEach(function(other) {
            if (other !== cb) other.checked = false;
          });
        }
      });
    });

  });
</script>
{% endblock %}
