{% extends "base.html" %}
{% block title %}Reports{% endblock %}
{% block header %}Reports & Stats ðŸ“Š{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<h1>Reports & KPI</h1>


<div style="height: {{ 100 + chart_data|length * 50 }}px;">
    <canvas id="billedEarnedChart"></canvas>
</div>


<div style="height: {{ 100 + creation_chart_data.labels|length * 50 }}px;">
    <canvas id="creationChart"></canvas>
</div>


<div style="height: {{ 100 + redemption_chart_data.labels|length * 50 }}px;">
    <canvas id="redemptionChart"></canvas>
</div>


<script>
    const chartData = {{ chart_data | tojson }};
    const labels = chartData.map(d => {
        const [month, year] = d.label.split("/");
        const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'short' });
        return `${monthName} ${year}`;  // e.g., "Mar 2025"
    });

    const earned = chartData.map(d => d.earned);
    const unpaid = chartData.map(d => d.billed - d.earned);

    const ctx = document.getElementById('billedEarnedChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Earned ($)',
                    data: earned,
                    backgroundColor: 'rgba(75, 192, 192, 0.85)'
                },
                {
                    label: 'Unpaid ($)',
                    data: unpaid,
                    backgroundColor: 'rgba(255, 99, 132, 0.75)'
                }
            ]
        },
        options: {
            indexAxis: 'y',  // âœ… Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { font: { size: 12 } }
                },
                title: {
                    display: true,
                    text: 'Billed Breakdown by Month (Earned vs Unpaid)',
                    font: { size: 16 }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount ($)',
                        font: { size: 13 }
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Month',
                        font: { size: 13 }
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                }
            }
        }
    });
</script>


<script>
    const creationLabels = {{ creation_chart_data.labels | tojson }};
    const adminEmails = {{ creation_chart_data.admins | tojson }};
    const creationDatasets = {{ creation_chart_data.datasets | tojson }};

    const creationCtx = document.getElementById('creationChart').getContext('2d');
    new Chart(creationCtx, {
        type: 'bar',
        data: {
            labels: creationLabels.map(label => {
                const [month, year] = label.split("/");
                const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'short' });
                return `${monthName} ${year}`;
            }),
            datasets: creationDatasets.map(ds => ({
                ...ds,
                backgroundColor: getColorForAdmin(ds.label)
            }))
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { font: { size: 12 } }
                },
                title: {
                    display: true,
                    text: 'Passes Created per Admin per Month',
                    font: { size: 16 }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Passes Created', font: { size: 13 } },
                    ticks: { font: { size: 12 } }
                },
                y: {
                    title: { display: true, text: 'Month', font: { size: 13 } },
                    ticks: { font: { size: 12 } }
                }
            }
        }
    });

    function getColorForAdmin(email) {
        const hash = [...email].reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const hue = hash % 360;
        return `hsl(${hue}, 60%, 60%)`;
    }
</script>

<script>
    const redemptionLabels = {{ redemption_chart_data.labels | tojson }};
    const redemptionDatasets = {{ redemption_chart_data.datasets | tojson }};

    const redemptionCtx = document.getElementById('redemptionChart').getContext('2d');
    new Chart(redemptionCtx, {
        type: 'bar',
        data: {
            labels: redemptionLabels.map(label => {
                const [month, year] = label.split("/");
                const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'short' });
                return `${monthName} ${year}`;
            }),
            datasets: redemptionDatasets.map(ds => ({
                ...ds,
                backgroundColor: getColorForAdmin(ds.label)
            }))
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { font: { size: 12 } }
                },
                title: {
                    display: true,
                    text: 'Games Redeemed per Admin per Month',
                    font: { size: 16 }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Games Redeemed', font: { size: 13 } },
                    ticks: { font: { size: 12 } }
                },
                y: {
                    title: { display: true, text: 'Month', font: { size: 13 } },
                    ticks: { font: { size: 12 } }
                }
            }
        }
    });

    // Already defined above, reused here
    function getColorForAdmin(email) {
        const hash = [...email].reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const hue = hash % 360;
        return `hsl(${hue}, 60%, 60%)`;
    }
</script>


{% endblock %}
